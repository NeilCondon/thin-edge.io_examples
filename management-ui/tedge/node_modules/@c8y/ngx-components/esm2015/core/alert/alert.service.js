import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { Injectable } from '@angular/core';
import { StateService } from '../common/state-service.abstract';
import { gettext } from '../i18n/gettext';
import { isEqual } from 'lodash-es';
import * as i0 from "@angular/core";
/**
 * A service which allows to display alerts.
 */
let AlertService = class AlertService extends StateService {
    /**
     * A service which allows to display alerts.
     */
    constructor() {
        super(...arguments);
        /**
         * @ignore
         */
        this.state$ = new BehaviorSubject([]);
        this.MAX_ALERTS = 3;
        this.ALERT_TIMEOUT = 3000;
    }
    /**
     * Returns all alerts.
     * @readonly
     */
    get state() {
        return this.state$.value;
    }
    /**
     * Adds a new alert to the current state.
     */
    add(alert) {
        this.addAlert(alert);
    }
    /**
     * Adds a alert by text.
     */
    addByText(type, txt, detailedData) {
        this.addAlert({ text: txt, type, detailedData });
    }
    /**
     * Returns all alerts.
     * @deprecated Use alertService.alerts instead.
     */
    list() {
        return this.state;
    }
    /**
     * Remove an alert from the current state.
     */
    remove(alert) {
        this.changeAlerts(this.state.filter(item => !this.areSame(alert, item)));
    }
    /**
     * Updates matching alert with provided values.
     */
    update(alert, fieldsToUpdate) {
        this.changeAlerts(this.state.map(item => {
            if (this.areSame(alert, item)) {
                Object.assign(item, fieldsToUpdate);
            }
            return item;
        }));
    }
    /**
     * Removes last danger alert.
     * It can be used e.g. in the case of a failed request which triggered an alert, to hide it from user.
     *
     * ```js
     *  try {
     *    // something that might throw a danger server msg
     *  } catch (ex) {
     *   this.alertService.removeLastDanger();
     *  }
     * ```
     */
    removeLastDanger() {
        const firstDangerAlert = this.state.reverse().find(({ type }) => type === 'danger');
        this.changeAlerts(this.state.filter(alert => alert !== firstDangerAlert));
    }
    /**
     * Shorthand for a save successful alert.
     * @param savedObject The object which was saved.
     * @return A function that can be executed to show the msg.
     */
    saveSuccess(savedObject) {
        return () => {
            const text = `${savedObject} saved successfully`;
            this.addByText('success', text);
        };
    }
    /**
     * Shorthand for a create successful alert.
     * @param createdObject The object which was created.
     * @return A function that can be executed to show the msg.
     */
    createSuccess(createdObject) {
        return () => {
            const text = `${createdObject} created successfully`;
            this.addByText('success', text);
        };
    }
    /**
     * Clears all alerts.
     */
    clearAll() {
        this.changeAlerts([]);
    }
    /**
     * A shorthand to display a simple success message.
     * @param text The success text.
     * @param detailedData The text with additional information.
     */
    success(text, detailedData) {
        this.addByText('success', text, detailedData);
    }
    /**
     * A shorthand to display a simple danger message.
     * @param text The danger text.
     * @param detailedData The text with additional information.
     */
    danger(text, detailedData) {
        this.addByText('danger', text, detailedData);
    }
    /**
     * A shorthand to display a simple info message.
     * @param text The info text.
     * @param detailedData The text with additional information.
     */
    info(text, detailedData) {
        this.addByText('info', text, detailedData);
    }
    /**
     * A shorthand to display a simple warning message.
     * @param text The warning text.
     * @param detailedData The text with additional information.
     */
    warning(text, detailedData) {
        this.addByText('warning', text, detailedData);
    }
    /**
     * Creates alert from standard api errors.
     * Should be used for errors generated by @c8y/client services.
     * @param {IResult}  error The error from server.
     * @param {alertType} type The type of alert.
     */
    addServerFailure(error, type = 'danger') {
        const { data, res } = error;
        let text = data && data.message ? data.message : null;
        let detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        const hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (!hasRelevantMessage) {
            detailedData = {
                status: res.status,
                statusText: res.statusText,
                url: res.url
            };
        }
        this.addAlert({
            type,
            text,
            detailedData
        });
    }
    /**
     * Compares two alert objects. Alerts are same if text, type, detailed data and callbacks are same.
     * Callbacks are same if they refer to the same function.
     */
    areSame(alert1, alert2) {
        return (alert1.text === alert2.text &&
            alert1.type === alert2.type &&
            isEqual(alert1.detailedData, alert2.detailedData) &&
            alert1.onClose === alert2.onClose &&
            alert1.onDetail === alert2.onDetail);
    }
    changeAlerts(newAlerts) {
        this.state$.next(newAlerts);
    }
    addAlert(alert) {
        if (!alert.text && !alert.type) {
            throw new Error('Cannot add empty alert');
        }
        const alertAlreadyAdded = this.state.find(item => this.areSame(alert, item));
        if (alertAlreadyAdded) {
            return;
        }
        this.changeAlerts([...this.state, alert]);
        this.hideAutomaticallyIfNeeded(alert);
        this.removeOldestIfMax();
    }
    hideAutomaticallyIfNeeded(alert) {
        const isSuccess = alert.type === 'success';
        const noDetails = !alert.detailedData;
        let alertTimeout = isSuccess && noDetails ? this.ALERT_TIMEOUT : 0;
        if (typeof alert.timeout !== 'undefined') {
            alertTimeout = alert.timeout;
        }
        if (alertTimeout) {
            setTimeout(() => this.remove(alert), alertTimeout);
        }
    }
    removeOldestIfMax() {
        if (this.state.length > this.MAX_ALERTS) {
            const [, ...firstRemoved] = this.state;
            this.changeAlerts(firstRemoved);
        }
    }
};
AlertService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AlertService_Factory() { return new AlertService(); }, token: AlertService, providedIn: "root" });
AlertService = tslib_1.__decorate([
    Injectable({
        providedIn: 'root'
    })
], AlertService);
export { AlertService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2FsZXJ0L2FsZXJ0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7O0FBR3BDOztHQUVHO0FBSUgsSUFBYSxZQUFZLEdBQXpCLE1BQWEsWUFBYSxTQUFRLFlBQVk7SUFOOUM7O09BRUc7SUFDSDs7UUFXRTs7V0FFRztRQUNILFdBQU0sR0FBRyxJQUFJLGVBQWUsQ0FBVSxFQUFFLENBQUMsQ0FBQztRQUVsQyxlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ2Ysa0JBQWEsR0FBRyxJQUFJLENBQUM7S0F3TjlCO0lBck9DOzs7T0FHRztJQUNILElBQUksS0FBSztRQUNQLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDM0IsQ0FBQztJQVNEOztPQUVHO0lBQ0gsR0FBRyxDQUFDLEtBQVk7UUFDZCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVMsQ0FBQyxJQUFlLEVBQUUsR0FBVyxFQUFFLFlBQXFCO1FBQzNELElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRDs7O09BR0c7SUFDSCxJQUFJO1FBQ0YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDO0lB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SyxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDcEQ7SUFDSCxDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUN2QyxNQUFNLENBQUMsRUFBRSxHQUFHLFlBQVksQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7WUFDdkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUNqQztJQUNILENBQUM7Q0FDRixDQUFBOztBQXRPWSxZQUFZO0lBSHhCLFVBQVUsQ0FBQztRQUNWLFVBQVUsRUFBRSxNQUFNO0tBQ25CLENBQUM7R0FDVyxZQUFZLENBc094QjtTQXRPWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWxlcnQgfSBmcm9tICcuL2FsZXJ0Lm1vZGVsJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3N0YXRlLXNlcnZpY2UuYWJzdHJhY3QnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJy4uL2kxOG4vZ2V0dGV4dCc7XG5pbXBvcnQge0lSZXN1bHR9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGlzRXF1YWwgfSBmcm9tICdsb2Rhc2gtZXMnO1xuXG50eXBlIGFsZXJ0VHlwZSA9ICdzdWNjZXNzJyB8ICd3YXJuaW5nJyB8ICdkYW5nZXInIHwgJ2luZm8nIHwgJ3N5c3RlbSc7XG4vKipcbiAqIEEgc2VydmljZSB3aGljaCBhbGxvd3MgdG8gZGlzcGxheSBhbGVydHMuXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEFsZXJ0U2VydmljZSBleHRlbmRzIFN0YXRlU2VydmljZSB7XG4gIC8qKlxuICAgKiBSZXR1cm5zIGFsbCBhbGVydHMuXG4gICAqIEByZWFkb25seVxuICAgKi9cbiAgZ2V0IHN0YXRlKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlJC52YWx1ZTtcbiAgfVxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgc3RhdGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxBbGVydFtdPihbXSk7XG5cbiAgcHJpdmF0ZSBNQVhfQUxFUlRTID0gMztcbiAgcHJpdmF0ZSBBTEVSVF9USU1FT1VUID0gMzAwMDtcblxuICAvKipcbiAgICogQWRkcyBhIG5ldyBhbGVydCB0byB0aGUgY3VycmVudCBzdGF0ZS5cbiAgICovXG4gIGFkZChhbGVydDogQWxlcnQpIHtcbiAgICB0aGlzLmFkZEFsZXJ0KGFsZXJ0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgYWxlcnQgYnkgdGV4dC5cbiAgICovXG4gIGFkZEJ5VGV4dCh0eXBlOiBhbGVydFR5cGUsIHR4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmFkZEFsZXJ0KHsgdGV4dDogdHh0LCB0eXBlLCBkZXRhaWxlZERhdGEgfSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbGwgYWxlcnRzLlxuICAgKiBAZGVwcmVjYXRlZCBVc2UgYWxlcnRTZXJ2aWNlLmFsZXJ0cyBpbnN0ZWFkLlxuICAgKi9cbiAgbGlzdCgpOiBBbGVydFtdIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYW4gYWxlcnQgZnJvbSB0aGUgY3VycmVudCBzdGF0ZS5cbiAgICovXG4gIHJlbW92ZShhbGVydDogQWxlcnQpIHtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyh0aGlzLnN0YXRlLmZpbHRlcihpdGVtID0+ICF0aGlzLmFyZVNhbWUoYWxlcnQsIGl0ZW0pKSk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyBtYXRjaGluZyBhbGVydCB3aXRoIHByb3ZpZGVkIHZhbHVlcy5cbiAgICovXG4gIHVwZGF0ZShhbGVydDogQWxlcnQsIGZpZWxkc1RvVXBkYXRlOiBQYXJ0aWFsPEFsZXJ0Pikge1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKFxuICAgICAgdGhpcy5zdGF0ZS5tYXAoaXRlbSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmFyZVNhbWUoYWxlcnQsIGl0ZW0pKSB7XG4gICAgICAgICAgT2JqZWN0LmFzc2lnbihpdGVtLCBmaWVsZHNUb1VwZGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBsYXN0IGRhbmdlciBhbGVydC5cbiAgICogSXQgY2FuIGJlIHVzZWQgZS5nLiBpbiB0aGUgY2FzZSBvZiBhIGZhaWxlZCByZXF1ZXN0IHdoaWNoIHRyaWdnZXJlZCBhbiBhbGVydCwgdG8gaGlkZSBpdCBmcm9tIHVzZXIuXG4gICAqXG4gICAqIGBgYGpzXG4gICAqICB0cnkge1xuICAgKiAgICAvLyBzb21ldGhpbmcgdGhhdCBtaWdodCB0aHJvdyBhIGRhbmdlciBzZXJ2ZXIgbXNnXG4gICAqICB9IGNhdGNoIChleCkge1xuICAgKiAgIHRoaXMuYWxlcnRTZXJ2aWNlLnJlbW92ZUxhc3REYW5nZXIoKTtcbiAgICogIH1cbiAgICogYGBgXG4gICAqL1xuICByZW1vdmVMYXN0RGFuZ2VyKCkge1xuICAgIGNvbnN0IGZpcnN0RGFuZ2VyQWxlcnQgPSB0aGlzLnN0YXRlLnJldmVyc2UoKS5maW5kKCh7IHR5cGUgfSkgPT4gdHlwZSA9PT0gJ2RhbmdlcicpO1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKHRoaXMuc3RhdGUuZmlsdGVyKGFsZXJ0ID0+IGFsZXJ0ICE9PSBmaXJzdERhbmdlckFsZXJ0KSk7XG4gIH1cblxuICAvKipcbiAgICogU2hvcnRoYW5kIGZvciBhIHNhdmUgc3VjY2Vzc2Z1bCBhbGVydC5cbiAgICogQHBhcmFtIHNhdmVkT2JqZWN0IFRoZSBvYmplY3Qgd2hpY2ggd2FzIHNhdmVkLlxuICAgKiBAcmV0dXJuIEEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgZXhlY3V0ZWQgdG8gc2hvdyB0aGUgbXNnLlxuICAgKi9cbiAgc2F2ZVN1Y2Nlc3Moc2F2ZWRPYmplY3Q6IHN0cmluZykge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXh0ID0gYCR7c2F2ZWRPYmplY3R9IHNhdmVkIHN1Y2Nlc3NmdWxseWA7XG4gICAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQpO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2hvcnRoYW5kIGZvciBhIGNyZWF0ZSBzdWNjZXNzZnVsIGFsZXJ0LlxuICAgKiBAcGFyYW0gY3JlYXRlZE9iamVjdCBUaGUgb2JqZWN0IHdoaWNoIHdhcyBjcmVhdGVkLlxuICAgKiBAcmV0dXJuIEEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgZXhlY3V0ZWQgdG8gc2hvdyB0aGUgbXNnLlxuICAgKi9cbiAgY3JlYXRlU3VjY2VzcyhjcmVhdGVkT2JqZWN0KSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHRleHQgPSBgJHtjcmVhdGVkT2JqZWN0fSBjcmVhdGVkIHN1Y2Nlc3NmdWxseWA7XG4gICAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQpO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXJzIGFsbCBhbGVydHMuXG4gICAqL1xuICBjbGVhckFsbCgpIHtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyhbXSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBzdWNjZXNzIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSBzdWNjZXNzIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgc3VjY2Vzcyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdzdWNjZXNzJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIGRhbmdlciBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgZGFuZ2VyIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgZGFuZ2VyKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ2RhbmdlcicsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBpbmZvIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSBpbmZvIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgaW5mbyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdpbmZvJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIHdhcm5pbmcgbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIHdhcm5pbmcgdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICB3YXJuaW5nKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ3dhcm5pbmcnLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYWxlcnQgZnJvbSBzdGFuZGFyZCBhcGkgZXJyb3JzLlxuICAgKiBTaG91bGQgYmUgdXNlZCBmb3IgZXJyb3JzIGdlbmVyYXRlZCBieSBAYzh5L2NsaWVudCBzZXJ2aWNlcy5cbiAgICogQHBhcmFtIHtJUmVzdWx0fSAgZXJyb3IgVGhlIGVycm9yIGZyb20gc2VydmVyLlxuICAgKiBAcGFyYW0ge2FsZXJ0VHlwZX0gdHlwZSBUaGUgdHlwZSBvZiBhbGVydC5cbiAgICovXG4gIGFkZFNlcnZlckZhaWx1cmUoZXJyb3I6IGFueSwgdHlwZTogYWxlcnRUeXBlID0gJ2RhbmdlcicpIHtcbiAgICBjb25zdCB7IGRhdGEsIHJlcyB9ID0gZXJyb3I7XG4gICAgbGV0IHRleHQgPSBkYXRhICYmIGRhdGEubWVzc2FnZSA/IGRhdGEubWVzc2FnZSA6IG51bGw7XG4gICAgbGV0IGRldGFpbGVkRGF0YTtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAnb2JqZWN0Jykge1xuICAgICAgICBkZXRhaWxlZERhdGEgPSBkYXRhLmV4Y2VwdGlvbk1lc3NhZ2U7XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykge1xuICAgICAgICBkZXRhaWxlZERhdGEgPSBkYXRhO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBoYXNSZWxldmFudE1lc3NhZ2UgPSAhISh0ZXh0IHx8IGRldGFpbGVkRGF0YSk7XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICB0ZXh0ID0gZ2V0dGV4dCgnQSBzZXJ2ZXIgZXJyb3Igb2NjdXJyZWQuJyk7XG4gICAgfVxuICAgIGlmICghaGFzUmVsZXZhbnRNZXNzYWdlKSB7XG4gICAgICBkZXRhaWxlZERhdGEgPSB7XG4gICAgICAgIHN0YXR1czogcmVzLnN0YXR1cyxcbiAgICAgICAgc3RhdHVzVGV4dDogcmVzLnN0YXR1c1RleHQsXG4gICAgICAgIHVybDogcmVzLnVybFxuICAgICAgfTtcbiAgICB9XG5cbiAgICB0aGlzLmFkZEFsZXJ0KHtcbiAgICAgIHR5cGUsXG4gICAgICB0ZXh0LFxuICAgICAgZGV0YWlsZWREYXRhXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ29tcGFyZXMgdHdvIGFsZXJ0IG9iamVjdHMuIEFsZXJ0cyBhcmUgc2FtZSBpZiB0ZXh0LCB0eXBlLCBkZXRhaWxlZCBkYXRhIGFuZCBjYWxsYmFja3MgYXJlIHNhbWUuXG4gICAqIENhbGxiYWNrcyBhcmUgc2FtZSBpZiB0aGV5IHJlZmVyIHRvIHRoZSBzYW1lIGZ1bmN0aW9uLlxuICAgKi9cbiAgYXJlU2FtZShhbGVydDE6IEFsZXJ0LCBhbGVydDI6IEFsZXJ0KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIGFsZXJ0MS50ZXh0ID09PSBhbGVydDIudGV4dCAmJlxuICAgICAgYWxlcnQxLnR5cGUgPT09IGFsZXJ0Mi50eXBlICYmXG4gICAgICBpc0VxdWFsKGFsZXJ0MS5kZXRhaWxlZERhdGEsIGFsZXJ0Mi5kZXRhaWxlZERhdGEpICYmXG4gICAgICBhbGVydDEub25DbG9zZSA9PT0gYWxlcnQyLm9uQ2xvc2UgJiZcbiAgICAgIGFsZXJ0MS5vbkRldGFpbCA9PT0gYWxlcnQyLm9uRGV0YWlsXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgY2hhbmdlQWxlcnRzKG5ld0FsZXJ0czogQWxlcnRbXSkge1xuICAgIHRoaXMuc3RhdGUkLm5leHQobmV3QWxlcnRzKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkQWxlcnQoYWxlcnQ6IEFsZXJ0KTogdm9pZCB7XG4gICAgaWYgKCFhbGVydC50ZXh0ICYmICFhbGVydC50eXBlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBhZGQgZW1wdHkgYWxlcnQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBhbGVydEFscmVhZHlBZGRlZCA9IHRoaXMuc3RhdGUuZmluZChpdGVtID0+IHRoaXMuYXJlU2FtZShhbGVydCwgaXRlbSkpO1xuICAgIGlmIChhbGVydEFscmVhZHlBZGRlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuY2hhbmdlQWxlcnRzKFsuLi50aGlzLnN0YXRlLCBhbGVydF0pO1xuICAgIHRoaXMuaGlkZUF1dG9tYXRpY2FsbHlJZk5lZWRlZChhbGVydCk7XG4gICAgdGhpcy5yZW1vdmVPbGRlc3RJZk1heCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBoaWRlQXV0b21hdGljYWxseUlmTmVlZGVkKGFsZXJ0OiBBbGVydCkge1xuICAgIGNvbnN0IGlzU3VjY2VzcyA9IGFsZXJ0LnR5cGUgPT09ICdzdWNjZXNzJztcbiAgICBjb25zdCBub0RldGFpbHMgPSAhYWxlcnQuZGV0YWlsZWREYXRhO1xuICAgIGxldCBhbGVydFRpbWVvdXQgPSBpc1N1Y2Nlc3MgJiYgbm9EZXRhaWxzID8gdGhpcy5BTEVSVF9USU1FT1VUIDogMDtcbiAgICBpZiAodHlwZW9mIGFsZXJ0LnRpbWVvdXQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBhbGVydFRpbWVvdXQgPSBhbGVydC50aW1lb3V0O1xuICAgIH1cbiAgICBpZiAoYWxlcnRUaW1lb3V0KSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMucmVtb3ZlKGFsZXJ0KSwgYWxlcnRUaW1lb3V0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZU9sZGVzdElmTWF4KCkge1xuICAgIGlmICh0aGlzLnN0YXRlLmxlbmd0aCA+IHRoaXMuTUFYX0FMRVJUUykge1xuICAgICAgY29uc3QgWywgLi4uZmlyc3RSZW1vdmVkXSA9IHRoaXMuc3RhdGU7XG4gICAgICB0aGlzLmNoYW5nZUFsZXJ0cyhmaXJzdFJlbW92ZWQpO1xuICAgIH1cbiAgfVxufVxuIl19