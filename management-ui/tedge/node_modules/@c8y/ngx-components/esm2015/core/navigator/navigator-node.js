import { matches, snakeCase } from 'lodash-es';
/**
 * Base navigator node. Represents a single entry in the navigator menu.
 * Is considered to be the basic building block of the navigator.
 */
export class NavigatorNode {
    /**
     * @ignore
     */
    constructor(data) {
        /**
         * Navigator node children (subentries).
         */
        this.children = [];
        /**
         * Navigator node parent nodes.
         */
        this.parents = [];
        /**
         * Indicates whether the navigator node should be active based on matching the node path and the URL path.
         * To match the URL exactly, set this option to true.
         *
         * routerLinkExact set to true:
         * When the URL path is set to /a/b/c and the node path to /a/b then the node will not be set active.
         *
         * routerLinkExact set to false:
         * When the URL path is set to /a/b/c and the node path to /a/b then the node will be set active.
         */
        this.routerLinkExact = true;
        /**
         * Indicates that the navigator node is expanded/collapsed.
         */
        this.open = false;
        /**
         * Indicates that the navigator node is visible/hidden.
         */
        this.hidden = false;
        /**
         * Indicates that the navigator node is draggable.
         */
        this.draggable = false;
        /**
         * Indicates that the navigator node is droppable.
         */
        this.droppable = false;
        /**
         * Indicates that the navigator node is dragged.
         */
        this.dragged = false;
        /**
         * Indicates that currently something is dragged over the node.
         */
        this.draggedHover = false;
        /**
         * Confirmation popover displayed at the end of the process of moving the navigator menu item.
         */
        this.confirm = undefined;
        this._priority = 0;
        this.update(data);
    }
    /**
     * Returns information whether a navigator node has children.
     * @readonly
     */
    get hasChildren() {
        return this.children.length > 0;
    }
    /**
     * Returns the ID of the navigator node.
     * @readonly
     */
    get id() {
        return 'navigator_node_' + snakeCase(this.label);
    }
    /**
     * Returns the priority value of the navigator node.
     * @readonly
     */
    get priority() {
        if (this._priority) {
            return this._priority;
        }
        else {
            const childrenPriorities = this.children.map(({ priority }) => priority || 0);
            if (childrenPriorities.length) {
                return childrenPriorities.length ? Math.max(...childrenPriorities) : 0;
            }
            return 0;
        }
    }
    /**
     * Sets the priority value of the navigator node.
     *
     * @param {number} priority Priority value.
     */
    set priority(priority) {
        this._priority = priority;
    }
    /**
     * @ignore
     */
    openOnStart(url) {
        return false;
    }
    /**
     * Adds a child navigator node to the node.
     *
     * @param {NavigatorNode} node Child node.
     */
    add(node) {
        if (node === this) {
            throw new Error('Adding node to itself');
        }
        if (this.children.indexOf(node) === -1) {
            this.children.push(node);
        }
        if (node.parents.indexOf(this) === -1) {
            node.parents.push(this);
        }
        this.updateChildren();
    }
    /**
     * Removes the child navigator node from the node.
     *
     * @param {NavigatorNode} node Child node.
     */
    remove(node) {
        const ix = this.children.indexOf(node);
        const pix = node.parents.indexOf(this);
        if (ix > -1) {
            this.children.splice(ix, 1);
        }
        if (pix > -1) {
            node.parents.splice(pix, 1);
        }
        this.updateChildren();
    }
    /**
     * Updates the navigator node.
     *
     * @param {NavigatorNodeData} data Data to be upated.
     */
    update(data) {
        if (data) {
            Object.assign(this, data);
            if (data.hidden !== undefined) {
                this.parents.forEach(p => {
                    p.updateHidden();
                });
            }
        }
    }
    /**
     * Returns a child navigator node based on the predicate.
     *
     * @param {string|object} predicate Filter criteria.
     *
     * @example
     * ```ts
     * // The function will compare the labels to the string and return a matching result.
     * // The capitalization of the characters does not matter (case insensitive).
     * const predicate = 'group1';
     * const childNode = parentNode.find(predicate);
     *
     * // Check: [lodash matches](https://lodash.com/docs/4.17.15#matches)
     * const predicate = { label: 'group2' };
     * const childNode = parentNode.find(predicate);
     * ```
     */
    find(predicate) {
        if (typeof predicate === 'string') {
            const compareLabel = predicate.toLocaleLowerCase();
            predicate = ({ label }) => compareLabel === label.toLowerCase();
        }
        if (typeof predicate === 'object') {
            predicate = matches(predicate);
        }
        if (typeof predicate !== 'function') {
            throw new Error('Invalid search predicate');
        }
        return this.children.reduce((found, child) => found || child.find(predicate), this.children.find(predicate));
    }
    /**
     * Removes children nodes.
     */
    empty() {
        this.children.length = 0;
    }
    /**
     * @ignore
     */
    click(options = {}) {
        // do nothing
    }
    /**
     * This event is fired when an element is dropped on a valid drop target.
     * @param $event DOM event.
     */
    drop($event) {
        $event.stopPropagation();
        clearTimeout(this.expandDragTimeout);
    }
    /**
     * This event is fired when the user starts dragging an element.
     * @param $event DOM event.
     */
    dragStart($event) {
        $event.stopPropagation();
        // we can't pass a object to setData, so we do it via service
        // set data is still needed, to make the drag&drop work
        $event.dataTransfer.setData('node', 'node');
        this.dragged = true;
    }
    /**
     * This event is fired when a drag operation has ended.
     * @param $event DOM event.
     */
    dragEnd($event) {
        $event.stopPropagation();
        this.dragged = false;
        $event.dataTransfer.clearData();
    }
    /**
     * Returns information whether the navigator node is droppable.
     * @readonly
     */
    get canDrop() {
        return this.droppable;
    }
    /**
     * Returns information whether navigation is possible.
     * @readonly
     */
    get canNavigate() {
        return typeof this.path !== 'undefined';
    }
    /**
     * This event is fired when a dragged element enters a valid drop target.
     * @param $event DOM event.
     */
    dragEnter($event) {
        $event.preventDefault();
        $event.stopPropagation();
        this.draggedHover = true;
        if (!this.open) {
            this.expandDragTimeout = setTimeout(() => this.expand(), 1000);
        }
    }
    /**
     * This event is fired when a dragged element leaves a valid drop target.
     * @param $event DOM event.
     */
    dragLeave($event) {
        $event.preventDefault();
        $event.stopPropagation();
        this.draggedHover = false;
        clearTimeout(this.expandDragTimeout);
    }
    /**
     * Expands the navigator node if it is collapsed.
     */
    expand() {
        if (!this.open) {
            this.open = true;
            this.click({ open: true, expander: true });
        }
    }
    /**
     * Performs a callback function recursively on each of the navigator node's children down the hierarchy.
     * @param {function} callback Function to be called.
     *
     * @example
     * ```ts
     * const expandChild = (childNode) => childNode.expand();
     * parentNode.traverse(expandChild);
     * ```
     */
    traverse(callback) {
        if (this.children) {
            this.children.forEach(child => {
                callback(child);
                child.traverse(callback);
            });
        }
    }
    /**
     * @ignore
     */
    destroy() {
        // nothing todo here
    }
    /**
     * Updates the navigator node by sorting its children and also checking their visibility.
     */
    updateChildren() {
        this.sort();
        this.updateHidden();
    }
    /**
     * Sorts the children of the navigator node, by priority and name (ASC).
     * The higher the priority, the higher the position in the hierarchy.
     * For the same priority values, the alphabetical order will take precedence.
     */
    sort() {
        this.children.sort((a, b) => {
            if (a.priority > b.priority) {
                return -1;
            }
            else if (a.priority < b.priority) {
                return 1;
            }
            else if ((a.label || '').toLowerCase() < (b.label || '').toLowerCase()) {
                return -1;
            }
            else if ((a.label || '').toLowerCase() > (b.label || '').toLowerCase()) {
                return 1;
            }
            else {
                return 0;
            }
        });
    }
    /**
     * Checks if the navigator node should be hidden based on the visibility of its child nodes.
     */
    updateHidden() {
        if (typeof this.path === 'undefined') {
            this.hidden = !this.children.some(({ hidden }) => !hidden);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLW5vZGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9uYXZpZ2F0b3IvbmF2aWdhdG9yLW5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUF5Qi9DOzs7R0FHRztBQUNILE1BQU0sT0FBTyxhQUFhO0lBbUl4Qjs7T0FFRztJQUNILFlBQVksSUFBd0I7UUF0SHBDOztXQUVHO1FBQ0gsYUFBUSxHQUFvQixFQUFFLENBQUM7UUFZL0I7O1dBRUc7UUFDSCxZQUFPLEdBQW9CLEVBQUUsQ0FBQztRQU85Qjs7Ozs7Ozs7O1dBU0c7UUFDSCxvQkFBZSxHQUFZLElBQUksQ0FBQztRQUVoQzs7V0FFRztRQUNILFNBQUksR0FBWSxLQUFLLENBQUM7UUFFdEI7O1dBRUc7UUFDSCxXQUFNLEdBQVksS0FBSyxDQUFDO1FBRXhCOztXQUVHO1FBQ0gsY0FBUyxHQUFZLEtBQUssQ0FBQztRQUUzQjs7V0FFRztRQUNILGNBQVMsR0FBWSxLQUFLLENBQUM7UUFFM0I7O1dBRUc7UUFDSCxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBRWhCOztXQUVHO1FBQ0gsaUJBQVksR0FBRyxLQUFLLENBQUM7UUFFckI7O1dBRUc7UUFDSCxZQUFPLEdBQTRCLFNBQVMsQ0FBQztRQUNyQyxjQUFTLEdBQVcsQ0FBQyxDQUFDO1FBZ0Q1QixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BCLENBQUM7SUE5Q0Q7OztPQUdHO0lBQ0gsSUFBSSxXQUFXO1FBQ2IsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVEOzs7T0FHRztJQUNILElBQUksRUFBRTtRQUNKLE9BQU8saUJBQWlCLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJ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TyxDQUFDLENBQUM7YUFDVjtpQkFBTTtnQkFDTCxPQUFPLENBQUMsQ0FBQzthQUNWO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDTyxZQUFZO1FBQ3BCLElBQUksT0FBTyxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRTtZQUNwQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQzVEO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGVtcGxhdGVSZWYsIFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG1hdGNoZXMsIHNuYWtlQ2FzZSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBOYXZpZ2F0b3JOb2RlRGF0YSB9IGZyb20gJy4vbmF2aWdhdG9yLW5vZGUtZGF0YSc7XG5pbXBvcnQgeyBQb3BvdmVyQ29uZmlybUNvbXBvbmVudCB9IGZyb20gJy4uL21vZGFsL3BvcG92ZXItY29uZmlybS5jb21wb25lbnQnO1xuXG4vKipcbiAqIEludGVyZmFjZSB0aGF0IGRldGVybWluZXMgdGhlIGF2YWlsYWJsZSBjbGljayBvcHRpb25zLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENsaWNrT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgdGhhdCB0aGUgc291cmNlIG9mIHRoZSBldmVudCBpcyBhIGNsaWNrIG9uIHRoZSBub2RlIGljb24uXG4gICAqL1xuICBpY29uPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBzb3VyY2Ugb2YgdGhlIGV2ZW50IGlzIGEgY2xpY2sgb24gdGhlIG5vZGUgZXhwYW5kZXIuXG4gICAqL1xuICBleHBhbmRlcj86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgdGhhdCB0aGUgbmF2aWdhdG9yIG5vZGUgaXMgZXhwYW5kZWQvY29sbGFwc2VkLlxuICAgKi9cbiAgb3Blbj86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBET00gZXZlbnQuXG4gICAqL1xuICAkZXZlbnQ/OiBhbnk7IC8vIFRPRE86IGFkZCBwcm9wZXIgdHlwZVxufVxuLyoqXG4gKiBCYXNlIG5hdmlnYXRvciBub2RlLiBSZXByZXNlbnRzIGEgc2luZ2xlIGVudHJ5IGluIHRoZSBuYXZpZ2F0b3IgbWVudS5cbiAqIElzIGNvbnNpZGVyZWQgdG8gYmUgdGhlIGJhc2ljIGJ1aWxkaW5nIGJsb2NrIG9mIHRoZSBuYXZpZ2F0b3IuXG4gKi9cbmV4cG9ydCBjbGFzcyBOYXZpZ2F0b3JOb2RlIHtcbiAgLyoqXG4gICAqIE5hdmlnYXRvciBub2RlIGljb24uXG4gICAqL1xuICBpY29uOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEN1c3RvbSBpY29uIHRlbXBsYXRlLlxuICAgKi9cbiAgaWNvblRlbXBsYXRlPzogVGVtcGxhdGVSZWY8YW55PjtcblxuICAvKipcbiAgICogQ3VzdG9tIGljb24gY29tcG9uZW50LlxuICAgKi9cbiAgaWNvbkNvbXBvbmVudD86IFR5cGU8YW55PjtcblxuICAvKipcbiAgICogTmF2aWdhdG9yIG5vZGUgY2hpbGRyZW4gKHN1YmVudHJpZXMpLlxuICAgKi9cbiAgY2hpbGRyZW46IE5hdmlnYXRvck5vZGVbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiBMYWJlbCB0byBiZSBkaXNwbGF5ZWQgaW4gdGhlIG5hdmlnYXRvciBub2RlLlxuICAgKi9cbiAgbGFiZWw7XG5cbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHdoaWNoIHRoZSBVSSB3aWxsIGJlIHJlZGlyZWN0ZWQgYWZ0ZXIgY2xpY2tpbmcgdGhlIG5hdmlnYXRvciBub2RlLlxuICAgKi9cbiAgcGF0aDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBOYXZpZ2F0b3Igbm9kZSBwYXJlbnQgbm9kZXMuXG4gICAqL1xuICBwYXJlbnRzOiBOYXZpZ2F0b3JOb2RlW10gPSBbXTtcblxuICAvKipcbiAgICogTG9hZGluZyBzdGF0ZSBpbmRpY2F0b3IuXG4gICAqL1xuICBsb2FkaW5nPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogSW5kaWNhdGVzIHdoZXRoZXIgdGhlIG5hdmlnYXRvciBub2RlIHNob3VsZCBiZSBhY3RpdmUgYmFzZWQgb24gbWF0Y2hpbmcgdGhlIG5vZGUgcGF0aCBhbmQgdGhlIFVSTCBwYXRoLlxuICAgKiBUbyBtYXRjaCB0aGUgVVJMIGV4YWN0bHksIHNldCB0aGlzIG9wdGlvbiB0byB0cnVlLlxuICAgKlxuICAgKiByb3V0ZXJMaW5rRXhhY3Qgc2V0IHRvIHRydWU6XG4gICAqIFdoZW4gdGhlIFVSTCBwYXRoIGlzIHNldCB0byAvYS9iL2MgYW5kIHRoZSBub2RlIHBhdGggdG8gL2EvYiB0aGVuIHRoZSBub2RlIHdpbGwgbm90IGJlIHNldCBhY3RpdmUuXG4gICAqXG4gICAqIHJvdXRlckxpbmtFeGFjdCBzZXQgdG8gZmFsc2U6XG4gICAqIFdoZW4gdGhlIFVSTCBwYXRoIGlzIHNldCB0byAvYS9iL2MgYW5kIHRoZSBub2RlIHBhdGggdG8gL2EvYiB0aGVuIHRoZSBub2RlIHdpbGwgYmUgc2V0IGFjdGl2ZS5cbiAgICovXG4gIHJvdXRlckxpbmtFeGFjdDogYm9vbGVhbiA9IHRydWU7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyBleHBhbmRlZC9jb2xsYXBzZWQuXG4gICAqL1xuICBvcGVuOiBib29sZWFuID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyB2aXNpYmxlL2hpZGRlbi5cbiAgICovXG4gIGhpZGRlbjogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgdGhhdCB0aGUgbmF2aWdhdG9yIG5vZGUgaXMgZHJhZ2dhYmxlLlxuICAgKi9cbiAgZHJhZ2dhYmxlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyBkcm9wcGFibGUuXG4gICAqL1xuICBkcm9wcGFibGU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKipcbiAgICogSW5kaWNhdGVzIHRoYXQgdGhlIG5hdmlnYXRvciBub2RlIGlzIGRyYWdnZWQuXG4gICAqL1xuICBkcmFnZ2VkID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IGN1cnJlbnRseSBzb21ldGhpbmcgaXMgZHJhZ2dlZCBvdmVyIHRoZSBub2RlLlxuICAgKi9cbiAgZHJhZ2dlZEhvdmVyID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIENvbmZpcm1hdGlvbiBwb3BvdmVyIGRpc3BsYXllZCBhdCB0aGUgZW5kIG9mIHRoZSBwcm9jZXNzIG9mIG1vdmluZyB0aGUgbmF2aWdhdG9yIG1lbnUgaXRlbS5cbiAgICovXG4gIGNvbmZpcm06IFBvcG92ZXJDb25maXJtQ29tcG9uZW50ID0gdW5kZWZpbmVkO1xuICBwcml2YXRlIF9wcmlvcml0eTogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBleHBhbmREcmFnVGltZW91dDtcblxuICAvKipcbiAgICogUmV0dXJucyBpbmZvcm1hdGlvbiB3aGV0aGVyIGEgbmF2aWdhdG9yIG5vZGUgaGFzIGNoaWxkcmVuLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBoYXNDaGlsZHJlbigpIHtcbiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGggPiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIElEIG9mIHRoZSBuYXZpZ2F0b3Igbm9kZS5cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgaWQoKSB7XG4gICAgcmV0dXJuICduYXZpZ2F0b3Jfbm9kZV8nICsgc25ha2VDYXNlKHRoaXMubGFiZWwpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIHByaW9yaXR5IHZhbHVlIG9mIHRoZSBuYXZpZ2F0b3Igbm9kZS5cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgcHJpb3JpdHkoKSB7XG4gICAgaWYgKHRoaXMuX3ByaW9yaXR5KSB7XG4gICAgICByZXR1cm4gdGhpcy5fcHJpb3JpdHk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuUHJpb3JpdGllcyA9IHRoaXMuY2hpbGRyZW4ubWFwKCh7IHByaW9yaXR5IH0pID0+IHByaW9yaXR5IHx8IDApO1xuICAgICAgaWYgKGNoaWxkcmVuUHJpb3JpdGllcy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIGNoaWxkcmVuUHJpb3JpdGllcy5sZW5ndGggPyBNYXRoLm1heCguLi5jaGlsZHJlblByaW9yaXRpZXMpIDogMDtcbiAgICAgIH1cbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBwcmlvcml0eSB2YWx1ZSBvZiB0aGUgbmF2aWdhdG9yIG5vZGUuXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBwcmlvcml0eSBQcmlvcml0eSB2YWx1ZS5cbiAgICovXG4gIHNldCBwcmlvcml0eShwcmlvcml0eSkge1xuICAgIHRoaXMuX3ByaW9yaXR5ID0gcHJpb3JpdHk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgY29uc3RydWN0b3IoZGF0YT86IE5hdmlnYXRvck5vZGVEYXRhKSB7XG4gICAgdGhpcy51cGRhdGUoZGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgb3Blbk9uU3RhcnQodXJsOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIGNoaWxkIG5hdmlnYXRvciBub2RlIHRvIHRoZSBub2RlLlxuICAgKlxuICAgKiBAcGFyYW0ge05hdmlnYXRvck5vZGV9IG5vZGUgQ2hpbGQgbm9kZS5cbiAgICovXG4gIGFkZChub2RlOiBOYXZpZ2F0b3JOb2RlKSB7XG4gICAgaWYgKG5vZGUgPT09IHRoaXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQWRkaW5nIG5vZGUgdG8gaXRzZWxmJyk7XG4gICAgfVxuICAgIGlmICh0aGlzLmNoaWxkcmVuLmluZGV4T2Yobm9kZSkgPT09IC0xKSB7XG4gICAgICB0aGlzLmNoaWxkcmVuLnB1c2gobm9kZSk7XG4gICAgfVxuICAgIGlmIChub2RlLnBhcmVudHMuaW5kZXhPZih0aGlzKSA9PT0gLTEpIHtcbiAgICAgIG5vZGUucGFyZW50cy5wdXNoKHRoaXMpO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZUNoaWxkcmVuKCk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyB0aGUgY2hpbGQgbmF2aWdhdG9yIG5vZGUgZnJvbSB0aGUgbm9kZS5cbiAgICpcbiAgICogQHBhcmFtIHtOYXZpZ2F0b3JOb2RlfSBub2RlIENoaWxkIG5vZGUuXG4gICAqL1xuICByZW1vdmUobm9kZTogTmF2aWdhdG9yTm9kZSkge1xuICAgIGNvbnN0IGl4ID0gdGhpcy5jaGlsZHJlbi5pbmRleE9mKG5vZGUpO1xuICAgIGNvbnN0IHBpeCA9IG5vZGUucGFyZW50cy5pbmRleE9mKHRoaXMpO1xuICAgIGlmIChpeCA+IC0xKSB7XG4gICAgICB0aGlzLmNoaWxkcmVuLnNwbGljZShpeCwgMSk7XG4gICAgfVxuICAgIGlmIChwaXggPiAtMSkge1xuICAgICAgbm9kZS5wYXJlbnRzLnNwbGljZShwaXgsIDEpO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZUNoaWxkcmVuKCk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlcyB0aGUgbmF2aWdhdG9yIG5vZGUuXG4gICAqXG4gICAqIEBwYXJhbSB7TmF2aWdhdG9yTm9kZURhdGF9IGRhdGEgRGF0YSB0byBiZSB1cGF0ZWQuXG4gICAqL1xuICB1cGRhdGUoZGF0YT86IE5hdmlnYXRvck5vZGVEYXRhKSB7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24odGhpcywgZGF0YSk7XG4gICAgICBpZiAoZGF0YS5oaWRkZW4gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnBhcmVudHMuZm9yRWFjaChwID0+IHtcbiAgICAgICAgICBwLnVwZGF0ZUhpZGRlbigpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIGNoaWxkIG5hdmlnYXRvciBub2RlIGJhc2VkIG9uIHRoZSBwcmVkaWNhdGUuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gcHJlZGljYXRlIEZpbHRlciBjcml0ZXJpYS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBgdHNcbiAgICogLy8gVGhlIGZ1bmN0aW9uIHdpbGwgY29tcGFyZSB0aGUgbGFiZWxzIHRvIHRoZSBzdHJpbmcgYW5kIHJldHVybiBhIG1hdGNoaW5nIHJlc3VsdC5cbiAgICogLy8gVGhlIGNhcGl0YWxpemF0aW9uIG9mIHRoZSBjaGFyYWN0ZXJzIGRvZXMgbm90IG1hdHRlciAoY2FzZSBpbnNlbnNpdGl2ZSkuXG4gICAqIGNvbnN0IHByZWRpY2F0ZSA9ICdncm91cDEnO1xuICAgKiBjb25zdCBjaGlsZE5vZGUgPSBwYXJlbnROb2RlLmZpbmQocHJlZGljYXRlKTtcbiAgICpcbiAgICogLy8gQ2hlY2s6IFtsb2Rhc2ggbWF0Y2hlc10oaHR0cHM6Ly9sb2Rhc2guY29tL2RvY3MvNC4xNy4xNSNtYXRjaGVzKVxuICAgKiBjb25zdCBwcmVkaWNhdGUgPSB7IGxhYmVsOiAnZ3JvdXAyJyB9O1xuICAgKiBjb25zdCBjaGlsZE5vZGUgPSBwYXJlbnROb2RlLmZpbmQocHJlZGljYXRlKTtcbiAgICogYGBgXG4gICAqL1xuICBmaW5kKHByZWRpY2F0ZSkge1xuICAgIGlmICh0eXBlb2YgcHJlZGljYXRlID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3QgY29tcGFyZUxhYmVsID0gcHJlZGljYXRlLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG4gICAgICBwcmVkaWNhdGUgPSAoeyBsYWJlbCB9KSA9PiBjb21wYXJlTGFiZWwgPT09IGxhYmVsLnRvTG93ZXJDYXNlKCk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgcHJlZGljYXRlID09PSAnb2JqZWN0Jykge1xuICAgICAgcHJlZGljYXRlID0gbWF0Y2hlcyhwcmVkaWNhdGUpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHByZWRpY2F0ZSAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNlYXJjaCBwcmVkaWNhdGUnKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY2hpbGRyZW4ucmVkdWNlKFxuICAgICAgKGZvdW5kLCBjaGlsZCkgPT4gZm91bmQgfHwgY2hpbGQuZmluZChwcmVkaWNhdGUpLFxuICAgICAgdGhpcy5jaGlsZHJlbi5maW5kKHByZWRpY2F0ZSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgY2hpbGRyZW4gbm9kZXMuXG4gICAqL1xuICBlbXB0eSgpIHtcbiAgICB0aGlzLmNoaWxkcmVuLmxlbmd0aCA9IDA7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgY2xpY2sob3B0aW9uczogQ2xpY2tPcHRpb25zID0ge30pIHtcbiAgICAvLyBkbyBub3RoaW5nXG4gIH1cblxuICAvKipcbiAgICogVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIGFuIGVsZW1lbnQgaXMgZHJvcHBlZCBvbiBhIHZhbGlkIGRyb3AgdGFyZ2V0LlxuICAgKiBAcGFyYW0gJGV2ZW50IERPTSBldmVudC5cbiAgICovXG4gIGRyb3AoJGV2ZW50KSB7XG4gICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cGFuZERyYWdUaW1lb3V0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gdGhlIHVzZXIgc3RhcnRzIGRyYWdnaW5nIGFuIGVsZW1lbnQuXG4gICAqIEBwYXJhbSAkZXZlbnQgRE9NIGV2ZW50LlxuICAgKi9cbiAgZHJhZ1N0YXJ0KCRldmVudCkge1xuICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAvLyB3ZSBjYW4ndCBwYXNzIGEgb2JqZWN0IHRvIHNldERhdGEsIHNvIHdlIGRvIGl0IHZpYSBzZXJ2aWNlXG4gICAgLy8gc2V0IGRhdGEgaXMgc3RpbGwgbmVlZGVkLCB0byBtYWtlIHRoZSBkcmFnJmRyb3Agd29ya1xuICAgICRldmVudC5kYXRhVHJhbnNmZXIuc2V0RGF0YSgnbm9kZScsICdub2RlJyk7XG4gICAgdGhpcy5kcmFnZ2VkID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gYSBkcmFnIG9wZXJhdGlvbiBoYXMgZW5kZWQuXG4gICAqIEBwYXJhbSAkZXZlbnQgRE9NIGV2ZW50LlxuICAgKi9cbiAgZHJhZ0VuZCgkZXZlbnQpIHtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgdGhpcy5kcmFnZ2VkID0gZmFsc2U7XG4gICAgJGV2ZW50LmRhdGFUcmFuc2Zlci5jbGVhckRhdGEoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGluZm9ybWF0aW9uIHdoZXRoZXIgdGhlIG5hdmlnYXRvciBub2RlIGlzIGRyb3BwYWJsZS5cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgY2FuRHJvcCgpIHtcbiAgICByZXR1cm4gdGhpcy5kcm9wcGFibGU7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBpbmZvcm1hdGlvbiB3aGV0aGVyIG5hdmlnYXRpb24gaXMgcG9zc2libGUuXG4gICAqIEByZWFkb25seVxuICAgKi9cbiAgZ2V0IGNhbk5hdmlnYXRlKCkge1xuICAgIHJldHVybiB0eXBlb2YgdGhpcy5wYXRoICE9PSAndW5kZWZpbmVkJztcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gYSBkcmFnZ2VkIGVsZW1lbnQgZW50ZXJzIGEgdmFsaWQgZHJvcCB0YXJnZXQuXG4gICAqIEBwYXJhbSAkZXZlbnQgRE9NIGV2ZW50LlxuICAgKi9cbiAgZHJhZ0VudGVyKCRldmVudCkge1xuICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmRyYWdnZWRIb3ZlciA9IHRydWU7XG4gICAgaWYgKCF0aGlzLm9wZW4pIHtcbiAgICAgIHRoaXMuZXhwYW5kRHJhZ1RpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZXhwYW5kKCksIDEwMDApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gYSBkcmFnZ2VkIGVsZW1lbnQgbGVhdmVzIGEgdmFsaWQgZHJvcCB0YXJnZXQuXG4gICAqIEBwYXJhbSAkZXZlbnQgRE9NIGV2ZW50LlxuICAgKi9cbiAgZHJhZ0xlYXZlKCRldmVudCkge1xuICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmRyYWdnZWRIb3ZlciA9IGZhbHNlO1xuICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cGFuZERyYWdUaW1lb3V0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeHBhbmRzIHRoZSBuYXZpZ2F0b3Igbm9kZSBpZiBpdCBpcyBjb2xsYXBzZWQuXG4gICAqL1xuICBleHBhbmQoKSB7XG4gICAgaWYgKCF0aGlzLm9wZW4pIHtcbiAgICAgIHRoaXMub3BlbiA9IHRydWU7XG4gICAgICB0aGlzLmNsaWNrKHsgb3BlbjogdHJ1ZSwgZXhwYW5kZXI6IHRydWUgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIGEgY2FsbGJhY2sgZnVuY3Rpb24gcmVjdXJzaXZlbHkgb24gZWFjaCBvZiB0aGUgbmF2aWdhdG9yIG5vZGUncyBjaGlsZHJlbiBkb3duIHRoZSBoaWVyYXJjaHkuXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIEZ1bmN0aW9uIHRvIGJlIGNhbGxlZC5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogYGBgdHNcbiAgICogY29uc3QgZXhwYW5kQ2hpbGQgPSAoY2hpbGROb2RlKSA9PiBjaGlsZE5vZGUuZXhwYW5kKCk7XG4gICAqIHBhcmVudE5vZGUudHJhdmVyc2UoZXhwYW5kQ2hpbGQpO1xuICAgKiBgYGBcbiAgICovXG4gIHRyYXZlcnNlKGNhbGxiYWNrKSB7XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4pIHtcbiAgICAgIHRoaXMuY2hpbGRyZW4uZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgICAgIGNhbGxiYWNrKGNoaWxkKTtcbiAgICAgICAgY2hpbGQudHJhdmVyc2UoY2FsbGJhY2spO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGRlc3Ryb3koKSB7XG4gICAgLy8gbm90aGluZyB0b2RvIGhlcmVcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSBuYXZpZ2F0b3Igbm9kZSBieSBzb3J0aW5nIGl0cyBjaGlsZHJlbiBhbmQgYWxzbyBjaGVja2luZyB0aGVpciB2aXNpYmlsaXR5LlxuICAgKi9cbiAgcHJvdGVjdGVkIHVwZGF0ZUNoaWxkcmVuKCkge1xuICAgIHRoaXMuc29ydCgpO1xuICAgIHRoaXMudXBkYXRlSGlkZGVuKCk7XG4gIH1cblxuICAvKipcbiAgICogU29ydHMgdGhlIGNoaWxkcmVuIG9mIHRoZSBuYXZpZ2F0b3Igbm9kZSwgYnkgcHJpb3JpdHkgYW5kIG5hbWUgKEFTQykuXG4gICAqIFRoZSBoaWdoZXIgdGhlIHByaW9yaXR5LCB0aGUgaGlnaGVyIHRoZSBwb3NpdGlvbiBpbiB0aGUgaGllcmFyY2h5LlxuICAgKiBGb3IgdGhlIHNhbWUgcHJpb3JpdHkgdmFsdWVzLCB0aGUgYWxwaGFiZXRpY2FsIG9yZGVyIHdpbGwgdGFrZSBwcmVjZWRlbmNlLlxuICAgKi9cbiAgcHJvdGVjdGVkIHNvcnQoKSB7XG4gICAgdGhpcy5jaGlsZHJlbi5zb3J0KChhLCBiKSA9PiB7XG4gICAgICBpZiAoYS5wcmlvcml0eSA+IGIucHJpb3JpdHkpIHtcbiAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgfSBlbHNlIGlmIChhLnByaW9yaXR5IDwgYi5wcmlvcml0eSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICAgIH0gZWxzZSBpZiAoKGEubGFiZWwgfHwgJycpLnRvTG93ZXJDYXNlKCkgPCAoYi5sYWJlbCB8fCAnJykudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgICB9IGVsc2UgaWYgKChhLmxhYmVsIHx8ICcnKS50b0xvd2VyQ2FzZSgpID4gKGIubGFiZWwgfHwgJycpLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gMDtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgdGhlIG5hdmlnYXRvciBub2RlIHNob3VsZCBiZSBoaWRkZW4gYmFzZWQgb24gdGhlIHZpc2liaWxpdHkgb2YgaXRzIGNoaWxkIG5vZGVzLlxuICAgKi9cbiAgcHJvdGVjdGVkIHVwZGF0ZUhpZGRlbigpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMucGF0aCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuaGlkZGVuID0gIXRoaXMuY2hpbGRyZW4uc29tZSgoeyBoaWRkZW4gfSkgPT4gIWhpZGRlbik7XG4gICAgfVxuICB9XG59XG4iXX0=