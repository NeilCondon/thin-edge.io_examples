import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector, Optional } from '@angular/core';
import { flatten } from 'lodash-es';
import { forkJoin, from, isObservable, of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { NavigatorNode } from '../navigator';
import { HOOK_DYNAMIC_PROVIDER_CONFIG } from './provider-configuration-hook';
let ProviderConfigurationNodeFactory = class ProviderConfigurationNodeFactory {
    constructor(config, injector) {
        this.injector = injector;
        this.config = flatten(config);
    }
    get() {
        if (!this.config || !this.config.length) {
            return;
        }
        if (!this.nodes) {
            const canActivate = this.config
                .map(c => c.navigation.canActivate && c.navigation.canActivate.length
                ? this.getGuards(c)
                : undefined)
                .map(this.checkCanActivate.bind(this));
            return forkJoin(canActivate).pipe(map((canActivateResult) => this.config
                .map((c, index) => canActivateResult[index] ? new NavigatorNode(c.navigation) : undefined)
                .filter(el => !!el)), tap(nodes => (this.nodes = nodes)));
        }
        return this.nodes;
    }
    checkCanActivate(ca) {
        if (!!ca && ca.length) {
            const canActivateResult = ca
                .map((canActivate) => canActivate.canActivate(undefined, undefined))
                .map(this.wrapIntoObservable.bind(this));
            return forkJoin(canActivateResult).pipe(map((caResult) => caResult.reduce((acc, curr) => acc && curr)));
        }
        return of(true);
    }
    isPromise(obj) {
        return !!obj && typeof obj.then === 'function';
    }
    wrapIntoObservable(value) {
        if (isObservable(value)) {
            return value;
        }
        if (this.isPromise(value)) {
            return from(value);
        }
        return of(value);
    }
    getGuards(c) {
        return c.tab && c.tab.canActivate && c.tab.canActivate.length
            ? [
                ...c.navigation.canActivate.map(ca => this.injector.get(ca)),
                ...c.tab.canActivate.map(ca => this.injector.get(ca))
            ]
            : c.navigation.canActivate.map(ca => this.injector.get(ca));
    }
    getNodeTabPath(nodePath, tabPath) {
        return `${nodePath.replace(/^\/|\/$/g, '')}/${tabPath.replace(/^\/|\/$/g, '')}`;
    }
};
ProviderConfigurationNodeFactory.ctorParameters = () => [
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_DYNAMIC_PROVIDER_CONFIG,] }] },
    { type: Injector }
];
ProviderConfigurationNodeFactory = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(0, Optional()),
    tslib_1.__param(0, Inject(HOOK_DYNAMIC_PROVIDER_CONFIG))
], ProviderConfigurationNodeFactory);
export { ProviderConfigurationNodeFactory };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXItY29uZmlndXJhdGlvbi1ub2RlLmZhY3RvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9wcm92aWRlci1jb25maWd1cmF0aW9uL3Byb3ZpZGVyLWNvbmZpZ3VyYXRpb24tbm9kZS5mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXZFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDcEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRSxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQXdCLE1BQU0sY0FBYyxDQUFDO0FBRW5FLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRzdFLElBQWEsZ0NBQWdDLEdBQTdDLE1BQWEsZ0NBQWdDO0lBSTNDLFlBR0UsTUFBaUMsRUFDekIsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUUxQixJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRUQsR0FBRztRQUNELElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7WUFDdkMsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZixNQUFNLFdBQVcsR0FBK0IsSUFBSSxDQUFDLE1BQU07aUJBQ3hELEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUNQLENBQUMsQ0FBQyxVQUFV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QUFDO2FBQ3REO1lBQ0gsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVPLGNBQWMsQ0FBQyxRQUFRLEVBQUUsT0FBTztRQUN0QyxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztJQUNsRixDQUFDO0NBQ0YsQ0FBQTs7d0NBOUVJLFFBQVEsWUFDUixNQUFNLFNBQUMsNEJBQTRCO1lBRWxCLFFBQVE7O0FBUmpCLGdDQUFnQztJQUQ1QyxVQUFVLEVBQUU7SUFNUixtQkFBQSxRQUFRLEVBQUUsQ0FBQTtJQUNWLG1CQUFBLE1BQU0sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFBO0dBTjVCLGdDQUFnQyxDQW1GNUM7U0FuRlksZ0NBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENhbkFjdGl2YXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGZsYXR0ZW4gfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgZm9ya0pvaW4sIGZyb20sIGlzT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTmF2aWdhdG9yTm9kZSwgTmF2aWdhdG9yTm9kZUZhY3RvcnkgfSBmcm9tICcuLi9uYXZpZ2F0b3InO1xuaW1wb3J0IHsgRHluYW1pY1Byb3ZpZGVyQ29uZmlnIH0gZnJvbSAnLi9tb2RlbC9keW5hbWljLXByb3ZpZGVyLWNvbmZpZy5tb2RlbCc7XG5pbXBvcnQgeyBIT09LX0RZTkFNSUNfUFJPVklERVJfQ09ORklHIH0gZnJvbSAnLi9wcm92aWRlci1jb25maWd1cmF0aW9uLWhvb2snO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUHJvdmlkZXJDb25maWd1cmF0aW9uTm9kZUZhY3RvcnkgaW1wbGVtZW50cyBOYXZpZ2F0b3JOb2RlRmFjdG9yeSB7XG4gIHByaXZhdGUgY29uZmlnOiBEeW5hbWljUHJvdmlkZXJDb25maWdbXTtcbiAgcHJpdmF0ZSBub2RlczogTmF2aWdhdG9yTm9kZVtdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdChIT09LX0RZTkFNSUNfUFJPVklERVJfQ09ORklHKVxuICAgIGNvbmZpZzogRHluYW1pY1Byb3ZpZGVyQ29uZmlnW11bXSxcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxuICApIHtcbiAgICB0aGlzLmNvbmZpZyA9IGZsYXR0ZW4oY29uZmlnKTtcbiAgfVxuXG4gIGdldCgpIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnIHx8ICF0aGlzLmNvbmZpZy5sZW5ndGgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMubm9kZXMpIHtcbiAgICAgIGNvbnN0IGNhbkFjdGl2YXRlOiBBcnJheTxPYnNlcnZhYmxlPGJvb2xlYW4+PiA9IHRoaXMuY29uZmlnXG4gICAgICAgIC5tYXAoYyA9PlxuICAgICAgICAgIGMubmF2aWdhdGlvbi5jYW5BY3RpdmF0ZSAmJiBjLm5hdmlnYXRpb24uY2FuQWN0aXZhdGUubGVuZ3RoXG4gICAgICAgICAgICA/IHRoaXMuZ2V0R3VhcmRzKGMpXG4gICAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgICApXG4gICAgICAgIC5tYXAodGhpcy5jaGVja0NhbkFjdGl2YXRlLmJpbmQodGhpcykpO1xuXG4gICAgICByZXR1cm4gZm9ya0pvaW4oY2FuQWN0aXZhdGUpLnBpcGUoXG4gICAgICAgIG1hcCgoY2FuQWN0aXZhdGVSZXN1bHQ6IGJvb2xlYW5bXSkgPT5cbiAgICAgICAgICB0aGlzLmNvbmZpZ1xuICAgICAgICAgICAgLm1hcCgoYywgaW5kZXgpID0+XG4gICAgICAgICAgICAgIGNhbkFjdGl2YXRlUmVzdWx0W2luZGV4XSA/IG5ldyBOYXZpZ2F0b3JOb2RlKGMubmF2aWdhdGlvbikgOiB1bmRlZmluZWRcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5maWx0ZXIoZWwgPT4gISFlbClcbiAgICAgICAgKSxcbiAgICAgICAgdGFwKG5vZGVzID0+ICh0aGlzLm5vZGVzID0gbm9kZXMpKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5ub2RlcztcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tDYW5BY3RpdmF0ZShjYTogQ2FuQWN0aXZhdGVbXSk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIGlmICghIWNhICYmIGNhLmxlbmd0aCkge1xuICAgICAgY29uc3QgY2FuQWN0aXZhdGVSZXN1bHQ6IEFycmF5PE9ic2VydmFibGU8Ym9vbGVhbj4+ID0gY2FcbiAgICAgICAgLm1hcCgoY2FuQWN0aXZhdGU6IENhbkFjdGl2YXRlKSA9PiBjYW5BY3RpdmF0ZS5jYW5BY3RpdmF0ZSh1bmRlZmluZWQsIHVuZGVmaW5lZCkpXG4gICAgICAgIC5tYXAodGhpcy53cmFwSW50b09ic2VydmFibGUuYmluZCh0aGlzKSk7XG5cbiAgICAgIHJldHVybiBmb3JrSm9pbihjYW5BY3RpdmF0ZVJlc3VsdCkucGlwZShcbiAgICAgICAgbWFwKChjYVJlc3VsdDogYm9vbGVhbltdKSA9PiBjYVJlc3VsdC5yZWR1Y2UoKGFjYywgY3VycikgPT4gYWNjICYmIGN1cnIpKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG9mKHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1Byb21pc2U8VCA9IGFueT4ob2JqOiBhbnkpOiBvYmogaXMgUHJvbWlzZTxUPiB7XG4gICAgcmV0dXJuICEhb2JqICYmIHR5cGVvZiBvYmoudGhlbiA9PT0gJ2Z1bmN0aW9uJztcbiAgfVxuXG4gIHByaXZhdGUgd3JhcEludG9PYnNlcnZhYmxlPFQ+KHZhbHVlOiBUIHwgUHJvbWlzZTxUPiB8IE9ic2VydmFibGU8VD4pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBpZiAoaXNPYnNlcnZhYmxlKHZhbHVlKSkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzUHJvbWlzZSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiBmcm9tKHZhbHVlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gb2YodmFsdWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRHdWFyZHMoYykge1xuICAgIHJldHVybiBjLnRhYiAmJiBjLnRhYi5jYW5BY3RpdmF0ZSAmJiBjLnRhYi5jYW5BY3RpdmF0ZS5sZW5ndGhcbiAgICAgID8gW1xuICAgICAgICAgIC4uLmMubmF2aWdhdGlvbi5jYW5BY3RpdmF0ZS5tYXAoY2EgPT4gdGhpcy5pbmplY3Rvci5nZXQoY2EpKSxcbiAgICAgICAgICAuLi5jLnRhYi5jYW5BY3RpdmF0ZS5tYXAoY2EgPT4gdGhpcy5pbmplY3Rvci5nZXQoY2EpKVxuICAgICAgICBdXG4gICAgICA6IGMubmF2aWdhdGlvbi5jYW5BY3RpdmF0ZS5tYXAoY2EgPT4gdGhpcy5pbmplY3Rvci5nZXQoY2EpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Tm9kZVRhYlBhdGgobm9kZVBhdGgsIHRhYlBhdGgpIHtcbiAgICByZXR1cm4gYCR7bm9kZVBhdGgucmVwbGFjZSgvXlxcL3xcXC8kL2csICcnKX0vJHt0YWJQYXRoLnJlcGxhY2UoL15cXC98XFwvJC9nLCAnJyl9YDtcbiAgfVxufVxuIl19