import * as tslib_1 from "tslib";
import { Component, ContentChildren, EventEmitter, Output, ViewChild } from '@angular/core';
import { AlertService, C8yStepper, gettext, ModalService, Status } from '@c8y/ngx-components';
import { get } from 'lodash-es';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { OperationDetailsComponent } from '@c8y/ngx-components/operations/details';
import { CustomStep } from './custom-step.directive';
import { OperationDetails, BulkOperationType, BulkOperationsService } from '@c8y/ngx-components/operations/bulk-operations-service';
let BulkOperationStepper = class BulkOperationStepper {
    constructor(bulkOperationService, modal, alert) {
        this.bulkOperationService = bulkOperationService;
        this.modal = modal;
        this.alert = alert;
        this.selectionChange = new EventEmitter();
        this.steps = [];
        this.showStepper = false;
        this.showButtons = false;
        this.stepperButtonsLabels = { custom: gettext('Schedule bulk operation') };
        this.deviceTypesSubject$ = new Subject();
        this.endSubscriptions = new Subject();
        this.deviceTypes$ = this.deviceTypesSubject$.asObservable();
    }
    ngAfterViewInit() {
        setTimeout(() => {
            // wait for the next event loop turn as `steps` has already been checked in this CD cycle
            this.steps = this.customSteps.toArray();
            this.showStepper = true;
            setTimeout(() => {
                // postpone rendering of buttons for custom steps to the point where custom steps have already been rendered
                this.showButtons = true;
                if (this.stepper) {
                    this.stepper.selectionChange.pipe(takeUntil(this.endSubscriptions)).subscribe(event => {
                        this.selectionChange.next(event);
                    });
                    this.operationDetailsForm = this.operationDetailsComponent.fgOperationDescription;
                }
            });
        });
    }
    changeDeviceTypes(deviceTypes) {
        if (deviceTypes) {
            this.deviceTypesSubject$.next(Array.isArray(deviceTypes) ? deviceTypes : [deviceTypes]);
        }
        else {
            this.deviceTypesSubject$.next([]);
        }
    }
    confirmDeviceSelection($event) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (!this.deviceQueryString) {
                try {
                    yield this.modal.confirm(gettext('All devices selected'), gettext('You are about to schedule the bulk operation to be executed for all devices. Do you want to proceed?'), Status.WARNING, { ok: gettext('Schedule for all devices'), cancel: gettext('Cancel and select devices') });
                    $event.step.completed = true;
                    $event.stepper.next();
                    this.operationDetails = this.retrieveOperationDetails
                        ? yield this.retrieveOperationDetails()
                        : undefined;
                }
                catch (ex) {
                    // Intentionally empty
                }
            }
            else {
                $event.step.completed = true;
                $event.stepper.next();
                this.operationDetails = this.retrieveOperationDetails
                    ? yield this.retrieveOperationDetails()
                    : undefined;
            }
            this.bulkOperationType = this.bulkOperationService.retrieveBulkOperationType(get(this.operationDetails, 'prototype'));
            if (this.operationDetailsForm &&
                get(this.operationDetailsForm, 'controls.description.pristine') &&
                this.operationDetails) {
                this.operationDetailsForm.patchValue({
                    description: get(this.operationDetails, 'prototype.description')
                });
            }
        });
    }
    cancel() {
        this.close();
    }
    scheduleBulkOperation() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.pendingStatus = true;
            try {
                this.operationDetails.prototype.description = get(this.operationDetailsForm, 'controls.description.value');
                this.operationDetails.note = get(this.operationDetailsForm, 'controls.note.value');
                this.operationDetails.schedule = get(this.operationDetailsForm, 'controls.schedule.value');
                yield this.bulkOperationService.scheduleBulkOperation(this.deviceQueryString, this.operationDetails);
                this.alert.success(gettext('New bulk operation scheduled.'));
                this.close();
            }
            catch (ex) {
                this.alert.addServerFailure(ex);
            }
            this.pendingStatus = false;
        });
    }
    ngOnDestroy() {
        this.endSubscriptions.next();
        this.endSubscriptions.complete();
    }
    close() {
        this.stepper.reset();
        this.bulkOperationService.returnToBulkOperationOverview();
    }
};
BulkOperationStepper.ctorParameters = () => [
    { type: BulkOperationsService },
    { type: ModalService },
    { type: AlertService }
];
tslib_1.__decorate([
    Output()
], BulkOperationStepper.prototype, "selectionChange", void 0);
tslib_1.__decorate([
    ContentChildren(CustomStep)
], BulkOperationStepper.prototype, "customSteps", void 0);
tslib_1.__decorate([
    ViewChild(C8yStepper, { static: false })
], BulkOperationStepper.prototype, "stepper", void 0);
tslib_1.__decorate([
    ViewChild(OperationDetailsComponent, { static: false })
], BulkOperationStepper.prototype, "operationDetailsComponent", void 0);
BulkOperationStepper = tslib_1.__decorate([
    Component({
        selector: 'c8y-bulk-operation-stepper',
        template: "<div class=\"fit-h\">\n  <c8y-stepper\n    class=\"flex-col no-align-items fit-h c8y-stepper--no-btns\"\n    linear\n    [disableDefaultIcons]=\"{ edit: true, done: false }\"\n    [customClasses]=\"['col-md-6', 'col-md-offset-3', 'p-t-16', 'p-b-32', 'flex-no-shrink']\"\n    *ngIf=\"showStepper\"\n  >\n    <!-- CUSTOM STEPS 1 to N-2 -->\n    <cdk-step\n      *ngFor=\"let step of steps\"\n      [label]=\"step.label | translate\"\n      [completed]=\"step.completed\"\n    >\n      <ng-container *ngTemplateOutlet=\"step.templateRef\"></ng-container>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        *ngIf=\"showButtons\"\n        [disabled]=\"step.buttonsDisabled\"\n        (onNext)=\"step.onNext($event)\"\n        (onCancel)=\"cancel()\"\n      ></c8y-stepper-buttons>\n    </cdk-step>\n    <!-- STEP N-1 - Data-grid -->\n    <cdk-step [label]=\"'Select target devices' | translate\">\n      <div class=\"card-block p-t-0 flex-no-shrink separator-bottom col-xs-12\">\n        <div class=\"row p-b-16\">\n          <div class=\"col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4\">\n            <h4 class=\"text-center m-b-16\">\n              {{ 'Select target devices' | translate }}\n            </h4>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"col-xs-12 flex-grow no-gutter\">\n        <c8y-device-selector\n          [deviceTypes]=\"deviceTypes$\"\n          (onDeviceQueryStringChange)=\"deviceQueryString = $event\"\n        ></c8y-device-selector>\n      </div>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        (onNext)=\"confirmDeviceSelection($event)\"\n        (onCancel)=\"cancel()\"\n      ></c8y-stepper-buttons>\n    </cdk-step>\n\n    <!-- STEP N - Scheduler -->\n    <cdk-step [label]=\"'Confirm and schedule bulk operation' | translate\">\n      <div class=\"card-block p-t-0 flex-no-shrink separator-bottom col-xs-12\">\n        <div class=\"row p-b-16\">\n          <div class=\"col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4\">\n            <h4 class=\"text-center m-b-16\">\n              {{ 'Confirm and schedule bulk operation' | translate }}\n            </h4>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"col-xs-12 flex-grow no-gutter\">\n        <div class=\"card-inner-scroll fit-h\">\n          <div class=\"card-block p-b-0\">\n            <div class=\"text-center p-b-16\">\n              <c8y-operation-summary\n                [name]=\"operationDetails?.name | translate\"\n                [description]=\"operationDetails?.description | translate\"\n                [deviceQueryString]=\"deviceQueryString\"\n              ></c8y-operation-summary>\n            </div>\n            <div class=\"row\">\n              <div class=\"col-md-4 col-md-offset-4\">\n                <c8y-operation-details\n                  [bulkOperationType]=\"bulkOperationType\"\n                ></c8y-operation-details>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        [labels]=\"stepperButtonsLabels\"\n        [pending]=\"pendingStatus\"\n        [disabled]=\"operationDetailsForm?.invalid\"\n        (onCancel)=\"cancel()\"\n        (onCustom)=\"scheduleBulkOperation()\"\n      >\n      </c8y-stepper-buttons>\n    </cdk-step>\n  </c8y-stepper>\n</div>\n"
    })
], BulkOperationStepper);
export { BulkOperationStepper };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb24tc3RlcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb24tc3RlcHBlci8iLCJzb3VyY2VzIjpbImJ1bGstb3BlcmF0aW9uLXN0ZXBwZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQ0wsU0FBUyxFQUNULGVBQWUsRUFDZixZQUFZLEVBRVosTUFBTSxFQUVOLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlGLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDaEMsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFFbkYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3JELE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLHFCQUFxQixFQUN0QixNQUFNLHdEQUF3RCxDQUFDO0FBTWhFLElBQWEsb0JBQW9CLEdBQWpDLE1BQWEsb0JBQW9CO0lBd0IvQixZQUNVLG9CQUEyQyxFQUMzQyxLQUFtQixFQUNuQixLQUFtQjtRQUZuQix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXVCO1FBQzNDLFVBQUssR0FBTCxLQUFLLENBQWM7UUFDbkIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQTFCbkIsb0JBQWUsR0FBd0MsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU9wRixVQUFLLEdBQWlCLEVBQUUsQ0FBQztRQUN6QixnQkFBVyxHQUFZ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TyxDQUFDLCtCQUErQixDQUFDLENBQUMsQ0FBQztnQkFDN0QsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQ2Q7WUFBQyxPQUFPLEVBQUUsRUFBRTtnQkFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ2pDO1lBRUQsSUFBSSxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7UUFDN0IsQ0FBQztLQUFBO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM3QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVPLEtBQUs7UUFDWCxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyw2QkFBNkIsRUFBRSxDQUFDO0lBQzVELENBQUM7Q0FDRixDQUFBOztZQS9HaUMscUJBQXFCO1lBQ3BDLFlBQVk7WUFDWixZQUFZOztBQTFCbkI7SUFBVCxNQUFNLEVBQUU7NkRBQTJFO0FBQ3ZEO0lBQTVCLGVBQWUsQ0FBQyxVQUFVLENBQUM7eURBQW9DO0FBRWhFO0lBREMsU0FBUyxDQUFDLFVBQVUsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQztxREFDckI7QUFFcEI7SUFEQyxTQUFTLENBQUMseUJBQXlCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7dUVBQ0g7QUFOMUMsb0JBQW9CO0lBSmhDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSw0QkFBNEI7UUFDdEMsbzRHQUFvRDtLQUNyRCxDQUFDO0dBQ1csb0JBQW9CLENBd0loQztTQXhJWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZGtTdGVwLCBTdGVwcGVyU2VsZWN0aW9uRXZlbnQgfSBmcm9tICdAYW5ndWxhci9jZGsvc3RlcHBlcic7XG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgRXZlbnRFbWl0dGVyLFxuICBPbkRlc3Ryb3ksXG4gIE91dHB1dCxcbiAgUXVlcnlMaXN0LFxuICBWaWV3Q2hpbGRcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtR3JvdXAgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIEM4eVN0ZXBwZXIsIGdldHRleHQsIE1vZGFsU2VydmljZSwgU3RhdHVzIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBnZXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgT3BlcmF0aW9uRGV0YWlsc0NvbXBvbmVudCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvb3BlcmF0aW9ucy9kZXRhaWxzJztcbmltcG9ydCB7IE9wZXJhdGlvblNjaGVkdWxlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9uLXNjaGVkdWxlcic7XG5pbXBvcnQgeyBDdXN0b21TdGVwIH0gZnJvbSAnLi9jdXN0b20tc3RlcC5kaXJlY3RpdmUnO1xuaW1wb3J0IHtcbiAgT3BlcmF0aW9uRGV0YWlscyxcbiAgQnVsa09wZXJhdGlvblR5cGUsXG4gIEJ1bGtPcGVyYXRpb25zU2VydmljZVxufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb25zLXNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktYnVsay1vcGVyYXRpb24tc3RlcHBlcicsXG4gIHRlbXBsYXRlVXJsOiAnYnVsay1vcGVyYXRpb24tc3RlcHBlci5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgQnVsa09wZXJhdGlvblN0ZXBwZXIgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBAT3V0cHV0KCkgc2VsZWN0aW9uQ2hhbmdlOiBFdmVudEVtaXR0ZXI8U3RlcHBlclNlbGVjdGlvbkV2ZW50PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQENvbnRlbnRDaGlsZHJlbihDdXN0b21TdGVwKSBjdXN0b21TdGVwczogUXVlcnlMaXN0PEN1c3RvbVN0ZXA+O1xuICBAVmlld0NoaWxkKEM4eVN0ZXBwZXIsIHsgc3RhdGljOiBmYWxzZSB9KVxuICBzdGVwcGVyOiBDOHlTdGVwcGVyO1xuICBAVmlld0NoaWxkKE9wZXJhdGlvbkRldGFpbHNDb21wb25lbnQsIHsgc3RhdGljOiBmYWxzZSB9KVxuICBvcGVyYXRpb25EZXRhaWxzQ29tcG9uZW50OiBPcGVyYXRpb25EZXRhaWxzQ29tcG9uZW50O1xuXG4gIHN0ZXBzOiBDdXN0b21TdGVwW10gPSBbXTtcbiAgc2hvd1N0ZXBwZXI6IGJvb2xlYW4gPSBmYWxzZTtcbiAgc2hvd0J1dHRvbnM6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcGVuZGluZ1N0YXR1czogYm9vbGVhbjtcbiAgc3RlcHBlckJ1dHRvbnNMYWJlbHMgPSB7IGN1c3RvbTogZ2V0dGV4dCgnU2NoZWR1bGUgYnVsayBvcGVyYXRpb24nKSB9O1xuICBkZXZpY2VUeXBlcyQ6IE9ic2VydmFibGU8c3RyaW5nW10+O1xuICBkZXZpY2VRdWVyeVN0cmluZzogc3RyaW5nO1xuICBidWxrT3BlcmF0aW9uVHlwZTogQnVsa09wZXJhdGlvblR5cGU7XG4gIHNjaGVkdWxlRGF0YTogT3BlcmF0aW9uU2NoZWR1bGU7XG4gIG9wZXJhdGlvbkRldGFpbHNGb3JtOiBGb3JtR3JvdXA7XG4gIG9wZXJhdGlvbkRldGFpbHM6IE9wZXJhdGlvbkRldGFpbHM7XG4gIHJldHJpZXZlT3BlcmF0aW9uRGV0YWlsczogKCkgPT4gT3BlcmF0aW9uRGV0YWlscyB8IFByb21pc2U8T3BlcmF0aW9uRGV0YWlscz47XG5cbiAgcHJpdmF0ZSBkZXZpY2VUeXBlc1N1YmplY3QkOiBTdWJqZWN0PHN0cmluZ1tdPiA9IG5ldyBTdWJqZWN0KCk7XG4gIHByaXZhdGUgZW5kU3Vic2NyaXB0aW9uczogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBidWxrT3BlcmF0aW9uU2VydmljZTogQnVsa09wZXJhdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgbW9kYWw6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5kZXZpY2VUeXBlcyQgPSB0aGlzLmRldmljZVR5cGVzU3ViamVjdCQuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAvLyB3YWl0IGZvciB0aGUgbmV4dCBldmVudCBsb29wIHR1cm4gYXMgYHN0ZXBzYCBoYXMgYWxyZWFkeSBiZWVuIGNoZWNrZWQgaW4gdGhpcyBDRCBjeWNsZVxuICAgICAgdGhpcy5zdGVwcyA9IHRoaXMuY3VzdG9tU3RlcHMudG9BcnJheSgpO1xuICAgICAgdGhpcy5zaG93U3RlcHBlciA9IHRydWU7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgLy8gcG9zdHBvbmUgcmVuZGVyaW5nIG9mIGJ1dHRvbnMgZm9yIGN1c3RvbSBzdGVwcyB0byB0aGUgcG9pbnQgd2hlcmUgY3VzdG9tIHN0ZXBzIGhhdmUgYWxyZWFkeSBiZWVuIHJlbmRlcmVkXG4gICAgICAgIHRoaXMuc2hvd0J1dHRvbnMgPSB0cnVlO1xuICAgICAgICBpZiAodGhpcy5zdGVwcGVyKSB7XG4gICAgICAgICAgdGhpcy5zdGVwcGVyLnNlbGVjdGlvbkNoYW5nZS5waXBlKHRha2VVbnRpbCh0aGlzLmVuZFN1YnNjcmlwdGlvbnMpKS5zdWJzY3JpYmUoZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb25DaGFuZ2UubmV4dChldmVudCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzRm9ybSA9IHRoaXMub3BlcmF0aW9uRGV0YWlsc0NvbXBvbmVudC5mZ09wZXJhdGlvbkRlc2NyaXB0aW9uO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGNoYW5nZURldmljZVR5cGVzKGRldmljZVR5cGVzOiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgIGlmIChkZXZpY2VUeXBlcykge1xuICAgICAgdGhpcy5kZXZpY2VUeXBlc1N1YmplY3QkLm5leHQoQXJyYXkuaXNBcnJheShkZXZpY2VUeXBlcykgPyBkZXZpY2VUeXBlcyA6IFtkZXZpY2VUeXBlc10pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRldmljZVR5cGVzU3ViamVjdCQubmV4dChbXSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY29uZmlybURldmljZVNlbGVjdGlvbigkZXZlbnQ6IHsgc3RlcHBlcjogQzh5U3RlcHBlcjsgc3RlcDogQ2RrU3RlcCB9KSB7XG4gICAgaWYgKCF0aGlzLmRldmljZVF1ZXJ5U3RyaW5nKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLm1vZGFsLmNvbmZpcm0oXG4gICAgICAgICAgZ2V0dGV4dCgnQWxsIGRldmljZXMgc2VsZWN0ZWQnKSxcbiAgICAgICAgICBnZXR0ZXh0KFxuICAgICAgICAgICAgJ1lvdSBhcmUgYWJvdXQgdG8gc2NoZWR1bGUgdGhlIGJ1bGsgb3BlcmF0aW9uIHRvIGJlIGV4ZWN1dGVkIGZvciBhbGwgZGV2aWNlcy4gRG8geW91IHdhbnQgdG8gcHJvY2VlZD8nXG4gICAgICAgICAgKSxcbiAgICAgICAgICBTdGF0dXMuV0FSTklORyxcbiAgICAgICAgICB7IG9rOiBnZXR0ZXh0KCdTY2hlZHVsZSBmb3IgYWxsIGRldmljZXMnKSwgY2FuY2VsOiBnZXR0ZXh0KCdDYW5jZWwgYW5kIHNlbGVjdCBkZXZpY2VzJykgfVxuICAgICAgICApO1xuICAgICAgICAkZXZlbnQuc3RlcC5jb21wbGV0ZWQgPSB0cnVlO1xuICAgICAgICAkZXZlbnQuc3RlcHBlci5uZXh0KCk7XG4gICAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlscyA9IHRoaXMucmV0cmlldmVPcGVyYXRpb25EZXRhaWxzXG4gICAgICAgICAgPyBhd2FpdCB0aGlzLnJldHJpZXZlT3BlcmF0aW9uRGV0YWlscygpXG4gICAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGVtcHR5XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICRldmVudC5zdGVwLmNvbXBsZXRlZCA9IHRydWU7XG4gICAgICAkZXZlbnQuc3RlcHBlci5uZXh0KCk7XG4gICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHMgPSB0aGlzLnJldHJpZXZlT3BlcmF0aW9uRGV0YWlsc1xuICAgICAgICA/IGF3YWl0IHRoaXMucmV0cmlldmVPcGVyYXRpb25EZXRhaWxzKClcbiAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgdGhpcy5idWxrT3BlcmF0aW9uVHlwZSA9IHRoaXMuYnVsa09wZXJhdGlvblNlcnZpY2UucmV0cmlldmVCdWxrT3BlcmF0aW9uVHlwZShcbiAgICAgIGdldCh0aGlzLm9wZXJhdGlvbkRldGFpbHMsICdwcm90b3R5cGUnKVxuICAgICk7XG4gICAgaWYgKFxuICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzRm9ybSAmJlxuICAgICAgZ2V0KHRoaXMub3BlcmF0aW9uRGV0YWlsc0Zvcm0sICdjb250cm9scy5kZXNjcmlwdGlvbi5wcmlzdGluZScpICYmXG4gICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHNcbiAgICApIHtcbiAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlsc0Zvcm0ucGF0Y2hWYWx1ZSh7XG4gICAgICAgIGRlc2NyaXB0aW9uOiBnZXQodGhpcy5vcGVyYXRpb25EZXRhaWxzLCAncHJvdG90eXBlLmRlc2NyaXB0aW9uJylcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGNhbmNlbCgpIHtcbiAgICB0aGlzLmNsb3NlKCk7XG4gIH1cblxuICBhc3luYyBzY2hlZHVsZUJ1bGtPcGVyYXRpb24oKSB7XG4gICAgdGhpcy5wZW5kaW5nU3RhdHVzID0gdHJ1ZTtcblxuICAgIHRyeSB7XG4gICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHMucHJvdG90eXBlLmRlc2NyaXB0aW9uID0gZ2V0KFxuICAgICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHNGb3JtLFxuICAgICAgICAnY29udHJvbHMuZGVzY3JpcHRpb24udmFsdWUnXG4gICAgICApO1xuICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzLm5vdGUgPSBnZXQodGhpcy5vcGVyYXRpb25EZXRhaWxzRm9ybSwgJ2NvbnRyb2xzLm5vdGUudmFsdWUnKTtcbiAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlscy5zY2hlZHVsZSA9IGdldCh0aGlzLm9wZXJhdGlvbkRldGFpbHNGb3JtLCAnY29udHJvbHMuc2NoZWR1bGUudmFsdWUnKTtcblxuICAgICAgYXdhaXQgdGhpcy5idWxrT3BlcmF0aW9uU2VydmljZS5zY2hlZHVsZUJ1bGtPcGVyYXRpb24oXG4gICAgICAgIHRoaXMuZGV2aWNlUXVlcnlTdHJpbmcsXG4gICAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlsc1xuICAgICAgKTtcbiAgICAgIHRoaXMuYWxlcnQuc3VjY2VzcyhnZXR0ZXh0KCdOZXcgYnVsayBvcGVyYXRpb24gc2NoZWR1bGVkLicpKTtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICB9XG5cbiAgICB0aGlzLnBlbmRpbmdTdGF0dXMgPSBmYWxzZTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZW5kU3Vic2NyaXB0aW9ucy5uZXh0KCk7XG4gICAgdGhpcy5lbmRTdWJzY3JpcHRpb25zLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwcml2YXRlIGNsb3NlKCkge1xuICAgIHRoaXMuc3RlcHBlci5yZXNldCgpO1xuICAgIHRoaXMuYnVsa09wZXJhdGlvblNlcnZpY2UucmV0dXJuVG9CdWxrT3BlcmF0aW9uT3ZlcnZpZXcoKTtcbiAgfVxufVxuIl19