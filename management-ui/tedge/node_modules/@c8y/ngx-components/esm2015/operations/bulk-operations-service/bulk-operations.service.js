import * as tslib_1 from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { flatten, has, isUndefined } from 'lodash-es';
import { Subject } from 'rxjs';
import { IdReference, IManagedObject, InventoryService, IOperation, IOperationBulk, IResult, OperationBulkService, OperationService } from '@c8y/client';
export const baseUrl = 'devicecontrol/bulk/creation/';
export const HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
let BulkOperationsService = class BulkOperationsService {
    constructor(operationBulkService, operationService, inventoryService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.location = location;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        this.bulkTypes = flatten(bulkTypes);
        this.bulkTypes = this.bulkTypes.map(type => {
            if (isUndefined(type.selected)) {
                type.selected = false;
            }
            return type;
        });
    }
    getBulkOperations(customFilter = {}) {
        const filter = Object.assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    }
    getBulkOperationById(bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    }
    createBulkOperation(bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    }
    deleteBulkOperation(bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    }
    updateBulkOperation(bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    }
    getOperation(id) {
        return this.operationService.detail(id);
    }
    returnToBulkOperationOverview() {
        this.location.back();
    }
    setBulkTypes(list) {
        this.bulkTypes = list;
    }
    getBulkTypes() {
        return this.bulkTypes;
    }
    setFirmwareId(id) {
        this.firmwareId.next(id);
    }
    createGroup(deviceQueryDataString) {
        const dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    }
    scheduleBulkOperation(deviceQueryString, details) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const dynamicGroup = yield this.createGroup(deviceQueryString);
            const bulkOperation = {
                groupId: dynamicGroup.data.id,
                operationPrototype: details.prototype,
                creationRamp: details.schedule.delayInSeconds,
                startDate: details.schedule.scheduledDate.toISOString(),
                note: details.note
            };
            yield this.createBulkOperation(bulkOperation);
        });
    }
    getSingleOperationsByStatus(status, bulkOperationId) {
        const filter = {
            withTotalPages: true,
            bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    }
    createSingleOperation(operation) {
        return this.operationService.create(operation);
    }
    updateSingleOperation(partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    }
    getManagedObject(deviceId) {
        return this.inventoryService.detail(deviceId);
    }
    retrieveBulkOperationType(operation) {
        let type;
        this.bulkTypes.some(t => {
            if (t.fragments.some(fragment => has(operation, fragment))) {
                type = t.type;
                return true;
            }
        });
        return type;
    }
};
BulkOperationsService.ctorParameters = () => [
    { type: OperationBulkService },
    { type: OperationService },
    { type: InventoryService },
    { type: Location },
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
];
BulkOperationsService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(4, Optional()), tslib_1.__param(4, Inject(HOOK_LIST_BULK_TYPE))
], BulkOperationsService);
export { BulkOperationsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb25zLXNlcnZpY2UvIiwic291cmNlcyI6WyJidWxrLW9wZXJhdGlvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0UsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUNMLFdBQVcsRUFDWCxjQUFjLEVBQ2QsZ0JBQWdCLEVBQ2hCLFVBQVUsRUFDVixjQUFjLEVBQ2QsT0FBTyxFQUNQLG9CQUFvQixFQUNwQixnQkFBZ0IsRUFDakIsTUFBTSxhQUFhLENBQUM7QUFNckIsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLDhCQUE4QixDQUFDO0FBQ3RELE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLElBQUksY0FBYyxDQUNuRCxnQkFBZ0IsQ0FDakIsQ0FBQztBQUdGLElBQWEscUJBQXFCLEdBQWxDLE1BQWEscUJBQXFCO0lBTWhDLFlBQ1Usb0JBQTBDLEVBQzFDLGdCQUFrQyxFQUNsQyxnQkFBa0MsRUFDbEMsUUFBa0IsRUFFZSxTQUFpRDtRQUxsRix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBVG5CLGlCQUFZLEdBQVcsRUFBRSxDQUFDO1FBQ25DLGVBQVUsR0FB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QUNoQixnQkFBZ0I7WUFDeEIsUUFBUTtZQUUwQixLQUFLLHVCQUF4RCxRQUFRLFlBQUksTUFBTSxTQUFDLG1CQUFtQjs7QUFaOUIscUJBQXFCO0lBRGpDLFVBQVUsRUFBRTtJQWFSLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUE7R0FaL0IscUJBQXFCLENBa0lqQztTQWxJWSxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZmxhdHRlbiwgaGFzLCBpc1VuZGVmaW5lZCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7XG4gIElkUmVmZXJlbmNlLFxuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSU9wZXJhdGlvbixcbiAgSU9wZXJhdGlvbkJ1bGssXG4gIElSZXN1bHQsXG4gIE9wZXJhdGlvbkJ1bGtTZXJ2aWNlLFxuICBPcGVyYXRpb25TZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcblxuaW1wb3J0IHsgT3BlcmF0aW9uRGV0YWlscyB9IGZyb20gJy4vb3BlcmF0aW9uLWRldGFpbHMubW9kZWwnO1xuaW1wb3J0IHsgT3BlcmF0aW9uVHlwZSB9IGZyb20gJy4vb3BlcmF0aW9uLXR5cGUubW9kZWwnO1xuaW1wb3J0IHsgQnVsa09wZXJhdGlvblR5cGUgfSBmcm9tICcuL2J1bGstb3BlcmF0aW9uLm1vZGVsJztcblxuZXhwb3J0IGNvbnN0IGJhc2VVcmwgPSAnZGV2aWNlY29udHJvbC9idWxrL2NyZWF0aW9uLyc7XG5leHBvcnQgY29uc3QgSE9PS19MSVNUX0JVTEtfVFlQRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxPcGVyYXRpb25UeXBlIHwgT3BlcmF0aW9uVHlwZVtdPihcbiAgJ0xJU1RfQlVMS19UWVBFJ1xuKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJ1bGtPcGVyYXRpb25zU2VydmljZSB7XG4gIHJlYWRvbmx5IEREX0xPV19DT1VOVDogbnVtYmVyID0gMTA7XG4gIGZpcm13YXJlSWQ6IFN1YmplY3Q8SWRSZWZlcmVuY2U+ID0gbmV3IFN1YmplY3Q8SWRSZWZlcmVuY2U+KCk7XG5cbiAgcHJpdmF0ZSBidWxrVHlwZXM6IE9wZXJhdGlvblR5cGVbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG9wZXJhdGlvbkJ1bGtTZXJ2aWNlOiBPcGVyYXRpb25CdWxrU2VydmljZSxcbiAgICBwcml2YXRlIG9wZXJhdGlvblNlcnZpY2U6IE9wZXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uLFxuXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChIT09LX0xJU1RfQlVMS19UWVBFKSBidWxrVHlwZXM6IEFycmF5PE9wZXJhdGlvblR5cGUgfCBPcGVyYXRpb25UeXBlW10+XG4gICkge1xuICAgIHRoaXMuYnVsa1R5cGVzID0gZmxhdHRlbihidWxrVHlwZXMpO1xuXG4gICAgdGhpcy5idWxrVHlwZXMgPSB0aGlzLmJ1bGtUeXBlcy5tYXAodHlwZSA9PiB7XG4gICAgICBpZiAoaXNVbmRlZmluZWQodHlwZS5zZWxlY3RlZCkpIHtcbiAgICAgICAgdHlwZS5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHR5cGU7XG4gICAgfSk7XG4gIH1cblxuICBnZXRCdWxrT3BlcmF0aW9ucyhjdXN0b21GaWx0ZXIgPSB7fSkge1xuICAgIGNvbnN0IGZpbHRlciA9IHtcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlLFxuICAgICAgd2l0aERlbGV0ZWQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogNTAsXG4gICAgICAuLi5jdXN0b21GaWx0ZXJcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UubGlzdChmaWx0ZXIpO1xuICB9XG5cbiAgZ2V0QnVsa09wZXJhdGlvbkJ5SWQoYnVsa09wZXJhdGlvbklkOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5kZXRhaWwoYnVsa09wZXJhdGlvbklkKTtcbiAgfVxuXG4gIGNyZWF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5jcmVhdGUoYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBkZWxldGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb25JZCkge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmRlbGV0ZShidWxrT3BlcmF0aW9uSWQpO1xuICB9XG5cbiAgdXBkYXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uOiBQYXJ0aWFsPElPcGVyYXRpb25CdWxrPikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLnVwZGF0ZShidWxrT3BlcmF0aW9uKTtcbiAgfVxuXG4gIGdldE9wZXJhdGlvbihpZDogc3RyaW5nKTogUHJvbWlzZTxJUmVzdWx0PElPcGVyYXRpb24+PiB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5kZXRhaWwoaWQpO1xuICB9XG5cbiAgcmV0dXJuVG9CdWxrT3BlcmF0aW9uT3ZlcnZpZXcoKSB7XG4gICAgdGhpcy5sb2NhdGlvbi5iYWNrKCk7XG4gIH1cblxuICBzZXRCdWxrVHlwZXMobGlzdDogT3BlcmF0aW9uVHlwZVtdKSB7XG4gICAgdGhpcy5idWxrVHlwZXMgPSBsaXN0O1xuICB9XG5cbiAgZ2V0QnVsa1R5cGVzKCk6IE9wZXJhdGlvblR5cGVbXSB7XG4gICAgcmV0dXJuIHRoaXMuYnVsa1R5cGVzO1xuICB9XG5cbiAgc2V0RmlybXdhcmVJZChpZDogSWRSZWZlcmVuY2UpIHtcbiAgICB0aGlzLmZpcm13YXJlSWQubmV4dChpZCk7XG4gIH1cblxuICBjcmVhdGVHcm91cChkZXZpY2VRdWVyeURhdGFTdHJpbmc6IHN0cmluZykge1xuICAgIGNvbnN0IGR5bmFtaWNHcm91cDogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4gPSB7XG4gICAgICBuYW1lOiAnQnVsayBvcGVyYXRpb25zIGdyb3VwJyxcbiAgICAgIHR5cGU6ICdjOHlfRHluYW1pY0dyb3VwJyxcbiAgICAgIGM4eV9Jc0R5bmFtaWNHcm91cDogeyBpbnZpc2libGU6IHt9IH0sXG4gICAgICBjOHlfRGV2aWNlUXVlcnlTdHJpbmc6IGRldmljZVF1ZXJ5RGF0YVN0cmluZ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmNyZWF0ZShkeW5hbWljR3JvdXApO1xuICB9XG5cbiAgYXN5bmMgc2NoZWR1bGVCdWxrT3BlcmF0aW9uKGRldmljZVF1ZXJ5U3RyaW5nOiBzdHJpbmcsIGRldGFpbHM6IE9wZXJhdGlvbkRldGFpbHMpIHtcbiAgICBjb25zdCBkeW5hbWljR3JvdXAgPSBhd2FpdCB0aGlzLmNyZWF0ZUdyb3VwKGRldmljZVF1ZXJ5U3RyaW5nKTtcblxuICAgIGNvbnN0IGJ1bGtPcGVyYXRpb246IElPcGVyYXRpb25CdWxrID0ge1xuICAgICAgZ3JvdXBJZDogZHluYW1pY0dyb3VwLmRhdGEuaWQsXG4gICAgICBvcGVyYXRpb25Qcm90b3R5cGU6IGRldGFpbHMucHJvdG90eXBlLFxuICAgICAgY3JlYXRpb25SYW1wOiBkZXRhaWxzLnNjaGVkdWxlLmRlbGF5SW5TZWNvbmRzLFxuICAgICAgc3RhcnREYXRlOiBkZXRhaWxzLnNjaGVkdWxlLnNjaGVkdWxlZERhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgIG5vdGU6IGRldGFpbHMubm90ZVxuICAgIH07XG5cbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBnZXRTaW5nbGVPcGVyYXRpb25zQnlTdGF0dXMoc3RhdHVzLCBidWxrT3BlcmF0aW9uSWQpIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7XG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICAgIGJ1bGtPcGVyYXRpb25JZCxcbiAgICAgIHN0YXR1czogKHN0YXR1cyAmJiBzdGF0dXMudG9VcHBlckNhc2UoKSkgfHwgJydcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5saXN0KGZpbHRlcik7XG4gIH1cblxuICBjcmVhdGVTaW5nbGVPcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5jcmVhdGUob3BlcmF0aW9uKTtcbiAgfVxuXG4gIHVwZGF0ZVNpbmdsZU9wZXJhdGlvbihwYXJ0aWFsVXBkYXRlT2JqZWN0OiBQYXJ0aWFsPElPcGVyYXRpb24+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS51cGRhdGUocGFydGlhbFVwZGF0ZU9iamVjdCk7XG4gIH1cblxuICBnZXRNYW5hZ2VkT2JqZWN0KGRldmljZUlkOiBJZFJlZmVyZW5jZSkge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKGRldmljZUlkKTtcbiAgfVxuXG4gIHJldHJpZXZlQnVsa09wZXJhdGlvblR5cGUob3BlcmF0aW9uOiBJT3BlcmF0aW9uKTogQnVsa09wZXJhdGlvblR5cGUge1xuICAgIGxldCB0eXBlOiBCdWxrT3BlcmF0aW9uVHlwZTtcblxuICAgIHRoaXMuYnVsa1R5cGVzLnNvbWUodCA9PiB7XG4gICAgICBpZiAodC5mcmFnbWVudHMuc29tZShmcmFnbWVudCA9PiBoYXMob3BlcmF0aW9uLCBmcmFnbWVudCkpKSB7XG4gICAgICAgIHR5cGUgPSB0LnR5cGU7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHR5cGU7XG4gIH1cbn1cbiJdfQ==