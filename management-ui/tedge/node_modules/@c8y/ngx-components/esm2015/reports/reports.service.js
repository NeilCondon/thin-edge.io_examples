import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { AlertService } from '@c8y/ngx-components';
import { orderBy, isEqual, remove, some } from 'lodash-es';
import { InventoryService, IdReference } from '@c8y/client';
import { FetchClient, IFetchOptions } from '@c8y/client';
let ReportsService = class ReportsService {
    constructor(alertService, inventoryService, client) {
        this.alertService = alertService;
        this.inventoryService = inventoryService;
        this.client = client;
        this.microserviceUrl = '/service/reporting/schedule';
        this.headers = { 'Content-Type': 'application/json' };
    }
    getExport(exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let exp;
            const exportDetail = yield this.inventoryService.detail(exportId);
            const { data, res } = exportDetail;
            if (res.status !== 200) {
                this.alertService.addServerFailure({ data, res });
            }
            else {
                exp = data ? data : {};
            }
            return exp;
        });
    }
    getScheduleList(exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const exp = yield this.getExport(exportId);
            return this.extractScheduleListFromExport(exp);
        });
    }
    extractScheduleListFromExport(exp) {
        let scheduleList;
        if (exp) {
            scheduleList = exp.c8y_ScheduleConfiguration ? exp.c8y_ScheduleConfiguration : [];
        }
        return orderBy(scheduleList, ['timestamp'], ['desc']);
    }
    addSchedule(schedule, exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.updateSchedules(exportId, [], [schedule]);
        });
    }
    updateSchedule(oldSchedule, schedule, exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.updateSchedules(exportId, [oldSchedule], [schedule]);
        });
    }
    updateSchedules(exportId, schedulesToRemove = [], schedulesToAdd = []) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let success = false;
            const exp = yield this.getExport(exportId);
            const schedules = this.extractScheduleListFromExport(exp);
            remove(schedules, (schedule) => some(schedulesToRemove, (scheduleToRemove) => isEqual(schedule, scheduleToRemove)));
            schedules.push.apply(schedules, schedulesToAdd);
            exp.c8y_ScheduleConfiguration = schedules;
            const { data, res } = yield this.inventoryService.update(exp);
            if (res.status === 200) {
                success = yield this.reschedule(exportId);
            }
            else {
                this.alertService.addServerFailure({ data, res });
            }
            return success;
        });
    }
    reschedule(exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'PUT',
                headers: this.headers
            };
            const rescheduling = yield this.client.fetch(`${this.microserviceUrl}/${exportId}`, options);
            return rescheduling.status === 200;
        });
    }
    deleteSchedule(schedule, exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.updateSchedules(exportId, [schedule], []);
        });
    }
};
ReportsService.ctorParameters = () => [
    { type: AlertService },
    { type: InventoryService },
    { type: FetchClient }
];
ReportsService = tslib_1.__decorate([
    Injectable()
], ReportsService);
export { ReportsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0cy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvcnRzLyIsInNvdXJjZXMiOlsicmVwb3J0cy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzNELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFJekQsSUFBYSxjQUFjLEdBQTNCLE1BQWEsY0FBYztJQUl6QixZQUNVLFlBQTBCLEVBQzFCLGdCQUFrQyxFQUNsQyxNQUFtQjtRQUZuQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWE7UUFFM0IsSUFBSSxDQUFDLGVBQWUsR0FBRyw2QkFBNkIsQ0FBQztRQUNyRCxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7SUFDeEQsQ0FBQztJQUVLLFNBQVMsQ0FBQyxRQUFxQjs7WUFDbkMsSUFBSSxHQUFXLENBQUM7WUFDaEIsTUFBTSxZQUFZLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2xFLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsWUFBWSxDQUFDO1lBQ25DLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQzthQUNuRDtpQkFBTTtnQkFDTCxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBRyxJQUEyQixDQUFDLENBQUMsQ0FBRSxFQUFhLENBQUM7YUFDN0Q7WUFFRCxPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUM7S0FBQTtJQUVLLGVBQWUsQ0FBQyxRQUFxQjs7WUFDekMsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTNDLE9BQU8sSUFBSSxDQUFDLDZCQUE2QixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELENBQUM7S0FBQTtJQUVELDZCQUE2QixDQUFDLEdBQVc7UUFDdkMsSUFBSSxZQUF3QixDQUFDO1FBQzdCLElBQUksR0FBRyxFQUFFO1lBQ1AsWUFBWSxHQUFHLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7U0FDbkY7UUFDRCxPQUFPLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVLLFdBQVcsQ0FBQyxRQUFrQixFQUFFLFFBQXFCOztZQUN6RCxPQUFPLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUM5RCxDQUFDO0tBQUE7SUFFSyxjQUFjLENBQUMsV0FBcUIsRUFBRSxRQUFrQixFQUFFLFFBQXFCOztZQUNuRixPQUFPLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDekUsQ0FBQztLQUFBO0lBRUssZUFBZSxDQUNuQixRQUFxQixFQUNyQixvQkFBZ0MsRUFBRSxFQUNsQyxpQkFBNkIsRUFBRTs7WUFFL0IsSUFBSSxPQUFPLEdBQVksS0FBSyxDQUFDO1lBQzdCLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMzQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsNkJBQTZCLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFMUQsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLFFBQWtCLEVBQUUsRUFBRSxDQUN2QyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxnQkFBMEIsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDLENBQzdGLENBQUM7WUFDRixTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsY0FBYyxDQUFDLENBQUM7WUFDaEQsR0FBRyxDQUFDLHlCQUF5QixHQUFHLFNBQVMsQ0FBQztZQUMxQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM5RCxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO2dCQUN0QixPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzNDO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQzthQUNuRDtZQUVELE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUM7S0FBQTtJQUVLLFVBQVUsQ0FBQyxRQUFxQjs7WUFDcEMsTUFBTSxPQUFPLEdBQWtCO2dCQUM3QixNQUFNLEVBQUUsS0FBSztnQkFDYixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87YUFDdEIsQ0FBQztZQUNGLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsZUFBZSxJQUFJLFFBQVEsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzdGLE9BQU8sWUFBWSxDQUFDLE1BQU0sS0FBSyxHQUFHLENBQUM7UUFDckMsQ0FBQztLQUFBO0lBRUssY0FBYyxDQUFDLFFBQWtCLEVBQUUsUUFBcUI7O1lBQzVELE9BQU8sTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzlELENBQUM7S0FBQTtDQUNGLENBQUE7O1lBL0V5QixZQUFZO1lBQ1IsZ0JBQWdCO1lBQzFCLFdBQVc7O0FBUGxCLGNBQWM7SUFEMUIsVUFBVSxFQUFFO0dBQ0EsY0FBYyxDQW9GMUI7U0FwRlksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEV4cG9ydCwgU2NoZWR1bGUgfSBmcm9tICcuL2V4cG9ydC1zY2hlZHVsZXMuaW50ZXJmYWNlJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgb3JkZXJCeSwgaXNFcXVhbCwgcmVtb3ZlLCBzb21lIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEludmVudG9yeVNlcnZpY2UsIElkUmVmZXJlbmNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgRmV0Y2hDbGllbnQsIElGZXRjaE9wdGlvbnMgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSZXBvcnRzU2VydmljZSB7XG4gIG1pY3Jvc2VydmljZVVybDogc3RyaW5nO1xuICBoZWFkZXJzOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjbGllbnQ6IEZldGNoQ2xpZW50XG4gICkge1xuICAgIHRoaXMubWljcm9zZXJ2aWNlVXJsID0gJy9zZXJ2aWNlL3JlcG9ydGluZy9zY2hlZHVsZSc7XG4gICAgdGhpcy5oZWFkZXJzID0geyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH07XG4gIH1cblxuICBhc3luYyBnZXRFeHBvcnQoZXhwb3J0SWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgbGV0IGV4cDogRXhwb3J0O1xuICAgIGNvbnN0IGV4cG9ydERldGFpbCA9IGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5kZXRhaWwoZXhwb3J0SWQpO1xuICAgIGNvbnN0IHsgZGF0YSwgcmVzIH0gPSBleHBvcnREZXRhaWw7XG4gICAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZSh7IGRhdGEsIHJlcyB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZXhwID0gZGF0YSA/ICgoZGF0YSBhcyB1bmtub3duKSBhcyBFeHBvcnQpIDogKHt9IGFzIEV4cG9ydCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGV4cDtcbiAgfVxuXG4gIGFzeW5jIGdldFNjaGVkdWxlTGlzdChleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICBjb25zdCBleHAgPSBhd2FpdCB0aGlzLmdldEV4cG9ydChleHBvcnRJZCk7XG5cbiAgICByZXR1cm4gdGhpcy5leHRyYWN0U2NoZWR1bGVMaXN0RnJvbUV4cG9ydChleHApO1xuICB9XG5cbiAgZXh0cmFjdFNjaGVkdWxlTGlzdEZyb21FeHBvcnQoZXhwOiBFeHBvcnQpIHtcbiAgICBsZXQgc2NoZWR1bGVMaXN0OiBTY2hlZHVsZVtdO1xuICAgIGlmIChleHApIHtcbiAgICAgIHNjaGVkdWxlTGlzdCA9IGV4cC5jOHlfU2NoZWR1bGVDb25maWd1cmF0aW9uID8gZXhwLmM4eV9TY2hlZHVsZUNvbmZpZ3VyYXRpb24gOiBbXTtcbiAgICB9XG4gICAgcmV0dXJuIG9yZGVyQnkoc2NoZWR1bGVMaXN0LCBbJ3RpbWVzdGFtcCddLCBbJ2Rlc2MnXSk7XG4gIH1cblxuICBhc3luYyBhZGRTY2hlZHVsZShzY2hlZHVsZTogU2NoZWR1bGUsIGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVwZGF0ZVNjaGVkdWxlcyhleHBvcnRJZCwgW10sIFtzY2hlZHVsZV0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlU2NoZWR1bGUob2xkU2NoZWR1bGU6IFNjaGVkdWxlLCBzY2hlZHVsZTogU2NoZWR1bGUsIGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVwZGF0ZVNjaGVkdWxlcyhleHBvcnRJZCwgW29sZFNjaGVkdWxlXSwgW3NjaGVkdWxlXSk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVTY2hlZHVsZXMoXG4gICAgZXhwb3J0SWQ6IElkUmVmZXJlbmNlLFxuICAgIHNjaGVkdWxlc1RvUmVtb3ZlOiBTY2hlZHVsZVtdID0gW10sXG4gICAgc2NoZWR1bGVzVG9BZGQ6IFNjaGVkdWxlW10gPSBbXVxuICApIHtcbiAgICBsZXQgc3VjY2VzczogYm9vbGVhbiA9IGZhbHNlO1xuICAgIGNvbnN0IGV4cCA9IGF3YWl0IHRoaXMuZ2V0RXhwb3J0KGV4cG9ydElkKTtcbiAgICBjb25zdCBzY2hlZHVsZXMgPSB0aGlzLmV4dHJhY3RTY2hlZHVsZUxpc3RGcm9tRXhwb3J0KGV4cCk7XG5cbiAgICByZW1vdmUoc2NoZWR1bGVzLCAoc2NoZWR1bGU6IFNjaGVkdWxlKSA9PlxuICAgICAgc29tZShzY2hlZHVsZXNUb1JlbW92ZSwgKHNjaGVkdWxlVG9SZW1vdmU6IFNjaGVkdWxlKSA9PiBpc0VxdWFsKHNjaGVkdWxlLCBzY2hlZHVsZVRvUmVtb3ZlKSlcbiAgICApO1xuICAgIHNjaGVkdWxlcy5wdXNoLmFwcGx5KHNjaGVkdWxlcywgc2NoZWR1bGVzVG9BZGQpO1xuICAgIGV4cC5jOHlfU2NoZWR1bGVDb25maWd1cmF0aW9uID0gc2NoZWR1bGVzO1xuICAgIGNvbnN0IHsgZGF0YSwgcmVzIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UudXBkYXRlKGV4cCk7XG4gICAgaWYgKHJlcy5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgc3VjY2VzcyA9IGF3YWl0IHRoaXMucmVzY2hlZHVsZShleHBvcnRJZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1Y2Nlc3M7XG4gIH1cblxuICBhc3luYyByZXNjaGVkdWxlKGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzXG4gICAgfTtcbiAgICBjb25zdCByZXNjaGVkdWxpbmcgPSBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaChgJHt0aGlzLm1pY3Jvc2VydmljZVVybH0vJHtleHBvcnRJZH1gLCBvcHRpb25zKTtcbiAgICByZXR1cm4gcmVzY2hlZHVsaW5nLnN0YXR1cyA9PT0gMjAwO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2NoZWR1bGUoc2NoZWR1bGU6IFNjaGVkdWxlLCBleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51cGRhdGVTY2hlZHVsZXMoZXhwb3J0SWQsIFtzY2hlZHVsZV0sIFtdKTtcbiAgfVxufVxuIl19