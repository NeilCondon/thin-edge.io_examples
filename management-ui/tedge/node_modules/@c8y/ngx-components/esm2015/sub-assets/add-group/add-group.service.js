import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { IIdentified, IManagedObject, InventoryService } from '@c8y/client';
import { GroupFragment } from '@c8y/ngx-components/assets-navigator';
let AddGroupService = class AddGroupService {
    constructor(inventoryService) {
        this.inventoryService = inventoryService;
        this.GROUP_FRAGMENT_TYPE = 'c8y_IsDeviceGroup';
    }
    createGroupAndAssignDevices(groupForm, groupContextId, selectedDevices) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let group;
            const { name, description } = groupForm;
            const newGroupMO = this.getGroupMO(name, description, groupContextId);
            if (groupContextId) {
                group = (yield this.inventoryService.childAssetsCreate(newGroupMO, groupContextId)).data;
            }
            else {
                group = (yield this.inventoryService.create(newGroupMO)).data;
            }
            if (selectedDevices.length > 0) {
                yield this.assignDevices(group.id, selectedDevices);
            }
            return group;
        });
    }
    getGroupMO(name, description = '', groupContextId) {
        const group = {
            type: this.getGroupType(groupContextId),
            [this.GROUP_FRAGMENT_TYPE]: {},
            name,
            description
        };
        return group;
    }
    getGroupType(groupContextId) {
        return groupContextId ? GroupFragment.subGroupType : GroupFragment.groupType;
    }
    assignDevices(id, selectedDevices) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const promises = [];
            selectedDevices.forEach(moId => {
                promises.push(this.inventoryService.childAssetsAdd(moId, id));
            });
            return yield Promise.all(promises);
        });
    }
};
AddGroupService.ctorParameters = () => [
    { type: InventoryService }
];
AddGroupService = tslib_1.__decorate([
    Injectable()
], AddGroupService);
export { AddGroupService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRkLWdyb3VwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3N1Yi1hc3NldHMvIiwic291cmNlcyI6WyJhZGQtZ3JvdXAvYWRkLWdyb3VwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFNUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBR3JFLElBQWEsZUFBZSxHQUE1QixNQUFhLGVBQWU7SUFHMUIsWUFBb0IsZ0JBQWtDO1FBQWxDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFGOUMsd0JBQW1CLEdBQUcsbUJBQW1CLENBQUM7SUFFTyxDQUFDO0lBRXBELDJCQUEyQixDQUMvQixTQUFvQixFQUNwQixjQUErQixFQUMvQixlQUF5Qjs7WUFFekIsSUFBSSxLQUFtQyxDQUFDO1lBQ3hDLE1BQU0sRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLEdBQUcsU0FBUyxDQUFDO1lBQ3hDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxjQUFjLENBQUMsQ0FBQztZQUV0RSxJQUFJLGNBQWMsRUFBRTtnQkFDbEIsS0FBSyxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO2FBQzFGO2lCQUFNO2dCQUNMLEtBQUssR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQzthQUMvRDtZQUVELElBQUksZUFBZSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQzlCLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLGVBQWUsQ0FBQyxDQUFDO2FBQ3JEO1lBRUQsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0tBQUE7SUFFTyxVQUFVLENBQ2hCLElBQVksRUFDWixjQUFzQixFQUFFLEVBQ3hCLGNBQStCO1FBRS9CLE1BQU0sS0FBSyxHQUFHO1lBQ1osSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDO1lBQ3ZDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEVBQUUsRUFBRTtZQUM5QixJQUFJO1lBQ0osV0FBVztTQUNaLENBQUM7UUFFRixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFTyxZQUFZLENBQ2xCLGNBQStCO1FBRS9CLE9BQU8sY0FBYyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDO0lBQy9FLENBQUM7SUFFYSxhQUFhLENBQUMsRUFBbUIsRUFBRSxlQUF5Qjs7WUFDeEUsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDO1lBRXBCLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQzdCLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNoRSxDQUFDLENBQUMsQ0FBQztZQUVILE9BQU8sTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3JDLENBQUM7S0FBQTtDQUNGLENBQUE7O1lBdER1QyxnQkFBZ0I7O0FBSDNDLGVBQWU7SUFEM0IsVUFBVSxFQUFFO0dBQ0EsZUFBZSxDQXlEM0I7U0F6RFksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElJZGVudGlmaWVkLCBJTWFuYWdlZE9iamVjdCwgSW52ZW50b3J5U2VydmljZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEdyb3VwRm9ybSB9IGZyb20gJy4vYWRkLWdyb3VwLm1vZGVsJztcbmltcG9ydCB7IEdyb3VwRnJhZ21lbnQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2Fzc2V0cy1uYXZpZ2F0b3InO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQWRkR3JvdXBTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBHUk9VUF9GUkFHTUVOVF9UWVBFID0gJ2M4eV9Jc0RldmljZUdyb3VwJztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgY3JlYXRlR3JvdXBBbmRBc3NpZ25EZXZpY2VzKFxuICAgIGdyb3VwRm9ybTogR3JvdXBGb3JtLFxuICAgIGdyb3VwQ29udGV4dElkOiBzdHJpbmcgfCBudW1iZXIsXG4gICAgc2VsZWN0ZWREZXZpY2VzOiBzdHJpbmdbXVxuICApOiBQcm9taXNlPElNYW5hZ2VkT2JqZWN0IHwgSUlkZW50aWZpZWQ+IHtcbiAgICBsZXQgZ3JvdXA6IElNYW5hZ2VkT2JqZWN0IHwgSUlkZW50aWZpZWQ7XG4gICAgY29uc3QgeyBuYW1lLCBkZXNjcmlwdGlvbiB9ID0gZ3JvdXBGb3JtO1xuICAgIGNvbnN0IG5ld0dyb3VwTU8gPSB0aGlzLmdldEdyb3VwTU8obmFtZSwgZGVzY3JpcHRpb24sIGdyb3VwQ29udGV4dElkKTtcblxuICAgIGlmIChncm91cENvbnRleHRJZCkge1xuICAgICAgZ3JvdXAgPSAoYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmNoaWxkQXNzZXRzQ3JlYXRlKG5ld0dyb3VwTU8sIGdyb3VwQ29udGV4dElkKSkuZGF0YTtcbiAgICB9IGVsc2Uge1xuICAgICAgZ3JvdXAgPSAoYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmNyZWF0ZShuZXdHcm91cE1PKSkuZGF0YTtcbiAgICB9XG5cbiAgICBpZiAoc2VsZWN0ZWREZXZpY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgIGF3YWl0IHRoaXMuYXNzaWduRGV2aWNlcyhncm91cC5pZCwgc2VsZWN0ZWREZXZpY2VzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZ3JvdXA7XG4gIH1cblxuICBwcml2YXRlIGdldEdyb3VwTU8oXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmcgPSAnJyxcbiAgICBncm91cENvbnRleHRJZDogc3RyaW5nIHwgbnVtYmVyXG4gICk6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+IHtcbiAgICBjb25zdCBncm91cCA9IHtcbiAgICAgIHR5cGU6IHRoaXMuZ2V0R3JvdXBUeXBlKGdyb3VwQ29udGV4dElkKSxcbiAgICAgIFt0aGlzLkdST1VQX0ZSQUdNRU5UX1RZUEVdOiB7fSxcbiAgICAgIG5hbWUsXG4gICAgICBkZXNjcmlwdGlvblxuICAgIH07XG5cbiAgICByZXR1cm4gZ3JvdXA7XG4gIH1cblxuICBwcml2YXRlIGdldEdyb3VwVHlwZShcbiAgICBncm91cENvbnRleHRJZDogc3RyaW5nIHwgbnVtYmVyXG4gICk6IEdyb3VwRnJhZ21lbnQuc3ViR3JvdXBUeXBlIHwgR3JvdXBGcmFnbWVudC5ncm91cFR5cGUge1xuICAgIHJldHVybiBncm91cENvbnRleHRJZCA/IEdyb3VwRnJhZ21lbnQuc3ViR3JvdXBUeXBlIDogR3JvdXBGcmFnbWVudC5ncm91cFR5cGU7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGFzc2lnbkRldmljZXMoaWQ6IHN0cmluZyB8IG51bWJlciwgc2VsZWN0ZWREZXZpY2VzOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IHByb21pc2VzID0gW107XG5cbiAgICBzZWxlY3RlZERldmljZXMuZm9yRWFjaChtb0lkID0+IHtcbiAgICAgIHByb21pc2VzLnB1c2godGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmNoaWxkQXNzZXRzQWRkKG1vSWQsIGlkKSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICB9XG59XG4iXX0=