import * as tslib_1 from "tslib";
import { Component, Input, Output, EventEmitter, HostListener } from '@angular/core';
import { Pagination, AlertService, gettext, ActionControl, Row } from '@c8y/ngx-components';
import { QueriesUtil } from '@c8y/client';
import { AssignDevicesService } from './assign-devices.service';
let AssignDevicesComponent = class AssignDevicesComponent {
    constructor(assignDevicesService, alert) {
        this.assignDevicesService = assignDevicesService;
        this.alert = alert;
        this.refresh = new EventEmitter();
        this.onCancel = new EventEmitter();
        this.onShowChildDevices = new EventEmitter();
        this.selectedDevice = new EventEmitter();
        this.pendingStatus = false;
        this.pagination = { pageSize: 20, currentPage: 1 };
        this.selected = [];
        this.canAssignDevice = false;
        this.actionControls = [];
        this.isSelectable = true;
        this.itemsSelectLimit = 15;
        this.queriesUtil = new QueriesUtil();
    }
    onEnterKeyDown(event) {
        if (this.selected.length > 0) {
            this.assignDevices();
        }
    }
    onEscapeKeyDown(event) {
        this.onCancel.emit();
    }
    ngOnInit() {
        this.setNotIncludedInGroupQuery();
    }
    setNotIncludedInGroupQuery() {
        const notIncludedInGroupQuery = { __not: { __bygroupid: this.currentGroupId } };
        this.baseQuery = notIncludedInGroupQuery;
    }
    setActionControls(showChildren) {
        const actionControls = [];
        const selectChildrenAction = {
            type: 'SELECT_CHILDREN',
            icon: 'enter-bottom',
            text: gettext('Select children'),
            callback: (asset) => this.selectChildren(asset),
            showIf: (asset) => asset.childDevices.references.length > 0
        };
        if (showChildren) {
            actionControls.push(selectChildrenAction);
        }
        this.actionControls = actionControls;
        this.refresh.emit();
    }
    assignDevices() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.pendingStatus = true;
            yield this.assignDevicesService.assignDevices(this.currentGroupId, this.selected);
            this.pendingStatus = false;
            this.selected = [];
            this.onCancel.emit();
            this.refresh.emit();
            this.alert.success(gettext('Devices assigned to the group.'));
        });
    }
    onSelected(selectedDevicesIDs) {
        this.selected = selectedDevicesIDs;
    }
    selectChildren(asset) {
        this.onShowChildDevices.emit(true);
        this.selectedDevice.emit(asset);
    }
};
AssignDevicesComponent.ctorParameters = () => [
    { type: AssignDevicesService },
    { type: AlertService }
];
tslib_1.__decorate([
    Input()
], AssignDevicesComponent.prototype, "currentGroupId", void 0);
tslib_1.__decorate([
    Input()
], AssignDevicesComponent.prototype, "refresh", void 0);
tslib_1.__decorate([
    Output()
], AssignDevicesComponent.prototype, "onCancel", void 0);
tslib_1.__decorate([
    Output()
], AssignDevicesComponent.prototype, "onShowChildDevices", void 0);
tslib_1.__decorate([
    Output()
], AssignDevicesComponent.prototype, "selectedDevice", void 0);
tslib_1.__decorate([
    HostListener('document:keydown.enter', ['$event'])
], AssignDevicesComponent.prototype, "onEnterKeyDown", null);
tslib_1.__decorate([
    HostListener('document:keydown.escape', ['$event'])
], AssignDevicesComponent.prototype, "onEscapeKeyDown", null);
AssignDevicesComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-assign-devices',
        template: "<div class=\"card-block flex-no-shrink separator-bottom col-xs-12 large-padding p-t-24 p-b-24\">\n  <div class=\"row\">\n    <div class=\"col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4\">\n      <h4 class=\"text-center text-medium\">\n        {{ 'Assign devices' | translate }}\n      </h4>\n    </div>\n  </div>\n</div>\n<c8y-device-grid\n  [title]=\"'Select target devices' | translate\"\n  [actionControls]=\"actionControls\"\n  [infiniteScroll]=\"'auto'\"\n  [selectable]=\"isSelectable\"\n  [pagination]=\"pagination\"\n  (itemsSelect)=\"onSelected($event)\"\n  [itemsSelectLimit]=\"itemsSelectLimit\"\n  [refresh]=\"refresh\"\n  [baseQuery]=\"baseQuery\"\n  (onChildDevices)=\"setActionControls($event)\"\n  [showChildDevices]=\"{ show: true, value: false }\"\n  class=\"flex-grow col-xs-12 no-gutter\"\n>\n  <div class=\"c8y-empty-state\">\n    <h1 c8yIcon=\"search\"></h1>\n    <div>\n      <p>\n        <strong>{{ 'No matching devices.' | translate }}</strong>\n      </p>\n      <small>{{ 'Refine your search terms' | translate }}</small>\n    </div>\n  </div>\n</c8y-device-grid>\n\n<div class=\"text-center card-footer p-24 separator\">\n  <button (click)=\"onCancel.emit()\" type=\"button\" class=\"btn btn-default\" title=\"{{'Cancel' | translate}}\">\n    <span>{{ 'Cancel' | translate }}</span>\n  </button>\n  <button\n    (click)=\"assignDevices()\"\n    type=\"button\"\n    class=\"btn btn-primary\"\n    [ngClass]=\"{ 'btn-pending': pendingStatus }\"\n    title=\"{{'Assign' | translate}}\"\n    [disabled]=\"selected.length === 0\"\n  >\n    <span>{{ 'Assign' | translate }}</span>\n  </button>\n</div>\n"
    })
], AssignDevicesComponent);
export { AssignDevicesComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzaWduLWRldmljZXMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9zdWItYXNzZXRzLyIsInNvdXJjZXMiOlsiYXNzaWduLWRldmljZXMvYXNzaWduLWRldmljZXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRixPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLEdBQUcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBSTVGLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDMUMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFNaEUsSUFBYSxzQkFBc0IsR0FBbkMsTUFBYSxzQkFBc0I7SUFrQmpDLFlBQW9CLG9CQUEwQyxFQUFVLEtBQW1CO1FBQXZFLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFBVSxVQUFLLEdBQUwsS0FBSyxDQUFjO1FBaEJsRixZQUFPLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNqQyxhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNuQyx1QkFBa0IsR0FBRyxJQUFJLFlBQVksRUFBVyxDQUFDO1FBQ2pELG1CQUFjLEdBQUcsSUFBSSxZQUFZLEVBQWtCLENBQUM7UUFHOUQsa0JBQWEsR0FBWSxLQUFLLENBQUM7UUFDL0IsZUFBVSxHQUFlLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDMUQsYUFBUSxHQUFhLEVBQUUsQ0FBQztRQUV4QixvQkFBZSxHQUFZLEtBQUssQ0FBQztRQUNqQyxtQkFBYyxHQUFvQixFQUFFLENBQUM7UUFDNUIsaUJBQVksR0FBRyxJQUFJ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WUFBWSxDQUFDLHlCQUF5QixFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7NkRBRW5EO0FBOUJVLHNCQUFzQjtJQUpsQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsb0JBQW9CO1FBQzlCLHltREFBOEM7S0FDL0MsQ0FBQztHQUNXLHNCQUFzQixDQStFbEM7U0EvRVksc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUGFnaW5hdGlvbiwgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0LCBBY3Rpb25Db250cm9sLCBSb3cgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IEludmVudG9yeVNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBTdWJBc3NldHNTZXJ2aWNlIH0gZnJvbSAnLi4vc3ViLWFzc2V0cy5zZXJ2aWNlJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgUXVlcmllc1V0aWwgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBc3NpZ25EZXZpY2VzU2VydmljZSB9IGZyb20gJy4vYXNzaWduLWRldmljZXMuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1hc3NpZ24tZGV2aWNlcycsXG4gIHRlbXBsYXRlVXJsOiAnLi9hc3NpZ24tZGV2aWNlcy5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgQXNzaWduRGV2aWNlc0NvbXBvbmVudCB7XG4gIEBJbnB1dCgpIGN1cnJlbnRHcm91cElkOiBzdHJpbmc7XG4gIEBJbnB1dCgpIHJlZnJlc2ggPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgpIG9uQ2FuY2VsID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoKSBvblNob3dDaGlsZERldmljZXMgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG4gIEBPdXRwdXQoKSBzZWxlY3RlZERldmljZSA9IG5ldyBFdmVudEVtaXR0ZXI8SU1hbmFnZWRPYmplY3Q+KCk7XG5cbiAgZGV2aWNlUXVlcnlTdHJpbmdPdXRwdXQ6IHN0cmluZztcbiAgcGVuZGluZ1N0YXR1czogYm9vbGVhbiA9IGZhbHNlO1xuICBwYWdpbmF0aW9uOiBQYWdpbmF0aW9uID0geyBwYWdlU2l6ZTogMjAsIGN1cnJlbnRQYWdlOiAxIH07XG4gIHNlbGVjdGVkOiBzdHJpbmdbXSA9IFtdO1xuICBiYXNlUXVlcnk6IGFueTtcbiAgY2FuQXNzaWduRGV2aWNlOiBib29sZWFuID0gZmFsc2U7XG4gIGFjdGlvbkNvbnRyb2xzOiBBY3Rpb25Db250cm9sW10gPSBbXTtcbiAgcmVhZG9ubHkgaXNTZWxlY3RhYmxlID0gdHJ1ZTtcbiAgcmVhZG9ubHkgaXRlbXNTZWxlY3RMaW1pdCA9IDE1O1xuICBwcml2YXRlIHF1ZXJpZXNVdGlsOiBRdWVyaWVzVXRpbDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFzc2lnbkRldmljZXNTZXJ2aWNlOiBBc3NpZ25EZXZpY2VzU2VydmljZSwgcHJpdmF0ZSBhbGVydDogQWxlcnRTZXJ2aWNlKSB7XG4gICAgdGhpcy5xdWVyaWVzVXRpbCA9IG5ldyBRdWVyaWVzVXRpbCgpO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6a2V5ZG93bi5lbnRlcicsIFsnJGV2ZW50J10pIG9uRW50ZXJLZXlEb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWQubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5hc3NpZ25EZXZpY2VzKCk7XG4gICAgfVxuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6a2V5ZG93bi5lc2NhcGUnLCBbJyRldmVudCddKSBvbkVzY2FwZUtleURvd24oZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICB0aGlzLm9uQ2FuY2VsLmVtaXQoKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuc2V0Tm90SW5jbHVkZWRJbkdyb3VwUXVlcnkoKTtcbiAgfVxuXG4gIHNldE5vdEluY2x1ZGVkSW5Hcm91cFF1ZXJ5KCkge1xuICAgIGNvbnN0IG5vdEluY2x1ZGVkSW5Hcm91cFF1ZXJ5ID0geyBfX25vdDogeyBfX2J5Z3JvdXBpZDogdGhpcy5jdXJyZW50R3JvdXBJZCB9IH07XG4gICAgdGhpcy5iYXNlUXVlcnkgPSBub3RJbmNsdWRlZEluR3JvdXBRdWVyeTtcbiAgfVxuXG4gIHNldEFjdGlvbkNvbnRyb2xzKHNob3dDaGlsZHJlbjogYm9vbGVhbikge1xuICAgIGNvbnN0IGFjdGlvbkNvbnRyb2xzOiBBY3Rpb25Db250cm9sW10gPSBbXTtcbiAgICBjb25zdCBzZWxlY3RDaGlsZHJlbkFjdGlvbjogQWN0aW9uQ29udHJvbCA9IHtcbiAgICAgIHR5cGU6ICdTRUxFQ1RfQ0hJTERSRU4nLFxuICAgICAgaWNvbjogJ2VudGVyLWJvdHRvbScsXG4gICAgICB0ZXh0OiBnZXR0ZXh0KCdTZWxlY3QgY2hpbGRyZW4nKSxcbiAgICAgIGNhbGxiYWNrOiAoYXNzZXQ6IFJvdykgPT4gdGhpcy5zZWxlY3RDaGlsZHJlbihhc3NldCBhcyBJTWFuYWdlZE9iamVjdCksXG4gICAgICBzaG93SWY6IChhc3NldDogUm93KSA9PlxuICAgICAgICBhc3NldC5jaGlsZERldmljZXMucmVmZXJlbmNlcy5sZW5ndGggPiAwXG4gICAgfTtcblxuICAgIGlmIChzaG93Q2hpbGRyZW4pIHtcbiAgICAgIGFjdGlvbkNvbnRyb2xzLnB1c2goc2VsZWN0Q2hpbGRyZW5BY3Rpb24pO1xuICAgIH1cbiAgICB0aGlzLmFjdGlvbkNvbnRyb2xzID0gYWN0aW9uQ29udHJvbHM7XG4gICAgdGhpcy5yZWZyZXNoLmVtaXQoKTtcbiAgfVxuXG4gIGFzeW5jIGFzc2lnbkRldmljZXMoKSB7XG4gICAgdGhpcy5wZW5kaW5nU3RhdHVzID0gdHJ1ZTtcbiAgICBhd2FpdCB0aGlzLmFzc2lnbkRldmljZXNTZXJ2aWNlLmFzc2lnbkRldmljZXModGhpcy5jdXJyZW50R3JvdXBJZCwgdGhpcy5zZWxlY3RlZCk7XG4gICAgdGhpcy5wZW5kaW5nU3RhdHVzID0gZmFsc2U7XG4gICAgdGhpcy5zZWxlY3RlZCA9IFtdO1xuXG4gICAgdGhpcy5vbkNhbmNlbC5lbWl0KCk7XG4gICAgdGhpcy5yZWZyZXNoLmVtaXQoKTtcblxuICAgIHRoaXMuYWxlcnQuc3VjY2VzcyhnZXR0ZXh0KCdEZXZpY2VzIGFzc2lnbmVkIHRvIHRoZSBncm91cC4nKSk7XG4gIH1cblxuICBvblNlbGVjdGVkKHNlbGVjdGVkRGV2aWNlc0lEczogc3RyaW5nW10pIHtcbiAgICB0aGlzLnNlbGVjdGVkID0gc2VsZWN0ZWREZXZpY2VzSURzO1xuICB9XG5cbiAgc2VsZWN0Q2hpbGRyZW4oYXNzZXQ6IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgdGhpcy5vblNob3dDaGlsZERldmljZXMuZW1pdCh0cnVlKTtcbiAgICB0aGlzLnNlbGVjdGVkRGV2aWNlLmVtaXQoYXNzZXQpO1xuICB9XG59XG4iXX0=