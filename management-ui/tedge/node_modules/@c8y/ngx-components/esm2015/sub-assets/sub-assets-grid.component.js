import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { IManagedObject, SmartGroupsService } from '@c8y/client';
import { DataGridComponent, gettext } from '@c8y/ngx-components';
import { BsModalService } from 'ngx-bootstrap/modal';
import { DeleteAssetsModalComponent } from './delete-assets-modal/delete-assets-modal.component';
import { SubAssetsService } from './sub-assets.service';
import { UnassignModalComponent } from './unassign-assets-modal/unassign-modal.component';
let SubAssetsGridComponent = class SubAssetsGridComponent {
    constructor(subAssetsGridService, bsModalService, smartGroupsService) {
        this.subAssetsGridService = subAssetsGridService;
        this.bsModalService = bsModalService;
        this.smartGroupsService = smartGroupsService;
        this.title = gettext('Subassets');
        this.emptyStateText = gettext('Add your first group or assign devices using the buttons on the toolbar.');
        this.loadingItemsLabel = gettext('Loading assetsâ€¦');
        this.selectable = false;
        this.baseQuery = {};
        this.filterable = true;
        this.sortable = true;
        this.onColumnsChange = new EventEmitter();
        this.itemsSelect = new EventEmitter();
        this.pagination = this.subAssetsGridService.getDefaultPagination();
        this.bulkActionControls = this.subAssetsGridService.getDefaultBulkActionControls();
        this.displayOptions = {
            striped: true,
            bordered: false,
            gridHeader: true,
            filter: true
        };
        this.serverSideDataCallback = this.onDataSourceModifier.bind(this);
    }
    get columns() {
        return this._columns;
    }
    set columns(value) {
        if (value) {
            this._columns = this.subAssetsGridService.getUserConfiguredColumns(value);
        }
        else {
            this._columns = this.subAssetsGridService.getUserConfiguredColumns(this.subAssetsGridService.getDefaultColumns());
        }
    }
    set _pagination(value) {
        if (value) {
            this.pagination = value;
        }
        else {
            this.pagination = this.subAssetsGridService.getDefaultPagination();
        }
    }
    set _actionControls(value) {
        if (value) {
            this.actionControls = value;
        }
        else {
            this.actionControls = this.subAssetsGridService.getDefaultActionControls();
        }
    }
    set _bulkActionControls(value) {
        if (value) {
            this.bulkActionControls = value;
        }
        else {
            this.bulkActionControls = this.subAssetsGridService.getDefaultBulkActionControls();
        }
    }
    get isRootGroup() {
        return !this.parentGroup;
    }
    get getInfiniteScrollMode() {
        return this.isRootGroup && this.subAssetsGridService.isUsingInventoryRoles()
            ? 'auto'
            : undefined;
    }
    set _displayOptions(displayOptions) {
        this.displayOptions = Object.assign({}, this.displayOptions, displayOptions);
    }
    ngOnInit() {
        this.columns = this.subAssetsGridService.getDefaultColumns(this.filterable, this.sortable);
        if (!this.filterable || !this.sortable) {
            this.columns.forEach(column => {
                column.filterable = this.filterable;
                column.sortable = this.sortable;
            });
        }
        this.setActionControls();
    }
    setActionControls() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const actionControls = [];
            const { data: isMicroserviceInstalled } = yield this.smartGroupsService.isSmartGroupsV2MicroserviceInstalled();
            const deleteAction = {
                type: "DELETE" /* Delete */,
                callback: (asset) => this.onDeleteAsset(asset, this.parentGroup),
                showIf: (asset) => {
                    if (this.smartGroupsService.isSmartGroupV2(asset)) {
                        return isMicroserviceInstalled ? this.subAssetsGridService.canDeleteSmartGroup() : false;
                    }
                    if (this.smartGroupsService.isSmartGroup(asset)) {
                        return this.subAssetsGridService.canDeleteSmartGroup();
                    }
                    return true;
                }
            };
            actionControls.push(deleteAction);
            const unassignAction = {
                type: 'UNASSIGN',
                icon: 'unlink',
                text: gettext('Unassign'),
                callback: (asset) => this.onUnassignAsset(asset, this.parentGroup),
                showIf: (asset) => this.subAssetsGridService.isDevice(asset) &&
                    !this.subAssetsGridService.isSmartGroup(this.parentGroup)
            };
            actionControls.push(unassignAction);
            if (!this.actionControls) {
                this.actionControls = actionControls;
            }
        });
    }
    onUnassignAsset(asset, parentRef) {
        const initialState = {
            asset
        };
        const modalRef = this.bsModalService.show(UnassignModalComponent, { initialState });
        modalRef.content.closeSubject.subscribe((result) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (result) {
                yield this.subAssetsGridService.unassignAsset(asset, parentRef);
                this.refresh.emit();
            }
        }));
    }
    onDeleteAsset(asset, parentRef) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const initialState = {
                showWithDeviceUserCheckbox: this.subAssetsGridService.shouldShowWithDeviceUserCheckbox(asset),
                asset,
                showWithCascadeCheckbox: !this.smartGroupsService.isSmartGroup(asset) &&
                    !this.smartGroupsService.isSmartGroupV2(asset)
            };
            const modalRef = this.bsModalService.show(DeleteAssetsModalComponent, { initialState });
            modalRef.content.closeSubject.subscribe((result) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                if (result) {
                    this.subAssetsGridService.uiOnlyCountersUpdate.next('DECREASE');
                    yield this.subAssetsGridService.deleteAsset(asset, parentRef, result);
                    this.refresh.emit();
                }
            }));
        });
    }
    ngOnChanges(changes) {
        if (changes.parentGroup && !changes.parentGroup.firstChange) {
            this.dataGrid.reload();
        }
    }
    trackByName(_index, column) {
        return column.name;
    }
    onDataSourceModifier(dataSourceModifier) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const promises = [];
            let counters;
            promises.push(this.subAssetsGridService.getData(dataSourceModifier.columns, dataSourceModifier.pagination, this.parentGroup, this.baseQuery));
            const action = this.subAssetsGridService.uiOnlyCountersUpdate.value;
            if (action) {
                counters = this.uiOnlyCountersUpdate(action);
                this.subAssetsGridService.uiOnlyCountersUpdate.next(null);
            }
            else {
                promises.push(this.subAssetsGridService.getTotal(this.parentGroup, this.baseQuery));
                promises.push(this.subAssetsGridService.getCount(dataSourceModifier.columns, dataSourceModifier.pagination, this.parentGroup, this.baseQuery));
            }
            const [dataResponse, size, filteredSize] = yield Promise.all(promises);
            if (!counters) {
                counters = {
                    size,
                    filteredSize
                };
            }
            this.onColumnsChange.emit(dataSourceModifier.columns);
            return Object.assign({ res: dataResponse.res, data: dataResponse.data, paging: dataResponse.paging }, counters);
        });
    }
    configChange(config) {
        this.subAssetsGridService.saveConfig(config);
    }
    // workaround since the totalPages value is cached on the BE
    uiOnlyCountersUpdate(action) {
        const currentAllItemsCount = this.dataGrid.filteringLabelsParams.allItemsCount;
        const currentFilteredItemsCount = this.dataGrid.filteringLabelsParams.filteredItemsCount;
        let counters;
        if (action === 'DECREASE') {
            counters = {
                size: currentAllItemsCount - 1,
                filteredSize: currentFilteredItemsCount - 1
            };
        }
        if (action === 'INCREASE') {
            counters = {
                size: currentAllItemsCount + 1,
                filteredSize: currentFilteredItemsCount + 1
            };
        }
        return counters;
    }
};
SubAssetsGridComponent.ctorParameters = () => [
    { type: SubAssetsService },
    { type: BsModalService },
    { type: SmartGroupsService }
];
tslib_1.__decorate([
    Input('parent-group')
], SubAssetsGridComponent.prototype, "parentGroup", void 0);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "refresh", void 0);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "title", void 0);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "emptyStateText", void 0);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "loadingItemsLabel", void 0);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "columns", null);
tslib_1.__decorate([
    Input('pagination')
], SubAssetsGridComponent.prototype, "_pagination", null);
tslib_1.__decorate([
    Input('actionControls')
], SubAssetsGridComponent.prototype, "_actionControls", null);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "selectable", void 0);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "baseQuery", void 0);
tslib_1.__decorate([
    Input('bulkActionControls')
], SubAssetsGridComponent.prototype, "_bulkActionControls", null);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "filterable", void 0);
tslib_1.__decorate([
    Input()
], SubAssetsGridComponent.prototype, "sortable", void 0);
tslib_1.__decorate([
    Output()
], SubAssetsGridComponent.prototype, "onColumnsChange", void 0);
tslib_1.__decorate([
    Output()
], SubAssetsGridComponent.prototype, "itemsSelect", void 0);
tslib_1.__decorate([
    ViewChild(DataGridComponent, { static: true })
], SubAssetsGridComponent.prototype, "dataGrid", void 0);
tslib_1.__decorate([
    Input('displayOptions')
], SubAssetsGridComponent.prototype, "_displayOptions", null);
SubAssetsGridComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-sub-assets-grid',
        template: "<c8y-data-grid\n  [title]=\"title\"\n  [loadingItemsLabel]=\"loadingItemsLabel\"\n  [columns]=\"columns\"\n  [pagination]=\"pagination\"\n  [actionControls]=\"actionControls\"\n  [selectable]=\"selectable\"\n  [bulkActionControls]=\"bulkActionControls\"\n  [serverSideDataCallback]=\"serverSideDataCallback\"\n  [infiniteScroll]=\"getInfiniteScrollMode\"\n  [refresh]=\"refresh\"\n  [displayOptions]=\"displayOptions\"\n  (onConfigChange)=\"configChange($event)\"\n  (itemsSelect)=\"itemsSelect.emit($event)\"\n  class=\"d-contents\"\n>\n  <ng-container *ngFor=\"let column of columns; trackBy: trackByName\">\n    <c8y-column [name]=\"column.name\"></c8y-column>\n  </ng-container>\n  <div class=\"c8y-empty-state\">\n    <h1 c8yIcon=\"c8y-group-add\" class=\"c8y-icon-duocolor\"></h1>\n    <div>\n      <p>\n        <strong>{{ 'No items to display.' | translate }}</strong>\n      </p>\n      <small>{{ emptyStateText | translate }}</small>\n    </div>\n  </div>\n</c8y-data-grid>\n"
    })
], SubAssetsGridComponent);
export { SubAssetsGridComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViLWFzc2V0cy1ncmlkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvc3ViLWFzc2V0cy8iLCJzb3VyY2VzIjpbInN1Yi1hc3NldHMtZ3JpZC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEVBRU4sU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDakUsT0FBTyxFQUlMLGlCQUFpQixFQUdqQixPQUFPLEVBSVIsTUFBTSxxQkFBcUIsQ0FBQztBQUU3QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFckQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0scURBQXFELENBQUM7QUFDakcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFLMUYsSUFBYSxzQkFBc0IsR0FBbkMsTUFBYSxzQkFBc0I7SUFtRmpDLFlBQ1Msb0JBQXNDLEVBQ3JDLGNBQThCLEVBQzlCLGtCQUFzQztRQUZ2Qyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQWtCO1FBQ3JDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBbkZ2QyxVQUFLLEdBQVcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JDLG1CQUFjLEdBQVcsT0FBTyxDQUN2QywwRUFBMEUsQ0FDM0UsQ0FBQztRQUNPLHNCQUFpQixHQUFXLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBNEJ2RCxlQUFVLEdBQVksS0FBSyxDQUFDO1FBQzVCLGNBQVMsR0FBUSxFQUFFLENBQUM7UUFRcEIs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bkI7QUFDd0I7SUFBeEIsS0FBSyxDQUFDLGdCQUFnQixDQUFDOzZEQU12QjtBQUNRO0lBQVIsS0FBSyxFQUFFOzBEQUE2QjtBQUM1QjtJQUFSLEtBQUssRUFBRTt5REFBcUI7QUFDQTtJQUE1QixLQUFLLENBQUMsb0JBQW9CLENBQUM7aUVBTTNCO0FBQ1E7SUFBUixLQUFLLEVBQUU7MERBQTRCO0FBQzNCO0lBQVIsS0FBSyxFQUFFO3dEQUEwQjtBQUN4QjtJQUFULE1BQU0sRUFBRTsrREFFTDtBQUNNO0lBQVQsTUFBTSxFQUFFOzJEQUFvRTtBQVE3RTtJQURDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQzt3REFDbkI7QUFzQjVCO0lBREMsS0FBSyxDQUFDLGdCQUFnQixDQUFDOzZEQUd2QjtBQWpGVSxzQkFBc0I7SUFKbEMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLHFCQUFxQjtRQUMvQixvK0JBQStDO0tBQ2hELENBQUM7R0FDVyxzQkFBc0IsQ0FpUWxDO1NBalFZLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0LCBTbWFydEdyb3Vwc1NlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQge1xuICBBY3Rpb25Db250cm9sLFxuICBCdWlsdEluQWN0aW9uVHlwZSxcbiAgQnVsa0FjdGlvbkNvbnRyb2wsXG4gIERhdGFHcmlkQ29tcG9uZW50LFxuICBEYXRhU291cmNlTW9kaWZpZXIsXG4gIERpc3BsYXlPcHRpb25zLFxuICBnZXR0ZXh0LFxuICBQYWdpbmF0aW9uLFxuICBSb3csXG4gIFNlcnZlclNpZGVEYXRhUmVzdWx0XG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgRGV2aWNlR3JpZENvbHVtbiB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvZGV2aWNlLWdyaWQnO1xuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICduZ3gtYm9vdHN0cmFwL21vZGFsJztcbmltcG9ydCB7IERlbGV0ZU1vZGFsQ2hlY2tib3hlcyB9IGZyb20gJy4vZGVsZXRlLWFzc2V0cy1tb2RhbCc7XG5pbXBvcnQgeyBEZWxldGVBc3NldHNNb2RhbENvbXBvbmVudCB9IGZyb20gJy4vZGVsZXRlLWFzc2V0cy1tb2RhbC9kZWxldGUtYXNzZXRzLW1vZGFsLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBTdWJBc3NldHNTZXJ2aWNlIH0gZnJvbSAnLi9zdWItYXNzZXRzLnNlcnZpY2UnO1xuaW1wb3J0IHsgVW5hc3NpZ25Nb2RhbENvbXBvbmVudCB9IGZyb20gJy4vdW5hc3NpZ24tYXNzZXRzLW1vZGFsL3VuYXNzaWduLW1vZGFsLmNvbXBvbmVudCc7XG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktc3ViLWFzc2V0cy1ncmlkJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3N1Yi1hc3NldHMtZ3JpZC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgU3ViQXNzZXRzR3JpZENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIEBJbnB1dCgncGFyZW50LWdyb3VwJykgcGFyZW50R3JvdXA6IElNYW5hZ2VkT2JqZWN0O1xuICBASW5wdXQoKSByZWZyZXNoOiBFdmVudEVtaXR0ZXI8YW55PjtcbiAgQElucHV0KCkgdGl0bGU6IHN0cmluZyA9IGdldHRleHQoJ1N1YmFzc2V0cycpO1xuICBASW5wdXQoKSBlbXB0eVN0YXRlVGV4dDogc3RyaW5nID0gZ2V0dGV4dChcbiAgICAnQWRkIHlvdXIgZmlyc3QgZ3JvdXAgb3IgYXNzaWduIGRldmljZXMgdXNpbmcgdGhlIGJ1dHRvbnMgb24gdGhlIHRvb2xiYXIuJ1xuICApO1xuICBASW5wdXQoKSBsb2FkaW5nSXRlbXNMYWJlbDogc3RyaW5nID0gZ2V0dGV4dCgnTG9hZGluZyBhc3NldHPigKYnKTtcblxuICBnZXQgY29sdW1ucygpIHtcbiAgICByZXR1cm4gdGhpcy5fY29sdW1ucztcbiAgfVxuICBASW5wdXQoKSBzZXQgY29sdW1ucyh2YWx1ZTogRGV2aWNlR3JpZENvbHVtbltdKSB7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLl9jb2x1bW5zID0gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5nZXRVc2VyQ29uZmlndXJlZENvbHVtbnModmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9jb2x1bW5zID0gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5nZXRVc2VyQ29uZmlndXJlZENvbHVtbnMoXG4gICAgICAgIHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0RGVmYXVsdENvbHVtbnMoKVxuICAgICAgKTtcbiAgICB9XG4gIH1cbiAgQElucHV0KCdwYWdpbmF0aW9uJykgc2V0IF9wYWdpbmF0aW9uKHZhbHVlOiBQYWdpbmF0aW9uKSB7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLnBhZ2luYXRpb24gPSB2YWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wYWdpbmF0aW9uID0gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5nZXREZWZhdWx0UGFnaW5hdGlvbigpO1xuICAgIH1cbiAgfVxuICBASW5wdXQoJ2FjdGlvbkNvbnRyb2xzJykgc2V0IF9hY3Rpb25Db250cm9scyh2YWx1ZTogQWN0aW9uQ29udHJvbFtdKSB7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLmFjdGlvbkNvbnRyb2xzID0gdmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWN0aW9uQ29udHJvbHMgPSB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmdldERlZmF1bHRBY3Rpb25Db250cm9scygpO1xuICAgIH1cbiAgfVxuICBASW5wdXQoKSBzZWxlY3RhYmxlOiBib29sZWFuID0gZmFsc2U7XG4gIEBJbnB1dCgpIGJhc2VRdWVyeTogYW55ID0ge307XG4gIEBJbnB1dCgnYnVsa0FjdGlvbkNvbnRyb2xzJykgc2V0IF9idWxrQWN0aW9uQ29udHJvbHModmFsdWU6IEJ1bGtBY3Rpb25Db250cm9sW10pIHtcbiAgICBpZiAodmFsdWUpIHtcbiAgICAgIHRoaXMuYnVsa0FjdGlvbkNvbnRyb2xzID0gdmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYnVsa0FjdGlvbkNvbnRyb2xzID0gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5nZXREZWZhdWx0QnVsa0FjdGlvbkNvbnRyb2xzKCk7XG4gICAgfVxuICB9XG4gIEBJbnB1dCgpIGZpbHRlcmFibGU6IGJvb2xlYW4gPSB0cnVlO1xuICBASW5wdXQoKSBzb3J0YWJsZTogYm9vbGVhbiA9IHRydWU7XG4gIEBPdXRwdXQoKSBvbkNvbHVtbnNDaGFuZ2U6IEV2ZW50RW1pdHRlcjxEZXZpY2VHcmlkQ29sdW1uW10+ID0gbmV3IEV2ZW50RW1pdHRlcjxcbiAgICBEZXZpY2VHcmlkQ29sdW1uW11cbiAgPigpO1xuICBAT3V0cHV0KCkgaXRlbXNTZWxlY3Q6IEV2ZW50RW1pdHRlcjxzdHJpbmdbXT4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZ1tdPigpO1xuXG4gIHBhZ2luYXRpb246IFBhZ2luYXRpb24gPSB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmdldERlZmF1bHRQYWdpbmF0aW9uKCk7XG4gIGFjdGlvbkNvbnRyb2xzOiBBY3Rpb25Db250cm9sW107XG4gIGJ1bGtBY3Rpb25Db250cm9sczogQnVsa0FjdGlvbkNvbnRyb2xbXSA9IHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0RGVmYXVsdEJ1bGtBY3Rpb25Db250cm9scygpO1xuICBzZXJ2ZXJTaWRlRGF0YUNhbGxiYWNrOiBhbnk7XG5cbiAgQFZpZXdDaGlsZChEYXRhR3JpZENvbXBvbmVudCwgeyBzdGF0aWM6IHRydWUgfSlcbiAgZGF0YUdyaWQ6IERhdGFHcmlkQ29tcG9uZW50O1xuXG4gIGRpc3BsYXlPcHRpb25zOiBEaXNwbGF5T3B0aW9ucyA9IHtcbiAgICBzdHJpcGVkOiB0cnVlLFxuICAgIGJvcmRlcmVkOiBmYWxzZSxcbiAgICBncmlkSGVhZGVyOiB0cnVlLFxuICAgIGZpbHRlcjogdHJ1ZVxuICB9O1xuXG4gIHByaXZhdGUgX2NvbHVtbnM6IERldmljZUdyaWRDb2x1bW5bXTtcblxuICBnZXQgaXNSb290R3JvdXAoKSB7XG4gICAgcmV0dXJuICF0aGlzLnBhcmVudEdyb3VwO1xuICB9XG5cbiAgZ2V0IGdldEluZmluaXRlU2Nyb2xsTW9kZSgpIHtcbiAgICByZXR1cm4gdGhpcy5pc1Jvb3RHcm91cCAmJiB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmlzVXNpbmdJbnZlbnRvcnlSb2xlcygpXG4gICAgICA/ICdhdXRvJ1xuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBASW5wdXQoJ2Rpc3BsYXlPcHRpb25zJylcbiAgc2V0IF9kaXNwbGF5T3B0aW9ucyhkaXNwbGF5T3B0aW9ucykge1xuICAgIHRoaXMuZGlzcGxheU9wdGlvbnMgPSB7IC4uLnRoaXMuZGlzcGxheU9wdGlvbnMsIC4uLmRpc3BsYXlPcHRpb25zIH07XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgc3ViQXNzZXRzR3JpZFNlcnZpY2U6IFN1YkFzc2V0c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBic01vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBzbWFydEdyb3Vwc1NlcnZpY2U6IFNtYXJ0R3JvdXBzU2VydmljZVxuICApIHtcbiAgICB0aGlzLnNlcnZlclNpZGVEYXRhQ2FsbGJhY2sgPSB0aGlzLm9uRGF0YVNvdXJjZU1vZGlmaWVyLmJpbmQodGhpcyk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmNvbHVtbnMgPSB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmdldERlZmF1bHRDb2x1bW5zKHRoaXMuZmlsdGVyYWJsZSwgdGhpcy5zb3J0YWJsZSk7XG4gICAgaWYgKCF0aGlzLmZpbHRlcmFibGUgfHwgIXRoaXMuc29ydGFibGUpIHtcbiAgICAgIHRoaXMuY29sdW1ucy5mb3JFYWNoKGNvbHVtbiA9PiB7XG4gICAgICAgIGNvbHVtbi5maWx0ZXJhYmxlID0gdGhpcy5maWx0ZXJhYmxlO1xuICAgICAgICBjb2x1bW4uc29ydGFibGUgPSB0aGlzLnNvcnRhYmxlO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMuc2V0QWN0aW9uQ29udHJvbHMoKTtcbiAgfVxuXG4gIGFzeW5jIHNldEFjdGlvbkNvbnRyb2xzKCkge1xuICAgIGNvbnN0IGFjdGlvbkNvbnRyb2xzOiBBY3Rpb25Db250cm9sW10gPSBbXTtcbiAgICBjb25zdCB7XG4gICAgICBkYXRhOiBpc01pY3Jvc2VydmljZUluc3RhbGxlZFxuICAgIH0gPSBhd2FpdCB0aGlzLnNtYXJ0R3JvdXBzU2VydmljZS5pc1NtYXJ0R3JvdXBzVjJNaWNyb3NlcnZpY2VJbnN0YWxsZWQoKTtcblxuICAgIGNvbnN0IGRlbGV0ZUFjdGlvbjogQWN0aW9uQ29udHJvbCA9IHtcbiAgICAgIHR5cGU6IEJ1aWx0SW5BY3Rpb25UeXBlLkRlbGV0ZSxcbiAgICAgIGNhbGxiYWNrOiAoYXNzZXQ6IFJvdykgPT4gdGhpcy5vbkRlbGV0ZUFzc2V0KGFzc2V0IGFzIElNYW5hZ2VkT2JqZWN0LCB0aGlzLnBhcmVudEdyb3VwKSxcbiAgICAgIHNob3dJZjogKGFzc2V0OiBSb3cpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuc21hcnRHcm91cHNTZXJ2aWNlLmlzU21hcnRHcm91cFYyKGFzc2V0IGFzIElNYW5hZ2VkT2JqZWN0KSkge1xuICAgICAgICAgIHJldHVybiBpc01pY3Jvc2VydmljZUluc3RhbGxlZCA/IHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuY2FuRGVsZXRlU21hcnRHcm91cCgpIDogZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zbWFydEdyb3Vwc1NlcnZpY2UuaXNTbWFydEdyb3VwKGFzc2V0IGFzIElNYW5hZ2VkT2JqZWN0KSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmNhbkRlbGV0ZVNtYXJ0R3JvdXAoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBhY3Rpb25Db250cm9scy5wdXNoKGRlbGV0ZUFjdGlvbik7XG5cbiAgICBjb25zdCB1bmFzc2lnbkFjdGlvbjogQWN0aW9uQ29udHJvbCA9IHtcbiAgICAgIHR5cGU6ICdVTkFTU0lHTicsXG4gICAgICBpY29uOiAndW5saW5rJyxcbiAgICAgIHRleHQ6IGdldHRleHQoJ1VuYXNzaWduJyksXG4gICAgICBjYWxsYmFjazogKGFzc2V0OiBSb3cpID0+IHRoaXMub25VbmFzc2lnbkFzc2V0KGFzc2V0IGFzIElNYW5hZ2VkT2JqZWN0LCB0aGlzLnBhcmVudEdyb3VwKSxcbiAgICAgIHNob3dJZjogKGFzc2V0OiBSb3cpID0+XG4gICAgICAgIHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuaXNEZXZpY2UoYXNzZXQgYXMgSU1hbmFnZWRPYmplY3QpICYmXG4gICAgICAgICF0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmlzU21hcnRHcm91cCh0aGlzLnBhcmVudEdyb3VwIGFzIElNYW5hZ2VkT2JqZWN0KVxuICAgIH07XG5cbiAgICBhY3Rpb25Db250cm9scy5wdXNoKHVuYXNzaWduQWN0aW9uKTtcblxuICAgIGlmICghdGhpcy5hY3Rpb25Db250cm9scykge1xuICAgICAgdGhpcy5hY3Rpb25Db250cm9scyA9IGFjdGlvbkNvbnRyb2xzO1xuICAgIH1cbiAgfVxuXG4gIG9uVW5hc3NpZ25Bc3NldChhc3NldDogSU1hbmFnZWRPYmplY3QsIHBhcmVudFJlZjogSU1hbmFnZWRPYmplY3QpIHtcbiAgICBjb25zdCBpbml0aWFsU3RhdGUgPSB7XG4gICAgICBhc3NldFxuICAgIH07XG4gICAgY29uc3QgbW9kYWxSZWYgPSB0aGlzLmJzTW9kYWxTZXJ2aWNlLnNob3coVW5hc3NpZ25Nb2RhbENvbXBvbmVudCwgeyBpbml0aWFsU3RhdGUgfSk7XG5cbiAgICBtb2RhbFJlZi5jb250ZW50LmNsb3NlU3ViamVjdC5zdWJzY3JpYmUoYXN5bmMgKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICBhd2FpdCB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLnVuYXNzaWduQXNzZXQoYXNzZXQsIHBhcmVudFJlZik7XG4gICAgICAgIHRoaXMucmVmcmVzaC5lbWl0KCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBvbkRlbGV0ZUFzc2V0KGFzc2V0OiBJTWFuYWdlZE9iamVjdCwgcGFyZW50UmVmOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHtcbiAgICAgIHNob3dXaXRoRGV2aWNlVXNlckNoZWNrYm94OiB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLnNob3VsZFNob3dXaXRoRGV2aWNlVXNlckNoZWNrYm94KGFzc2V0KSxcbiAgICAgIGFzc2V0LFxuICAgICAgc2hvd1dpdGhDYXNjYWRlQ2hlY2tib3g6XG4gICAgICAgICF0aGlzLnNtYXJ0R3JvdXBzU2VydmljZS5pc1NtYXJ0R3JvdXAoYXNzZXQpICYmXG4gICAgICAgICF0aGlzLnNtYXJ0R3JvdXBzU2VydmljZS5pc1NtYXJ0R3JvdXBWMihhc3NldClcbiAgICB9O1xuXG4gICAgY29uc3QgbW9kYWxSZWYgPSB0aGlzLmJzTW9kYWxTZXJ2aWNlLnNob3coRGVsZXRlQXNzZXRzTW9kYWxDb21wb25lbnQsIHsgaW5pdGlhbFN0YXRlIH0pO1xuXG4gICAgbW9kYWxSZWYuY29udGVudC5jbG9zZVN1YmplY3Quc3Vic2NyaWJlKGFzeW5jIChyZXN1bHQ6IERlbGV0ZU1vZGFsQ2hlY2tib3hlcykgPT4ge1xuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLnVpT25seUNvdW50ZXJzVXBkYXRlLm5leHQoJ0RFQ1JFQVNFJyk7XG4gICAgICAgIGF3YWl0IHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZGVsZXRlQXNzZXQoYXNzZXQsIHBhcmVudFJlZiwgcmVzdWx0KTtcbiAgICAgICAgdGhpcy5yZWZyZXNoLmVtaXQoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlcy5wYXJlbnRHcm91cCAmJiAhY2hhbmdlcy5wYXJlbnRHcm91cC5maXJzdENoYW5nZSkge1xuICAgICAgdGhpcy5kYXRhR3JpZC5yZWxvYWQoKTtcbiAgICB9XG4gIH1cblxuICB0cmFja0J5TmFtZShfaW5kZXgsIGNvbHVtbjogRGV2aWNlR3JpZENvbHVtbik6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNvbHVtbi5uYW1lO1xuICB9XG5cbiAgYXN5bmMgb25EYXRhU291cmNlTW9kaWZpZXIoXG4gICAgZGF0YVNvdXJjZU1vZGlmaWVyOiBEYXRhU291cmNlTW9kaWZpZXJcbiAgKTogUHJvbWlzZTxTZXJ2ZXJTaWRlRGF0YVJlc3VsdD4ge1xuICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgbGV0IGNvdW50ZXJzO1xuXG4gICAgcHJvbWlzZXMucHVzaChcbiAgICAgIHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0RGF0YShcbiAgICAgICAgZGF0YVNvdXJjZU1vZGlmaWVyLmNvbHVtbnMsXG4gICAgICAgIGRhdGFTb3VyY2VNb2RpZmllci5wYWdpbmF0aW9uLFxuICAgICAgICB0aGlzLnBhcmVudEdyb3VwLFxuICAgICAgICB0aGlzLmJhc2VRdWVyeVxuICAgICAgKVxuICAgICk7XG5cbiAgICBjb25zdCBhY3Rpb24gPSB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLnVpT25seUNvdW50ZXJzVXBkYXRlLnZhbHVlO1xuICAgIGlmIChhY3Rpb24pIHtcbiAgICAgIGNvdW50ZXJzID0gdGhpcy51aU9ubHlDb3VudGVyc1VwZGF0ZShhY3Rpb24pO1xuICAgICAgdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS51aU9ubHlDb3VudGVyc1VwZGF0ZS5uZXh0KG51bGwpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcm9taXNlcy5wdXNoKHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0VG90YWwodGhpcy5wYXJlbnRHcm91cCwgdGhpcy5iYXNlUXVlcnkpKTtcbiAgICAgIHByb21pc2VzLnB1c2goXG4gICAgICAgIHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0Q291bnQoXG4gICAgICAgICAgZGF0YVNvdXJjZU1vZGlmaWVyLmNvbHVtbnMsXG4gICAgICAgICAgZGF0YVNvdXJjZU1vZGlmaWVyLnBhZ2luYXRpb24sXG4gICAgICAgICAgdGhpcy5wYXJlbnRHcm91cCxcbiAgICAgICAgICB0aGlzLmJhc2VRdWVyeVxuICAgICAgICApXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBbZGF0YVJlc3BvbnNlLCBzaXplLCBmaWx0ZXJlZFNpemVdID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIGlmICghY291bnRlcnMpIHtcbiAgICAgIGNvdW50ZXJzID0ge1xuICAgICAgICBzaXplLFxuICAgICAgICBmaWx0ZXJlZFNpemVcbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMub25Db2x1bW5zQ2hhbmdlLmVtaXQoZGF0YVNvdXJjZU1vZGlmaWVyLmNvbHVtbnMpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJlczogZGF0YVJlc3BvbnNlLnJlcyxcbiAgICAgIGRhdGE6IGRhdGFSZXNwb25zZS5kYXRhLFxuICAgICAgcGFnaW5nOiBkYXRhUmVzcG9uc2UucGFnaW5nLFxuICAgICAgLi4uY291bnRlcnNcbiAgICB9O1xuICB9XG5cbiAgY29uZmlnQ2hhbmdlKGNvbmZpZykge1xuICAgIHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2Uuc2F2ZUNvbmZpZyhjb25maWcpO1xuICB9XG5cbiAgLy8gd29ya2Fyb3VuZCBzaW5jZSB0aGUgdG90YWxQYWdlcyB2YWx1ZSBpcyBjYWNoZWQgb24gdGhlIEJFXG4gIHByaXZhdGUgdWlPbmx5Q291bnRlcnNVcGRhdGUoYWN0aW9uOiAnSU5DUkVBU0UnIHwgJ0RFQ1JFQVNFJykge1xuICAgIGNvbnN0IGN1cnJlbnRBbGxJdGVtc0NvdW50ID0gdGhpcy5kYXRhR3JpZC5maWx0ZXJpbmdMYWJlbHNQYXJhbXMuYWxsSXRlbXNDb3VudDtcbiAgICBjb25zdCBjdXJyZW50RmlsdGVyZWRJdGVtc0NvdW50ID0gdGhpcy5kYXRhR3JpZC5maWx0ZXJpbmdMYWJlbHNQYXJhbXMuZmlsdGVyZWRJdGVtc0NvdW50O1xuICAgIGxldCBjb3VudGVycztcbiAgICBpZiAoYWN0aW9uID09PSAnREVDUkVBU0UnKSB7XG4gICAgICBjb3VudGVycyA9IHtcbiAgICAgICAgc2l6ZTogY3VycmVudEFsbEl0ZW1zQ291bnQgLSAxLFxuICAgICAgICBmaWx0ZXJlZFNpemU6IGN1cnJlbnRGaWx0ZXJlZEl0ZW1zQ291bnQgLSAxXG4gICAgICB9O1xuICAgIH1cbiAgICBpZiAoYWN0aW9uID09PSAnSU5DUkVBU0UnKSB7XG4gICAgICBjb3VudGVycyA9IHtcbiAgICAgICAgc2l6ZTogY3VycmVudEFsbEl0ZW1zQ291bnQgKyAxLFxuICAgICAgICBmaWx0ZXJlZFNpemU6IGN1cnJlbnRGaWx0ZXJlZEl0ZW1zQ291bnQgKyAxXG4gICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gY291bnRlcnM7XG4gIH1cbn1cbiJdfQ==