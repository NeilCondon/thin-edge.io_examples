import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { Injectable } from '@angular/core';
import { StateService } from '../common/state-service.abstract';
import { gettext } from '../i18n/gettext';
import { isEqual } from 'lodash-es';
import * as i0 from "@angular/core";
/**
 * A service which allows to display alerts.
 */
var AlertService = /** @class */ (function (_super) {
    tslib_1.__extends(AlertService, _super);
    function AlertService() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        /**
         * @ignore
         */
        _this.state$ = new BehaviorSubject([]);
        _this.MAX_ALERTS = 3;
        _this.ALERT_TIMEOUT = 3000;
        return _this;
    }
    Object.defineProperty(AlertService.prototype, "state", {
        /**
         * Returns all alerts.
         * @readonly
         */
        get: function () {
            return this.state$.value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Adds a new alert to the current state.
     */
    AlertService.prototype.add = function (alert) {
        this.addAlert(alert);
    };
    /**
     * Adds a alert by text.
     */
    AlertService.prototype.addByText = function (type, txt, detailedData) {
        this.addAlert({ text: txt, type: type, detailedData: detailedData });
    };
    /**
     * Returns all alerts.
     * @deprecated Use alertService.alerts instead.
     */
    AlertService.prototype.list = function () {
        return this.state;
    };
    /**
     * Remove an alert from the current state.
     */
    AlertService.prototype.remove = function (alert) {
        var _this = this;
        this.changeAlerts(this.state.filter(function (item) { return !_this.areSame(alert, item); }));
    };
    /**
     * Updates matching alert with provided values.
     */
    AlertService.prototype.update = function (alert, fieldsToUpdate) {
        var _this = this;
        this.changeAlerts(this.state.map(function (item) {
            if (_this.areSame(alert, item)) {
                Object.assign(item, fieldsToUpdate);
            }
            return item;
        }));
    };
    /**
     * Removes last danger alert.
     * It can be used e.g. in the case of a failed request which triggered an alert, to hide it from user.
     *
     * ```js
     *  try {
     *    // something that might throw a danger server msg
     *  } catch (ex) {
     *   this.alertService.removeLastDanger();
     *  }
     * ```
     */
    AlertService.prototype.removeLastDanger = function () {
        var firstDangerAlert = this.state.reverse().find(function (_a) {
            var type = _a.type;
            return type === 'danger';
        });
        this.changeAlerts(this.state.filter(function (alert) { return alert !== firstDangerAlert; }));
    };
    /**
     * Shorthand for a save successful alert.
     * @param savedObject The object which was saved.
     * @return A function that can be executed to show the msg.
     */
    AlertService.prototype.saveSuccess = function (savedObject) {
        var _this = this;
        return function () {
            var text = savedObject + " saved successfully";
            _this.addByText('success', text);
        };
    };
    /**
     * Shorthand for a create successful alert.
     * @param createdObject The object which was created.
     * @return A function that can be executed to show the msg.
     */
    AlertService.prototype.createSuccess = function (createdObject) {
        var _this = this;
        return function () {
            var text = createdObject + " created successfully";
            _this.addByText('success', text);
        };
    };
    /**
     * Clears all alerts.
     */
    AlertService.prototype.clearAll = function () {
        this.changeAlerts([]);
    };
    /**
     * A shorthand to display a simple success message.
     * @param text The success text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.success = function (text, detailedData) {
        this.addByText('success', text, detailedData);
    };
    /**
     * A shorthand to display a simple danger message.
     * @param text The danger text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.danger = function (text, detailedData) {
        this.addByText('danger', text, detailedData);
    };
    /**
     * A shorthand to display a simple info message.
     * @param text The info text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.info = function (text, detailedData) {
        this.addByText('info', text, detailedData);
    };
    /**
     * A shorthand to display a simple warning message.
     * @param text The warning text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.warning = function (text, detailedData) {
        this.addByText('warning', text, detailedData);
    };
    /**
     * Creates alert from standard api errors.
     * Should be used for errors generated by @c8y/client services.
     * @param {IResult}  error The error from server.
     * @param {alertType} type The type of alert.
     */
    AlertService.prototype.addServerFailure = function (error, type) {
        if (type === void 0) { type = 'danger'; }
        var data = error.data, res = error.res;
        var text = data && data.message ? data.message : null;
        var detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        var hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (!hasRelevantMessage) {
            detailedData = {
                status: res.status,
                statusText: res.statusText,
                url: res.url
            };
        }
        this.addAlert({
            type: type,
            text: text,
            detailedData: detailedData
        });
    };
    /**
     * Compares two alert objects. Alerts are same if text, type, detailed data and callbacks are same.
     * Callbacks are same if they refer to the same function.
     */
    AlertService.prototype.areSame = function (alert1, alert2) {
        return (alert1.text === alert2.text &&
            alert1.type === alert2.type &&
            isEqual(alert1.detailedData, alert2.detailedData) &&
            alert1.onClose === alert2.onClose &&
            alert1.onDetail === alert2.onDetail);
    };
    AlertService.prototype.changeAlerts = function (newAlerts) {
        this.state$.next(newAlerts);
    };
    AlertService.prototype.addAlert = function (alert) {
        var _this = this;
        if (!alert.text && !alert.type) {
            throw new Error('Cannot add empty alert');
        }
        var alertAlreadyAdded = this.state.find(function (item) { return _this.areSame(alert, item); });
        if (alertAlreadyAdded) {
            return;
        }
        this.changeAlerts(tslib_1.__spread(this.state, [alert]));
        this.hideAutomaticallyIfNeeded(alert);
        this.removeOldestIfMax();
    };
    AlertService.prototype.hideAutomaticallyIfNeeded = function (alert) {
        var _this = this;
        var isSuccess = alert.type === 'success';
        var noDetails = !alert.detailedData;
        var alertTimeout = isSuccess && noDetails ? this.ALERT_TIMEOUT : 0;
        if (typeof alert.timeout !== 'undefined') {
            alertTimeout = alert.timeout;
        }
        if (alertTimeout) {
            setTimeout(function () { return _this.remove(alert); }, alertTimeout);
        }
    };
    AlertService.prototype.removeOldestIfMax = function () {
        if (this.state.length > this.MAX_ALERTS) {
            var _a = tslib_1.__read(this.state), firstRemoved = _a.slice(1);
            this.changeAlerts(firstRemoved);
        }
    };
    AlertService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AlertService_Factory() { return new AlertService(); }, token: AlertService, providedIn: "root" });
    AlertService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root'
        })
    ], AlertService);
    return AlertService;
}(StateService));
export { AlertService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2FsZXJ0L2FsZXJ0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7O0FBR3BDOztHQUVHO0FBSUg7SUFBa0Msd0NBQVk7SUFIOUM7UUFBQSxxRUF5T0M7UUE5TkM7O1dBRUc7UUFDSCxZQUFNLEdBQUcsSUFBSSxlQUFlLENBQVUsRUFBRSxDQUFDLENBQUM7UUFFbEMsZ0JBQVUsR0FBRyxDQUFDLENBQUM7UUFDZixtQkFBYSxHQUFHLElBQUksQ0FBQzs7S0F3TjlCO0lBak9DLHNCQUFJLCtCQUFLO1FBSlQ7OztXQUdHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQzNCLENBQUM7OztPQUFBO0lBU0Q7O09BRUc7SUFDSCwwQkFBRyxHQUFILFVBQUksS0FBWTtRQUNkLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsZ0NBQVMsR0FBVCxVQUFVLElBQWUsRUFBRSxHQUFXLEVBQUUsWUFBcUI7UUFDM0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxNQUFBLEVBQUUsWUFBWSxjQUFBLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRDs7O09BR0c7SUFDSCwyQkFBSSxHQUFKO1FBQ0UsT0FBTyxJ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YUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbkUsSUFBSSxPQUFPLEtBQUssQ0FBQyxPQUFPLEtBQUssV0FBVyxFQUFFO1lBQ3hDLFlBQVksR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1NBQzlCO1FBQ0QsSUFBSSxZQUFZLEVBQUU7WUFDaEIsVUFBVSxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFsQixDQUFrQixFQUFFLFlBQVksQ0FBQyxDQUFDO1NBQ3BEO0lBQ0gsQ0FBQztJQUVPLHdDQUFpQixHQUF6QjtRQUNFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqQyxJQUFBLCtCQUFnQyxFQUE3QiwwQkFBNkIsQ0FBQztZQUN2QyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQzs7SUFyT1UsWUFBWTtRQUh4QixVQUFVLENBQUM7WUFDVixVQUFVLEVBQUUsTUFBTTtTQUNuQixDQUFDO09BQ1csWUFBWSxDQXNPeEI7dUJBclBEO0NBcVBDLEFBdE9ELENBQWtDLFlBQVksR0FzTzdDO1NBdE9ZLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbGVydCB9IGZyb20gJy4vYWxlcnQubW9kZWwnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vc3RhdGUtc2VydmljZS5hYnN0cmFjdCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnLi4vaTE4bi9nZXR0ZXh0JztcbmltcG9ydCB7SVJlc3VsdH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgaXNFcXVhbCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbnR5cGUgYWxlcnRUeXBlID0gJ3N1Y2Nlc3MnIHwgJ3dhcm5pbmcnIHwgJ2RhbmdlcicgfCAnaW5mbycgfCAnc3lzdGVtJztcbi8qKlxuICogQSBzZXJ2aWNlIHdoaWNoIGFsbG93cyB0byBkaXNwbGF5IGFsZXJ0cy5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQWxlcnRTZXJ2aWNlIGV4dGVuZHMgU3RhdGVTZXJ2aWNlIHtcbiAgLyoqXG4gICAqIFJldHVybnMgYWxsIGFsZXJ0cy5cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgc3RhdGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUkLnZhbHVlO1xuICB9XG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBzdGF0ZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEFsZXJ0W10+KFtdKTtcblxuICBwcml2YXRlIE1BWF9BTEVSVFMgPSAzO1xuICBwcml2YXRlIEFMRVJUX1RJTUVPVVQgPSAzMDAwO1xuXG4gIC8qKlxuICAgKiBBZGRzIGEgbmV3IGFsZXJ0IHRvIHRoZSBjdXJyZW50IHN0YXRlLlxuICAgKi9cbiAgYWRkKGFsZXJ0OiBBbGVydCkge1xuICAgIHRoaXMuYWRkQWxlcnQoYWxlcnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBhbGVydCBieSB0ZXh0LlxuICAgKi9cbiAgYWRkQnlUZXh0KHR5cGU6IGFsZXJ0VHlwZSwgdHh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuYWRkQWxlcnQoeyB0ZXh0OiB0eHQsIHR5cGUsIGRldGFpbGVkRGF0YSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFsbCBhbGVydHMuXG4gICAqIEBkZXByZWNhdGVkIFVzZSBhbGVydFNlcnZpY2UuYWxlcnRzIGluc3RlYWQuXG4gICAqL1xuICBsaXN0KCk6IEFsZXJ0W10ge1xuICAgIHJldHVybiB0aGlzLnN0YXRlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhbiBhbGVydCBmcm9tIHRoZSBjdXJyZW50IHN0YXRlLlxuICAgKi9cbiAgcmVtb3ZlKGFsZXJ0OiBBbGVydCkge1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKHRoaXMuc3RhdGUuZmlsdGVyKGl0ZW0gPT4gIXRoaXMuYXJlU2FtZShhbGVydCwgaXRlbSkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIG1hdGNoaW5nIGFsZXJ0IHdpdGggcHJvdmlkZWQgdmFsdWVzLlxuICAgKi9cbiAgdXBkYXRlKGFsZXJ0OiBBbGVydCwgZmllbGRzVG9VcGRhdGU6IFBhcnRpYWw8QWxlcnQ+KSB7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoXG4gICAgICB0aGlzLnN0YXRlLm1hcChpdGVtID0+IHtcbiAgICAgICAgaWYgKHRoaXMuYXJlU2FtZShhbGVydCwgaXRlbSkpIHtcbiAgICAgICAgICBPYmplY3QuYXNzaWduKGl0ZW0sIGZpZWxkc1RvVXBkYXRlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGxhc3QgZGFuZ2VyIGFsZXJ0LlxuICAgKiBJdCBjYW4gYmUgdXNlZCBlLmcuIGluIHRoZSBjYXNlIG9mIGEgZmFpbGVkIHJlcXVlc3Qgd2hpY2ggdHJpZ2dlcmVkIGFuIGFsZXJ0LCB0byBoaWRlIGl0IGZyb20gdXNlci5cbiAgICpcbiAgICogYGBganNcbiAgICogIHRyeSB7XG4gICAqICAgIC8vIHNvbWV0aGluZyB0aGF0IG1pZ2h0IHRocm93IGEgZGFuZ2VyIHNlcnZlciBtc2dcbiAgICogIH0gY2F0Y2ggKGV4KSB7XG4gICAqICAgdGhpcy5hbGVydFNlcnZpY2UucmVtb3ZlTGFzdERhbmdlcigpO1xuICAgKiAgfVxuICAgKiBgYGBcbiAgICovXG4gIHJlbW92ZUxhc3REYW5nZXIoKSB7XG4gICAgY29uc3QgZmlyc3REYW5nZXJBbGVydCA9IHRoaXMuc3RhdGUucmV2ZXJzZSgpLmZpbmQoKHsgdHlwZSB9KSA9PiB0eXBlID09PSAnZGFuZ2VyJyk7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHModGhpcy5zdGF0ZS5maWx0ZXIoYWxlcnQgPT4gYWxlcnQgIT09IGZpcnN0RGFuZ2VyQWxlcnQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG9ydGhhbmQgZm9yIGEgc2F2ZSBzdWNjZXNzZnVsIGFsZXJ0LlxuICAgKiBAcGFyYW0gc2F2ZWRPYmplY3QgVGhlIG9iamVjdCB3aGljaCB3YXMgc2F2ZWQuXG4gICAqIEByZXR1cm4gQSBmdW5jdGlvbiB0aGF0IGNhbiBiZSBleGVjdXRlZCB0byBzaG93IHRoZSBtc2cuXG4gICAqL1xuICBzYXZlU3VjY2VzcyhzYXZlZE9iamVjdDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHRleHQgPSBgJHtzYXZlZE9iamVjdH0gc2F2ZWQgc3VjY2Vzc2Z1bGx5YDtcbiAgICAgIHRoaXMuYWRkQnlUZXh0KCdzdWNjZXNzJywgdGV4dCk7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG9ydGhhbmQgZm9yIGEgY3JlYXRlIHN1Y2Nlc3NmdWwgYWxlcnQuXG4gICAqIEBwYXJhbSBjcmVhdGVkT2JqZWN0IFRoZSBvYmplY3Qgd2hpY2ggd2FzIGNyZWF0ZWQuXG4gICAqIEByZXR1cm4gQSBmdW5jdGlvbiB0aGF0IGNhbiBiZSBleGVjdXRlZCB0byBzaG93IHRoZSBtc2cuXG4gICAqL1xuICBjcmVhdGVTdWNjZXNzKGNyZWF0ZWRPYmplY3QpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgdGV4dCA9IGAke2NyZWF0ZWRPYmplY3R9IGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5YDtcbiAgICAgIHRoaXMuYWRkQnlUZXh0KCdzdWNjZXNzJywgdGV4dCk7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhcnMgYWxsIGFsZXJ0cy5cbiAgICovXG4gIGNsZWFyQWxsKCkge1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKFtdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIHN1Y2Nlc3MgbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIHN1Y2Nlc3MgdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICBzdWNjZXNzKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ3N1Y2Nlc3MnLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgZGFuZ2VyIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSBkYW5nZXIgdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICBkYW5nZXIodGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnZGFuZ2VyJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIGluZm8gbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIGluZm8gdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICBpbmZvKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ2luZm8nLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgd2FybmluZyBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgd2FybmluZyB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIHdhcm5pbmcodGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnd2FybmluZycsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhbGVydCBmcm9tIHN0YW5kYXJkIGFwaSBlcnJvcnMuXG4gICAqIFNob3VsZCBiZSB1c2VkIGZvciBlcnJvcnMgZ2VuZXJhdGVkIGJ5IEBjOHkvY2xpZW50IHNlcnZpY2VzLlxuICAgKiBAcGFyYW0ge0lSZXN1bHR9ICBlcnJvciBUaGUgZXJyb3IgZnJvbSBzZXJ2ZXIuXG4gICAqIEBwYXJhbSB7YWxlcnRUeXBlfSB0eXBlIFRoZSB0eXBlIG9mIGFsZXJ0LlxuICAgKi9cbiAgYWRkU2VydmVyRmFpbHVyZShlcnJvcjogYW55LCB0eXBlOiBhbGVydFR5cGUgPSAnZGFuZ2VyJykge1xuICAgIGNvbnN0IHsgZGF0YSwgcmVzIH0gPSBlcnJvcjtcbiAgICBsZXQgdGV4dCA9IGRhdGEgJiYgZGF0YS5tZXNzYWdlID8gZGF0YS5tZXNzYWdlIDogbnVsbDtcbiAgICBsZXQgZGV0YWlsZWREYXRhO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGRldGFpbGVkRGF0YSA9IGRhdGEuZXhjZXB0aW9uTWVzc2FnZTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGRldGFpbGVkRGF0YSA9IGRhdGE7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGhhc1JlbGV2YW50TWVzc2FnZSA9ICEhKHRleHQgfHwgZGV0YWlsZWREYXRhKTtcbiAgICBpZiAoIXRleHQpIHtcbiAgICAgIHRleHQgPSBnZXR0ZXh0KCdBIHNlcnZlciBlcnJvciBvY2N1cnJlZC4nKTtcbiAgICB9XG4gICAgaWYgKCFoYXNSZWxldmFudE1lc3NhZ2UpIHtcbiAgICAgIGRldGFpbGVkRGF0YSA9IHtcbiAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzLFxuICAgICAgICBzdGF0dXNUZXh0OiByZXMuc3RhdHVzVGV4dCxcbiAgICAgICAgdXJsOiByZXMudXJsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHRoaXMuYWRkQWxlcnQoe1xuICAgICAgdHlwZSxcbiAgICAgIHRleHQsXG4gICAgICBkZXRhaWxlZERhdGFcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wYXJlcyB0d28gYWxlcnQgb2JqZWN0cy4gQWxlcnRzIGFyZSBzYW1lIGlmIHRleHQsIHR5cGUsIGRldGFpbGVkIGRhdGEgYW5kIGNhbGxiYWNrcyBhcmUgc2FtZS5cbiAgICogQ2FsbGJhY2tzIGFyZSBzYW1lIGlmIHRoZXkgcmVmZXIgdG8gdGhlIHNhbWUgZnVuY3Rpb24uXG4gICAqL1xuICBhcmVTYW1lKGFsZXJ0MTogQWxlcnQsIGFsZXJ0MjogQWxlcnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgYWxlcnQxLnRleHQgPT09IGFsZXJ0Mi50ZXh0ICYmXG4gICAgICBhbGVydDEudHlwZSA9PT0gYWxlcnQyLnR5cGUgJiZcbiAgICAgIGlzRXF1YWwoYWxlcnQxLmRldGFpbGVkRGF0YSwgYWxlcnQyLmRldGFpbGVkRGF0YSkgJiZcbiAgICAgIGFsZXJ0MS5vbkNsb3NlID09PSBhbGVydDIub25DbG9zZSAmJlxuICAgICAgYWxlcnQxLm9uRGV0YWlsID09PSBhbGVydDIub25EZXRhaWxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGFuZ2VBbGVydHMobmV3QWxlcnRzOiBBbGVydFtdKSB7XG4gICAgdGhpcy5zdGF0ZSQubmV4dChuZXdBbGVydHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRBbGVydChhbGVydDogQWxlcnQpOiB2b2lkIHtcbiAgICBpZiAoIWFsZXJ0LnRleHQgJiYgIWFsZXJ0LnR5cGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGFkZCBlbXB0eSBhbGVydCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGFsZXJ0QWxyZWFkeUFkZGVkID0gdGhpcy5zdGF0ZS5maW5kKGl0ZW0gPT4gdGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSk7XG4gICAgaWYgKGFsZXJ0QWxyZWFkeUFkZGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoWy4uLnRoaXMuc3RhdGUsIGFsZXJ0XSk7XG4gICAgdGhpcy5oaWRlQXV0b21hdGljYWxseUlmTmVlZGVkKGFsZXJ0KTtcbiAgICB0aGlzLnJlbW92ZU9sZGVzdElmTWF4KCk7XG4gIH1cblxuICBwcml2YXRlIGhpZGVBdXRvbWF0aWNhbGx5SWZOZWVkZWQoYWxlcnQ6IEFsZXJ0KSB7XG4gICAgY29uc3QgaXNTdWNjZXNzID0gYWxlcnQudHlwZSA9PT0gJ3N1Y2Nlc3MnO1xuICAgIGNvbnN0IG5vRGV0YWlscyA9ICFhbGVydC5kZXRhaWxlZERhdGE7XG4gICAgbGV0IGFsZXJ0VGltZW91dCA9IGlzU3VjY2VzcyAmJiBub0RldGFpbHMgPyB0aGlzLkFMRVJUX1RJTUVPVVQgOiAwO1xuICAgIGlmICh0eXBlb2YgYWxlcnQudGltZW91dCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGFsZXJ0VGltZW91dCA9IGFsZXJ0LnRpbWVvdXQ7XG4gICAgfVxuICAgIGlmIChhbGVydFRpbWVvdXQpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZW1vdmUoYWxlcnQpLCBhbGVydFRpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlT2xkZXN0SWZNYXgoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUubGVuZ3RoID4gdGhpcy5NQVhfQUxFUlRTKSB7XG4gICAgICBjb25zdCBbLCAuLi5maXJzdFJlbW92ZWRdID0gdGhpcy5zdGF0ZTtcbiAgICAgIHRoaXMuY2hhbmdlQWxlcnRzKGZpcnN0UmVtb3ZlZCk7XG4gICAgfVxuICB9XG59XG4iXX0=