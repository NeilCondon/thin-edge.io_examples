import * as tslib_1 from "tslib";
import { coerceNumberProperty } from '@angular/cdk/coercion';
import { ComponentFactory, ComponentFactoryResolver, Directive, EmbeddedViewRef, Input, SimpleChanges, TemplateRef, Type, ViewContainerRef, ViewRef } from '@angular/core';
import { assign, get } from 'lodash-es';
import { isObservable, of, pipe, Subject } from 'rxjs';
import { map, takeUntil, tap } from 'rxjs/operators';
import { LoadMoreComponent } from './load-more.component';
/**
 * A directive to iterate over IResultList<T> data from @c8y/client.
 * Depending on the [c8yForLoadMore] a load more button is:
 *  - auto: Tries to automatically load more data (default maximum 10 iterations; can be
 *          change with maxIterations settings).
 *  - show: Shows a load more button for the user to decide
 *  - none: Doesn't perform any load more action.
 *  - hidden: Loads more data automatically but with no visible button for the user.
 *
 * Additional, any rxjs operator pipe can be applied to the [c8yForPipe] input, e.g. to
 * filter the data displayed currently as well as the data loaded by subsequent requests.
 *
 * Example:
 * ```html
 * <div *c8yFor="let device of devices; loadMore: 'auto'; let i = index; pipe: filterPipe;">
 *  {{ i + 1 }}. {{device.name}}
 * </div>
 * ```
 * The above example will list all entities that are applied to `devices`:
 * ```typescript
 * this.devices = this.inventoryService.list({ pageSize: 10, fragmentType: 'c8y_IsDevice' })
 * ```
 * It will display the first 10 items, if there is more space left on the screen, and there are more
 * than 10 devices, it will automatically load up to 10 pages more. If it still can't fit the screen
 * it will stop and switch to `show` mode.
 *
 * A pipe can be applied e.g. for filtering or grouping. This pipe is attached to every follow up
 * request done by the load more component:
 * ```typescript
 * this.filterPipe = pipe(
 *    map((data: []) => {
 *     return data.filter(
 *      (mo: any) => mo.name && mo.name.toLowerCase().indexOf(value.toLowerCase()) > -1
 *    );
 *  })
 * );
 * ```
 * The pipe must be an rxjs pipe and can take any operator.
 */
var ForOfDirective = /** @class */ (function () {
    function ForOfDirective(tpl, vcr, componentFactoryResolver) {
        this.tpl = tpl;
        this.vcr = vcr;
        this.componentFactoryResolver = componentFactoryResolver;
        this.cachedData = [];
        this.loadMoreMode = 'auto';
        this.dataPipe = pipe(tap());
        this.maxIterations = 10;
        this.unsubscribe$ = new Subject();
    }
    Object.defineProperty(ForOfDirective.prototype, "shouldUseLoadMoreButton", {
        get: function () {
            return (this.loadMoreMode === 'auto' || this.loadMoreMode === 'show' || this.loadMoreMode === 'hidden');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "hasMoreData", {
        get: function () {
            return this.loadMore && this.loadMore.hasMore;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "length", {
        get: function () {
            return this.cachedData.length;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForOf", {
        /**
         * The data setter. Must be a response from @c8y/data or an observable.
         * You can pass an observable with null to explicitly clear the list.
         */
        set: function (fetchData) {
            var _this = this;
            if (fetchData) {
                this.obs$ = (isObservable(fetchData) ? fetchData : of(fetchData)).pipe(map(function (result) {
                    if (result === null) {
                        _this.paging = null;
                        return [];
                    }
                    var paging = result.paging, data = result.data;
                    _this.paging = paging;
                    return data;
                }));
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForLoadMore", {
        /**
         * The mode setter:
         *  - auto: Tries to automatically load more data (default maximum 10 iterations; can be
         *          change with maxIterations settings).
         *  - show: Shows a load more button for the user to decide
         *  - none: Doesn't perform any load more action.
         *  - hidden: Loads more data automatically but with no visible button for the user.
         */
        set: function (type) {
            this.loadMoreMode = type;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForPipe", {
        /**
         * The pipe setter to attach any rxjs pipe to the current and more loaded data.
         */
        set: function (dataPipe) {
            if (dataPipe) {
                this.dataPipe = dataPipe;
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForNotFound", {
        /**
         * A template to use if no data is found at all (e.g. if you apply a filter pipe).
         */
        set: function (notFoundTemplate) {
            this.notFoundTemplate = notFoundTemplate;
            if (this.loadMore) {
                this.loadMore.noMoreDataHint = notFoundTemplate;
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForMaxIterations", {
        /**
         * The maximum numbers of iterations to call data from the api.
         */
        set: function (maxIterations) {
            this.maxIterations = maxIterations;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForLoadingTemplate", {
        /**
         * A custom loading component.
         */
        set: function (loadingTemplate) {
            this.loadingTemplate = loadingTemplate;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForLoadNextLabel", {
        /**
         * Load next text label.
         */
        set: function (loadNextLabel) {
            this.loadNextLabel = loadNextLabel;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForRealtime", {
        /**
         * A RealtimeService instance.
         */
        set: function (source) {
            this.realtime = source;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForComparator", {
        /**
         * A comparator function for comparing list items. Used to determine
         * the position at which a new element should be added to the list.
         */
        set: function (comparator) {
            this.comparator = comparator;
        },
        enumerable: true,
        configurable: true
    });
    ForOfDirective.prototype.ngOnInit = function () {
        this.handleRealtime();
    };
    ForOfDirective.prototype.ngOnChanges = function (changes) {
        var _this = this;
        if (this.obs$ && (changes.c8yForPipe || changes.c8yForOf)) {
            this.unsubscribePaging();
            // only re-rendering  on filtering if all data is already loaded
            // from the backend
            var reRender_1 = !this.hasMoreData && !!changes.c8yForPipe && !changes.c8yForOf;
            if (reRender_1) {
                this.obs$ = of(this.cachedData);
            }
            this.pagingSub = this.obs$
                .pipe(tap(function (data) {
                if (!reRender_1) {
                    _this.cachedData = data;
                }
            }))
                .pipe(function (src) { return _this.dataPipe(src); })
                .subscribe(function (data) {
                _this.render(data, reRender_1);
            });
        }
    };
    ForOfDirective.prototype.ngOnDestroy = function () {
        this.unsubscribePaging();
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
    };
    ForOfDirective.prototype.handleRealtime = function () {
        var _this = this;
        if (this.realtime) {
            this.realtime
                .onCreate$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(function (item) { return _this.insert(item); });
            this.realtime
                .onUpdate$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(function (item) { return _this.update(item); });
            this.realtime
                .onDelete$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(function (id) { return _this.remove(coerceNumberProperty(id)); });
        }
    };
    ForOfDirective.prototype.render = function (data, reRender) {
        var _this = this;
        if (reRender === void 0) { reRender = false; }
        this.vcr.clear();
        data.forEach(function (item, index) {
            var context = {
                $implicit: item,
                index: index,
                length: _this.length,
                hasMore: _this.hasMoreData,
                loadMoreComponent: _this.loadMore
            };
            _this.vcr.createEmbeddedView(_this.tpl, context);
        });
        if (this.shouldUseLoadMoreButton) {
            this.loadMore = this.createLoadMoreButtonComponent(reRender);
        }
    };
    ForOfDirective.prototype.append = function (data) {
        var _this = this;
        data.forEach(function (item) {
            var index = _this.shouldUseLoadMoreButton ? _this.vcr.length - 1 : _this.vcr.length;
            var context = {
                $implicit: item,
                index: index,
                length: _this.length,
                hasMore: _this.hasMoreData,
                loadMoreComponent: _this.loadMore
            };
            _this.vcr.createEmbeddedView(_this.tpl, context, index);
        });
    };
    ForOfDirective.prototype.loadMoreData = function (data) {
        if (data.length > 0) {
            this.append(data);
        }
    };
    ForOfDirective.prototype.createLoadMoreButtonComponent = function (reRender) {
        var _this = this;
        var componentFactory = this.componentFactoryResolver.resolveComponentFactory(LoadMoreComponent);
        var componentRef = this.vcr.createComponent(componentFactory);
        var instance = componentRef.instance;
        instance.paging = this.paging;
        instance.useIntersection = this.loadMoreMode === 'auto' || this.loadMoreMode === 'hidden';
        instance.hidden = this.loadMoreMode === 'hidden';
        instance.maxIterations = this.maxIterations;
        instance.noMoreDataHint = this.notFoundTemplate;
        instance.loadingTemplate = this.loadingTemplate;
        instance.loadNextLabel = this.loadNextLabel;
        this.pagingSub = instance.onLoad
            .pipe(map(function (data) { return _this.checkForDuplicates(data); }), tap(function (data) {
            _this.cachedData = _this.cachedData.concat(data);
        }))
            .pipe(function (src) { return _this.dataPipe(src); })
            .subscribe(function (data) { return _this.loadMoreData(data); });
        if (reRender) {
            assign(instance, this.loadMore);
        }
        return instance;
    };
    ForOfDirective.prototype.insert = function (item) {
        var index = 0;
        if (this.comparator && this.cachedData.length) {
            var comparisionResult = void 0;
            do {
                var view = this.vcr.get(index);
                var itemB = get(view, 'context.$implicit');
                comparisionResult = item && itemB ? this.comparator(item, itemB) : 0;
                if (comparisionResult <= 0) {
                    index++;
                }
            } while (comparisionResult <= 0 && index < this.cachedData.length);
        }
        // Do not append elements after the last one currently loaded,
        // as it may belong further down there on the list and will
        // be eventually loaded with one of the next pages.
        if (index < this.cachedData.length || this.cachedData.length === 0) {
            var context = {
                $implicit: item,
                index: index,
                length: this.length,
                hasMore: this.hasMoreData
            };
            this.cachedData.splice(index, 0, item);
            var viewRef = this.tpl.createEmbeddedView(context);
            this.vcr.insert(viewRef, index);
        }
    };
    ForOfDirective.prototype.update = function (updatedItem) {
        this.forMatchingEmbeddedViewRef(function (item) { return item && updatedItem && item.id === updatedItem.id; }, function (view) {
            view.context.$implicit = updatedItem;
            view.markForCheck();
        });
    };
    ForOfDirective.prototype.remove = function (idToRemove) {
        this.forMatchingEmbeddedViewRef(function (item) { return item && coerceNumberProperty(item.id, NaN) === idToRemove; }, function (view) { return view.destroy(); });
    };
    ForOfDirective.prototype.forMatchingEmbeddedViewRef = function (filter, callback) {
        for (var i = 0; i < this.vcr.length; i++) {
            var view = this.vcr.get(i);
            var item = get(view, 'context.$implicit');
            if (filter(item)) {
                callback(view);
            }
        }
    };
    ForOfDirective.prototype.checkForDuplicates = function (data) {
        var _this = this;
        return this.realtime
            ? data.filter(function (item) { return !_this.cachedData.some(function (cached) { return cached.id === item.id; }); })
            : data;
    };
    ForOfDirective.prototype.unsubscribePaging = function () {
        if (this.pagingSub) {
            this.pagingSub.unsubscribe();
        }
    };
    ForOfDirective.ctorParameters = function () { return [
        { type: TemplateRef },
        { type: ViewContainerRef },
        { type: ComponentFactoryResolver }
    ]; };
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForOf", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForLoadMore", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForPipe", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForNotFound", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForMaxIterations", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForLoadingTemplate", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForLoadNextLabel", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForRealtime", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForComparator", null);
    ForOfDirective = tslib_1.__decorate([
        Directive({
            selector: '[c8yFor]'
        })
    ], ForOfDirective);
    return ForOfDirective;
}());
export { ForOfDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9yT2YuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvY29tbW9uL2Zvck9mLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0QsT0FBTyxFQUNMLGdCQUFnQixFQUNoQix3QkFBd0IsRUFDeEIsU0FBUyxFQUNULGVBQWUsRUFDZixLQUFLLEVBQ0wsYUFBYSxFQUNiLFdBQVcsRUFDWCxJQUFJLEVBQ0osZ0JBQWdCLEVBQ2hCLE9BQU8sRUFDUixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4QyxPQUFPLEVBQUUsWUFBWSxFQUFjLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUNqRixPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVyRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUcxRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FzQ0c7QUFJSDtJQThIRSx3QkFDVSxHQUFxQixFQUNyQixHQUFxQixFQUNyQix3QkFBa0Q7UUFGbEQsUUFBRyxHQUFILEdBQUcsQ0FBa0I7UUFDckIsUUFBRyxHQUFILEdBQUcsQ0FBa0I7UUFDckIsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQWhJcEQsZUFBVSxHQUFrQixFQUFFLENBQUM7UUFFL0IsaUJBQVksR0FBaUIsTUFBTSxDQUFDO1FBQ3BDLGFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUt2QixrQkFBYSxHQUFHLEVBQUUsQ0FBQztRQUtuQixpQkFBWSxHQUFrQixJQUFJ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NUhVLGNBQWM7UUFIMUIsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLFVBQVU7U0FDckIsQ0FBQztPQUNXLGNBQWMsQ0FxVTFCO0lBQUQscUJBQUM7Q0FBQSxBQXJVRCxJQXFVQztTQXJVWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29lcmNlTnVtYmVyUHJvcGVydHkgfSBmcm9tICdAYW5ndWxhci9jZGsvY29lcmNpb24nO1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50RmFjdG9yeSxcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBEaXJlY3RpdmUsXG4gIEVtYmVkZGVkVmlld1JlZixcbiAgSW5wdXQsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFRlbXBsYXRlUmVmLFxuICBUeXBlLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBWaWV3UmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSUlkZW50aWZpZWQsIElSZXN1bHRMaXN0LCBQYWdpbmcgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBhc3NpZ24sIGdldCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBpc09ic2VydmFibGUsIE9ic2VydmFibGUsIG9mLCBwaXBlLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSZWFsdGltZVNlcnZpY2UgfSBmcm9tICcuLi9yZWFsdGltZS9yZWFsdGltZS5zZXJ2aWNlJztcbmltcG9ydCB7IExvYWRNb3JlQ29tcG9uZW50IH0gZnJvbSAnLi9sb2FkLW1vcmUuY29tcG9uZW50JztcbmltcG9ydCB7IExvYWRNb3JlTW9kZSB9IGZyb20gJy4vbG9hZC1tb3JlLm1vZGVsJztcblxuLyoqXG4gKiBBIGRpcmVjdGl2ZSB0byBpdGVyYXRlIG92ZXIgSVJlc3VsdExpc3Q8VD4gZGF0YSBmcm9tIEBjOHkvY2xpZW50LlxuICogRGVwZW5kaW5nIG9uIHRoZSBbYzh5Rm9yTG9hZE1vcmVdIGEgbG9hZCBtb3JlIGJ1dHRvbiBpczpcbiAqICAtIGF1dG86IFRyaWVzIHRvIGF1dG9tYXRpY2FsbHkgbG9hZCBtb3JlIGRhdGEgKGRlZmF1bHQgbWF4aW11bSAxMCBpdGVyYXRpb25zOyBjYW4gYmVcbiAqICAgICAgICAgIGNoYW5nZSB3aXRoIG1heEl0ZXJhdGlvbnMgc2V0dGluZ3MpLlxuICogIC0gc2hvdzogU2hvd3MgYSBsb2FkIG1vcmUgYnV0dG9uIGZvciB0aGUgdXNlciB0byBkZWNpZGVcbiAqICAtIG5vbmU6IERvZXNuJ3QgcGVyZm9ybSBhbnkgbG9hZCBtb3JlIGFjdGlvbi5cbiAqICAtIGhpZGRlbjogTG9hZHMgbW9yZSBkYXRhIGF1dG9tYXRpY2FsbHkgYnV0IHdpdGggbm8gdmlzaWJsZSBidXR0b24gZm9yIHRoZSB1c2VyLlxuICpcbiAqIEFkZGl0aW9uYWwsIGFueSByeGpzIG9wZXJhdG9yIHBpcGUgY2FuIGJlIGFwcGxpZWQgdG8gdGhlIFtjOHlGb3JQaXBlXSBpbnB1dCwgZS5nLiB0b1xuICogZmlsdGVyIHRoZSBkYXRhIGRpc3BsYXllZCBjdXJyZW50bHkgYXMgd2VsbCBhcyB0aGUgZGF0YSBsb2FkZWQgYnkgc3Vic2VxdWVudCByZXF1ZXN0cy5cbiAqXG4gKiBFeGFtcGxlOlxuICogYGBgaHRtbFxuICogPGRpdiAqYzh5Rm9yPVwibGV0IGRldmljZSBvZiBkZXZpY2VzOyBsb2FkTW9yZTogJ2F1dG8nOyBsZXQgaSA9IGluZGV4OyBwaXBlOiBmaWx0ZXJQaXBlO1wiPlxuICogIHt7IGkgKyAxIH19LiB7e2RldmljZS5uYW1lfX1cbiAqIDwvZGl2PlxuICogYGBgXG4gKiBUaGUgYWJvdmUgZXhhbXBsZSB3aWxsIGxpc3QgYWxsIGVudGl0aWVzIHRoYXQgYXJlIGFwcGxpZWQgdG8gYGRldmljZXNgOlxuICogYGBgdHlwZXNjcmlwdFxuICogdGhpcy5kZXZpY2VzID0gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmxpc3QoeyBwYWdlU2l6ZTogMTAsIGZyYWdtZW50VHlwZTogJ2M4eV9Jc0RldmljZScgfSlcbiAqIGBgYFxuICogSXQgd2lsbCBkaXNwbGF5IHRoZSBmaXJzdCAxMCBpdGVtcywgaWYgdGhlcmUgaXMgbW9yZSBzcGFjZSBsZWZ0IG9uIHRoZSBzY3JlZW4sIGFuZCB0aGVyZSBhcmUgbW9yZVxuICogdGhhbiAxMCBkZXZpY2VzLCBpdCB3aWxsIGF1dG9tYXRpY2FsbHkgbG9hZCB1cCB0byAxMCBwYWdlcyBtb3JlLiBJZiBpdCBzdGlsbCBjYW4ndCBmaXQgdGhlIHNjcmVlblxuICogaXQgd2lsbCBzdG9wIGFuZCBzd2l0Y2ggdG8gYHNob3dgIG1vZGUuXG4gKlxuICogQSBwaXBlIGNhbiBiZSBhcHBsaWVkIGUuZy4gZm9yIGZpbHRlcmluZyBvciBncm91cGluZy4gVGhpcyBwaXBlIGlzIGF0dGFjaGVkIHRvIGV2ZXJ5IGZvbGxvdyB1cFxuICogcmVxdWVzdCBkb25lIGJ5IHRoZSBsb2FkIG1vcmUgY29tcG9uZW50OlxuICogYGBgdHlwZXNjcmlwdFxuICogdGhpcy5maWx0ZXJQaXBlID0gcGlwZShcbiAqICAgIG1hcCgoZGF0YTogW10pID0+IHtcbiAqICAgICByZXR1cm4gZGF0YS5maWx0ZXIoXG4gKiAgICAgIChtbzogYW55KSA9PiBtby5uYW1lICYmIG1vLm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKHZhbHVlLnRvTG93ZXJDYXNlKCkpID4gLTFcbiAqICAgICk7XG4gKiAgfSlcbiAqICk7XG4gKiBgYGBcbiAqIFRoZSBwaXBlIG11c3QgYmUgYW4gcnhqcyBwaXBlIGFuZCBjYW4gdGFrZSBhbnkgb3BlcmF0b3IuXG4gKi9cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tjOHlGb3JdJ1xufSlcbmV4cG9ydCBjbGFzcyBGb3JPZkRpcmVjdGl2ZSB7XG4gIHByaXZhdGUgY2FjaGVkRGF0YTogSUlkZW50aWZpZWRbXSA9IFtdO1xuICBwcml2YXRlIHBhZ2luZzogUGFnaW5nPElJZGVudGlmaWVkPjtcbiAgcHJpdmF0ZSBsb2FkTW9yZU1vZGU6IExvYWRNb3JlTW9kZSA9ICdhdXRvJztcbiAgcHJpdmF0ZSBkYXRhUGlwZSA9IHBpcGUodGFwKCkpO1xuICBwcml2YXRlIHBhZ2luZ1N1YjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIG9icyQ6IE9ic2VydmFibGU8SUlkZW50aWZpZWRbXT47XG4gIHByaXZhdGUgbG9hZE1vcmU6IExvYWRNb3JlQ29tcG9uZW50O1xuICBwcml2YXRlIGxvYWRpbmdUZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PjtcbiAgcHJpdmF0ZSBtYXhJdGVyYXRpb25zID0gMTA7XG4gIHByaXZhdGUgbm90Rm91bmRUZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PjtcbiAgcHJpdmF0ZSBsb2FkTmV4dExhYmVsOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhbHRpbWU6IFJlYWx0aW1lU2VydmljZTxhbnk+O1xuICBwcml2YXRlIGNvbXBhcmF0b3I6IChpdGVtQTogb2JqZWN0LCBpdGVtQjogb2JqZWN0KSA9PiBudW1iZXI7XG4gIHByaXZhdGUgdW5zdWJzY3JpYmUkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcblxuICBwcml2YXRlIGdldCBzaG91bGRVc2VMb2FkTW9yZUJ1dHRvbigpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5sb2FkTW9yZU1vZGUgPT09ICdhdXRvJyB8fCB0aGlzLmxvYWRNb3JlTW9kZSA9PT0gJ3Nob3cnIHx8IHRoaXMubG9hZE1vcmVNb2RlID09PSAnaGlkZGVuJ1xuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldCBoYXNNb3JlRGF0YSgpIHtcbiAgICByZXR1cm4gdGhpcy5sb2FkTW9yZSAmJiB0aGlzLmxvYWRNb3JlLmhhc01vcmU7XG4gIH1cblxuICBwcml2YXRlIGdldCBsZW5ndGgoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGVkRGF0YS5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogVGhlIGRhdGEgc2V0dGVyLiBNdXN0IGJlIGEgcmVzcG9uc2UgZnJvbSBAYzh5L2RhdGEgb3IgYW4gb2JzZXJ2YWJsZS5cbiAgICogWW91IGNhbiBwYXNzIGFuIG9ic2VydmFibGUgd2l0aCBudWxsIHRvIGV4cGxpY2l0bHkgY2xlYXIgdGhlIGxpc3QuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgYzh5Rm9yT2YoZmV0Y2hEYXRhOiBJUmVzdWx0TGlzdDxJSWRlbnRpZmllZD4gfCBPYnNlcnZhYmxlPElSZXN1bHRMaXN0PElJZGVudGlmaWVkPj4pIHtcbiAgICBpZiAoZmV0Y2hEYXRhKSB7XG4gICAgICB0aGlzLm9icyQgPSAoaXNPYnNlcnZhYmxlKGZldGNoRGF0YSkgPyBmZXRjaERhdGEgOiBvZihmZXRjaERhdGEpKS5waXBlKFxuICAgICAgICBtYXAocmVzdWx0ID0+IHtcbiAgICAgICAgICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLnBhZ2luZyA9IG51bGw7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHsgcGFnaW5nLCBkYXRhIH0gPSByZXN1bHQ7XG4gICAgICAgICAgdGhpcy5wYWdpbmcgPSBwYWdpbmc7XG4gICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbW9kZSBzZXR0ZXI6XG4gICAqICAtIGF1dG86IFRyaWVzIHRvIGF1dG9tYXRpY2FsbHkgbG9hZCBtb3JlIGRhdGEgKGRlZmF1bHQgbWF4aW11bSAxMCBpdGVyYXRpb25zOyBjYW4gYmVcbiAgICogICAgICAgICAgY2hhbmdlIHdpdGggbWF4SXRlcmF0aW9ucyBzZXR0aW5ncykuXG4gICAqICAtIHNob3c6IFNob3dzIGEgbG9hZCBtb3JlIGJ1dHRvbiBmb3IgdGhlIHVzZXIgdG8gZGVjaWRlXG4gICAqICAtIG5vbmU6IERvZXNuJ3QgcGVyZm9ybSBhbnkgbG9hZCBtb3JlIGFjdGlvbi5cbiAgICogIC0gaGlkZGVuOiBMb2FkcyBtb3JlIGRhdGEgYXV0b21hdGljYWxseSBidXQgd2l0aCBubyB2aXNpYmxlIGJ1dHRvbiBmb3IgdGhlIHVzZXIuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgYzh5Rm9yTG9hZE1vcmUodHlwZTogTG9hZE1vcmVNb2RlKSB7XG4gICAgdGhpcy5sb2FkTW9yZU1vZGUgPSB0eXBlO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBwaXBlIHNldHRlciB0byBhdHRhY2ggYW55IHJ4anMgcGlwZSB0byB0aGUgY3VycmVudCBhbmQgbW9yZSBsb2FkZWQgZGF0YS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JQaXBlKGRhdGFQaXBlKSB7XG4gICAgaWYgKGRhdGFQaXBlKSB7XG4gICAgICB0aGlzLmRhdGFQaXBlID0gZGF0YVBpcGU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEEgdGVtcGxhdGUgdG8gdXNlIGlmIG5vIGRhdGEgaXMgZm91bmQgYXQgYWxsIChlLmcuIGlmIHlvdSBhcHBseSBhIGZpbHRlciBwaXBlKS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JOb3RGb3VuZChub3RGb3VuZFRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+KSB7XG4gICAgdGhpcy5ub3RGb3VuZFRlbXBsYXRlID0gbm90Rm91bmRUZW1wbGF0ZTtcbiAgICBpZiAodGhpcy5sb2FkTW9yZSkge1xuICAgICAgdGhpcy5sb2FkTW9yZS5ub01vcmVEYXRhSGludCA9IG5vdEZvdW5kVGVtcGxhdGU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBtYXhpbXVtIG51bWJlcnMgb2YgaXRlcmF0aW9ucyB0byBjYWxsIGRhdGEgZnJvbSB0aGUgYXBpLlxuICAgKi9cbiAgQElucHV0KClcbiAgc2V0IGM4eUZvck1heEl0ZXJhdGlvbnMobWF4SXRlcmF0aW9uczogbnVtYmVyKSB7XG4gICAgdGhpcy5tYXhJdGVyYXRpb25zID0gbWF4SXRlcmF0aW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiBBIGN1c3RvbSBsb2FkaW5nIGNvbXBvbmVudC5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JMb2FkaW5nVGVtcGxhdGUobG9hZGluZ1RlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+KSB7XG4gICAgdGhpcy5sb2FkaW5nVGVtcGxhdGUgPSBsb2FkaW5nVGVtcGxhdGU7XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBuZXh0IHRleHQgbGFiZWwuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgYzh5Rm9yTG9hZE5leHRMYWJlbChsb2FkTmV4dExhYmVsOiBzdHJpbmcpIHtcbiAgICB0aGlzLmxvYWROZXh0TGFiZWwgPSBsb2FkTmV4dExhYmVsO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgUmVhbHRpbWVTZXJ2aWNlIGluc3RhbmNlLlxuICAgKi9cbiAgQElucHV0KClcbiAgc2V0IGM4eUZvclJlYWx0aW1lKHNvdXJjZTogUmVhbHRpbWVTZXJ2aWNlPGFueT4pIHtcbiAgICB0aGlzLnJlYWx0aW1lID0gc291cmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgY29tcGFyYXRvciBmdW5jdGlvbiBmb3IgY29tcGFyaW5nIGxpc3QgaXRlbXMuIFVzZWQgdG8gZGV0ZXJtaW5lXG4gICAqIHRoZSBwb3NpdGlvbiBhdCB3aGljaCBhIG5ldyBlbGVtZW50IHNob3VsZCBiZSBhZGRlZCB0byB0aGUgbGlzdC5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JDb21wYXJhdG9yKGNvbXBhcmF0b3I6IChpdGVtQTogb2JqZWN0LCBpdGVtQjogb2JqZWN0KSA9PiBudW1iZXIpIHtcbiAgICB0aGlzLmNvbXBhcmF0b3IgPSBjb21wYXJhdG9yO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0cGw6IFRlbXBsYXRlUmVmPGFueT4sXG4gICAgcHJpdmF0ZSB2Y3I6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlclxuICApIHt9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5oYW5kbGVSZWFsdGltZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKHRoaXMub2JzJCAmJiAoY2hhbmdlcy5jOHlGb3JQaXBlIHx8IGNoYW5nZXMuYzh5Rm9yT2YpKSB7XG4gICAgICB0aGlzLnVuc3Vic2NyaWJlUGFnaW5nKCk7XG5cbiAgICAgIC8vIG9ubHkgcmUtcmVuZGVyaW5nICBvbiBmaWx0ZXJpbmcgaWYgYWxsIGRhdGEgaXMgYWxyZWFkeSBsb2FkZWRcbiAgICAgIC8vIGZyb20gdGhlIGJhY2tlbmRcbiAgICAgIGNvbnN0IHJlUmVuZGVyID0gIXRoaXMuaGFzTW9yZURhdGEgJiYgISFjaGFuZ2VzLmM4eUZvclBpcGUgJiYgIWNoYW5nZXMuYzh5Rm9yT2Y7XG5cbiAgICAgIGlmIChyZVJlbmRlcikge1xuICAgICAgICB0aGlzLm9icyQgPSBvZih0aGlzLmNhY2hlZERhdGEpO1xuICAgICAgfVxuICAgICAgdGhpcy5wYWdpbmdTdWIgPSB0aGlzLm9icyRcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgdGFwKGRhdGEgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZVJlbmRlcikge1xuICAgICAgICAgICAgICB0aGlzLmNhY2hlZERhdGEgPSBkYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgLnBpcGUoc3JjID0+IHRoaXMuZGF0YVBpcGUoc3JjKSlcbiAgICAgICAgLnN1YnNjcmliZSgoZGF0YTogW10pID0+IHtcbiAgICAgICAgICB0aGlzLnJlbmRlcihkYXRhLCByZVJlbmRlcik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy51bnN1YnNjcmliZVBhZ2luZygpO1xuICAgIHRoaXMudW5zdWJzY3JpYmUkLm5leHQoKTtcbiAgICB0aGlzLnVuc3Vic2NyaWJlJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVSZWFsdGltZSgpIHtcbiAgICBpZiAodGhpcy5yZWFsdGltZSkge1xuICAgICAgdGhpcy5yZWFsdGltZVxuICAgICAgICAub25DcmVhdGUkKClcbiAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUkKSlcbiAgICAgICAgLnN1YnNjcmliZShpdGVtID0+IHRoaXMuaW5zZXJ0KGl0ZW0pKTtcbiAgICAgIHRoaXMucmVhbHRpbWVcbiAgICAgICAgLm9uVXBkYXRlJCgpXG4gICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLnVuc3Vic2NyaWJlJCkpXG4gICAgICAgIC5zdWJzY3JpYmUoaXRlbSA9PiB0aGlzLnVwZGF0ZShpdGVtKSk7XG4gICAgICB0aGlzLnJlYWx0aW1lXG4gICAgICAgIC5vbkRlbGV0ZSQoKVxuICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpKVxuICAgICAgICAuc3Vic2NyaWJlKGlkID0+IHRoaXMucmVtb3ZlKGNvZXJjZU51bWJlclByb3BlcnR5KGlkKSkpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVuZGVyKGRhdGEsIHJlUmVuZGVyID0gZmFsc2UpOiB2b2lkIHtcbiAgICB0aGlzLnZjci5jbGVhcigpO1xuXG4gICAgZGF0YS5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgY29udGV4dCA9IHtcbiAgICAgICAgJGltcGxpY2l0OiBpdGVtLFxuICAgICAgICBpbmRleCxcbiAgICAgICAgbGVuZ3RoOiB0aGlzLmxlbmd0aCxcbiAgICAgICAgaGFzTW9yZTogdGhpcy5oYXNNb3JlRGF0YSxcbiAgICAgICAgbG9hZE1vcmVDb21wb25lbnQ6IHRoaXMubG9hZE1vcmVcbiAgICAgIH07XG4gICAgICB0aGlzLnZjci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy50cGwsIGNvbnRleHQpO1xuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuc2hvdWxkVXNlTG9hZE1vcmVCdXR0b24pIHtcbiAgICAgIHRoaXMubG9hZE1vcmUgPSB0aGlzLmNyZWF0ZUxvYWRNb3JlQnV0dG9uQ29tcG9uZW50KHJlUmVuZGVyKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFwcGVuZChkYXRhKSB7XG4gICAgZGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNob3VsZFVzZUxvYWRNb3JlQnV0dG9uID8gdGhpcy52Y3IubGVuZ3RoIC0gMSA6IHRoaXMudmNyLmxlbmd0aDtcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICAgICRpbXBsaWNpdDogaXRlbSxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsXG4gICAgICAgIGhhc01vcmU6IHRoaXMuaGFzTW9yZURhdGEsXG4gICAgICAgIGxvYWRNb3JlQ29tcG9uZW50OiB0aGlzLmxvYWRNb3JlXG4gICAgICB9O1xuICAgICAgdGhpcy52Y3IuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMudHBsLCBjb250ZXh0LCBpbmRleCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRNb3JlRGF0YShkYXRhKSB7XG4gICAgaWYgKGRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5hcHBlbmQoZGF0YSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVMb2FkTW9yZUJ1dHRvbkNvbXBvbmVudChyZVJlbmRlcikge1xuICAgIGNvbnN0IGNvbXBvbmVudEZhY3Rvcnk6IENvbXBvbmVudEZhY3Rvcnk8XG4gICAgICBhbnlcbiAgICA+ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoTG9hZE1vcmVDb21wb25lbnQpO1xuICAgIGNvbnN0IGNvbXBvbmVudFJlZiA9IHRoaXMudmNyLmNyZWF0ZUNvbXBvbmVudChjb21wb25lbnRGYWN0b3J5KTtcbiAgICBjb25zdCBpbnN0YW5jZSA9IGNvbXBvbmVudFJlZi5pbnN0YW5jZSBhcyBMb2FkTW9yZUNvbXBvbmVudDtcbiAgICBpbnN0YW5jZS5wYWdpbmcgPSB0aGlzLnBhZ2luZztcbiAgICBpbnN0YW5jZS51c2VJbnRlcnNlY3Rpb24gPSB0aGlzLmxvYWRNb3JlTW9kZSA9PT0gJ2F1dG8nIHx8IHRoaXMubG9hZE1vcmVNb2RlID09PSAnaGlkZGVuJztcbiAgICBpbnN0YW5jZS5oaWRkZW4gPSB0aGlzLmxvYWRNb3JlTW9kZSA9PT0gJ2hpZGRlbic7XG4gICAgaW5zdGFuY2UubWF4SXRlcmF0aW9ucyA9IHRoaXMubWF4SXRlcmF0aW9ucztcbiAgICBpbnN0YW5jZS5ub01vcmVEYXRhSGludCA9IHRoaXMubm90Rm91bmRUZW1wbGF0ZTtcbiAgICBpbnN0YW5jZS5sb2FkaW5nVGVtcGxhdGUgPSB0aGlzLmxvYWRpbmdUZW1wbGF0ZTtcbiAgICBpbnN0YW5jZS5sb2FkTmV4dExhYmVsID0gdGhpcy5sb2FkTmV4dExhYmVsO1xuICAgIHRoaXMucGFnaW5nU3ViID0gaW5zdGFuY2Uub25Mb2FkXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChkYXRhOiBbXSkgPT4gdGhpcy5jaGVja0ZvckR1cGxpY2F0ZXMoZGF0YSkpLFxuICAgICAgICB0YXAoKGRhdGE6IFtdKSA9PiB7XG4gICAgICAgICAgdGhpcy5jYWNoZWREYXRhID0gdGhpcy5jYWNoZWREYXRhLmNvbmNhdChkYXRhKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICAgIC5waXBlKHNyYyA9PiB0aGlzLmRhdGFQaXBlKHNyYykpXG4gICAgICAuc3Vic2NyaWJlKGRhdGEgPT4gdGhpcy5sb2FkTW9yZURhdGEoZGF0YSkpO1xuICAgIGlmIChyZVJlbmRlcikge1xuICAgICAgYXNzaWduKGluc3RhbmNlLCB0aGlzLmxvYWRNb3JlKTtcbiAgICB9XG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnQoaXRlbSkge1xuICAgIGxldCBpbmRleDogbnVtYmVyID0gMDtcblxuICAgIGlmICh0aGlzLmNvbXBhcmF0b3IgJiYgdGhpcy5jYWNoZWREYXRhLmxlbmd0aCkge1xuICAgICAgbGV0IGNvbXBhcmlzaW9uUmVzdWx0OiBudW1iZXI7XG4gICAgICBkbyB7XG4gICAgICAgIGNvbnN0IHZpZXc6IEVtYmVkZGVkVmlld1JlZjxhbnk+ID0gdGhpcy52Y3IuZ2V0KGluZGV4KSBhcyBFbWJlZGRlZFZpZXdSZWY8YW55PjtcbiAgICAgICAgY29uc3QgaXRlbUIgPSBnZXQodmlldywgJ2NvbnRleHQuJGltcGxpY2l0Jyk7XG4gICAgICAgIGNvbXBhcmlzaW9uUmVzdWx0ID0gaXRlbSAmJiBpdGVtQiA/IHRoaXMuY29tcGFyYXRvcihpdGVtLCBpdGVtQikgOiAwO1xuICAgICAgICBpZiAoY29tcGFyaXNpb25SZXN1bHQgPD0gMCkge1xuICAgICAgICAgIGluZGV4Kys7XG4gICAgICAgIH1cbiAgICAgIH0gd2hpbGUgKGNvbXBhcmlzaW9uUmVzdWx0IDw9IDAgJiYgaW5kZXggPCB0aGlzLmNhY2hlZERhdGEubGVuZ3RoKTtcbiAgICB9XG5cbiAgICAvLyBEbyBub3QgYXBwZW5kIGVsZW1lbnRzIGFmdGVyIHRoZSBsYXN0IG9uZSBjdXJyZW50bHkgbG9hZGVkLFxuICAgIC8vIGFzIGl0IG1heSBiZWxvbmcgZnVydGhlciBkb3duIHRoZXJlIG9uIHRoZSBsaXN0IGFuZCB3aWxsXG4gICAgLy8gYmUgZXZlbnR1YWxseSBsb2FkZWQgd2l0aCBvbmUgb2YgdGhlIG5leHQgcGFnZXMuXG4gICAgaWYgKGluZGV4IDwgdGhpcy5jYWNoZWREYXRhLmxlbmd0aCB8fCB0aGlzLmNhY2hlZERhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgICAkaW1wbGljaXQ6IGl0ZW0sXG4gICAgICAgIGluZGV4LFxuICAgICAgICBsZW5ndGg6IHRoaXMubGVuZ3RoLFxuICAgICAgICBoYXNNb3JlOiB0aGlzLmhhc01vcmVEYXRhXG4gICAgICB9O1xuXG4gICAgICB0aGlzLmNhY2hlZERhdGEuc3BsaWNlKGluZGV4LCAwLCBpdGVtKTtcbiAgICAgIGNvbnN0IHZpZXdSZWY6IFZpZXdSZWYgPSB0aGlzLnRwbC5jcmVhdGVFbWJlZGRlZFZpZXcoY29udGV4dCk7XG4gICAgICB0aGlzLnZjci5pbnNlcnQodmlld1JlZiwgaW5kZXgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKHVwZGF0ZWRJdGVtKSB7XG4gICAgdGhpcy5mb3JNYXRjaGluZ0VtYmVkZGVkVmlld1JlZihcbiAgICAgIChpdGVtOiBJSWRlbnRpZmllZCkgPT4gaXRlbSAmJiB1cGRhdGVkSXRlbSAmJiBpdGVtLmlkID09PSB1cGRhdGVkSXRlbS5pZCxcbiAgICAgICh2aWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PikgPT4ge1xuICAgICAgICB2aWV3LmNvbnRleHQuJGltcGxpY2l0ID0gdXBkYXRlZEl0ZW07XG4gICAgICAgIHZpZXcubWFya0ZvckNoZWNrKCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlKGlkVG9SZW1vdmUpIHtcbiAgICB0aGlzLmZvck1hdGNoaW5nRW1iZWRkZWRWaWV3UmVmKFxuICAgICAgKGl0ZW06IElJZGVudGlmaWVkKSA9PiBpdGVtICYmIGNvZXJjZU51bWJlclByb3BlcnR5KGl0ZW0uaWQsIE5hTikgPT09IGlkVG9SZW1vdmUsXG4gICAgICAodmlldzogRW1iZWRkZWRWaWV3UmVmPGFueT4pID0+IHZpZXcuZGVzdHJveSgpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZm9yTWF0Y2hpbmdFbWJlZGRlZFZpZXdSZWYoXG4gICAgZmlsdGVyOiAoaXRlbTogSUlkZW50aWZpZWQpID0+IGJvb2xlYW4sXG4gICAgY2FsbGJhY2s6ICh2aWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PikgPT4gdm9pZFxuICApIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmNyLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB2aWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PiA9IHRoaXMudmNyLmdldChpKSBhcyBFbWJlZGRlZFZpZXdSZWY8YW55PjtcbiAgICAgIGNvbnN0IGl0ZW06IElJZGVudGlmaWVkID0gZ2V0KHZpZXcsICdjb250ZXh0LiRpbXBsaWNpdCcpO1xuICAgICAgaWYgKGZpbHRlcihpdGVtKSkge1xuICAgICAgICBjYWxsYmFjayh2aWV3KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNoZWNrRm9yRHVwbGljYXRlcyhkYXRhOiBJSWRlbnRpZmllZFtdKTogSUlkZW50aWZpZWRbXSB7XG4gICAgcmV0dXJuIHRoaXMucmVhbHRpbWVcbiAgICAgID8gZGF0YS5maWx0ZXIoaXRlbSA9PiAhdGhpcy5jYWNoZWREYXRhLnNvbWUoY2FjaGVkID0+IGNhY2hlZC5pZCA9PT0gaXRlbS5pZCkpXG4gICAgICA6IGRhdGE7XG4gIH1cblxuICBwcml2YXRlIHVuc3Vic2NyaWJlUGFnaW5nKCkge1xuICAgIGlmICh0aGlzLnBhZ2luZ1N1Yikge1xuICAgICAgdGhpcy5wYWdpbmdTdWIudW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==