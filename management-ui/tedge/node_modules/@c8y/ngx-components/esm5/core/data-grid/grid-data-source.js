import * as tslib_1 from "tslib";
import { chunk, flow, get, isNil, mapValues, omitBy, orderBy, pick } from 'lodash-es';
import { BehaviorSubject, defer, from, isObservable, of, Subject } from 'rxjs';
import { catchError, finalize, map, switchMap, tap } from 'rxjs/operators';
var GridDataSource = /** @class */ (function () {
    function GridDataSource() {
        this.loadingSubject = new BehaviorSubject(true);
        this.dataSourceSubject = new BehaviorSubject([]);
        this.dataStatsSubject = new BehaviorSubject({
            size: 0,
            filteredSize: 0,
            currentPage: 0,
            currentPageSize: 0,
            firstPageSize: 0
        });
        this.dataSelectionSubject = new BehaviorSubject({
            filteredDataIds: []
        });
        this.resultListSubject = new Subject();
        this.loading$ = this.loadingSubject.asObservable();
        this.data$ = this.dataSourceSubject.asObservable();
        this.stats$ = this.dataStatsSubject.asObservable();
        this.selection$ = this.dataSelectionSubject.asObservable();
        this.resultList$ = this.resultListSubject.asObservable();
    }
    GridDataSource.prototype.connect = function (collectionViewer) {
        return this.data$;
    };
    GridDataSource.prototype.disconnect = function (collectionViewer) {
        this.loadingSubject.complete();
        this.dataSourceSubject.complete();
        this.dataStatsSubject.complete();
        this.dataSelectionSubject.complete();
    };
    GridDataSource.prototype.loadData = function (_a) {
        var _this = this;
        var rows = _a.rows, columns = _a.columns, pagination = _a.pagination, searchText = _a.searchText, serverSideDataCallback = _a.serverSideDataCallback, selectable = _a.selectable, selectionPrimaryKey = _a.selectionPrimaryKey, infiniteScroll = _a.infiniteScroll, _b = _a.reload, reload = _b === void 0 ? false : _b;
        var clientSideData$ = this.toObservable(rows).pipe(map(function (initialData) {
            var filteredSize = 0;
            var filteredDataIds = [];
            var transformedData = flow(function (data) { return _this.doClientSideSearch({ data: data, columns: columns, searchText: searchText }); }, function (data) { return _this.doClientSideFiltering({ data: data, columns: columns }); }, function (data) { return _this.doClientSideSorting({ data: data, columns: columns }); }, function (data) {
                filteredSize = data.length;
                filteredDataIds = selectable
                    ? data.map(function (item) { return item[selectionPrimaryKey]; })
                    : filteredDataIds;
                return data;
            }, function (data) { return _this.doClientSidePagination({ data: data, pagination: pagination }); })(initialData);
            _this.dataStatsSubject.next({
                size: initialData.length,
                filteredSize: filteredSize,
                currentPage: pagination.currentPage,
                currentPageSize: transformedData.length,
                firstPageSize: pagination.pageSize
            });
            _this.dataSelectionSubject.next({ filteredDataIds: filteredDataIds });
            return transformedData;
        }));
        var serverSideData$ = defer(function () {
            return _this.toObservable(serverSideDataCallback({
                columns: columns,
                searchText: searchText,
                pagination: pagination,
                selection: { enabled: selectable, primaryKey: selectionPrimaryKey }
            }));
        }).pipe(map(function (result) {
            var data = result.data, paging = result.paging, size = result.size, filteredSize = result.filteredSize, filteredDataIds = result.filteredDataIds;
            _this.dataStatsSubject.next({
                size: size,
                filteredSize: filteredSize,
                currentPage: paging.currentPage,
                currentPageSize: data.length,
                nextPage: paging.nextPage,
                firstPageSize: paging.pageSize
            });
            _this.dataSelectionSubject.next({ filteredDataIds: filteredDataIds || [] });
            _this.resultListSubject.next(result);
            return data;
        }));
        var data$ = typeof serverSideDataCallback === 'function' ? serverSideData$ : clientSideData$;
        of([])
            .pipe(tap(function () { return _this.loadingSubject.next(true); }), switchMap(function () { return data$; }), catchError(function (err) {
            _this.dataStatsSubject.next({
                size: 0,
                filteredSize: 0,
                currentPage: 0,
                currentPageSize: 0,
                firstPageSize: 0
            });
            _this.dataSelectionSubject.next({ filteredDataIds: [] });
            return of([]);
        }), finalize(function () { return _this.loadingSubject.next(false); }))
            .subscribe(function (result) {
            var data = infiniteScroll && !reload ? tslib_1.__spread(_this.dataSourceSubject.value, result) : result;
            _this.dataSourceSubject.next(data);
        });
    };
    GridDataSource.prototype.resolveValue = function (x, path) {
        return get(x, path);
    };
    GridDataSource.prototype.resolveFunction = function (x) {
        return typeof x === 'function' ? x() : x;
    };
    GridDataSource.prototype.normalizeNil = function (x) {
        return isNil(x) ? '' : x;
    };
    GridDataSource.prototype.doClientSideFiltering = function (_a) {
        var _this = this;
        var data = _a.data, columns = _a.columns;
        return columns.reduce(function (result, column) {
            var filterPredicate = column.filterPredicate;
            if (typeof filterPredicate === 'string') {
                return _this.doClientSideSearch({
                    data: result,
                    columns: [column],
                    searchText: filterPredicate
                });
            }
            if (typeof filterPredicate === 'function') {
                return result.filter(function (item) { return filterPredicate(item, column.path); });
            }
            return result;
        }, data);
    };
    GridDataSource.prototype.doClientSideSearch = function (_a) {
        var _this = this;
        var data = _a.data, columns = _a.columns, searchText = _a.searchText;
        var propPaths = columns.map(function (_a) {
            var path = _a.path;
            return path;
        }).filter(function (column) { return !isNil(column); });
        var regexSearch = this.createRegexSearch(searchText);
        return data.filter(function (item) {
            var itemWithResolvedValues = flow(function (x) { return pick(x, propPaths); }, function (x) { return mapValues(x, _this.resolveFunction); }, function (x) { return omitBy(x, isNil); })(item);
            var cellValues = Object.values(itemWithResolvedValues);
            return cellValues.some(function (cellValue) { return regexSearch.test(cellValue.toString()); });
        });
    };
    GridDataSource.prototype.doClientSideSorting = function (_a) {
        var data = _a.data, columns = _a.columns;
        var actives = columns.filter(function (_a) {
            var sortOrder = _a.sortOrder;
            return !!sortOrder;
        });
        var sortingState = {
            paths: actives.map(function (_a) {
                var path = _a.path;
                return path;
            }),
            orders: actives.map(function (_a) {
                var sortOrder = _a.sortOrder;
                return sortOrder;
            })
        };
        return orderBy(data, sortingState.paths, sortingState.orders);
    };
    GridDataSource.prototype.doClientSidePagination = function (_a) {
        var data = _a.data, pagination = _a.pagination;
        return pagination
            ? get(chunk(data, pagination.pageSize), pagination.currentPage - 1, [])
            : data;
    };
    GridDataSource.prototype.createRegexSearch = function (filterValue) {
        return RegExp(escapeRegExpPattern(filterValue), 'i');
    };
    GridDataSource.prototype.toObservable = function (x) {
        return isObservable(x) ? x : x instanceof Promise ? from(x) : of(x);
    };
    return GridDataSource;
}());
export { GridDataSource };
/**
 *
 * @param string pattern Regex pattern.
 * @return string The escaped regex.
 * @see https://stackoverflow.com/a/3561711/2013891
 */
function escapeRegExpPattern(pattern) {
    if (pattern === void 0) { pattern = ''; }
    return pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC1kYXRhLXNvdXJjZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2RhdGEtZ3JpZC9ncmlkLWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0RixPQUFPLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFjLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0YsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUczRTtJQXFCRTtRQWRRLG1CQUFjLEdBQUcsSUFBSSxlQUFlLENBQVUsSUFBSSxDQUFDLENBQUM7UUFDcEQsc0JBQWlCLEdBQUcsSUFBSSxlQUFlLENBQVcsRUFBRSxDQUFDLENBQUM7UUFDdEQscUJBQWdCLEdBQUcsSUFBSSxlQUFlLENBQWtCO1lBQzlELElBQUksRUFBRSxDQUFDO1lBQ1AsWUFBWSxFQUFFLENBQUM7WUFDZixXQUFXLEVBQUUsQ0FBQztZQUNkLGVBQWUsRUFBRSxDQUFDO1lBQ2xCLGFBQWEsRUFBRSxDQUFDO1NBQ2pCLENBQUMsQ0FBQztRQUNLLHlCQUFvQixHQUFHLElBQUksZUFBZSxDQUFNO1lBQ3RELGVBQWUsRUFBRSxFQUFFO1NBQ3BCLENBQUMsQ0FBQztRQUNLLHNCQUFpQixHQUFHLElBQUksT0FBTyxFQUF1QixDQUFDO1FBRzdELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNuRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FB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QU8sT0FBQSxTQUFTO1lBQVQsQ0FBUyxDQUFDO1NBQ2xELENBQUM7UUFFRixPQUFPLE9BQU8sQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDaEUsQ0FBQztJQUVPLCtDQUFzQixHQUE5QixVQUErQixFQUFvQjtZQUFsQixjQUFJLEVBQUUsMEJBQVU7UUFDL0MsT0FBTyxVQUFVO1lBQ2YsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxVQUFVLENBQUMsV0FBVyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDdkUsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNYLENBQUM7SUFFTywwQ0FBaUIsR0FBekIsVUFBMEIsV0FBVztRQUNuQyxPQUFPLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRU8scUNBQVksR0FBcEIsVUFBcUIsQ0FBQztRQUNwQixPQUFPLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBQ0gscUJBQUM7QUFBRCxDQUFDLEFBcE5ELElBb05DOztBQUVEOzs7OztHQUtHO0FBQ0gsU0FBUyxtQkFBbUIsQ0FBQyxPQUFZO0lBQVosd0JBQUEsRUFBQSxZQUFZO0lBQ3ZDLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUN4RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29sbGVjdGlvblZpZXdlciwgRGF0YVNvdXJjZSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2xsZWN0aW9ucyc7XG5pbXBvcnQgeyBJUmVzdWx0TGlzdCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGNodW5rLCBmbG93LCBnZXQsIGlzTmlsLCBtYXBWYWx1ZXMsIG9taXRCeSwgb3JkZXJCeSwgcGljayB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGRlZmVyLCBmcm9tLCBpc09ic2VydmFibGUsIE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBmaW5hbGl6ZSwgbWFwLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvbHVtbiwgRGF0YVNvdXJjZVN0YXRzLCBTZXJ2ZXJTaWRlRGF0YVJlc3VsdCB9IGZyb20gJy4vZGF0YS1ncmlkLm1vZGVsJztcblxuZXhwb3J0IGNsYXNzIEdyaWREYXRhU291cmNlIGltcGxlbWVudHMgRGF0YVNvdXJjZTxvYmplY3Q+IHtcbiAgbG9hZGluZyQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIGRhdGEkOiBPYnNlcnZhYmxlPG9iamVjdFtdPjtcbiAgc3RhdHMkOiBPYnNlcnZhYmxlPERhdGFTb3VyY2VTdGF0cz47XG4gIHNlbGVjdGlvbiQ6IE9ic2VydmFibGU8YW55PjtcbiAgcmVzdWx0TGlzdCQ6IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8b2JqZWN0Pj47XG5cbiAgcHJpdmF0ZSBsb2FkaW5nU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odHJ1ZSk7XG4gIHByaXZhdGUgZGF0YVNvdXJjZVN1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PG9iamVjdFtdPihbXSk7XG4gIHByaXZhdGUgZGF0YVN0YXRzU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RGF0YVNvdXJjZVN0YXRzPih7XG4gICAgc2l6ZTogMCxcbiAgICBmaWx0ZXJlZFNpemU6IDAsXG4gICAgY3VycmVudFBhZ2U6IDAsXG4gICAgY3VycmVudFBhZ2VTaXplOiAwLFxuICAgIGZpcnN0UGFnZVNpemU6IDBcbiAgfSk7XG4gIHByaXZhdGUgZGF0YVNlbGVjdGlvblN1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4oe1xuICAgIGZpbHRlcmVkRGF0YUlkczogW11cbiAgfSk7XG4gIHByaXZhdGUgcmVzdWx0TGlzdFN1YmplY3QgPSBuZXcgU3ViamVjdDxJUmVzdWx0TGlzdDxvYmplY3Q+PigpO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMubG9hZGluZyQgPSB0aGlzLmxvYWRpbmdTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMuZGF0YSQgPSB0aGlzLmRhdGFTb3VyY2VTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMuc3RhdHMkID0gdGhpcy5kYXRhU3RhdHNTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMuc2VsZWN0aW9uJCA9IHRoaXMuZGF0YVNlbGVjdGlvblN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gICAgdGhpcy5yZXN1bHRMaXN0JCA9IHRoaXMucmVzdWx0TGlzdFN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICBjb25uZWN0KGNvbGxlY3Rpb25WaWV3ZXI6IENvbGxlY3Rpb25WaWV3ZXIpOiBPYnNlcnZhYmxlPG9iamVjdFtdPiB7XG4gICAgcmV0dXJuIHRoaXMuZGF0YSQ7XG4gIH1cblxuICBkaXNjb25uZWN0KGNvbGxlY3Rpb25WaWV3ZXI6IENvbGxlY3Rpb25WaWV3ZXIpOiB2b2lkIHtcbiAgICB0aGlzLmxvYWRpbmdTdWJqZWN0LmNvbXBsZXRlKCk7XG4gICAgdGhpcy5kYXRhU291cmNlU3ViamVjdC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuZGF0YVN0YXRzU3ViamVjdC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuZGF0YVNlbGVjdGlvblN1YmplY3QuY29tcGxldGUoKTtcbiAgfVxuXG4gIGxvYWREYXRhKHtcbiAgICByb3dzLFxuICAgIGNvbHVtbnMsXG4gICAgcGFnaW5hdGlvbixcbiAgICBzZWFyY2hUZXh0LFxuICAgIHNlcnZlclNpZGVEYXRhQ2FsbGJhY2ssXG4gICAgc2VsZWN0YWJsZSxcbiAgICBzZWxlY3Rpb25QcmltYXJ5S2V5LFxuICAgIGluZmluaXRlU2Nyb2xsLFxuICAgIHJlbG9hZCA9IGZhbHNlXG4gIH0pIHtcbiAgICBjb25zdCBjbGllbnRTaWRlRGF0YSQgPSB0aGlzLnRvT2JzZXJ2YWJsZShyb3dzKS5waXBlKFxuICAgICAgbWFwKGluaXRpYWxEYXRhID0+IHtcbiAgICAgICAgbGV0IGZpbHRlcmVkU2l6ZSA9IDA7XG4gICAgICAgIGxldCBmaWx0ZXJlZERhdGFJZHMgPSBbXTtcblxuICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZERhdGEgPSBmbG93KFxuICAgICAgICAgIGRhdGEgPT4gdGhpcy5kb0NsaWVudFNpZGVTZWFyY2goeyBkYXRhLCBjb2x1bW5zLCBzZWFyY2hUZXh0IH0pLFxuICAgICAgICAgIGRhdGEgPT4gdGhpcy5kb0NsaWVudFNpZGVGaWx0ZXJpbmcoeyBkYXRhLCBjb2x1bW5zIH0pLFxuICAgICAgICAgIGRhdGEgPT4gdGhpcy5kb0NsaWVudFNpZGVTb3J0aW5nKHsgZGF0YSwgY29sdW1ucyB9KSxcbiAgICAgICAgICBkYXRhID0+IHtcbiAgICAgICAgICAgIGZpbHRlcmVkU2l6ZSA9IGRhdGEubGVuZ3RoO1xuICAgICAgICAgICAgZmlsdGVyZWREYXRhSWRzID0gc2VsZWN0YWJsZVxuICAgICAgICAgICAgICA/IGRhdGEubWFwKGl0ZW0gPT4gaXRlbVtzZWxlY3Rpb25QcmltYXJ5S2V5XSlcbiAgICAgICAgICAgICAgOiBmaWx0ZXJlZERhdGFJZHM7XG5cbiAgICAgICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZGF0YSA9PiB0aGlzLmRvQ2xpZW50U2lkZVBhZ2luYXRpb24oeyBkYXRhLCBwYWdpbmF0aW9uIH0pXG4gICAgICAgICkoaW5pdGlhbERhdGEpO1xuXG4gICAgICAgIHRoaXMuZGF0YVN0YXRzU3ViamVjdC5uZXh0KHtcbiAgICAgICAgICBzaXplOiBpbml0aWFsRGF0YS5sZW5ndGgsXG4gICAgICAgICAgZmlsdGVyZWRTaXplLFxuICAgICAgICAgIGN1cnJlbnRQYWdlOiBwYWdpbmF0aW9uLmN1cnJlbnRQYWdlLFxuICAgICAgICAgIGN1cnJlbnRQYWdlU2l6ZTogdHJhbnNmb3JtZWREYXRhLmxlbmd0aCxcbiAgICAgICAgICBmaXJzdFBhZ2VTaXplOiBwYWdpbmF0aW9uLnBhZ2VTaXplXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmRhdGFTZWxlY3Rpb25TdWJqZWN0Lm5leHQoeyBmaWx0ZXJlZERhdGFJZHMgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRyYW5zZm9ybWVkRGF0YTtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIGNvbnN0IHNlcnZlclNpZGVEYXRhJCA9IGRlZmVyKCgpID0+XG4gICAgICB0aGlzLnRvT2JzZXJ2YWJsZShcbiAgICAgICAgc2VydmVyU2lkZURhdGFDYWxsYmFjayh7XG4gICAgICAgICAgY29sdW1ucyxcbiAgICAgICAgICBzZWFyY2hUZXh0LFxuICAgICAgICAgIHBhZ2luYXRpb24sXG4gICAgICAgICAgc2VsZWN0aW9uOiB7IGVuYWJsZWQ6IHNlbGVjdGFibGUsIHByaW1hcnlLZXk6IHNlbGVjdGlvblByaW1hcnlLZXkgfVxuICAgICAgICB9KVxuICAgICAgKVxuICAgICkucGlwZShcbiAgICAgIG1hcCgocmVzdWx0OiBTZXJ2ZXJTaWRlRGF0YVJlc3VsdCkgPT4ge1xuICAgICAgICBjb25zdCB7IGRhdGEsIHBhZ2luZywgc2l6ZSwgZmlsdGVyZWRTaXplLCBmaWx0ZXJlZERhdGFJZHMgfSA9IHJlc3VsdDtcblxuICAgICAgICB0aGlzLmRhdGFTdGF0c1N1YmplY3QubmV4dCh7XG4gICAgICAgICAgc2l6ZSxcbiAgICAgICAgICBmaWx0ZXJlZFNpemUsXG4gICAgICAgICAgY3VycmVudFBhZ2U6IHBhZ2luZy5jdXJyZW50UGFnZSxcbiAgICAgICAgICBjdXJyZW50UGFnZVNpemU6IGRhdGEubGVuZ3RoLFxuICAgICAgICAgIG5leHRQYWdlOiBwYWdpbmcubmV4dFBhZ2UsXG4gICAgICAgICAgZmlyc3RQYWdlU2l6ZTogcGFnaW5nLnBhZ2VTaXplXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmRhdGFTZWxlY3Rpb25TdWJqZWN0Lm5leHQoeyBmaWx0ZXJlZERhdGFJZHM6IGZpbHRlcmVkRGF0YUlkcyB8fCBbXSB9KTtcbiAgICAgICAgdGhpcy5yZXN1bHRMaXN0U3ViamVjdC5uZXh0KHJlc3VsdCk7XG5cbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBjb25zdCBkYXRhJCA9IHR5cGVvZiBzZXJ2ZXJTaWRlRGF0YUNhbGxiYWNrID09PSAnZnVuY3Rpb24nID8gc2VydmVyU2lkZURhdGEkIDogY2xpZW50U2lkZURhdGEkO1xuXG4gICAgb2YoW10pXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKCgpID0+IHRoaXMubG9hZGluZ1N1YmplY3QubmV4dCh0cnVlKSksXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiBkYXRhJCksXG4gICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHtcbiAgICAgICAgICB0aGlzLmRhdGFTdGF0c1N1YmplY3QubmV4dCh7XG4gICAgICAgICAgICBzaXplOiAwLFxuICAgICAgICAgICAgZmlsdGVyZWRTaXplOiAwLFxuICAgICAgICAgICAgY3VycmVudFBhZ2U6IDAsXG4gICAgICAgICAgICBjdXJyZW50UGFnZVNpemU6IDAsXG4gICAgICAgICAgICBmaXJzdFBhZ2VTaXplOiAwXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdGhpcy5kYXRhU2VsZWN0aW9uU3ViamVjdC5uZXh0KHsgZmlsdGVyZWREYXRhSWRzOiBbXSB9KTtcbiAgICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgICB9KSxcbiAgICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5sb2FkaW5nU3ViamVjdC5uZXh0KGZhbHNlKSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUocmVzdWx0ID0+IHtcbiAgICAgICAgY29uc3QgZGF0YSA9XG4gICAgICAgICAgaW5maW5pdGVTY3JvbGwgJiYgIXJlbG9hZCA/IFsuLi50aGlzLmRhdGFTb3VyY2VTdWJqZWN0LnZhbHVlLCAuLi5yZXN1bHRdIDogcmVzdWx0O1xuICAgICAgICB0aGlzLmRhdGFTb3VyY2VTdWJqZWN0Lm5leHQoZGF0YSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHJlc29sdmVWYWx1ZSh4LCBwYXRoKSB7XG4gICAgcmV0dXJuIGdldCh4LCBwYXRoKTtcbiAgfVxuXG4gIHJlc29sdmVGdW5jdGlvbih4KSB7XG4gICAgcmV0dXJuIHR5cGVvZiB4ID09PSAnZnVuY3Rpb24nID8geCgpIDogeDtcbiAgfVxuXG4gIG5vcm1hbGl6ZU5pbCh4KSB7XG4gICAgcmV0dXJuIGlzTmlsKHgpID8gJycgOiB4O1xuICB9XG5cbiAgcHJpdmF0ZSBkb0NsaWVudFNpZGVGaWx0ZXJpbmcoeyBkYXRhLCBjb2x1bW5zIH0pIHtcbiAgICByZXR1cm4gY29sdW1ucy5yZWR1Y2UoKHJlc3VsdCwgY29sdW1uKSA9PiB7XG4gICAgICBjb25zdCB7IGZpbHRlclByZWRpY2F0ZSB9ID0gY29sdW1uO1xuXG4gICAgICBpZiAodHlwZW9mIGZpbHRlclByZWRpY2F0ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9DbGllbnRTaWRlU2VhcmNoKHtcbiAgICAgICAgICBkYXRhOiByZXN1bHQsXG4gICAgICAgICAgY29sdW1uczogW2NvbHVtbl0sXG4gICAgICAgICAgc2VhcmNoVGV4dDogZmlsdGVyUHJlZGljYXRlXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIGZpbHRlclByZWRpY2F0ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICByZXR1cm4gcmVzdWx0LmZpbHRlcihpdGVtID0+IGZpbHRlclByZWRpY2F0ZShpdGVtLCBjb2x1bW4ucGF0aCkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIGRhdGEpO1xuICB9XG5cbiAgcHJpdmF0ZSBkb0NsaWVudFNpZGVTZWFyY2goeyBkYXRhLCBjb2x1bW5zLCBzZWFyY2hUZXh0IH0pIHtcbiAgICBjb25zdCBwcm9wUGF0aHMgPSBjb2x1bW5zLm1hcCgoeyBwYXRoIH0pID0+IHBhdGgpLmZpbHRlcihjb2x1bW4gPT4gIWlzTmlsKGNvbHVtbikpO1xuXG4gICAgY29uc3QgcmVnZXhTZWFyY2ggPSB0aGlzLmNyZWF0ZVJlZ2V4U2VhcmNoKHNlYXJjaFRleHQpO1xuXG4gICAgcmV0dXJuIGRhdGEuZmlsdGVyKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgaXRlbVdpdGhSZXNvbHZlZFZhbHVlcyA9IGZsb3coXG4gICAgICAgIHggPT4gcGljayh4LCBwcm9wUGF0aHMpLFxuICAgICAgICB4ID0+IG1hcFZhbHVlcyh4LCB0aGlzLnJlc29sdmVGdW5jdGlvbiksXG4gICAgICAgIHggPT4gb21pdEJ5KHgsIGlzTmlsKVxuICAgICAgKShpdGVtKTtcblxuICAgICAgY29uc3QgY2VsbFZhbHVlcyA9IE9iamVjdC52YWx1ZXMoaXRlbVdpdGhSZXNvbHZlZFZhbHVlcyk7XG5cbiAgICAgIHJldHVybiBjZWxsVmFsdWVzLnNvbWUoY2VsbFZhbHVlID0+IHJlZ2V4U2VhcmNoLnRlc3QoY2VsbFZhbHVlLnRvU3RyaW5nKCkpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZG9DbGllbnRTaWRlU29ydGluZyh7IGRhdGEsIGNvbHVtbnMgfSkge1xuICAgIGNvbnN0IGFjdGl2ZXM6IENvbHVtbltdID0gY29sdW1ucy5maWx0ZXIoKHsgc29ydE9yZGVyIH06IENvbHVtbikgPT4gISFzb3J0T3JkZXIpO1xuXG4gICAgY29uc3Qgc29ydGluZ1N0YXRlID0ge1xuICAgICAgcGF0aHM6IGFjdGl2ZXMubWFwKCh7IHBhdGggfSkgPT4gcGF0aCksXG4gICAgICBvcmRlcnM6IGFjdGl2ZXMubWFwKCh7IHNvcnRPcmRlciB9KSA9PiBzb3J0T3JkZXIpXG4gICAgfTtcblxuICAgIHJldHVybiBvcmRlckJ5KGRhdGEsIHNvcnRpbmdTdGF0ZS5wYXRocywgc29ydGluZ1N0YXRlLm9yZGVycyk7XG4gIH1cblxuICBwcml2YXRlIGRvQ2xpZW50U2lkZVBhZ2luYXRpb24oeyBkYXRhLCBwYWdpbmF0aW9uIH0pIHtcbiAgICByZXR1cm4gcGFnaW5hdGlvblxuICAgICAgPyBnZXQoY2h1bmsoZGF0YSwgcGFnaW5hdGlvbi5wYWdlU2l6ZSksIHBhZ2luYXRpb24uY3VycmVudFBhZ2UgLSAxLCBbXSlcbiAgICAgIDogZGF0YTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUmVnZXhTZWFyY2goZmlsdGVyVmFsdWUpIHtcbiAgICByZXR1cm4gUmVnRXhwKGVzY2FwZVJlZ0V4cFBhdHRlcm4oZmlsdGVyVmFsdWUpLCAnaScpO1xuICB9XG5cbiAgcHJpdmF0ZSB0b09ic2VydmFibGUoeCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGlzT2JzZXJ2YWJsZSh4KSA/IHggOiB4IGluc3RhbmNlb2YgUHJvbWlzZSA/IGZyb20oeCkgOiBvZih4KTtcbiAgfVxufVxuXG4vKipcbiAqXG4gKiBAcGFyYW0gc3RyaW5nIHBhdHRlcm4gUmVnZXggcGF0dGVybi5cbiAqIEByZXR1cm4gc3RyaW5nIFRoZSBlc2NhcGVkIHJlZ2V4LlxuICogQHNlZSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMzU2MTcxMS8yMDEzODkxXG4gKi9cbmZ1bmN0aW9uIGVzY2FwZVJlZ0V4cFBhdHRlcm4ocGF0dGVybiA9ICcnKSB7XG4gIHJldHVybiBwYXR0ZXJuLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXF1cXFxcXS9nLCAnXFxcXCQmJyk7XG59XG4iXX0=