import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector, Optional } from '@angular/core';
import { flatten } from 'lodash-es';
import { forkJoin, from, isObservable, of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { NavigatorNode } from '../navigator';
import { HOOK_DYNAMIC_PROVIDER_CONFIG } from './provider-configuration-hook';
var ProviderConfigurationNodeFactory = /** @class */ (function () {
    function ProviderConfigurationNodeFactory(config, injector) {
        this.injector = injector;
        this.config = flatten(config);
    }
    ProviderConfigurationNodeFactory.prototype.get = function () {
        var _this = this;
        if (!this.config || !this.config.length) {
            return;
        }
        if (!this.nodes) {
            var canActivate = this.config
                .map(function (c) {
                return c.navigation.canActivate && c.navigation.canActivate.length
                    ? _this.getGuards(c)
                    : undefined;
            })
                .map(this.checkCanActivate.bind(this));
            return forkJoin(canActivate).pipe(map(function (canActivateResult) {
                return _this.config
                    .map(function (c, index) {
                    return canActivateResult[index] ? new NavigatorNode(c.navigation) : undefined;
                })
                    .filter(function (el) { return !!el; });
            }), tap(function (nodes) { return (_this.nodes = nodes); }));
        }
        return this.nodes;
    };
    ProviderConfigurationNodeFactory.prototype.checkCanActivate = function (ca) {
        if (!!ca && ca.length) {
            var canActivateResult = ca
                .map(function (canActivate) { return canActivate.canActivate(undefined, undefined); })
                .map(this.wrapIntoObservable.bind(this));
            return forkJoin(canActivateResult).pipe(map(function (caResult) { return caResult.reduce(function (acc, curr) { return acc && curr; }); }));
        }
        return of(true);
    };
    ProviderConfigurationNodeFactory.prototype.isPromise = function (obj) {
        return !!obj && typeof obj.then === 'function';
    };
    ProviderConfigurationNodeFactory.prototype.wrapIntoObservable = function (value) {
        if (isObservable(value)) {
            return value;
        }
        if (this.isPromise(value)) {
            return from(value);
        }
        return of(value);
    };
    ProviderConfigurationNodeFactory.prototype.getGuards = function (c) {
        var _this = this;
        return c.tab && c.tab.canActivate && c.tab.canActivate.length
            ? tslib_1.__spread(c.navigation.canActivate.map(function (ca) { return _this.injector.get(ca); }), c.tab.canActivate.map(function (ca) { return _this.injector.get(ca); })) : c.navigation.canActivate.map(function (ca) { return _this.injector.get(ca); });
    };
    ProviderConfigurationNodeFactory.prototype.getNodeTabPath = function (nodePath, tabPath) {
        return nodePath.replace(/^\/|\/$/g, '') + "/" + tabPath.replace(/^\/|\/$/g, '');
    };
    ProviderConfigurationNodeFactory.ctorParameters = function () { return [
        { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_DYNAMIC_PROVIDER_CONFIG,] }] },
        { type: Injector }
    ]; };
    ProviderConfigurationNodeFactory = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(0, Optional()),
        tslib_1.__param(0, Inject(HOOK_DYNAMIC_PROVIDER_CONFIG))
    ], ProviderConfigurationNodeFactory);
    return ProviderConfigurationNodeFactory;
}());
export { ProviderConfigurationNodeFactory };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXItY29uZmlndXJhdGlvbi1ub2RlLmZhY3RvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9wcm92aWRlci1jb25maWd1cmF0aW9uL3Byb3ZpZGVyLWNvbmZpZ3VyYXRpb24tbm9kZS5mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXZFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDcEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRSxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQXdCLE1BQU0sY0FBYyxDQUFDO0FBRW5FLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRzdFO0lBSUUsMENBR0UsTUFBaUMsRUFDekIsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUUxQixJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRUQsOENBQUcsR0FBSDtRQUFBLGlCQTJCQztRQTFCQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ3ZDLE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2YsSUFBTSxXQUFXLEdBQStCLElBQUksQ0FBQyxNQUFNO2lCQUN4RCxHQUFHLENBQUMsVUFBQSxDQUFDO2dCQUNKLE9BQUEsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxXQUFX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QUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBQSxFQUFFLElBQUksT0FBQSxLQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBckIsQ0FBcUIsQ0FBQyxFQUV6RCxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQUEsRUFBRSxJQUFJLE9BQUEsS0FBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQXJCLENBQXFCLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRU8seURBQWMsR0FBdEIsVUFBdUIsUUFBUSxFQUFFLE9BQU87UUFDdEMsT0FBVSxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsU0FBSSxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUcsQ0FBQztJQUNsRixDQUFDOzs0Q0E3RUUsUUFBUSxZQUNSLE1BQU0sU0FBQyw0QkFBNEI7Z0JBRWxCLFFBQVE7O0lBUmpCLGdDQUFnQztRQUQ1QyxVQUFVLEVBQUU7UUFNUixtQkFBQSxRQUFRLEVBQUUsQ0FBQTtRQUNWLG1CQUFBLE1BQU0sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFBO09BTjVCLGdDQUFnQyxDQW1GNUM7SUFBRCx1Q0FBQztDQUFBLEFBbkZELElBbUZDO1NBbkZZLGdDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDYW5BY3RpdmF0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBmbGF0dGVuIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGZvcmtKb2luLCBmcm9tLCBpc09ic2VydmFibGUsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE5hdmlnYXRvck5vZGUsIE5hdmlnYXRvck5vZGVGYWN0b3J5IH0gZnJvbSAnLi4vbmF2aWdhdG9yJztcbmltcG9ydCB7IER5bmFtaWNQcm92aWRlckNvbmZpZyB9IGZyb20gJy4vbW9kZWwvZHluYW1pYy1wcm92aWRlci1jb25maWcubW9kZWwnO1xuaW1wb3J0IHsgSE9PS19EWU5BTUlDX1BST1ZJREVSX0NPTkZJRyB9IGZyb20gJy4vcHJvdmlkZXItY29uZmlndXJhdGlvbi1ob29rJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFByb3ZpZGVyQ29uZmlndXJhdGlvbk5vZGVGYWN0b3J5IGltcGxlbWVudHMgTmF2aWdhdG9yTm9kZUZhY3Rvcnkge1xuICBwcml2YXRlIGNvbmZpZzogRHluYW1pY1Byb3ZpZGVyQ29uZmlnW107XG4gIHByaXZhdGUgbm9kZXM6IE5hdmlnYXRvck5vZGVbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoSE9PS19EWU5BTUlDX1BST1ZJREVSX0NPTkZJRylcbiAgICBjb25maWc6IER5bmFtaWNQcm92aWRlckNvbmZpZ1tdW10sXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcbiAgKSB7XG4gICAgdGhpcy5jb25maWcgPSBmbGF0dGVuKGNvbmZpZyk7XG4gIH1cblxuICBnZXQoKSB7XG4gICAgaWYgKCF0aGlzLmNvbmZpZyB8fCAhdGhpcy5jb25maWcubGVuZ3RoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLm5vZGVzKSB7XG4gICAgICBjb25zdCBjYW5BY3RpdmF0ZTogQXJyYXk8T2JzZXJ2YWJsZTxib29sZWFuPj4gPSB0aGlzLmNvbmZpZ1xuICAgICAgICAubWFwKGMgPT5cbiAgICAgICAgICBjLm5hdmlnYXRpb24uY2FuQWN0aXZhdGUgJiYgYy5uYXZpZ2F0aW9uLmNhbkFjdGl2YXRlLmxlbmd0aFxuICAgICAgICAgICAgPyB0aGlzLmdldEd1YXJkcyhjKVxuICAgICAgICAgICAgOiB1bmRlZmluZWRcbiAgICAgICAgKVxuICAgICAgICAubWFwKHRoaXMuY2hlY2tDYW5BY3RpdmF0ZS5iaW5kKHRoaXMpKTtcblxuICAgICAgcmV0dXJuIGZvcmtKb2luKGNhbkFjdGl2YXRlKS5waXBlKFxuICAgICAgICBtYXAoKGNhbkFjdGl2YXRlUmVzdWx0OiBib29sZWFuW10pID0+XG4gICAgICAgICAgdGhpcy5jb25maWdcbiAgICAgICAgICAgIC5tYXAoKGMsIGluZGV4KSA9PlxuICAgICAgICAgICAgICBjYW5BY3RpdmF0ZVJlc3VsdFtpbmRleF0gPyBuZXcgTmF2aWdhdG9yTm9kZShjLm5hdmlnYXRpb24pIDogdW5kZWZpbmVkXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuZmlsdGVyKGVsID0+ICEhZWwpXG4gICAgICAgICksXG4gICAgICAgIHRhcChub2RlcyA9PiAodGhpcy5ub2RlcyA9IG5vZGVzKSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubm9kZXM7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrQ2FuQWN0aXZhdGUoY2E6IENhbkFjdGl2YXRlW10pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBpZiAoISFjYSAmJiBjYS5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IGNhbkFjdGl2YXRlUmVzdWx0OiBBcnJheTxPYnNlcnZhYmxlPGJvb2xlYW4+PiA9IGNhXG4gICAgICAgIC5tYXAoKGNhbkFjdGl2YXRlOiBDYW5BY3RpdmF0ZSkgPT4gY2FuQWN0aXZhdGUuY2FuQWN0aXZhdGUodW5kZWZpbmVkLCB1bmRlZmluZWQpKVxuICAgICAgICAubWFwKHRoaXMud3JhcEludG9PYnNlcnZhYmxlLmJpbmQodGhpcykpO1xuXG4gICAgICByZXR1cm4gZm9ya0pvaW4oY2FuQWN0aXZhdGVSZXN1bHQpLnBpcGUoXG4gICAgICAgIG1hcCgoY2FSZXN1bHQ6IGJvb2xlYW5bXSkgPT4gY2FSZXN1bHQucmVkdWNlKChhY2MsIGN1cnIpID0+IGFjYyAmJiBjdXJyKSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBvZih0cnVlKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNQcm9taXNlPFQgPSBhbnk+KG9iajogYW55KTogb2JqIGlzIFByb21pc2U8VD4ge1xuICAgIHJldHVybiAhIW9iaiAmJiB0eXBlb2Ygb2JqLnRoZW4gPT09ICdmdW5jdGlvbic7XG4gIH1cblxuICBwcml2YXRlIHdyYXBJbnRvT2JzZXJ2YWJsZTxUPih2YWx1ZTogVCB8IFByb21pc2U8VD4gfCBPYnNlcnZhYmxlPFQ+KTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgaWYgKGlzT2JzZXJ2YWJsZSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc1Byb21pc2UodmFsdWUpKSB7XG4gICAgICByZXR1cm4gZnJvbSh2YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9mKHZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0R3VhcmRzKGMpIHtcbiAgICByZXR1cm4gYy50YWIgJiYgYy50YWIuY2FuQWN0aXZhdGUgJiYgYy50YWIuY2FuQWN0aXZhdGUubGVuZ3RoXG4gICAgICA/IFtcbiAgICAgICAgICAuLi5jLm5hdmlnYXRpb24uY2FuQWN0aXZhdGUubWFwKGNhID0+IHRoaXMuaW5qZWN0b3IuZ2V0KGNhKSksXG4gICAgICAgICAgLi4uYy50YWIuY2FuQWN0aXZhdGUubWFwKGNhID0+IHRoaXMuaW5qZWN0b3IuZ2V0KGNhKSlcbiAgICAgICAgXVxuICAgICAgOiBjLm5hdmlnYXRpb24uY2FuQWN0aXZhdGUubWFwKGNhID0+IHRoaXMuaW5qZWN0b3IuZ2V0KGNhKSk7XG4gIH1cblxuICBwcml2YXRlIGdldE5vZGVUYWJQYXRoKG5vZGVQYXRoLCB0YWJQYXRoKSB7XG4gICAgcmV0dXJuIGAke25vZGVQYXRoLnJlcGxhY2UoL15cXC98XFwvJC9nLCAnJyl9LyR7dGFiUGF0aC5yZXBsYWNlKC9eXFwvfFxcLyQvZywgJycpfWA7XG4gIH1cbn1cbiJdfQ==