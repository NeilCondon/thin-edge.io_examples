import * as tslib_1 from "tslib";
import { BsDropdownDirective } from 'ngx-bootstrap/dropdown';
import { gettext } from '../i18n/gettext';
import { Component, EventEmitter, HostListener, Input, Output, ViewChild, ContentChildren } from '@angular/core';
import { ListItemComponent } from '../list-group/list-item.component';
var SelectComponent = /** @class */ (function () {
    function SelectComponent() {
        this.placeholder = gettext('Select item');
        this.applyLabel = gettext('Apply');
        this.disableApplyOnNoSelection = false;
        this.onChange = new EventEmitter();
        this.textFilter = '';
        this.labelText = '';
        this.isOpen = false;
        this.filteredItems = [];
        this.searchFilter = null;
        this.sizeToShowFilter = 5;
        this.labelsForSelectAll = {
            all: gettext('All'),
            allFiltered: gettext('All filtered')
        };
        this.showAllLabel = false;
        this.itemsSelected = new Set();
        this.stopClicks = false;
    }
    SelectComponent.prototype.preventClick = function (evt) {
        if (this.stopClicks) {
            evt.stopPropagation();
        }
        this.stopClicks = this.isOpen;
    };
    SelectComponent.prototype.isOpenChange = function (isOpen) {
        this.isOpen = isOpen;
        if (isOpen) {
            this.updateSelected();
            this.searchFilter = null;
        }
        else {
            this.stopClicks = false;
        }
    };
    SelectComponent.prototype.outterSelected = function (item) {
        var selected = this.selected;
        var isSelected = function () { return false; };
        if (typeof selected === 'function') {
            isSelected = selected;
        }
        else if (Array.isArray(selected)) {
            isSelected = function (i) { return selected.indexOf(i) > -1; };
        }
        return isSelected(item);
    };
    SelectComponent.prototype.isSelected = function (item) {
        return this.itemsSelected.has(item);
    };
    SelectComponent.prototype.isAllItemsSelected = function () {
        return this.itemsSelected.size === this.items.length;
    };
    SelectComponent.prototype.isAllFilteredSelected = function () {
        return this.itemsSelected.size === this.filteredItems.length;
    };
    SelectComponent.prototype.isNoItemSelected = function () {
        return !this.itemsSelected.size;
    };
    SelectComponent.prototype.applyChanges = function () {
        var selected = Array.from(this.itemsSelected.values());
        this.onChange.emit(selected);
        this.dropdown.hide();
    };
    SelectComponent.prototype.selectAll = function (checked) {
        var _this = this;
        this.filteredItems.forEach(function (item) { return _this.onChangeItem(checked, item); });
    };
    SelectComponent.prototype.ngOnInit = function () {
        var _this = this;
        if (this.updateItems) {
            this.updateItems.subscribe(function () {
                _this.updateSelected();
                _this.updateLabel();
                _this.showAllLabel = _this.isAllItemsSelected();
            });
        }
    };
    SelectComponent.prototype.onChangeItem = function (checked, item) {
        if (checked) {
            this.itemsSelected.add(item);
        }
        else {
            this.itemsSelected.delete(item);
        }
    };
    SelectComponent.prototype.updateFiltered = function (term) {
        if (term) {
            var search_1 = new RegExp(term, 'i');
            this.filteredItems = this.items.filter(function (_a) {
                var name = _a.name;
                return search_1.test(name);
            });
        }
        else {
            this.filteredItems = this.items;
        }
    };
    SelectComponent.prototype.getSelectAllToggleStatus = function () {
        var label = this.getLabel();
        var checked = this.isAllSelected();
        var indeterminate = !checked && this.itemsSelected.size > 0;
        return { label: label, checked: checked, indeterminate: indeterminate };
    };
    SelectComponent.prototype.ngOnChanges = function (changes) {
        if (this.isOpen) {
            return;
        }
        if (changes.items || changes.selected || changes.applyLabel) {
            this.updateSelected();
            this.updateLabel();
            this.showAllLabel = this.isAllItemsSelected();
        }
    };
    SelectComponent.prototype.ngOnDestroy = function () {
        if (this.updateItems && !this.updateItems.closed) {
            this.updateItems.unsubscribe();
        }
    };
    SelectComponent.prototype.updateLabel = function () {
        var _this = this;
        var outterSelected = this.items.filter(function (i) { return _this.outterSelected(i); });
        if (typeof this.selectedLabel === 'string') {
            this.labelText = this.selectedLabel;
        }
        else if (typeof this.selectedLabel === 'function') {
            this.labelText = this.selectedLabel(outterSelected);
        }
        else {
            this.labelText = outterSelected.map(function (_a) {
                var name = _a.name;
                return name;
            }).join(', ');
        }
    };
    SelectComponent.prototype.updateSelected = function () {
        var _this = this;
        var _a = this, itemsSelected = _a.itemsSelected, items = _a.items;
        itemsSelected.clear();
        items.forEach(function (item) {
            if (_this.outterSelected(item)) {
                itemsSelected.add(item);
            }
        });
        this.filteredItems = items;
    };
    SelectComponent.prototype.isAllSelected = function () {
        if (this.getLabel() === this.labelsForSelectAll.allFiltered) {
            return this.isAllFilteredSelected();
        }
        else {
            return this.isAllItemsSelected();
        }
    };
    SelectComponent.prototype.getLabel = function () {
        return this.searchFilter ? this.labelsForSelectAll.allFiltered : this.labelsForSelectAll.all;
    };
    tslib_1.__decorate([
        Input()
    ], SelectComponent.prototype, "placeholder", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectComponent.prototype, "selectedLabel", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectComponent.prototype, "applyLabel", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectComponent.prototype, "items", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectComponent.prototype, "selected", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectComponent.prototype, "updateItems", void 0);
    tslib_1.__decorate([
        Input()
    ], SelectComponent.prototype, "disableApplyOnNoSelection", void 0);
    tslib_1.__decorate([
        Output()
    ], SelectComponent.prototype, "onChange", void 0);
    tslib_1.__decorate([
        ViewChild(BsDropdownDirective, { static: false })
    ], SelectComponent.prototype, "dropdown", void 0);
    tslib_1.__decorate([
        ContentChildren(ListItemComponent)
    ], SelectComponent.prototype, "liChildren", void 0);
    tslib_1.__decorate([
        HostListener('click', ['$event'])
    ], SelectComponent.prototype, "preventClick", null);
    SelectComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-select',
            template: "<div\n  class=\"c8y-child-assets-selector dropdown fit-w\"\n  (isOpenChange)=\"isOpenChange($event)\"\n  dropdown\n  #dropdown\n>\n  <button\n    type=\"button\"\n    class=\"btn dropdown-toggle c8y-dropdown\"\n    title=\"{{ labelText || placeholder | translate }}\"\n    dropdownToggle\n  >\n    <span class=\"text-truncate\" *ngIf=\"labelText\">\n      <ng-container *ngIf=\"showAllLabel\">{{ 'All' | translate }}</ng-container>\n      <ng-container *ngIf=\"!showAllLabel\">{{ labelText | translate }}</ng-container>\n    </span>\n    <span class=\"text-truncate text-muted\" *ngIf=\"!labelText\">\n      {{ placeholder | translate }}\n    </span>\n  </button>\n\n  <ul class=\"dropdown-menu multiselect-container\" *dropdownMenu>\n    <ng-content select=\"c8y-li\"></ng-content>\n    <ng-container *ngIf=\"liChildren.length === 0\">\n      <li *ngIf=\"items.length > sizeToShowFilter\" class=\"multiselect-item\">\n        <div class=\"input-group input-group-search\">\n          <input\n            type=\"search\"\n            class=\"form-control\"\n            placeholder=\"{{ 'Filter' | translate }}\u2026\"\n            (keyup)=\"updateFiltered($event.target.value)\"\n            [(ngModel)]=\"searchFilter\"\n          />\n          <span class=\"input-group-addon\">\n            <i c8yIcon=\"search\" *ngIf=\"!textFilter\"></i>\n            <i c8yIcon=\"times\" class=\"text-muted\" *ngIf=\"textFilter\" (click)=\"textFilter = ''\"></i>\n          </span>\n        </div>\n      </li>\n\n      <li class=\"multiselect-item\">\n        <label\n          [title]=\"getSelectAllToggleStatus().label\"\n          class=\"c8y-checkbox input-sm\"\n          ng-click=\"vm.toggleSelectAll(); $event.preventDefault()\"\n        >\n          <input\n            type=\"checkbox\"\n            [checked]=\"getSelectAllToggleStatus().checked\"\n            (change)=\"selectAll($event.target.checked)\"\n            [indeterminate]=\"getSelectAllToggleStatus().indeterminate\"\n            class=\"m-t-0\"\n          />\n          <span></span>\n          <span class=\"label-text\">\n            {{ getSelectAllToggleStatus().label }}\n          </span>\n        </label>\n      </li>\n\n      <li class=\"multiselect-item-container\">\n        <ul class=\"list-unstyled\">\n          <li class=\"multiselect-item\" *ngFor=\"let item of filteredItems\">\n            <label title=\"{{ item.name | translate }}\" class=\"c8y-checkbox input-sm text-truncate\">\n              <input\n                type=\"checkbox\"\n                [checked]=\"isSelected(item)\"\n                (change)=\"onChangeItem($event.target.checked, item)\"\n                class=\"m-t-0\"\n              />\n              <span></span>\n              <span class=\"label-text\">\n                {{ item.name | translate }}\n              </span>\n            </label>\n          </li>\n        </ul>\n      </li>\n      <li class=\"divider\"></li>\n      <li class=\"bg-white\">\n        <button\n          title=\"{{ applyLabel | translate }}\"\n          class=\"btn btn-primary btn-block\"\n          [disabled]=\"disableApplyOnNoSelection && isNoItemSelected()\"\n          (click)=\"applyChanges()\"\n        >\n          {{ applyLabel | translate }}\n        </button>\n      </li>\n    </ng-container>\n  </ul>\n</div>\n"
        })
    ], SelectComponent);
    return SelectComponent;
}());
export { SelectComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL3NlbGVjdC9zZWxlY3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM3RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUMsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEVBRU4sU0FBUyxFQUNULGVBQWUsRUFFaEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFldEU7SUFKQTtRQUtXLGdCQUFXLEdBQVcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTdDLGVBQVUsR0FBVyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFJdEMsOEJBQXlCLEdBQVksS0FBSyxDQUFDO1FBQzFDLGFBQVEsR0FBeUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUc5RCxlQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixXQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ2Ysa0JBQWEsR0FBVyxFQUFFLENBQUM7UUFDM0IsaUJBQVksR0FBRyxJQUFJLENBQUM7UUFDWCxxQkFBZ0IsR0FBVyxDQUFDLENBQUM7UUFDdEMsdUJBQWtCLEdBQVE7WUFDeEIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUM7WUFDbkIsV0FBVyxFQUFFLE9BQU8sQ0FBQyxjQUFjLENBQUM7U0FDckMsQ0FBQztRQUNGLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ2Isa0JBQWEsR0FBYyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3JDLGVBQVUsR0FBRyxLQUFLLENBQUM7SUE4STdCLENB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LHNCQUFDO0NBQUEsQUFyS0QsSUFxS0M7U0FyS1ksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJzRHJvcGRvd25EaXJlY3RpdmUgfSBmcm9tICduZ3gtYm9vdHN0cmFwL2Ryb3Bkb3duJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICcuLi9pMThuL2dldHRleHQnO1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBFdmVudEVtaXR0ZXIsXG4gIEhvc3RMaXN0ZW5lcixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzLFxuICBWaWV3Q2hpbGQsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgT25Jbml0XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTGlzdEl0ZW1Db21wb25lbnQgfSBmcm9tICcuLi9saXN0LWdyb3VwL2xpc3QtaXRlbS5jb21wb25lbnQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEl0ZW0ge1xuICBuYW1lOiBzdHJpbmc7XG4gIF9zZWxlY3RlZD86IGJvb2xlYW47XG4gIFtrZXk6IHN0cmluZ106IGFueTtcbn1cblxuZXhwb3J0IHR5cGUgc2VsZWN0ZWRGdW5jdGlvbiA9IChpdGVtOiBJdGVtKSA9PiBib29sZWFuO1xuZXhwb3J0IHR5cGUgc2VsZWN0ZWRMYWJlbEZ1bmN0aW9uID0gKGl0ZW1zOiBJdGVtW10pID0+IHN0cmluZztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXNlbGVjdCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9zZWxlY3QuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFNlbGVjdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25Jbml0IHtcbiAgQElucHV0KCkgcGxhY2Vob2xkZXI6IHN0cmluZyA9IGdldHRleHQoJ1NlbGVjdCBpdGVtJyk7XG4gIEBJbnB1dCgpIHNlbGVjdGVkTGFiZWw6IHN0cmluZyB8IHNlbGVjdGVkTGFiZWxGdW5jdGlvbjtcbiAgQElucHV0KCkgYXBwbHlMYWJlbDogc3RyaW5nID0gZ2V0dGV4dCgnQXBwbHknKTtcbiAgQElucHV0KCkgaXRlbXM6IEl0ZW1bXTtcbiAgQElucHV0KCkgc2VsZWN0ZWQ6IEl0ZW1bXSB8IHNlbGVjdGVkRnVuY3Rpb247XG4gIEBJbnB1dCgpIHVwZGF0ZUl0ZW1zOiBFdmVudEVtaXR0ZXI8Ym9vbGVhbj47XG4gIEBJbnB1dCgpIGRpc2FibGVBcHBseU9uTm9TZWxlY3Rpb246IGJvb2xlYW4gPSBmYWxzZTtcbiAgQE91dHB1dCgpIG9uQ2hhbmdlOiBFdmVudEVtaXR0ZXI8SXRlbVtdPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQFZpZXdDaGlsZChCc0Ryb3Bkb3duRGlyZWN0aXZlLCB7IHN0YXRpYzogZmFsc2UgfSkgZHJvcGRvd246IEJzRHJvcGRvd25EaXJlY3RpdmU7XG4gIEBDb250ZW50Q2hpbGRyZW4oTGlzdEl0ZW1Db21wb25lbnQpIGxpQ2hpbGRyZW47XG4gIHRleHRGaWx0ZXIgPSAnJztcbiAgbGFiZWxUZXh0ID0gJyc7XG4gIGlzT3BlbiA9IGZhbHNlO1xuICBmaWx0ZXJlZEl0ZW1zOiBJdGVtW10gPSBbXTtcbiAgc2VhcmNoRmlsdGVyID0gbnVsbDtcbiAgcmVhZG9ubHkgc2l6ZVRvU2hvd0ZpbHRlcjogbnVtYmVyID0gNTtcbiAgbGFiZWxzRm9yU2VsZWN0QWxsOiBhbnkgPSB7XG4gICAgYWxsOiBnZXR0ZXh0KCdBbGwnKSxcbiAgICBhbGxGaWx0ZXJlZDogZ2V0dGV4dCgnQWxsIGZpbHRlcmVkJylcbiAgfTtcbiAgc2hvd0FsbExhYmVsID0gZmFsc2U7XG4gIHByaXZhdGUgaXRlbXNTZWxlY3RlZDogU2V0PEl0ZW0+ID0gbmV3IFNldCgpO1xuICBwcml2YXRlIHN0b3BDbGlja3MgPSBmYWxzZTtcblxuICBASG9zdExpc3RlbmVyKCdjbGljaycsIFsnJGV2ZW50J10pXG4gIHByZXZlbnRDbGljayhldnQpIHtcbiAgICBpZiAodGhpcy5zdG9wQ2xpY2tzKSB7XG4gICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuICAgIHRoaXMuc3RvcENsaWNrcyA9IHRoaXMuaXNPcGVuO1xuICB9XG5cbiAgaXNPcGVuQ2hhbmdlKGlzT3BlbjogYm9vbGVhbikge1xuICAgIHRoaXMuaXNPcGVuID0gaXNPcGVuO1xuICAgIGlmIChpc09wZW4pIHtcbiAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWQoKTtcbiAgICAgIHRoaXMuc2VhcmNoRmlsdGVyID0gbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdG9wQ2xpY2tzID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgb3V0dGVyU2VsZWN0ZWQoaXRlbTogSXRlbSkge1xuICAgIGNvbnN0IHsgc2VsZWN0ZWQgfSA9IHRoaXM7XG4gICAgbGV0IGlzU2VsZWN0ZWQ6IGFueSA9ICgpID0+IGZhbHNlO1xuICAgIGlmICh0eXBlb2Ygc2VsZWN0ZWQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGlzU2VsZWN0ZWQgPSBzZWxlY3RlZDtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoc2VsZWN0ZWQpKSB7XG4gICAgICBpc1NlbGVjdGVkID0gKGk6IEl0ZW0pID0+IHNlbGVjdGVkLmluZGV4T2YoaSkgPiAtMTtcbiAgICB9XG4gICAgcmV0dXJuIGlzU2VsZWN0ZWQoaXRlbSk7XG4gIH1cblxuICBpc1NlbGVjdGVkKGl0ZW06IEl0ZW0pIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtc1NlbGVjdGVkLmhhcyhpdGVtKTtcbiAgfVxuXG4gIGlzQWxsSXRlbXNTZWxlY3RlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtc1NlbGVjdGVkLnNpemUgPT09IHRoaXMuaXRlbXMubGVuZ3RoO1xuICB9XG5cbiAgaXNBbGxGaWx0ZXJlZFNlbGVjdGVkKCkge1xuICAgIHJldHVybiB0aGlzLml0ZW1zU2VsZWN0ZWQuc2l6ZSA9PT0gdGhpcy5maWx0ZXJlZEl0ZW1zLmxlbmd0aDtcbiAgfVxuXG4gIGlzTm9JdGVtU2VsZWN0ZWQoKSB7XG4gICAgcmV0dXJuICF0aGlzLml0ZW1zU2VsZWN0ZWQuc2l6ZTtcbiAgfVxuXG4gIGFwcGx5Q2hhbmdlcygpIHtcbiAgICBjb25zdCBzZWxlY3RlZCA9IEFycmF5LmZyb20odGhpcy5pdGVtc1NlbGVjdGVkLnZhbHVlcygpKTtcbiAgICB0aGlzLm9uQ2hhbmdlLmVtaXQoc2VsZWN0ZWQpO1xuICAgIHRoaXMuZHJvcGRvd24uaGlkZSgpO1xuICB9XG5cbiAgc2VsZWN0QWxsKGNoZWNrZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmZpbHRlcmVkSXRlbXMuZm9yRWFjaChpdGVtID0+IHRoaXMub25DaGFuZ2VJdGVtKGNoZWNrZWQsIGl0ZW0pKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLnVwZGF0ZUl0ZW1zKSB7XG4gICAgICB0aGlzLnVwZGF0ZUl0ZW1zLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWQoKTtcbiAgICAgICAgdGhpcy51cGRhdGVMYWJlbCgpO1xuICAgICAgICB0aGlzLnNob3dBbGxMYWJlbCA9IHRoaXMuaXNBbGxJdGVtc1NlbGVjdGVkKCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBvbkNoYW5nZUl0ZW0oY2hlY2tlZDogYm9vbGVhbiwgaXRlbTogSXRlbSkge1xuICAgIGlmIChjaGVja2VkKSB7XG4gICAgICB0aGlzLml0ZW1zU2VsZWN0ZWQuYWRkKGl0ZW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLml0ZW1zU2VsZWN0ZWQuZGVsZXRlKGl0ZW0pO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZUZpbHRlcmVkKHRlcm06IHN0cmluZykge1xuICAgIGlmICh0ZXJtKSB7XG4gICAgICBjb25zdCBzZWFyY2ggPSBuZXcgUmVnRXhwKHRlcm0sICdpJyk7XG4gICAgICB0aGlzLmZpbHRlcmVkSXRlbXMgPSB0aGlzLml0ZW1zLmZpbHRlcigoeyBuYW1lIH0pID0+IHNlYXJjaC50ZXN0KG5hbWUpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5maWx0ZXJlZEl0ZW1zID0gdGhpcy5pdGVtcztcbiAgICB9XG4gIH1cblxuICBnZXRTZWxlY3RBbGxUb2dnbGVTdGF0dXMoKSB7XG4gICAgY29uc3QgbGFiZWwgPSB0aGlzLmdldExhYmVsKCk7XG4gICAgY29uc3QgY2hlY2tlZCA9IHRoaXMuaXNBbGxTZWxlY3RlZCgpO1xuICAgIGNvbnN0IGluZGV0ZXJtaW5hdGUgPSAhY2hlY2tlZCAmJiB0aGlzLml0ZW1zU2VsZWN0ZWQuc2l6ZSA+IDA7XG5cbiAgICByZXR1cm4geyBsYWJlbCwgY2hlY2tlZCwgaW5kZXRlcm1pbmF0ZSB9O1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmICh0aGlzLmlzT3Blbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY2hhbmdlcy5pdGVtcyB8fCBjaGFuZ2VzLnNlbGVjdGVkIHx8IGNoYW5nZXMuYXBwbHlMYWJlbCkge1xuICAgICAgdGhpcy51cGRhdGVTZWxlY3RlZCgpO1xuICAgICAgdGhpcy51cGRhdGVMYWJlbCgpO1xuICAgICAgdGhpcy5zaG93QWxsTGFiZWwgPSB0aGlzLmlzQWxsSXRlbXNTZWxlY3RlZCgpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLnVwZGF0ZUl0ZW1zICYmICF0aGlzLnVwZGF0ZUl0ZW1zLmNsb3NlZCkge1xuICAgICAgdGhpcy51cGRhdGVJdGVtcy51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlTGFiZWwoKSB7XG4gICAgY29uc3Qgb3V0dGVyU2VsZWN0ZWQgPSB0aGlzLml0ZW1zLmZpbHRlcihpID0+IHRoaXMub3V0dGVyU2VsZWN0ZWQoaSkpO1xuICAgIGlmICh0eXBlb2YgdGhpcy5zZWxlY3RlZExhYmVsID09PSAnc3RyaW5nJykge1xuICAgICAgdGhpcy5sYWJlbFRleHQgPSB0aGlzLnNlbGVjdGVkTGFiZWw7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdGhpcy5zZWxlY3RlZExhYmVsID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aGlzLmxhYmVsVGV4dCA9IHRoaXMuc2VsZWN0ZWRMYWJlbChvdXR0ZXJTZWxlY3RlZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubGFiZWxUZXh0ID0gb3V0dGVyU2VsZWN0ZWQubWFwKCh7IG5hbWUgfSkgPT4gbmFtZSkuam9pbignLCAnKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVNlbGVjdGVkKCkge1xuICAgIGNvbnN0IHsgaXRlbXNTZWxlY3RlZCwgaXRlbXMgfSA9IHRoaXM7XG4gICAgaXRlbXNTZWxlY3RlZC5jbGVhcigpO1xuICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBpZiAodGhpcy5vdXR0ZXJTZWxlY3RlZChpdGVtKSkge1xuICAgICAgICBpdGVtc1NlbGVjdGVkLmFkZChpdGVtKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLmZpbHRlcmVkSXRlbXMgPSBpdGVtcztcbiAgfVxuXG4gIHByaXZhdGUgaXNBbGxTZWxlY3RlZCgpIHtcbiAgICBpZiAodGhpcy5nZXRMYWJlbCgpID09PSB0aGlzLmxhYmVsc0ZvclNlbGVjdEFsbC5hbGxGaWx0ZXJlZCkge1xuICAgICAgcmV0dXJuIHRoaXMuaXNBbGxGaWx0ZXJlZFNlbGVjdGVkKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmlzQWxsSXRlbXNTZWxlY3RlZCgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0TGFiZWwoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2VhcmNoRmlsdGVyID8gdGhpcy5sYWJlbHNGb3JTZWxlY3RBbGwuYWxsRmlsdGVyZWQgOiB0aGlzLmxhYmVsc0ZvclNlbGVjdEFsbC5hbGw7XG4gIH1cbn1cbiJdfQ==