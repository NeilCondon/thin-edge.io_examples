import * as tslib_1 from "tslib";
import { Component, ViewChild, ViewChildren } from '@angular/core';
import { OperationBulkRealtimeService, DatePickerComponent } from '@c8y/ngx-components';
import { flatten } from 'lodash-es';
import { BehaviorSubject, combineLatest, pipe } from 'rxjs';
import { map, tap, switchMap, withLatestFrom, shareReplay } from 'rxjs/operators';
import { BulkOperationsService, OperationType } from '@c8y/ngx-components/operations/bulk-operations-service';
import { BulkOperationModalsService } from './modals/bulk-operation-modals.service';
import { BulkOperationListItemComponent } from './bulk-operation-list-item.component';
import { BULK_OPERATION_STATUS_OPTIONS } from './bulk-operation-list-item.model';
var BulkOperationsListComponent = /** @class */ (function () {
    function BulkOperationsListComponent(realtime, bulkOperationsService, bulkOperationModalsService) {
        var _this = this;
        this.realtime = realtime;
        this.bulkOperationsService = bulkOperationsService;
        this.bulkOperationModalsService = bulkOperationModalsService;
        this.bulkTypes = [];
        this.selectedTypeFilters = this.getTypeFilters();
        this.bulkOperationStatusOptions = BULK_OPERATION_STATUS_OPTIONS;
        this.refreshLoading = false;
        this.statusFilter$ = new BehaviorSubject(null);
        this.typeFilter$ = new BehaviorSubject(null);
        this.timeFilter$ = new BehaviorSubject(null);
        this.reload$ = new BehaviorSubject(null);
        this.bulkOperations$ = combineLatest(this.statusFilter$, this.timeFilter$, this.typeFilter$, this.reload$).pipe(tap(function () {
            _this.refreshLoading = true;
        }), switchMap(function (_a) {
            var _b = tslib_1.__read(_a, 2), statusFilters = _b[0], timeFilters = _b[1];
            return _this.filter(statusFilters, timeFilters);
        }), withLatestFrom(this.typeFilter$), map(function (_a) {
            var _b = tslib_1.__read(_a, 2), result = _b[0], typeFilter = _b[1];
            _this.filterPipe = pipe(map(function (data) { return _this.filterByType(data, typeFilter); }));
            return tslib_1.__assign({}, result, { data: _this.filterByType(result.data, typeFilter) });
        }), tap(function () {
            _this.refreshLoading = false;
        }), shareReplay(1));
        this.allFilterFragments = this.flattenFilterFragments(this.getTypeFilters());
    }
    BulkOperationsListComponent.prototype.ngOnInit = function () {
        this.bulkTypes = this.bulkOperationsService.getBulkTypes();
    };
    BulkOperationsListComponent.prototype.filterByType = function (bulkOperations, typeFilter) {
        var flattenedFragments = this.flattenFilterFragments(typeFilter);
        if (
        // return data unfiltered if no filters selected...
        !flattenedFragments.length ||
            // ...or when all filters are selected
            this.allFilterFragments.every(function (fragment) { return flattenedFragments.includes(fragment); })) {
            return bulkOperations;
        }
        var filteredData = bulkOperations.filter(function (item) {
            return Object.keys(item.operationPrototype).some(function (key) { return flattenedFragments.includes(key); });
        });
        return filteredData;
    };
    BulkOperationsListComponent.prototype.resetFilter = function () {
        this.statusFilter$.next(null);
        this.timeFilter$.next(null);
        this.typeFilter$.next(null);
        this.datePicker.clearFilter();
        this.selectedTypeFilters = this.getTypeFilters();
        this.statusFilter.reset();
    };
    BulkOperationsListComponent.prototype.isFilterApplied = function () {
        return (this.statusFilter$.getValue() || this.typeFilter$.getValue() || this.timeFilter$.getValue());
    };
    BulkOperationsListComponent.prototype.filter = function (statusFilters, timeFilter) {
        var status = statusFilters && statusFilters.length > 0
            ? {
                generalStatus: flatten(statusFilters.map(function (statusFilter) { return statusFilter.generalStatus; }))
            }
            : {};
        var time = timeFilter
            ? tslib_1.__assign({}, (timeFilter.dateFrom && {
                dateFrom: timeFilter.dateFrom.toISOString()
            }), (timeFilter.dateTo && {
                dateTo: timeFilter.dateTo.toISOString()
            })) : {};
        return this.getBulkOperations(tslib_1.__assign({}, status, time));
    };
    BulkOperationsListComponent.prototype.getBulkOperations = function (filter) {
        return this.bulkOperationsService.getBulkOperations(filter);
    };
    BulkOperationsListComponent.prototype.getTypeFilters = function () {
        return this.bulkOperationsService.getBulkTypes();
    };
    BulkOperationsListComponent.prototype.addBulkOperation = function () {
        this.bulkOperationModalsService.showNewBulkOperationModal();
    };
    BulkOperationsListComponent.prototype.openFailedOperation = function (failedParentId) {
        this.listItems.forEach(function (item) {
            if (item.bulkOperation.id === failedParentId) {
                item.listItem.collapsed = false;
                item.listItem.element.nativeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    };
    BulkOperationsListComponent.prototype.compareOperations = function (operationA, operationB) {
        return new Date(operationA.startDate).getTime() - new Date(operationB.startDate).getTime();
    };
    BulkOperationsListComponent.prototype.flattenFilterFragments = function (filters) {
        return (filters || []).reduce(function (flattened, current) { return flattened.concat(current.fragments); }, []);
    };
    BulkOperationsListComponent.ctorParameters = function () { return [
        { type: OperationBulkRealtimeService },
        { type: BulkOperationsService },
        { type: BulkOperationModalsService }
    ]; };
    tslib_1.__decorate([
        ViewChildren(BulkOperationListItemComponent)
    ], BulkOperationsListComponent.prototype, "listItems", void 0);
    tslib_1.__decorate([
        ViewChild('statusFilter', { static: true })
    ], BulkOperationsListComponent.prototype, "statusFilter", void 0);
    tslib_1.__decorate([
        ViewChild(DatePickerComponent, { static: true })
    ], BulkOperationsListComponent.prototype, "datePicker", void 0);
    BulkOperationsListComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-bulk-operations',
            template: "<c8y-title> {{ 'Device control' | translate }}</c8y-title>\n<c8y-action-bar-item *ngIf=\"bulkTypes?.length\" itemClass=\"navbar-form\" [placement]=\"'left'\">\n  <label translate class=\"hidden-sm\">Type</label>\n  <c8y-select\n    style=\"width: 180px;\"\n    [items]=\"bulkTypes\"\n    [selected]=\"selectedTypeFilters\"\n    [disableApplyOnNoSelection]=\"true\"\n    (onChange)=\"selectedTypeFilters = $event; typeFilter$.next(selectedTypeFilters)\"\n  >\n  </c8y-select>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'left'\" itemClass=\"navbar-form\">\n  <c8y-status-filter\n    #statusFilter\n    [options]=\"bulkOperationStatusOptions\"\n    (onFilterChanged)=\"statusFilter$.next($event)\"\n  ></c8y-status-filter>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'left'\" itemClass=\"navbar-form\">\n  <c8y-date-picker (onDateSelected)=\"timeFilter$.next($event)\"></c8y-date-picker>\n</c8y-action-bar-item>\n\n<c8y-action-bar-item [placement]=\"'right'\">\n  <c8y-realtime-btn [service]=\"realtime\"></c8y-realtime-btn>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button\n    *ngIf=\"bulkTypes?.length\"\n    class=\"btn btn-link d-flex a-i-center\"\n    (click)=\"addBulkOperation()\"\n    title=\"{{ 'New bulk operation' | translate }}\"\n  >\n    <i c8yIcon=\"plus-circle\" class=\"m-r-4\"></i> \n    <span class=\"text-truncate\">\n      {{ 'New bulk operation' | translate }}\n    </span> \n  </button>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link d-flex a-i-center\" \n    title=\"{{ 'Reload' | translate }}\" \n    (click)=\"reload$.next()\"\n  >\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'icon-spin': refreshLoading }\" class=\"m-r-4\"></i>\n    <span class=\"text-truncate\">\n      {{ 'Reload' | translate }}\n    </span>\n  </button>\n</c8y-action-bar-item>\n<!-- Empty state  -->\n<div\n  class=\"c8y-empty-state text-center\"\n  *ngIf=\"(bulkOperations$ | async)?.data.length === 0 && !isFilterApplied()\"\n>\n  <h1 class=\"c8y-icon c8y-icon-energy c8y-icon-duocolor\"></h1>\n  <h3 translate>No items to display</h3>\n  <p translate>Bulk operations will be displayed here</p>\n  <button\n    type=\"button\"\n    *ngIf=\"bulkTypes?.length\"\n    title=\"{{ 'New bulk operation' | translate }}\"\n    class=\"btn btn-primary\"\n    (click)=\"addBulkOperation()\"\n    translate\n  >\n    New bulk operation\n  </button>\n</div>\n\n<!-- No results empty state -->\n<div\n  class=\"c8y-empty-state text-center\"\n  *ngIf=\"(bulkOperations$ | async)?.data.length === 0 && isFilterApplied()\"\n>\n  <h1 c8yIcon=\"search\" class=\"c8y-icon c8y-icon-duocolor\"></h1>\n  <h3 translate>No results to display.</h3>\n  <p translate>Adjust or reset the filter.</p>\n  <button\n    type=\"button\"\n    title=\"{{ 'Reset filter' | translate }}\"\n    class=\"btn btn-primary\"\n    (click)=\"resetFilter()\"\n    translate\n  >\n    Reset filter\n  </button>\n</div>\n\n<!-- Detailed list of operations + load more button -->\n<c8y-list-group\n  class=\"m-b-24\"\n  [ngClass]=\"{ 'dd-low': (bulkOperations$ | async)?.data.length < 10 }\"\n>\n  <div\n    class=\"page-sticky-header hidden-xs c8y-list__item--double-actions c8y-list__item\"\n    *ngIf=\"(bulkOperations$ | async)?.data.length\"\n  >\n    <div class=\"c8y-list__item__block\">\n      <div class=\"c8y-list__item__icon\">\n        <i class=\"fa\"></i>\n      </div>\n      <div class=\"c8y-list__item__body\">\n        <div class=\"content-flex-57\">\n          <div class=\"col-5\">\n            {{ 'Operation' | translate }}\n          </div>\n          <div class=\"flex-grow\">\n            {{ 'Progress' | translate }}\n          </div>\n          <div class=\"col-4\">\n            {{ 'Status' | translate }}\n          </div>\n        </div>\n      </div>\n      <div class=\"c8y-list__item__actions\"></div>\n    </div>\n  </div>\n  <div\n    class=\"d-contents\"\n    *c8yFor=\"\n      let bulkOperation of bulkOperations$ | async;\n      let i = index;\n      realtime: realtime;\n      pipe: filterPipe;\n      comparator: compareOperations.bind(this);\n      loadMore: 'auto';\n    \"\n  >\n    <c8y-bulk-operation-list-item\n      [bulkOperation]=\"bulkOperation\"\n      (reload)=\"reload$.next()\"\n      (showFailedOperation)=\"openFailedOperation($event)\"\n      class=\"d-contents\"\n    >\n    </c8y-bulk-operation-list-item>\n  </div>\n</c8y-list-group>\n",
            providers: [OperationBulkRealtimeService]
        })
    ], BulkOperationsListComponent);
    return BulkOperationsListComponent;
}());
export { BulkOperationsListComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLWxpc3QuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9ucy1saXN0LyIsInNvdXJjZXMiOlsiYnVsay1vcGVyYXRpb25zLWxpc3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFxQixTQUFTLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXRGLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3hGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDcEMsT0FBTyxFQUFFLGVBQWUsRUFBYyxhQUFhLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxjQUFjLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEYsT0FBTyxFQUNMLHFCQUFxQixFQUNyQixhQUFhLEVBQ2QsTUFBTSx3REFBd0QsQ0FBQztBQUNoRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNwRixPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUN0RixPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQU1qRjtJQXdDRSxxQ0FDUyxRQUFzQyxFQUNyQyxxQkFBNEMsRUFDNUMsMEJBQXNEO1FBSGhFLGlCQU1DO1FBTFEsYUFBUSxHQUFSLFFBQVEsQ0FBOEI7UUFDckMsMEJBQXFCLEdBQXJCLHFCQUFxQixDQUF1QjtRQUM1QywrQkFBMEIsR0FBMUIsMEJBQTBCLENBQTRCO1FBMUNoRSxjQUFTLEdBQW9CLEVBQUUsQ0FBQztRQUNoQyx3QkFBbUIsR0FBRyxJQUFJLENB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LE9BQUEsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQW5DLENBQW1DLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDakcsQ0FBQzs7Z0JBN0ZrQiw0QkFBNEI7Z0JBQ2QscUJBQXFCO2dCQUNoQiwwQkFBMEI7O0lBaENsQjtRQUE3QyxZQUFZLENBQUMsOEJBQThCLENBQUM7a0VBRTNDO0lBQzJDO1FBQTVDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7cUVBQXFDO0lBQy9CO1FBQWpELFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQzttRUFBaUM7SUFmdkUsMkJBQTJCO1FBTHZDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxxQkFBcUI7WUFDL0IsKzNJQUFvRDtZQUNwRCxTQUFTLEVBQUUsQ0FBQyw0QkFBNEIsQ0FBQztTQUMxQyxDQUFDO09BQ1csMkJBQTJCLENBdUl2QztJQUFELGtDQUFDO0NBQUEsQUF2SUQsSUF1SUM7U0F2SVksMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIFF1ZXJ5TGlzdCwgVmlld0NoaWxkLCBWaWV3Q2hpbGRyZW4gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElPcGVyYXRpb25CdWxrLCBJUmVzdWx0TGlzdCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IE9wZXJhdGlvbkJ1bGtSZWFsdGltZVNlcnZpY2UsIERhdGVQaWNrZXJDb21wb25lbnQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGZsYXR0ZW4gfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBjb21iaW5lTGF0ZXN0LCBwaXBlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRhcCwgc3dpdGNoTWFwLCB3aXRoTGF0ZXN0RnJvbSwgc2hhcmVSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBTdGF0dXNGaWx0ZXJDb21wb25lbnQsIElTdGF0dXNPcHRpb24gfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvc3RhdHVzLWZpbHRlcic7XG5pbXBvcnQge1xuICBCdWxrT3BlcmF0aW9uc1NlcnZpY2UsXG4gIE9wZXJhdGlvblR5cGVcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9ucy1zZXJ2aWNlJztcbmltcG9ydCB7IEJ1bGtPcGVyYXRpb25Nb2RhbHNTZXJ2aWNlIH0gZnJvbSAnLi9tb2RhbHMvYnVsay1vcGVyYXRpb24tbW9kYWxzLnNlcnZpY2UnO1xuaW1wb3J0IHsgQnVsa09wZXJhdGlvbkxpc3RJdGVtQ29tcG9uZW50IH0gZnJvbSAnLi9idWxrLW9wZXJhdGlvbi1saXN0LWl0ZW0uY29tcG9uZW50JztcbmltcG9ydCB7IEJVTEtfT1BFUkFUSU9OX1NUQVRVU19PUFRJT05TIH0gZnJvbSAnLi9idWxrLW9wZXJhdGlvbi1saXN0LWl0ZW0ubW9kZWwnO1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWJ1bGstb3BlcmF0aW9ucycsXG4gIHRlbXBsYXRlVXJsOiAnLi9idWxrLW9wZXJhdGlvbnMtbGlzdC5jb21wb25lbnQuaHRtbCcsXG4gIHByb3ZpZGVyczogW09wZXJhdGlvbkJ1bGtSZWFsdGltZVNlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIEJ1bGtPcGVyYXRpb25zTGlzdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIGJ1bGtUeXBlczogT3BlcmF0aW9uVHlwZVtdID0gW107XG4gIHNlbGVjdGVkVHlwZUZpbHRlcnMgPSB0aGlzLmdldFR5cGVGaWx0ZXJzKCk7XG4gIGJ1bGtPcGVyYXRpb25TdGF0dXNPcHRpb25zOiBJU3RhdHVzT3B0aW9uW10gPSBCVUxLX09QRVJBVElPTl9TVEFUVVNfT1BUSU9OUztcblxuICBmaWx0ZXJQaXBlO1xuICByZWZyZXNoTG9hZGluZzogYm9vbGVhbiA9IGZhbHNlO1xuICBzdGF0dXNGaWx0ZXIkOiBCZWhhdmlvclN1YmplY3Q8SVN0YXR1c09wdGlvbltdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIHR5cGVGaWx0ZXIkOiBCZWhhdmlvclN1YmplY3Q8T3BlcmF0aW9uVHlwZVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIHRpbWVGaWx0ZXIkOiBCZWhhdmlvclN1YmplY3Q8YW55PiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIHJlbG9hZCQ6IEJlaGF2aW9yU3ViamVjdDx2b2lkPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIEBWaWV3Q2hpbGRyZW4oQnVsa09wZXJhdGlvbkxpc3RJdGVtQ29tcG9uZW50KSBsaXN0SXRlbXM6IFF1ZXJ5TGlzdDxcbiAgICBCdWxrT3BlcmF0aW9uTGlzdEl0ZW1Db21wb25lbnRcbiAgPjtcbiAgQFZpZXdDaGlsZCgnc3RhdHVzRmlsdGVyJywgeyBzdGF0aWM6IHRydWUgfSkgc3RhdHVzRmlsdGVyOiBTdGF0dXNGaWx0ZXJDb21wb25lbnQ7XG4gIEBWaWV3Q2hpbGQoRGF0ZVBpY2tlckNvbXBvbmVudCwgeyBzdGF0aWM6IHRydWUgfSkgZGF0ZVBpY2tlcjogRGF0ZVBpY2tlckNvbXBvbmVudDtcblxuICBidWxrT3BlcmF0aW9ucyQ6IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SU9wZXJhdGlvbkJ1bGs+PiA9IGNvbWJpbmVMYXRlc3QoXG4gICAgdGhpcy5zdGF0dXNGaWx0ZXIkLFxuICAgIHRoaXMudGltZUZpbHRlciQsXG4gICAgdGhpcy50eXBlRmlsdGVyJCxcbiAgICB0aGlzLnJlbG9hZCRcbiAgKS5waXBlKFxuICAgIHRhcCgoKSA9PiB7XG4gICAgICB0aGlzLnJlZnJlc2hMb2FkaW5nID0gdHJ1ZTtcbiAgICB9KSxcbiAgICBzd2l0Y2hNYXAoKFtzdGF0dXNGaWx0ZXJzLCB0aW1lRmlsdGVyc10pID0+IHRoaXMuZmlsdGVyKHN0YXR1c0ZpbHRlcnMsIHRpbWVGaWx0ZXJzKSksXG4gICAgd2l0aExhdGVzdEZyb20odGhpcy50eXBlRmlsdGVyJCksXG4gICAgbWFwKChbcmVzdWx0LCB0eXBlRmlsdGVyXTogW0lSZXN1bHRMaXN0PElPcGVyYXRpb25CdWxrPiwgT3BlcmF0aW9uVHlwZVtdXSkgPT4ge1xuICAgICAgdGhpcy5maWx0ZXJQaXBlID0gcGlwZShtYXAoKGRhdGE6IFtdKSA9PiB0aGlzLmZpbHRlckJ5VHlwZShkYXRhLCB0eXBlRmlsdGVyKSkpO1xuICAgICAgcmV0dXJuIHsgLi4ucmVzdWx0LCBkYXRhOiB0aGlzLmZpbHRlckJ5VHlwZShyZXN1bHQuZGF0YSwgdHlwZUZpbHRlcikgfTtcbiAgICB9KSxcbiAgICB0YXAoKCkgPT4ge1xuICAgICAgdGhpcy5yZWZyZXNoTG9hZGluZyA9IGZhbHNlO1xuICAgIH0pLFxuICAgIHNoYXJlUmVwbGF5KDEpXG4gICk7XG5cbiAgcHJpdmF0ZSBhbGxGaWx0ZXJGcmFnbWVudHM6IHN0cmluZ1tdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByZWFsdGltZTogT3BlcmF0aW9uQnVsa1JlYWx0aW1lU2VydmljZSxcbiAgICBwcml2YXRlIGJ1bGtPcGVyYXRpb25zU2VydmljZTogQnVsa09wZXJhdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnVsa09wZXJhdGlvbk1vZGFsc1NlcnZpY2U6IEJ1bGtPcGVyYXRpb25Nb2RhbHNTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuYWxsRmlsdGVyRnJhZ21lbnRzID0gdGhpcy5mbGF0dGVuRmlsdGVyRnJhZ21lbnRzKHRoaXMuZ2V0VHlwZUZpbHRlcnMoKSk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmJ1bGtUeXBlcyA9IHRoaXMuYnVsa09wZXJhdGlvbnNTZXJ2aWNlLmdldEJ1bGtUeXBlcygpO1xuICB9XG5cbiAgZmlsdGVyQnlUeXBlKGJ1bGtPcGVyYXRpb25zOiBJT3BlcmF0aW9uQnVsa1tdLCB0eXBlRmlsdGVyKSB7XG4gICAgY29uc3QgZmxhdHRlbmVkRnJhZ21lbnRzOiBzdHJpbmdbXSA9IHRoaXMuZmxhdHRlbkZpbHRlckZyYWdtZW50cyh0eXBlRmlsdGVyKTtcbiAgICBpZiAoXG4gICAgICAvLyByZXR1cm4gZGF0YSB1bmZpbHRlcmVkIGlmIG5vIGZpbHRlcnMgc2VsZWN0ZWQuLi5cbiAgICAgICFmbGF0dGVuZWRGcmFnbWVudHMubGVuZ3RoIHx8XG4gICAgICAvLyAuLi5vciB3aGVuIGFsbCBmaWx0ZXJzIGFyZSBzZWxlY3RlZFxuICAgICAgdGhpcy5hbGxGaWx0ZXJGcmFnbWVudHMuZXZlcnkoZnJhZ21lbnQgPT4gZmxhdHRlbmVkRnJhZ21lbnRzLmluY2x1ZGVzKGZyYWdtZW50KSlcbiAgICApIHtcbiAgICAgIHJldHVybiBidWxrT3BlcmF0aW9ucztcbiAgICB9XG5cbiAgICBjb25zdCBmaWx0ZXJlZERhdGEgPSBidWxrT3BlcmF0aW9ucy5maWx0ZXIoaXRlbSA9PiB7XG4gICAgICByZXR1cm4gT2JqZWN0LmtleXMoaXRlbS5vcGVyYXRpb25Qcm90b3R5cGUpLnNvbWUoa2V5ID0+IGZsYXR0ZW5lZEZyYWdtZW50cy5pbmNsdWRlcyhrZXkpKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBmaWx0ZXJlZERhdGE7XG4gIH1cblxuICByZXNldEZpbHRlcigpIHtcbiAgICB0aGlzLnN0YXR1c0ZpbHRlciQubmV4dChudWxsKTtcbiAgICB0aGlzLnRpbWVGaWx0ZXIkLm5leHQobnVsbCk7XG4gICAgdGhpcy50eXBlRmlsdGVyJC5uZXh0KG51bGwpO1xuXG4gICAgdGhpcy5kYXRlUGlja2VyLmNsZWFyRmlsdGVyKCk7XG4gICAgdGhpcy5zZWxlY3RlZFR5cGVGaWx0ZXJzID0gdGhpcy5nZXRUeXBlRmlsdGVycygpO1xuICAgIHRoaXMuc3RhdHVzRmlsdGVyLnJlc2V0KCk7XG4gIH1cblxuICBpc0ZpbHRlckFwcGxpZWQoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuc3RhdHVzRmlsdGVyJC5nZXRWYWx1ZSgpIHx8IHRoaXMudHlwZUZpbHRlciQuZ2V0VmFsdWUoKSB8fCB0aGlzLnRpbWVGaWx0ZXIkLmdldFZhbHVlKClcbiAgICApO1xuICB9XG5cbiAgZmlsdGVyKHN0YXR1c0ZpbHRlcnMsIHRpbWVGaWx0ZXIpIHtcbiAgICBjb25zdCBzdGF0dXMgPVxuICAgICAgc3RhdHVzRmlsdGVycyAmJiBzdGF0dXNGaWx0ZXJzLmxlbmd0aCA+IDBcbiAgICAgICAgPyB7XG4gICAgICAgICAgICBnZW5lcmFsU3RhdHVzOiBmbGF0dGVuKHN0YXR1c0ZpbHRlcnMubWFwKHN0YXR1c0ZpbHRlciA9PiBzdGF0dXNGaWx0ZXIuZ2VuZXJhbFN0YXR1cykpXG4gICAgICAgICAgfVxuICAgICAgICA6IHt9O1xuXG4gICAgY29uc3QgdGltZSA9IHRpbWVGaWx0ZXJcbiAgICAgID8ge1xuICAgICAgICAgIC4uLih0aW1lRmlsdGVyLmRhdGVGcm9tICYmIHtcbiAgICAgICAgICAgIGRhdGVGcm9tOiB0aW1lRmlsdGVyLmRhdGVGcm9tLnRvSVNPU3RyaW5nKClcbiAgICAgICAgICB9KSxcbiAgICAgICAgICAuLi4odGltZUZpbHRlci5kYXRlVG8gJiYge1xuICAgICAgICAgICAgZGF0ZVRvOiB0aW1lRmlsdGVyLmRhdGVUby50b0lTT1N0cmluZygpXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgOiB7fTtcbiAgICByZXR1cm4gdGhpcy5nZXRCdWxrT3BlcmF0aW9ucyh7IC4uLnN0YXR1cywgLi4udGltZSB9KTtcbiAgfVxuXG4gIGdldEJ1bGtPcGVyYXRpb25zKGZpbHRlcj8pIHtcbiAgICByZXR1cm4gdGhpcy5idWxrT3BlcmF0aW9uc1NlcnZpY2UuZ2V0QnVsa09wZXJhdGlvbnMoZmlsdGVyKTtcbiAgfVxuXG4gIGdldFR5cGVGaWx0ZXJzKCkge1xuICAgIHJldHVybiB0aGlzLmJ1bGtPcGVyYXRpb25zU2VydmljZS5nZXRCdWxrVHlwZXMoKTtcbiAgfVxuXG4gIGFkZEJ1bGtPcGVyYXRpb24oKSB7XG4gICAgdGhpcy5idWxrT3BlcmF0aW9uTW9kYWxzU2VydmljZS5zaG93TmV3QnVsa09wZXJhdGlvbk1vZGFsKCk7XG4gIH1cblxuICBvcGVuRmFpbGVkT3BlcmF0aW9uKGZhaWxlZFBhcmVudElkKSB7XG4gICAgdGhpcy5saXN0SXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGlmIChpdGVtLmJ1bGtPcGVyYXRpb24uaWQgPT09IGZhaWxlZFBhcmVudElkKSB7XG4gICAgICAgIGl0ZW0ubGlzdEl0ZW0uY29sbGFwc2VkID0gZmFsc2U7XG4gICAgICAgIGl0ZW0ubGlzdEl0ZW0uZWxlbWVudC5uYXRpdmVFbGVtZW50LnNjcm9sbEludG9WaWV3KHsgYmVoYXZpb3I6ICdzbW9vdGgnLCBibG9jazogJ2NlbnRlcicgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBjb21wYXJlT3BlcmF0aW9ucyhvcGVyYXRpb25BOiBJT3BlcmF0aW9uQnVsaywgb3BlcmF0aW9uQjogSU9wZXJhdGlvbkJ1bGspOiBudW1iZXIge1xuICAgIHJldHVybiBuZXcgRGF0ZShvcGVyYXRpb25BLnN0YXJ0RGF0ZSkuZ2V0VGltZSgpIC0gbmV3IERhdGUob3BlcmF0aW9uQi5zdGFydERhdGUpLmdldFRpbWUoKTtcbiAgfVxuXG4gIHByaXZhdGUgZmxhdHRlbkZpbHRlckZyYWdtZW50cyhmaWx0ZXJzOiBPcGVyYXRpb25UeXBlW10pOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIChmaWx0ZXJzIHx8IFtdKS5yZWR1Y2UoKGZsYXR0ZW5lZCwgY3VycmVudCkgPT4gZmxhdHRlbmVkLmNvbmNhdChjdXJyZW50LmZyYWdtZW50cyksIFtdKTtcbiAgfVxufVxuIl19