import * as tslib_1 from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { flatten, has, isUndefined } from 'lodash-es';
import { Subject } from 'rxjs';
import { IdReference, IManagedObject, InventoryService, IOperation, IOperationBulk, IResult, OperationBulkService, OperationService } from '@c8y/client';
export var baseUrl = 'devicecontrol/bulk/creation/';
export var HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
var BulkOperationsService = /** @class */ (function () {
    function BulkOperationsService(operationBulkService, operationService, inventoryService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.location = location;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        this.bulkTypes = flatten(bulkTypes);
        this.bulkTypes = this.bulkTypes.map(function (type) {
            if (isUndefined(type.selected)) {
                type.selected = false;
            }
            return type;
        });
    }
    BulkOperationsService.prototype.getBulkOperations = function (customFilter) {
        if (customFilter === void 0) { customFilter = {}; }
        var filter = tslib_1.__assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    };
    BulkOperationsService.prototype.getBulkOperationById = function (bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    };
    BulkOperationsService.prototype.createBulkOperation = function (bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    };
    BulkOperationsService.prototype.deleteBulkOperation = function (bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    };
    BulkOperationsService.prototype.updateBulkOperation = function (bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    };
    BulkOperationsService.prototype.getOperation = function (id) {
        return this.operationService.detail(id);
    };
    BulkOperationsService.prototype.returnToBulkOperationOverview = function () {
        this.location.back();
    };
    BulkOperationsService.prototype.setBulkTypes = function (list) {
        this.bulkTypes = list;
    };
    BulkOperationsService.prototype.getBulkTypes = function () {
        return this.bulkTypes;
    };
    BulkOperationsService.prototype.setFirmwareId = function (id) {
        this.firmwareId.next(id);
    };
    BulkOperationsService.prototype.createGroup = function (deviceQueryDataString) {
        var dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    };
    BulkOperationsService.prototype.scheduleBulkOperation = function (deviceQueryString, details) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var dynamicGroup, bulkOperation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.createGroup(deviceQueryString)];
                    case 1:
                        dynamicGroup = _a.sent();
                        bulkOperation = {
                            groupId: dynamicGroup.data.id,
                            operationPrototype: details.prototype,
                            creationRamp: details.schedule.delayInSeconds,
                            startDate: details.schedule.scheduledDate.toISOString(),
                            note: details.note
                        };
                        return [4 /*yield*/, this.createBulkOperation(bulkOperation)];
                    case 2:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    BulkOperationsService.prototype.getSingleOperationsByStatus = function (status, bulkOperationId) {
        var filter = {
            withTotalPages: true,
            bulkOperationId: bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    };
    BulkOperationsService.prototype.createSingleOperation = function (operation) {
        return this.operationService.create(operation);
    };
    BulkOperationsService.prototype.updateSingleOperation = function (partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    };
    BulkOperationsService.prototype.getManagedObject = function (deviceId) {
        return this.inventoryService.detail(deviceId);
    };
    BulkOperationsService.prototype.retrieveBulkOperationType = function (operation) {
        var type;
        this.bulkTypes.some(function (t) {
            if (t.fragments.some(function (fragment) { return has(operation, fragment); })) {
                type = t.type;
                return true;
            }
        });
        return type;
    };
    BulkOperationsService.ctorParameters = function () { return [
        { type: OperationBulkService },
        { type: OperationService },
        { type: InventoryService },
        { type: Location },
        { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
    ]; };
    BulkOperationsService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(4, Optional()), tslib_1.__param(4, Inject(HOOK_LIST_BULK_TYPE))
    ], BulkOperationsService);
    return BulkOperationsService;
}());
export { BulkOperationsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb25zLXNlcnZpY2UvIiwic291cmNlcyI6WyJidWxrLW9wZXJhdGlvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0UsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUNMLFdBQVcsRUFDWCxjQUFjLEVBQ2QsZ0JBQWdCLEVBQ2hCLFVBQVUsRUFDVixjQUFjLEVBQ2QsT0FBTyxFQUNQLG9CQUFvQixFQUNwQixnQkFBZ0IsRUFDakIsTUFBTSxhQUFhLENBQUM7QUFNckIsTUFBTSxDQUFDLElBQU0sT0FBTyxHQUFHLDhCQUE4QixDQUFDO0FBQ3RELE1BQU0sQ0FBQyxJQUFNLG1CQUFtQixHQUFHLElBQUksY0FBYyxDQUNuRCxnQkFBZ0IsQ0FDakIsQ0FBQztBQUdGO0lBTUUsK0JBQ1Usb0JBQTBDLEVBQzFDLGdCQUFrQyxFQUNsQyxnQkFBa0MsRUFDbEMsUUFBa0IsRUFFZSxTQUFpRDtRQUxsRix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBVG5CLGlCQUFZLEdBQVcsRUFBRSxDQUFDO1FBQ25DLGVBQVUsR0FBeUIsSUFBSSxPQUFPLEVBQWUsQ0FBQztRQVk1RCxJ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LENBQUMsSUFBSSxDQUFDO2dCQUNkLE9BQU8sSUFBSSxDQUFDO2FBQ2I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7Z0JBMUgrQixvQkFBb0I7Z0JBQ3hCLGdCQUFnQjtnQkFDaEIsZ0JBQWdCO2dCQUN4QixRQUFRO2dCQUUwQixLQUFLLHVCQUF4RCxRQUFRLFlBQUksTUFBTSxTQUFDLG1CQUFtQjs7SUFaOUIscUJBQXFCO1FBRGpDLFVBQVUsRUFBRTtRQWFSLG1CQUFBLFFBQVEsRUFBRSxDQUFBLEVBQUUsbUJBQUEsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUE7T0FaL0IscUJBQXFCLENBa0lqQztJQUFELDRCQUFDO0NBQUEsQUFsSUQsSUFrSUM7U0FsSVkscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZsYXR0ZW4sIGhhcywgaXNVbmRlZmluZWQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQge1xuICBJZFJlZmVyZW5jZSxcbiAgSU1hbmFnZWRPYmplY3QsXG4gIEludmVudG9yeVNlcnZpY2UsXG4gIElPcGVyYXRpb24sXG4gIElPcGVyYXRpb25CdWxrLFxuICBJUmVzdWx0LFxuICBPcGVyYXRpb25CdWxrU2VydmljZSxcbiAgT3BlcmF0aW9uU2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbmltcG9ydCB7IE9wZXJhdGlvbkRldGFpbHMgfSBmcm9tICcuL29wZXJhdGlvbi1kZXRhaWxzLm1vZGVsJztcbmltcG9ydCB7IE9wZXJhdGlvblR5cGUgfSBmcm9tICcuL29wZXJhdGlvbi10eXBlLm1vZGVsJztcbmltcG9ydCB7IEJ1bGtPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi9idWxrLW9wZXJhdGlvbi5tb2RlbCc7XG5cbmV4cG9ydCBjb25zdCBiYXNlVXJsID0gJ2RldmljZWNvbnRyb2wvYnVsay9jcmVhdGlvbi8nO1xuZXhwb3J0IGNvbnN0IEhPT0tfTElTVF9CVUxLX1RZUEUgPSBuZXcgSW5qZWN0aW9uVG9rZW48T3BlcmF0aW9uVHlwZSB8IE9wZXJhdGlvblR5cGVbXT4oXG4gICdMSVNUX0JVTEtfVFlQRSdcbik7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCdWxrT3BlcmF0aW9uc1NlcnZpY2Uge1xuICByZWFkb25seSBERF9MT1dfQ09VTlQ6IG51bWJlciA9IDEwO1xuICBmaXJtd2FyZUlkOiBTdWJqZWN0PElkUmVmZXJlbmNlPiA9IG5ldyBTdWJqZWN0PElkUmVmZXJlbmNlPigpO1xuXG4gIHByaXZhdGUgYnVsa1R5cGVzOiBPcGVyYXRpb25UeXBlW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25CdWxrU2VydmljZTogT3BlcmF0aW9uQnVsa1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25TZXJ2aWNlOiBPcGVyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgaW52ZW50b3J5U2VydmljZTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGxvY2F0aW9uOiBMb2NhdGlvbixcblxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSE9PS19MSVNUX0JVTEtfVFlQRSkgYnVsa1R5cGVzOiBBcnJheTxPcGVyYXRpb25UeXBlIHwgT3BlcmF0aW9uVHlwZVtdPlxuICApIHtcbiAgICB0aGlzLmJ1bGtUeXBlcyA9IGZsYXR0ZW4oYnVsa1R5cGVzKTtcblxuICAgIHRoaXMuYnVsa1R5cGVzID0gdGhpcy5idWxrVHlwZXMubWFwKHR5cGUgPT4ge1xuICAgICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUuc2VsZWN0ZWQpKSB7XG4gICAgICAgIHR5cGUuc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0eXBlO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0QnVsa09wZXJhdGlvbnMoY3VzdG9tRmlsdGVyID0ge30pIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7XG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICAgIHdpdGhEZWxldGVkOiB0cnVlLFxuICAgICAgcGFnZVNpemU6IDUwLFxuICAgICAgLi4uY3VzdG9tRmlsdGVyXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmxpc3QoZmlsdGVyKTtcbiAgfVxuXG4gIGdldEJ1bGtPcGVyYXRpb25CeUlkKGJ1bGtPcGVyYXRpb25JZDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuZGV0YWlsKGJ1bGtPcGVyYXRpb25JZCk7XG4gIH1cblxuICBjcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb246IFBhcnRpYWw8SU9wZXJhdGlvbkJ1bGs+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuY3JlYXRlKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZGVsZXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uSWQpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5kZWxldGUoYnVsa09wZXJhdGlvbklkKTtcbiAgfVxuXG4gIHVwZGF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS51cGRhdGUoYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBnZXRPcGVyYXRpb24oaWQ6IHN0cmluZyk6IFByb21pc2U8SVJlc3VsdDxJT3BlcmF0aW9uPj4ge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UuZGV0YWlsKGlkKTtcbiAgfVxuXG4gIHJldHVyblRvQnVsa09wZXJhdGlvbk92ZXJ2aWV3KCkge1xuICAgIHRoaXMubG9jYXRpb24uYmFjaygpO1xuICB9XG5cbiAgc2V0QnVsa1R5cGVzKGxpc3Q6IE9wZXJhdGlvblR5cGVbXSkge1xuICAgIHRoaXMuYnVsa1R5cGVzID0gbGlzdDtcbiAgfVxuXG4gIGdldEJ1bGtUeXBlcygpOiBPcGVyYXRpb25UeXBlW10ge1xuICAgIHJldHVybiB0aGlzLmJ1bGtUeXBlcztcbiAgfVxuXG4gIHNldEZpcm13YXJlSWQoaWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgdGhpcy5maXJtd2FyZUlkLm5leHQoaWQpO1xuICB9XG5cbiAgY3JlYXRlR3JvdXAoZGV2aWNlUXVlcnlEYXRhU3RyaW5nOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkeW5hbWljR3JvdXA6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+ID0ge1xuICAgICAgbmFtZTogJ0J1bGsgb3BlcmF0aW9ucyBncm91cCcsXG4gICAgICB0eXBlOiAnYzh5X0R5bmFtaWNHcm91cCcsXG4gICAgICBjOHlfSXNEeW5hbWljR3JvdXA6IHsgaW52aXNpYmxlOiB7fSB9LFxuICAgICAgYzh5X0RldmljZVF1ZXJ5U3RyaW5nOiBkZXZpY2VRdWVyeURhdGFTdHJpbmdcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5jcmVhdGUoZHluYW1pY0dyb3VwKTtcbiAgfVxuXG4gIGFzeW5jIHNjaGVkdWxlQnVsa09wZXJhdGlvbihkZXZpY2VRdWVyeVN0cmluZzogc3RyaW5nLCBkZXRhaWxzOiBPcGVyYXRpb25EZXRhaWxzKSB7XG4gICAgY29uc3QgZHluYW1pY0dyb3VwID0gYXdhaXQgdGhpcy5jcmVhdGVHcm91cChkZXZpY2VRdWVyeVN0cmluZyk7XG5cbiAgICBjb25zdCBidWxrT3BlcmF0aW9uOiBJT3BlcmF0aW9uQnVsayA9IHtcbiAgICAgIGdyb3VwSWQ6IGR5bmFtaWNHcm91cC5kYXRhLmlkLFxuICAgICAgb3BlcmF0aW9uUHJvdG90eXBlOiBkZXRhaWxzLnByb3RvdHlwZSxcbiAgICAgIGNyZWF0aW9uUmFtcDogZGV0YWlscy5zY2hlZHVsZS5kZWxheUluU2Vjb25kcyxcbiAgICAgIHN0YXJ0RGF0ZTogZGV0YWlscy5zY2hlZHVsZS5zY2hlZHVsZWREYXRlLnRvSVNPU3RyaW5nKCksXG4gICAgICBub3RlOiBkZXRhaWxzLm5vdGVcbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5jcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZ2V0U2luZ2xlT3BlcmF0aW9uc0J5U3RhdHVzKHN0YXR1cywgYnVsa09wZXJhdGlvbklkKSB7XG4gICAgY29uc3QgZmlsdGVyID0ge1xuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICBidWxrT3BlcmF0aW9uSWQsXG4gICAgICBzdGF0dXM6IChzdGF0dXMgJiYgc3RhdHVzLnRvVXBwZXJDYXNlKCkpIHx8ICcnXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UubGlzdChmaWx0ZXIpO1xuICB9XG5cbiAgY3JlYXRlU2luZ2xlT3BlcmF0aW9uKG9wZXJhdGlvbjogSU9wZXJhdGlvbikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UuY3JlYXRlKG9wZXJhdGlvbik7XG4gIH1cblxuICB1cGRhdGVTaW5nbGVPcGVyYXRpb24ocGFydGlhbFVwZGF0ZU9iamVjdDogUGFydGlhbDxJT3BlcmF0aW9uPikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UudXBkYXRlKHBhcnRpYWxVcGRhdGVPYmplY3QpO1xuICB9XG5cbiAgZ2V0TWFuYWdlZE9iamVjdChkZXZpY2VJZDogSWRSZWZlcmVuY2UpIHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmRldGFpbChkZXZpY2VJZCk7XG4gIH1cblxuICByZXRyaWV2ZUJ1bGtPcGVyYXRpb25UeXBlKG9wZXJhdGlvbjogSU9wZXJhdGlvbik6IEJ1bGtPcGVyYXRpb25UeXBlIHtcbiAgICBsZXQgdHlwZTogQnVsa09wZXJhdGlvblR5cGU7XG5cbiAgICB0aGlzLmJ1bGtUeXBlcy5zb21lKHQgPT4ge1xuICAgICAgaWYgKHQuZnJhZ21lbnRzLnNvbWUoZnJhZ21lbnQgPT4gaGFzKG9wZXJhdGlvbiwgZnJhZ21lbnQpKSkge1xuICAgICAgICB0eXBlID0gdC50eXBlO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB0eXBlO1xuICB9XG59XG4iXX0=