import * as tslib_1 from "tslib";
import { Component, EventEmitter, Output, ViewChildren } from '@angular/core';
import { gettext, ListItemRadioComponent, memoize } from '@c8y/ngx-components';
import { RepositoryService, RepositoryType } from '@c8y/ngx-components/repository';
import { TranslateService } from '@ngx-translate/core';
import { get, isEqual, property, uniqWith } from 'lodash-es';
import { BehaviorSubject, combineLatest, from } from 'rxjs';
import { debounceTime, distinctUntilChanged, shareReplay, switchMap } from 'rxjs/operators';
var SelectSoftwareStepComponent = /** @class */ (function () {
    function SelectSoftwareStepComponent(repositoryService, translate) {
        var _this = this;
        this.repositoryService = repositoryService;
        this.translate = translate;
        this.software = new EventEmitter();
        this.textFilter$ = new BehaviorSubject('');
        this.deviceType$ = new BehaviorSubject('');
        this.deviceTypes = [];
        this.selectedDeviceType = { name: '' };
        this.isLegacy = this.repositoryService.isLegacyEntry.bind(this.repositoryService);
        this.software$ = combineLatest(this.textFilter$, this.deviceType$).pipe(switchMap(function (_a) {
            var _b = tslib_1.__read(_a, 2), name = _b[0], deviceType = _b[1];
            return _this.getSoftware(name, deviceType);
        }), shareReplay(1));
        this.NO_DEVICE_TYPE_AVAILABLE = gettext('No device type available');
        this.loadDeviceTypes();
    }
    SelectSoftwareStepComponent.prototype.getBaseVersionsCount$ = function (software) {
        return this.repositoryService.getBaseVersionsCount$(software).pipe(shareReplay(1));
    };
    SelectSoftwareStepComponent.prototype.getVersions = function (software) {
        return this.repositoryService.listAllVersions(software);
    };
    SelectSoftwareStepComponent.prototype.getDeviceTypeTitle = function (software) {
        return get(software, 'c8y_Filter.type', this.translate.instant(this.NO_DEVICE_TYPE_AVAILABLE));
    };
    SelectSoftwareStepComponent.prototype.loadDeviceTypes = function () {
        var _this = this;
        this.deviceTypeSubscription = this.deviceType$
            .pipe(debounceTime(300), distinctUntilChanged(), switchMap(function (searchStr) {
            var query = { 'c8y_Filter.type': "*" + searchStr + "*" };
            return from(_this.repositoryService.listRepositoryEntries(RepositoryType.SOFTWARE, { query: query }));
        }))
            .subscribe(function (result) {
            var data = result.data;
            _this.deviceTypes = uniqWith(data.map(function (val) { return ({ name: val.c8y_Filter.type }); }), isEqual);
        });
    };
    SelectSoftwareStepComponent.prototype.ngOnDestroy = function () {
        this.deviceTypeSubscription.unsubscribe();
    };
    SelectSoftwareStepComponent.prototype.resetSelection = function () {
        this.radioButtons.map(function (radio) { return radio.reset(); });
    };
    SelectSoftwareStepComponent.prototype.selectSoftware = function (_a) {
        var option = _a.option, software = _a.software;
        software.selectedId = option.id;
        option.action = 'install';
        this.emitSoftware({ option: option, software: software });
    };
    SelectSoftwareStepComponent.prototype.emitSoftware = function (_a) {
        var option = _a.option, software = _a.software;
        var emitData = Object.assign({}, { software: software }, { version: option }, { action: option.action });
        this.software.emit(emitData);
    };
    SelectSoftwareStepComponent.prototype.getSoftware = function (name, deviceType) {
        var query = name ? { name: "*" + name + "*" } : {};
        if (deviceType) {
            query.__or = [{ 'c8y_Filter.type': deviceType }, { __not: { __has: "c8y_Filter.type" } }];
        }
        return this.repositoryService.listRepositoryEntries(RepositoryType.SOFTWARE, { query: query });
    };
    SelectSoftwareStepComponent.ctorParameters = function () { return [
        { type: RepositoryService },
        { type: TranslateService }
    ]; };
    tslib_1.__decorate([
        Output()
    ], SelectSoftwareStepComponent.prototype, "software", void 0);
    tslib_1.__decorate([
        ViewChildren(ListItemRadioComponent)
    ], SelectSoftwareStepComponent.prototype, "radioButtons", void 0);
    tslib_1.__decorate([
        memoize(property('id'))
    ], SelectSoftwareStepComponent.prototype, "getBaseVersionsCount$", null);
    tslib_1.__decorate([
        memoize(property('id'))
    ], SelectSoftwareStepComponent.prototype, "getVersions", null);
    SelectSoftwareStepComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-select-software-step',
            template: "<div class=\"card-block p-t-0 overflow-visible flex-no-shrink separator-bottom col-xs-12\">\n  <div class=\"row p-b-16\">\n    <div class=\"col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3\">\n      <h4 class=\"text-center m-b-16\">{{ 'Select software' | translate }}</h4>\n      <div class=\"row\">\n        <div class=\"col-md-6\">\n          <div class=\"input-group input-group-search\">\n            <input\n              type=\"search\"\n              class=\"form-control\"\n              title=\"{{ 'Filter software\u2026' | translate }}\"\n              placeholder=\"{{ 'Filter software\u2026' | translate }}\"\n              [ngModel]=\"textFilter$ | async\"\n              (ngModelChange)=\"textFilter$.next($event)\"\n            />\n            <span class=\"input-group-addon\">\n              <i c8yIcon=\"filter\" *ngIf=\"(textFilter$ | async).length === 0\"></i>\n              <i\n                c8yIcon=\"times\"\n                class=\"text-muted\"\n                *ngIf=\"(textFilter$ | async).length > 0\"\n                (click)=\"textFilter$.next('')\"\n              ></i>\n            </span>\n          </div>\n        </div>\n        <div class=\"col-xs-12 p-b-8 visible-xs visible-sm\"></div>\n        <div class=\"col-md-6\">\n          <c8y-form-group class=\"m-0\">\n            <c8y-typeahead\n              name=\"deviceType\"\n              [(ngModel)]=\"selectedDeviceType\"\n              placeholder=\"{{ 'Type to filter device types\u2026' | translate }}\"\n              (onSearch)=\"deviceType$.next($event)\"\n              [allowFreeEntries]=\"false\"\n            >\n              <c8y-li\n                class=\"p-l-8 p-r-8 c8y-list__item--link\"\n                (click)=\"selectedDeviceType = {name: ''}; deviceType$.next('')\"\n              >\n                <span>{{'All device types' | translate }}</span>\n              </c8y-li>\n              <c8y-li\n              *ngFor=\"let deviceType of deviceTypes\"\n              class=\"p-l-8 p-r-8 c8y-list__item--link\"\n              (click)=\"selectedDeviceType = deviceType; deviceType$.next(deviceType.name)\"\n              [active]=\"selectedDeviceType === deviceType\"\n              >\n              <c8y-highlight\n              [text]=\"deviceType.name\"\n              [pattern]=\"deviceType$ | async\"\n              ></c8y-highlight>\n              </c8y-li>\n            </c8y-typeahead>\n            <c8y-messages\n            ><c8y-message\n              name=\"notExisting\"\n              [text]=\"'Select one of the existing device types.' | translate\"\n            ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n<div class=\"col-xs-12 flex-grow no-gutter\">\n  <div class=\"card-inner-scroll fit-h\">\n    <div class=\"card-block p-t-0 p-b-0\">\n      <c8y-list-group [ngClass]=\"{ 'dd-low': (software$ | async)?.data.length < 10 }\">\n        <c8y-li *c8yFor=\"let software of software$ | async; loadMore: 'auto'\">\n          <c8y-li-icon>\n            <i c8yIcon=\"c8y-tools\"></i>\n          </c8y-li-icon>\n          <c8y-li-body class=\"content-flex-60\">\n            <div class=\"col-5\">\n              <div class=\"text-truncate\" title=\"{{ software.name }}\">\n                {{ software.name }}\n              </div>\n            </div>\n            <div class=\"col-3\">\n              <div class=\"text-truncate\" title=\"{{ 'Device type' | translate }}: {{ getDeviceTypeTitle(software) }}\">\n                <span class=\"text-label-small m-r-8\" translate>\n                  Device type\n                </span>\n                <span *ngIf=\"software.c8y_Filter?.type; else noType\">\n                  {{ software.c8y_Filter?.type }}\n                </span>\n                <ng-template #noType>\n                  <small><em class=\"text-muted\" translate>Undefined`device type`</em></small>\n                </ng-template>\n              </div>\n            </div>\n            <div class=\"col-2\">\n              <span *ngIf=\"isLegacy(software)\" class=\"label label-warning flex-item-right-sm\">\n                <span translate>Legacy</span>\n              </span>\n              <span *ngIf=\"!isLegacy(software)\">\n                <span *ngIf=\"(getBaseVersionsCount$(software) | async) === null\">\n                  <span class=\"label label-info\">\n                    <i c8yIcon=\"circle-o-notch\" class=\"icon-spin\"></i>\n                  </span>\n                </span>\n                <span *ngIf=\"(getBaseVersionsCount$(software) | async) !== null\">\n                  <span [ngPlural]=\"getBaseVersionsCount$(software) | async\">\n                    <ng-template ngPluralCase=\"=0\">\n                      <span class=\"label label-default flex-item-right-sm\">\n                        <span translate>No versions</span>\n                      </span>\n                    </ng-template>\n                    <ng-template ngPluralCase=\"=1\">\n                      <span class=\"label label-info\"><span translate>1 version</span></span>\n                    </ng-template>\n                    <ng-template ngPluralCase=\"other\">\n                      <span class=\"label label-info\">\n                        <span\n                          ngNonBindable\n                          translate\n                          [translateParams]=\"{\n                            count: (getBaseVersionsCount$(software) | async) || ''\n                          }\"\n                          >{{ count }} versions</span\n                        >\n                      </span>\n                    </ng-template>\n                  </span>\n                </span>\n              </span>\n            </div>\n          </c8y-li-body>\n          <c8y-li-collapse>\n            <c8y-list-group>\n              <c8y-li *c8yFor=\"let option of getVersions(software) | async\">\n                <c8y-li-radio\n                  [name]=\"software.id\"\n                  (onSelect)=\"selectSoftware({ option: option, software: software })\"\n                ></c8y-li-radio>\n                <c8y-li-body class=\"content-flex-40 p-r-16\">\n                  <div class=\"col-4\">\n                    {{ option.c8y_Software.version }}\n                  </div>\n                  <div class=\"col-5\">\n                    <div class=\"text-truncate\" title=\"{{ option.c8y_Software.url }}\">\n                      <span class=\"text-label-small m-r-4\" translate> File </span>\n                      <span>{{ option.c8y_Software.url }}</span>\n                    </div>\n                  </div>\n                  <div class=\"col-3\" *ngIf=\"option.id === software.selectedId\">\n                    <div class=\"c8y-select-wrapper d-inline-block\" style=\"margin: -4px 0;\">\n                      <select\n                        id=\"action\"\n                        class=\"form-control input-sm\"\n                        [(ngModel)]=\"option.action\"\n                        (change)=\"emitSoftware({ option: option, software: software })\"\n                      >\n                        <option [ngValue]=\"'install'\">{{ 'Install/update`software`' | translate }}</option>\n                        <option [ngValue]=\"'delete'\">{{ 'Remove`software`' | translate }}</option>\n                      </select>\n                      <span></span>\n                    </div>\n                  </div>\n                </c8y-li-body>\n              </c8y-li>\n            </c8y-list-group>\n          </c8y-li-collapse>\n        </c8y-li>\n      </c8y-list-group>\n    </div>\n  </div>\n</div>\n"
        })
    ], SelectSoftwareStepComponent);
    return SelectSoftwareStepComponent;
}());
export { SelectSoftwareStepComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LXNvZnR3YXJlLXN0ZXAuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL3N0ZXBwZXItYnVsay10eXBlLXNvZnR3YXJlLyIsInNvdXJjZXMiOlsic2VsZWN0LXNvZnR3YXJlLXN0ZXAuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQWEsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXpGLE9BQU8sRUFBRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDL0UsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGNBQWMsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ25GLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDN0QsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUE0QixNQUFNLE1BQU0sQ0FBQztBQUN0RixPQUFPLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQU81RjtJQW1CRSxxQ0FDVSxpQkFBb0MsRUFDcEMsU0FBMkI7UUFGckMsaUJBS0M7UUFKUyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBcEIzQixhQUFRLEdBQW9DLElBQUksWUFBWSxFQUFxQixDQUFDO1FBQzVGLGdCQUFXLEdBQTRCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELGdCQUFXLEdBQTRCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELGdC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LElBQUksQ0FBQyxDQUFDO2tFQUd2QjtJQWxDVSwyQkFBMkI7UUFKdkMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDBCQUEwQjtZQUNwQyxtZ1BBQWtEO1NBQ25ELENBQUM7T0FDVywyQkFBMkIsQ0E0RnZDO0lBQUQsa0NBQUM7Q0FBQSxBQTVGRCxJQTRGQztTQTVGWSwyQkFBMkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBRdWVyeUxpc3QsIFZpZXdDaGlsZHJlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIElSZXN1bHRMaXN0IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0dGV4dCwgTGlzdEl0ZW1SYWRpb0NvbXBvbmVudCwgbWVtb2l6ZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UsIFJlcG9zaXRvcnlUeXBlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5JztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IGdldCwgaXNFcXVhbCwgcHJvcGVydHksIHVuaXFXaXRoIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgZnJvbSwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBzaGFyZVJlcGxheSwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSVNlbGVjdGVkU29mdHdhcmUgfSBmcm9tICcuL3NlbGVjdC1zb2Z0d2FyZS5tb2RlbCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1zZWxlY3Qtc29mdHdhcmUtc3RlcCcsXG4gIHRlbXBsYXRlVXJsOiAnc2VsZWN0LXNvZnR3YXJlLXN0ZXAuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFNlbGVjdFNvZnR3YXJlU3RlcENvbXBvbmVudCB7XG4gIEBPdXRwdXQoKSBzb2Z0d2FyZTogRXZlbnRFbWl0dGVyPElTZWxlY3RlZFNvZnR3YXJlPiA9IG5ldyBFdmVudEVtaXR0ZXI8SVNlbGVjdGVkU29mdHdhcmU+KCk7XG4gIHRleHRGaWx0ZXIkOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoJycpO1xuICBkZXZpY2VUeXBlJDogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KCcnKTtcbiAgZGV2aWNlVHlwZXMgPSBbXTtcbiAgc2VsZWN0ZWREZXZpY2VUeXBlID0geyBuYW1lOiAnJyB9O1xuICBpc0xlZ2FjeSA9IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuaXNMZWdhY3lFbnRyeS5iaW5kKHRoaXMucmVwb3NpdG9yeVNlcnZpY2UpO1xuICBzb2Z0d2FyZSQ6IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiA9IGNvbWJpbmVMYXRlc3QoXG4gICAgdGhpcy50ZXh0RmlsdGVyJCxcbiAgICB0aGlzLmRldmljZVR5cGUkXG4gICkucGlwZShcbiAgICBzd2l0Y2hNYXAoKFtuYW1lLCBkZXZpY2VUeXBlXSkgPT4gdGhpcy5nZXRTb2Z0d2FyZShuYW1lLCBkZXZpY2VUeXBlKSksXG4gICAgc2hhcmVSZXBsYXkoMSlcbiAgKTtcbiAgcmVhZG9ubHkgTk9fREVWSUNFX1RZUEVfQVZBSUxBQkxFID0gZ2V0dGV4dCgnTm8gZGV2aWNlIHR5cGUgYXZhaWxhYmxlJyk7XG4gIEBWaWV3Q2hpbGRyZW4oTGlzdEl0ZW1SYWRpb0NvbXBvbmVudCkgcmFkaW9CdXR0b25zOiBRdWVyeUxpc3Q8TGlzdEl0ZW1SYWRpb0NvbXBvbmVudD47XG5cbiAgcHJpdmF0ZSBkZXZpY2VUeXBlU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5U2VydmljZTogUmVwb3NpdG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5sb2FkRGV2aWNlVHlwZXMoKTtcbiAgfVxuXG4gIEBtZW1vaXplKHByb3BlcnR5KCdpZCcpKVxuICBnZXRCYXNlVmVyc2lvbnNDb3VudCQoc29mdHdhcmU6IElNYW5hZ2VkT2JqZWN0KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5U2VydmljZS5nZXRCYXNlVmVyc2lvbnNDb3VudCQoc29mdHdhcmUpLnBpcGUoc2hhcmVSZXBsYXkoMSkpO1xuICB9XG5cbiAgQG1lbW9pemUocHJvcGVydHkoJ2lkJykpXG4gIGdldFZlcnNpb25zKHNvZnR3YXJlOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmxpc3RBbGxWZXJzaW9ucyhzb2Z0d2FyZSk7XG4gIH1cblxuICBnZXREZXZpY2VUeXBlVGl0bGUoc29mdHdhcmU6IElNYW5hZ2VkT2JqZWN0KTogc3RyaW5nIHtcbiAgICByZXR1cm4gZ2V0KFxuICAgICAgc29mdHdhcmUsXG4gICAgICAnYzh5X0ZpbHRlci50eXBlJyxcbiAgICAgIHRoaXMudHJhbnNsYXRlLmluc3RhbnQodGhpcy5OT19ERVZJQ0VfVFlQRV9BVkFJTEFCTEUpKTtcbiAgfVxuXG4gIGxvYWREZXZpY2VUeXBlcygpIHtcbiAgICB0aGlzLmRldmljZVR5cGVTdWJzY3JpcHRpb24gPSB0aGlzLmRldmljZVR5cGUkXG4gICAgICAucGlwZShcbiAgICAgICAgZGVib3VuY2VUaW1lKDMwMCksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgIHN3aXRjaE1hcChzZWFyY2hTdHIgPT4ge1xuICAgICAgICAgIGNvbnN0IHF1ZXJ5ID0geyAnYzh5X0ZpbHRlci50eXBlJzogYCoke3NlYXJjaFN0cn0qYCB9O1xuICAgICAgICAgIHJldHVybiBmcm9tKFxuICAgICAgICAgICAgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5saXN0UmVwb3NpdG9yeUVudHJpZXMoUmVwb3NpdG9yeVR5cGUuU09GVFdBUkUsIHsgcXVlcnkgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZShyZXN1bHQgPT4ge1xuICAgICAgICBjb25zdCB7IGRhdGEgfSA9IHJlc3VsdDtcbiAgICAgICAgdGhpcy5kZXZpY2VUeXBlcyA9IHVuaXFXaXRoKGRhdGEubWFwKHZhbCA9PiAoeyBuYW1lOiB2YWwuYzh5X0ZpbHRlci50eXBlIH0pKSwgaXNFcXVhbCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGV2aWNlVHlwZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgcmVzZXRTZWxlY3Rpb24oKSB7XG4gICAgdGhpcy5yYWRpb0J1dHRvbnMubWFwKHJhZGlvID0+IHJhZGlvLnJlc2V0KCkpO1xuICB9XG5cbiAgc2VsZWN0U29mdHdhcmUoeyBvcHRpb24sIHNvZnR3YXJlIH0pIHtcbiAgICBzb2Z0d2FyZS5zZWxlY3RlZElkID0gb3B0aW9uLmlkO1xuICAgIG9wdGlvbi5hY3Rpb24gPSAnaW5zdGFsbCc7XG4gICAgdGhpcy5lbWl0U29mdHdhcmUoeyBvcHRpb24sIHNvZnR3YXJlIH0pO1xuICB9XG5cbiAgZW1pdFNvZnR3YXJlKHsgb3B0aW9uLCBzb2Z0d2FyZSB9KSB7XG4gICAgY29uc3QgZW1pdERhdGEgPSBPYmplY3QuYXNzaWduKFxuICAgICAge30sXG4gICAgICB7IHNvZnR3YXJlIH0sXG4gICAgICB7IHZlcnNpb246IG9wdGlvbiB9LFxuICAgICAgeyBhY3Rpb246IG9wdGlvbi5hY3Rpb24gfVxuICAgICk7XG4gICAgdGhpcy5zb2Z0d2FyZS5lbWl0KGVtaXREYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U29mdHdhcmUobmFtZT86IHN0cmluZywgZGV2aWNlVHlwZT86IHN0cmluZykge1xuICAgIGNvbnN0IHF1ZXJ5OiBhbnkgPSBuYW1lID8geyBuYW1lOiBgKiR7bmFtZX0qYCB9IDoge307XG4gICAgaWYgKGRldmljZVR5cGUpIHtcbiAgICAgIHF1ZXJ5Ll9fb3IgPSBbeyAnYzh5X0ZpbHRlci50eXBlJzogZGV2aWNlVHlwZSB9LCB7IF9fbm90OiB7IF9faGFzOiBgYzh5X0ZpbHRlci50eXBlYCB9IH1dO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5U2VydmljZS5saXN0UmVwb3NpdG9yeUVudHJpZXMoUmVwb3NpdG9yeVR5cGUuU09GVFdBUkUsIHsgcXVlcnkgfSk7XG4gIH1cbn1cbiJdfQ==