import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { IManagedObject, Realtime } from '@c8y/client';
import { DeviceConfigurationService } from './device-configuration.service';
import { DeviceConfigurationOperation } from '../repository.model';
import { gettext } from '@c8y/ngx-components';
import { RepositoryService } from '../repository.service';
var DeviceConfigurationComponent = /** @class */ (function () {
    function DeviceConfigurationComponent(route, deviceConfigurationService, realtime, repositoryService) {
        var _this = this;
        this.route = route;
        this.deviceConfigurationService = deviceConfigurationService;
        this.realtime = realtime;
        this.repositoryService = repositoryService;
        this.supportedConfigurations = [];
        this.showBinaryBasedConfig = false;
        this.configSnapshot = {};
        this.reloading = false;
        this.deviceConfigurationService.configurationsUpdated.subscribe(function (repositorySnapsOnly) {
            _this.updateSnapshots(repositorySnapsOnly);
        });
    }
    DeviceConfigurationComponent.prototype.ngOnInit = function () {
        this.device = this.route.snapshot.parent.data.contextData;
        if (this.device.c8y_SupportedConfigurations) {
            this.supportedConfigurations = this.device.c8y_SupportedConfigurations.map(function (item) { return ({
                name: item
            }); });
        }
        if (this.deviceConfigurationService.hasAnySupportedOperation(this.device, [
            DeviceConfigurationOperation.DOWNLOAD_CONFIG,
            DeviceConfigurationOperation.UPLOAD_CONFIG
        ])) {
            this.supportedConfigurations.push({
                name: gettext('Legacy configuration snapshot'),
                isLegacy: true
            });
        }
        if (this.supportedConfigurations.length > 0) {
            this.showBinaryBasedConfig = true;
        }
        this.repositorySnapshotsEmptyState = {
            icon: 'gears',
            title: gettext('No configurations available.'),
            text: gettext('Add configuration to configuration repository')
        };
        this.showTextBasedConfig = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.CONFIG, DeviceConfigurationOperation.SEND_CONFIG]);
    };
    DeviceConfigurationComponent.prototype.onConfigTypeSelected = function (config) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                this.configurationType = config.name;
                this.isLegacy = config.isLegacy;
                this.updateSnapshots();
                return [2 /*return*/];
            });
        });
    };
    DeviceConfigurationComponent.prototype.onRepositoryConfigSelected = function (config) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var binary, _a, ex_1;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.repositorySnapshot = {
                            id: config.id,
                            time: config.creationTime,
                            name: config.name,
                            binaryUrl: config.url,
                            deviceType: config.deviceType,
                            configurationType: config.configurationType
                        };
                        if (!config.url) return [3 /*break*/, 6];
                        _b.label = 1;
                    case 1:
                        _b.trys.push([1, 5, , 6]);
                        return [4 /*yield*/, this.repositoryService.getBinaryFile(config.url, {
                                allowExternal: false
                            })];
                    case 2:
                        binary = _b.sent();
                        if (!binary) return [3 /*break*/, 4];
                        _a = this.repositorySnapshot;
                        return [4 /*yield*/, binary.text()];
                    case 3:
                        _a.binary = _b.sent();
                        _b.label = 4;
                    case 4: return [3 /*break*/, 6];
                    case 5:
                        ex_1 = _b.sent();
                        return [3 /*break*/, 6];
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    DeviceConfigurationComponent.prototype.updateSnapshots = function (repositorySnapsOnly) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b, _c;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        this.reloading = false;
                        this.repositorySnapshot = undefined;
                        _a = this;
                        return [4 /*yield*/, this.repositoryService.getSnapshotsFromRepository(this.device, this.configurationType)];
                    case 1:
                        _a.repositorySnapshots = _d.sent();
                        if (!!repositorySnapsOnly) return [3 /*break*/, 6];
                        _b = this;
                        if (!this.isLegacy) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.repositoryService.getLegacyConfigSnapshot(this.device)];
                    case 2:
                        _c = _d.sent();
                        return [3 /*break*/, 5];
                    case 3: return [4 /*yield*/, this.repositoryService.getConfigSnapshot(this.device, this.configurationType)];
                    case 4:
                        _c = _d.sent();
                        _d.label = 5;
                    case 5:
                        _b.configSnapshot = _c;
                        _d.label = 6;
                    case 6:
                        this.reloading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    DeviceConfigurationComponent.ctorParameters = function () { return [
        { type: ActivatedRoute },
        { type: DeviceConfigurationService },
        { type: Realtime },
        { type: RepositoryService }
    ]; };
    DeviceConfigurationComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-device-configuration',
            template: "<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" title=\"{{ 'Reload' | translate }}\" (click)=\"updateSnapshots()\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'icon-spin': reloading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div class=\"card content-fullpage card-has-tabs\">\n  <tabset>\n    <div class=\"card-header separator\" *ngIf=\"showBinaryBasedConfig && !showTextBasedConfig\">\n      <h4 class=\"card-title\">{{ 'Configurations' | translate }}</h4>\n    </div>\n    <div class=\"card-header separator\" *ngIf=\"!showBinaryBasedConfig && showTextBasedConfig\">\n      <h4 class=\"card-title\">{{ 'Text-based configuration' | translate }}</h4>\n    </div>\n    <tab heading=\"{{ 'Configurations' | translate }}\" *ngIf=\"showBinaryBasedConfig\">\n      <div class=\"card--grid card grid__col--4-8--md grid__row--6-6--md m-b-0\">\n        <!-- DEVICE SUPPORTED CONFIGURATIONS -->\n        <div class=\"card--grid__inner-scroll\">\n          <div class=\"card-block\">\n            <h5 class=\"legend form-block\">\n              <span translate>Device-supported configurations</span>\n            </h5>\n          </div>\n          <div class=\"p-r-16\">\n            <c8y-device-configuration-list\n              [items]=\"supportedConfigurations\"\n              [itemIcon]=\"'gears'\"\n              (configSelected)=\"onConfigTypeSelected($event)\"\n            ></c8y-device-configuration-list>\n          </div>\n        </div>\n\n        <!-- CONFIGURATION PREVIEW -->\n        <div class=\"card--grid__inner-scroll d-flex d-col flex-grow bg-gray-lighter\">\n          <div class=\"card-block d-flex d-col flex-grow\">\n            <h5 class=\"legend form-block\"><span translate>Preview</span></h5>\n\n            <!-- EMPTY STATE -->\n            <div class=\"c8y-empty-state text-left\" *ngIf=\"!configurationType\">\n              <h1 [c8yIcon]=\"'file-text'\"></h1>\n              <p>\n                <strong translate>No configuration selected.</strong><br />\n                <small translate>Select a configuration to preview</small>\n              </p>\n            </div>\n\n            <!-- PREVIEW AVAILABLE STATE -->\n            <c8y-device-configuration-preview\n              *ngIf=\"configurationType\"\n              [device]=\"device\"\n              [configurationType]=\"configurationType\"\n              [configSnapshot]=\"configSnapshot\"\n              [canSaveSnapshot]=\"true\"\n              [operationToTrigger]=\"'c8y_UploadConfigFile'\"\n              [actionButtonText]=\"'Get snapshot from device' | translate\"\n              [actionButtonIcon]=\"'download'\"\n              [isLegacy]=\"isLegacy\"\n              class=\"d-flex d-col flex-grow\"\n            ></c8y-device-configuration-preview>\n          </div>\n        </div>\n\n        <!-- AVAILABLE SUPPORTED CONFIGURATIONS -->\n        <div class=\"card--grid__inner-scroll\">\n          <div class=\"card-block\">\n            <h5 class=\"legend form-block\" translate>Available supported configurations</h5>\n          </div>\n\n          <!-- EMPTY STATE -->\n          <div class=\"c8y-empty-state text-left\" *ngIf=\"!configurationType\">\n            <h1 [c8yIcon]=\"'gears'\"></h1>\n            <p>\n              <strong translate>No selection</strong><br />\n              <small translate\n                >Select a configuration from the device-supported configuration list</small\n              >\n            </p>\n          </div>\n          <div class=\"p-r-16\" *ngIf=\"configurationType\">\n            <c8y-device-configuration-list\n              [items]=\"repositorySnapshots\"\n              [itemIcon]=\"'file-text'\"\n              [emptyState]=\"repositorySnapshotsEmptyState\"\n              [isFilterEnabled]=\"true\"\n              (configSelected)=\"onRepositoryConfigSelected($event)\"\n            ></c8y-device-configuration-list>\n          </div>\n        </div>\n\n        <!-- CONFIGURATION PREVIEW -->\n        <div class=\"card--grid__inner-scroll bg-gray-lighter d-flex d-col flex-grow\">\n          <div class=\"card-block flex-grow d-flex d-col\">\n            <h5 class=\"legend form-block\" translate>Preview</h5>\n\n            <!-- EMPTY STATE -->\n\n            <div class=\"c8y-empty-state text-left\" *ngIf=\"!repositorySnapshot\">\n              <h1 [c8yIcon]=\"'file-text'\"></h1>\n              <p>\n                <strong translate>No configuration selected.</strong><br />\n                <small *ngIf=\"!configurationType; else noSnapshot\" translate\n                  >Select a configuration to preview</small\n                >\n                <ng-template #noSnapshot>\n                  <small translate>Select the configuration you want to preview</small>\n                </ng-template>\n              </p>\n            </div>\n\n            <!-- CONFIGURATION SELECTED STATE -->\n            <c8y-device-configuration-preview\n              *ngIf=\"repositorySnapshot\"\n              [device]=\"device\"\n              [configurationType]=\"configurationType\"\n              [configSnapshot]=\"repositorySnapshot\"\n              [operationToTrigger]=\"'c8y_DownloadConfigFile'\"\n              [actionButtonText]=\"'Send configuration to device' | translate\"\n              [actionButtonIcon]=\"'upload'\"\n              [isLegacy]=\"isLegacy\"\n              class=\"d-flex d-col flex-grow\"\n            ></c8y-device-configuration-preview>\n          </div>\n        </div>\n      </div>\n    </tab>\n    <tab heading=\"{{ 'Text-based configuration' | translate }}\" *ngIf=\"showTextBasedConfig\">\n      <c8y-text-based-configuration *ngIf=\"showTextBasedConfig\"></c8y-text-based-configuration>\n    </tab>\n  </tabset>\n</div>\n"
        })
    ], DeviceConfigurationComponent);
    return DeviceConfigurationComponent;
}());
export { DeviceConfigurationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5LyIsInNvdXJjZXMiOlsiY29uZmlndXJhdGlvbi1kZXZpY2UtdGFiL2RldmljZS1jb25maWd1cmF0aW9uLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDNUUsT0FBTyxFQUlMLDRCQUE0QixFQUM3QixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQU0xRDtJQWFFLHNDQUNVLEtBQXFCLEVBQ3JCLDBCQUFzRCxFQUN0RCxRQUFrQixFQUNsQixpQkFBb0M7UUFKOUMsaUJBU0M7UUFSUyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQiwrQkFBMEIsR0FBMUIsMEJBQTBCLENBQTRCO1FBQ3RELGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQWhCOUMsNEJBQXVCLEdBQWlDLEVBQUUsQ0FBQztRQUMzRCwwQkFBcUIsR0FBRyxLQUFLLENBQUM7UUFFOUIsbUJBQWMsR0FBbUMsRUFBRSxDQUFDO1FBT3BELGNBQVMsR0FBWSxLQUFLLENBQUM7UUFRekIsSUFBSSxDQUFDLDBCQUEwQixDQUFDLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxVQUFBLG1CQUFtQjtZQUNqRixLQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsK0NBQVEsR0FBUjtRQUNFLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUQsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLDJCQUEyQixFQUFFO1lBQzNDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLDJCQUEyQixDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLENBQUM7Z0JBQ2xGLElBQUksRUFBRSxJQUFJO2FBQ1gsQ0FBQyxFQUZpRixDQUVqRixDQUFDLENBQUM7U0FDTDtRQUVELElBQ0UsSUFBSSxDQUFDLDBCQUEwQixDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDcEUsNEJBQTRCLENBQUMsZUFBZTtZQUM1Qyw0QkFBNEIsQ0FBQyxhQUFhO1NBQzNDLENBQUMsRUFDRjtZQUNBLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUM7Z0JBQ2hDLElBQUksRUFBRSxPQUFPLENBQUMsK0JBQStCLENBQUM7Z0JBQzlDLFFBQVEsRUFBRSxJQUFJO2FBQ2YsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxJQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzNDLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUM7U0FDbkM7UUFFRCxJQUFJLENBQUMsNkJBQTZCLEdBQUc7WUFDbkMsSUFBSSxFQUFFLE9BQU87WUFDYixLQUFLLEVBQUUsT0FBTyxDQUFDLDhCQUE4QixDQUFDO1lBQzlDLElBQUksRUFBRSxPQUFPLENBQUMsK0NBQStDLENBQUM7U0FDL0QsQ0FBQztRQUVGLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQUMsd0JBQXdCLENBQ2pGLElBQUksQ0FBQyxNQUFNLEVBQ1gsQ0FBQyw0QkFBNEIsQ0FBQyxNQUFNLEVBQUUsNEJBQTRCLENBQUMsV0FBVyxDQUFDLENBQ2hGLENBQUM7SUFDSixDQUFDO0lBRUssMkRBQW9CLEdBQTFCLFVBQTJCLE1BQU07OztnQkFDL0IsSUFBSSxDQUFDLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBQ3JDLElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztnQkFDaEMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDOzs7O0tBQ3hCO0lBRUssaUVBQTBCLEdBQWhDLFVBQWlDLE1BQU07Ozs7Ozt3QkFDckMsSUFBSSxDQUFDLGtCQUFrQixHQUFHOzRCQUN4QixFQUFFLEVBQUUsTUFBTSxDQUFDLEVBQUU7NEJBQ2IsSUFBSSxFQUFFLE1BQU0sQ0FBQyxZQUFZOzRCQUN6QixJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUk7NEJBQ2pCLFNBQVMsRUFBRSxNQUFNLENBQUMsR0FBRzs0QkFDckIsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVOzRCQUM3QixpQkFBaUIsRUFBRSxNQUFNLENBQUMsaUJBQWlCO3lCQUM1QyxDQUFDOzZCQUNFLE1BQU0sQ0FBQyxHQUFHLEVBQVYsd0JBQVU7Ozs7d0JBRUsscUJBQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFO2dDQUNwRSxhQUFhLEVBQUUsS0FBSzs2QkFDckIsQ0FBQyxFQUFBOzt3QkFGSSxNQUFNLEdBQUcsU0FFYjs2QkFDRSxNQUFNLEVBQU4sd0JBQU07d0JBQ1IsS0FBQSxJQUFJLENBQUMsa0JBQWtCLENBQUE7d0JBQVUscUJBQU8sTUFBYyxDQUFDLElBQUksRUFBRSxFQUFBOzt3QkFBN0QsR0FBd0IsTUFBTSxHQUFHLFNBQTRCLENBQUM7Ozs7Ozs7Ozs7S0FNckU7SUFFSyxzREFBZSxHQUFyQixVQUFzQixtQkFBNkI7Ozs7Ozt3QkFDakQsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7d0JBQ3ZCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxTQUFTLENBQUM7d0JBQ3BDLEtBQUEsSUFBSSxDQUFBO3dCQUF1QixxQkFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsMEJBQTBCLENBQ2hGLElBQUksQ0FBQyxNQUFNLEVBQ1gsSUFBSSxDQUFDLGlCQUFpQixDQUN2QixFQUFBOzt3QkFIRCxHQUFLLG1CQUFtQixHQUFHLFNBRzFCLENBQUM7NkJBQ0UsQ0FBQyxtQkFBbUIsRUFBcEIsd0JBQW9CO3dCQUN0QixLQUFBLElBQUksQ0FBQTs2QkFBa0IsSUFBSSxDQUFDLFFBQVEsRUFBYix3QkFBYTt3QkFDL0IscUJBQU0sSUFBSSxDQUFDLGlCQUFpQixDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBQTs7d0JBQWpFLEtBQUEsU0FBaUUsQ0FBQTs7NEJBQ2pFLHFCQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFBOzt3QkFBbkYsS0FBQSxTQUFtRixDQUFBOzs7d0JBRnZGLEdBQUssY0FBYyxLQUVvRSxDQUFDOzs7d0JBRTFGLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDOzs7OztLQUN4Qjs7Z0JBdkZnQixjQUFjO2dCQUNPLDBCQUEwQjtnQkFDNUMsUUFBUTtnQkFDQyxpQkFBaUI7O0lBakJuQyw0QkFBNEI7UUFKeEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDBCQUEwQjtZQUNwQyxncUxBQW9EO1NBQ3JELENBQUM7T0FDVyw0QkFBNEIsQ0FzR3hDO0lBQUQsbUNBQUM7Q0FBQSxBQXRHRCxJQXNHQztTQXRHWSw0QkFBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIFJlYWx0aW1lIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgRGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UgfSBmcm9tICcuL2RldmljZS1jb25maWd1cmF0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgRGV2aWNlQ29uZmlndXJhdGlvbkxpc3RFbXB0eVN0YXRlLFxuICBDb25maWd1cmF0aW9uU25hcHNob3QsXG4gIFN1cHBvcnRlZENvbmZpZ3VyYXRpb25JdGVtLFxuICBEZXZpY2VDb25maWd1cmF0aW9uT3BlcmF0aW9uXG59IGZyb20gJy4uL3JlcG9zaXRvcnkubW9kZWwnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICcuLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktZGV2aWNlLWNvbmZpZ3VyYXRpb24nLFxuICB0ZW1wbGF0ZVVybDogJy4vZGV2aWNlLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIERldmljZUNvbmZpZ3VyYXRpb25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBzdXBwb3J0ZWRDb25maWd1cmF0aW9uczogU3VwcG9ydGVkQ29uZmlndXJhdGlvbkl0ZW1bXSA9IFtdO1xuICBzaG93QmluYXJ5QmFzZWRDb25maWcgPSBmYWxzZTtcbiAgY29uZmlndXJhdGlvblR5cGU6IHN0cmluZztcbiAgY29uZmlnU25hcHNob3Q6IFBhcnRpYWw8Q29uZmlndXJhdGlvblNuYXBzaG90PiA9IHt9O1xuICByZXBvc2l0b3J5U25hcHNob3RzOiBJTWFuYWdlZE9iamVjdFtdO1xuICByZXBvc2l0b3J5U25hcHNob3Q6IENvbmZpZ3VyYXRpb25TbmFwc2hvdDtcbiAgcmVwb3NpdG9yeVNuYXBzaG90c0VtcHR5U3RhdGU6IERldmljZUNvbmZpZ3VyYXRpb25MaXN0RW1wdHlTdGF0ZTtcbiAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdDtcbiAgaXNMZWdhY3k6IGJvb2xlYW47XG4gIHNob3dUZXh0QmFzZWRDb25maWc6IGJvb2xlYW47XG4gIHJlbG9hZGluZzogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2U6IERldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhbHRpbWU6IFJlYWx0aW1lLFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeVNlcnZpY2U6IFJlcG9zaXRvcnlTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UuY29uZmlndXJhdGlvbnNVcGRhdGVkLnN1YnNjcmliZShyZXBvc2l0b3J5U25hcHNPbmx5ID0+IHtcbiAgICAgIHRoaXMudXBkYXRlU25hcHNob3RzKHJlcG9zaXRvcnlTbmFwc09ubHkpO1xuICAgIH0pO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5kZXZpY2UgPSB0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmVudC5kYXRhLmNvbnRleHREYXRhO1xuICAgIGlmICh0aGlzLmRldmljZS5jOHlfU3VwcG9ydGVkQ29uZmlndXJhdGlvbnMpIHtcbiAgICAgIHRoaXMuc3VwcG9ydGVkQ29uZmlndXJhdGlvbnMgPSB0aGlzLmRldmljZS5jOHlfU3VwcG9ydGVkQ29uZmlndXJhdGlvbnMubWFwKGl0ZW0gPT4gKHtcbiAgICAgICAgbmFtZTogaXRlbVxuICAgICAgfSkpO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIHRoaXMuZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UuaGFzQW55U3VwcG9ydGVkT3BlcmF0aW9uKHRoaXMuZGV2aWNlLCBbXG4gICAgICAgIERldmljZUNvbmZpZ3VyYXRpb25PcGVyYXRpb24uRE9XTkxPQURfQ09ORklHLFxuICAgICAgICBEZXZpY2VDb25maWd1cmF0aW9uT3BlcmF0aW9uLlVQTE9BRF9DT05GSUdcbiAgICAgIF0pXG4gICAgKSB7XG4gICAgICB0aGlzLnN1cHBvcnRlZENvbmZpZ3VyYXRpb25zLnB1c2goe1xuICAgICAgICBuYW1lOiBnZXR0ZXh0KCdMZWdhY3kgY29uZmlndXJhdGlvbiBzbmFwc2hvdCcpLFxuICAgICAgICBpc0xlZ2FjeTogdHJ1ZVxuICAgICAgfSk7XG4gICAgfVxuICAgIGlmICh0aGlzLnN1cHBvcnRlZENvbmZpZ3VyYXRpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuc2hvd0JpbmFyeUJhc2VkQ29uZmlnID0gdHJ1ZTtcbiAgICB9XG5cbiAgICB0aGlzLnJlcG9zaXRvcnlTbmFwc2hvdHNFbXB0eVN0YXRlID0ge1xuICAgICAgaWNvbjogJ2dlYXJzJyxcbiAgICAgIHRpdGxlOiBnZXR0ZXh0KCdObyBjb25maWd1cmF0aW9ucyBhdmFpbGFibGUuJyksXG4gICAgICB0ZXh0OiBnZXR0ZXh0KCdBZGQgY29uZmlndXJhdGlvbiB0byBjb25maWd1cmF0aW9uIHJlcG9zaXRvcnknKVxuICAgIH07XG5cbiAgICB0aGlzLnNob3dUZXh0QmFzZWRDb25maWcgPSB0aGlzLmRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLmhhc0FueVN1cHBvcnRlZE9wZXJhdGlvbihcbiAgICAgIHRoaXMuZGV2aWNlLFxuICAgICAgW0RldmljZUNvbmZpZ3VyYXRpb25PcGVyYXRpb24uQ09ORklHLCBEZXZpY2VDb25maWd1cmF0aW9uT3BlcmF0aW9uLlNFTkRfQ09ORklHXVxuICAgICk7XG4gIH1cblxuICBhc3luYyBvbkNvbmZpZ1R5cGVTZWxlY3RlZChjb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25UeXBlID0gY29uZmlnLm5hbWU7XG4gICAgdGhpcy5pc0xlZ2FjeSA9IGNvbmZpZy5pc0xlZ2FjeTtcbiAgICB0aGlzLnVwZGF0ZVNuYXBzaG90cygpO1xuICB9XG5cbiAgYXN5bmMgb25SZXBvc2l0b3J5Q29uZmlnU2VsZWN0ZWQoY29uZmlnKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5U25hcHNob3QgPSB7XG4gICAgICBpZDogY29uZmlnLmlkLFxuICAgICAgdGltZTogY29uZmlnLmNyZWF0aW9uVGltZSxcbiAgICAgIG5hbWU6IGNvbmZpZy5uYW1lLFxuICAgICAgYmluYXJ5VXJsOiBjb25maWcudXJsLFxuICAgICAgZGV2aWNlVHlwZTogY29uZmlnLmRldmljZVR5cGUsXG4gICAgICBjb25maWd1cmF0aW9uVHlwZTogY29uZmlnLmNvbmZpZ3VyYXRpb25UeXBlXG4gICAgfTtcbiAgICBpZiAoY29uZmlnLnVybCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYmluYXJ5ID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5nZXRCaW5hcnlGaWxlKGNvbmZpZy51cmwsIHtcbiAgICAgICAgICBhbGxvd0V4dGVybmFsOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGJpbmFyeSkge1xuICAgICAgICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90LmJpbmFyeSA9IGF3YWl0IChiaW5hcnkgYXMgYW55KS50ZXh0KCk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyB1cGRhdGVTbmFwc2hvdHMocmVwb3NpdG9yeVNuYXBzT25seT86IGJvb2xlYW4pIHtcbiAgICB0aGlzLnJlbG9hZGluZyA9IGZhbHNlO1xuICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMucmVwb3NpdG9yeVNuYXBzaG90cyA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZ2V0U25hcHNob3RzRnJvbVJlcG9zaXRvcnkoXG4gICAgICB0aGlzLmRldmljZSxcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvblR5cGVcbiAgICApO1xuICAgIGlmICghcmVwb3NpdG9yeVNuYXBzT25seSkge1xuICAgICAgdGhpcy5jb25maWdTbmFwc2hvdCA9IHRoaXMuaXNMZWdhY3lcbiAgICAgICAgPyBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmdldExlZ2FjeUNvbmZpZ1NuYXBzaG90KHRoaXMuZGV2aWNlKVxuICAgICAgICA6IGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZ2V0Q29uZmlnU25hcHNob3QodGhpcy5kZXZpY2UsIHRoaXMuY29uZmlndXJhdGlvblR5cGUpO1xuICAgIH1cbiAgICB0aGlzLnJlbG9hZGluZyA9IGZhbHNlO1xuICB9XG59XG4iXX0=