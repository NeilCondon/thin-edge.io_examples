import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { IManagedObject, InventoryService, SmartGroupsService } from '@c8y/client';
import { AlertService, gettext, ModalService, Status } from '@c8y/ngx-components';
import { DeviceGroupService } from '@c8y/ngx-components/assets-navigator';
import { TranslateService } from '@ngx-translate/core';
import { SubAssetsService } from './sub-assets.service';
var GroupInfoComponent = /** @class */ (function () {
    function GroupInfoComponent(inventory, subAssetsService, deviceGroupService, smartGroupsService, alertService, translate, modalService) {
        this.inventory = inventory;
        this.subAssetsService = subAssetsService;
        this.deviceGroupService = deviceGroupService;
        this.smartGroupsService = smartGroupsService;
        this.alertService = alertService;
        this.translate = translate;
        this.modalService = modalService;
        this.onGroupChange = new EventEmitter();
        this.filterMsg = gettext('Smart groups are groups dynamically constructed based on filtering criteria.');
        this.canEditMsg = gettext('You can edit the filter here.');
        this.GROUP_UPDATED_MSG = gettext('Group updated.');
    }
    GroupInfoComponent.prototype.ngOnInit = function () {
        this.canEdit = this.smartGroupsService.isSmartGroupV2(this.group)
            ? this.subAssetsService.canEditSmartGroup()
            : this.subAssetsService.canEditGroup(this.group);
        this.groupIcon = this.deviceGroupService.icon(this.group);
        this.smartGroupFilter = this.group.c8y_DeviceQueryString;
        this.setHintMsg();
    };
    GroupInfoComponent.prototype.isSmartGroup = function () {
        return this.subAssetsService.isSmartGroup(this.group);
    };
    GroupInfoComponent.prototype.update = function (partialGroup) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var isSmartGroup, _a, error_1;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _b.trys.push([0, 5, , 6]);
                        isSmartGroup = this.subAssetsService.isSmartGroup(this.group);
                        if (!isSmartGroup) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.updateSmartGroup(partialGroup)];
                    case 1:
                        _a = _b.sent();
                        return [3 /*break*/, 4];
                    case 2: return [4 /*yield*/, this.updateGroup(partialGroup)];
                    case 3:
                        _a = _b.sent();
                        _b.label = 4;
                    case 4:
                        _a;
                        return [3 /*break*/, 6];
                    case 5:
                        error_1 = _b.sent();
                        this.alertService.addServerFailure(error_1);
                        return [3 /*break*/, 6];
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    GroupInfoComponent.prototype.setHintMsg = function () {
        var filterMsgTranslated = this.translate.instant(this.filterMsg);
        var canEditMsgTranslated = this.translate.instant(this.canEditMsg);
        this.filterHintMsg = this.canEdit
            ? filterMsgTranslated + " " + canEditMsgTranslated
            : this.filterMsg;
    };
    GroupInfoComponent.prototype.updateGroup = function (partialGroup) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var id, group, updatedGroup;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        id = this.group.id;
                        group = tslib_1.__assign({ id: id }, partialGroup);
                        return [4 /*yield*/, this.inventory.update(group)];
                    case 1:
                        updatedGroup = (_a.sent()).data;
                        this.setGroup(updatedGroup);
                        return [2 /*return*/];
                }
            });
        });
    };
    GroupInfoComponent.prototype.updateSmartGroup = function (partialGroup) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var id, c8y_DeviceQueryString, group, updatedGroup, modalBody, title, e_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        id = this.group.id;
                        c8y_DeviceQueryString = partialGroup.c8y_DeviceQueryString;
                        group = tslib_1.__assign({ id: id }, partialGroup);
                        if (!!c8y_DeviceQueryString) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.smartGroupsService.update(group)];
                    case 1:
                        updatedGroup = (_a.sent()).data;
                        this.setGroup(updatedGroup);
                        return [2 /*return*/];
                    case 2:
                        _a.trys.push([2, 5, , 6]);
                        modalBody = gettext('You are about to change the smart group filter. Do you want to proceed?');
                        title = gettext('Smart group filter');
                        return [4 /*yield*/, this.modalService.confirm(title, modalBody, Status.WARNING, {
                                ok: gettext('Save'),
                                cancel: gettext('Cancel')
                            })];
                    case 3:
                        _a.sent();
                        return [4 /*yield*/, this.isQueryExecutable(c8y_DeviceQueryString)];
                    case 4:
                        if (!(_a.sent())) {
                            return [2 /*return*/];
                        }
                        return [3 /*break*/, 6];
                    case 5:
                        e_1 = _a.sent();
                        return [2 /*return*/];
                    case 6: return [4 /*yield*/, this.smartGroupsService.update(group)];
                    case 7:
                        updatedGroup = (_a.sent()).data;
                        this.setGroup(updatedGroup);
                        return [2 /*return*/];
                }
            });
        });
    };
    GroupInfoComponent.prototype.setGroup = function (group) {
        this.onGroupChange.emit(group);
        this.alertService.success(this.GROUP_UPDATED_MSG);
    };
    GroupInfoComponent.prototype.isQueryExecutable = function (query) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var filter, error_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        filter = { q: query };
                        return [4 /*yield*/, this.inventory.list(filter)];
                    case 1:
                        _a.sent();
                        return [2 /*return*/, true];
                    case 2:
                        error_2 = _a.sent();
                        this.alertService.addServerFailure(error_2);
                        return [2 /*return*/, false];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    GroupInfoComponent.ctorParameters = function () { return [
        { type: InventoryService },
        { type: SubAssetsService },
        { type: DeviceGroupService },
        { type: SmartGroupsService },
        { type: AlertService },
        { type: TranslateService },
        { type: ModalService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], GroupInfoComponent.prototype, "group", void 0);
    tslib_1.__decorate([
        Output()
    ], GroupInfoComponent.prototype, "onGroupChange", void 0);
    GroupInfoComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-group-info',
            template: "<div class=\"bg-gray-white\">\n  <div class=\"card-block p-t-24 p-b-24 large-padding\">\n    <div class=\"content-flex-70\">\n      <div class=\"text-center\">\n        <i class=\"c8y-icon-duocolor icon-48\" [c8yIcon]=\"groupIcon + '-open'\"></i>\n        <p>\n          <small class=\"label label-info\" *ngIf=\"group.c8y_IsDynamicGroup\">\n            {{ 'Smart group' | translate }}\n          </small>\n          <small\n            class=\"label label-info\"\n            *ngIf=\"!group.c8y_IsDynamicGroup && !group.com_cumulocity_model_Agent\"\n          >\n            {{ 'Group' | translate }}\n          </small>\n          <small class=\"label label-info\" *ngIf=\"group.com_cumulocity_model_Agent\">\n            {{ 'Remote group' | translate }}\n          </small>\n        </p>\n      </div>\n\n      <div class=\"flex-grow col-10\">\n        <div class=\"content-flex-80\">\n          <div class=\"col-9\">\n            <form #groupNameForm=\"ngForm\">\n              <c8y-form-group class=\"form-group-lg m-b-0\">\n                <label class=\"sr-only\" translate>\n                  Name\n                </label>\n\n                <p *ngIf=\"!canEdit\" class=\"form-control-static\">{{ group.name }}</p>\n                <div *ngIf=\"canEdit\" class=\"input-group input-group-editable\">\n                  <input\n                    type=\"text\"\n                    class=\"form-control\"\n                    [(ngModel)]=\"group.name\"\n                    name=\"name\"\n                    title=\"{{ 'Name' | translate }}\"\n                    size=\"{{ group.name.length + 2 }}\"\n                    placeholder=\"{{ 'e.g. My group' | translate }}\"\n                    maxlength=\"254\"\n                    required\n                  />\n                  <span></span>\n                  <div class=\"input-group-btn\">\n                    <button\n                      (click)=\"update({ name: group.name }); groupNameForm.form.markAsPristine()\"\n                      class=\"btn btn-primary\"\n                      title=\"{{ 'Save' | translate }}\"\n                      [disabled]=\"groupNameForm.form.invalid\"\n                    >\n                      {{ 'Save' | translate }}\n                    </button>\n                  </div>\n                </div>\n              </c8y-form-group>\n            </form>\n            <form #groupDescriptionForm=\"ngForm\">\n              <label class=\"sr-only\" translate>\n                Description\n              </label>\n              <p *ngIf=\"!canEdit\" class=\"form-control-static\">{{ group.c8y_Notes }}</p>\n              <div *ngIf=\"canEdit\" class=\"input-group input-group-editable\">\n                <textarea\n                  class=\"form-control\"\n                  [(ngModel)]=\"group.c8y_Notes\"\n                  name=\"description\"\n                  title=\"{{ 'Description' | translate }}\"\n                  cols=\"{{ group.c8y_Notes ? group.c8y_Notes.length : 25 }}\"\n                  placeholder=\"{{ 'e.g. My description' | translate }}\"\n                ></textarea>\n                <span></span>\n                <div class=\"input-group-btn\">\n                  <button\n                    (click)=\"\n                      update({ c8y_Notes: group.c8y_Notes });\n                      groupDescriptionForm.form.markAsPristine()\n                    \"\n                    class=\"btn btn-primary\"\n                    title=\"{{ 'Save' | translate }}\"\n                    [disabled]=\"groupDescriptionForm.form.invalid\"\n                  >\n                    {{ 'Save' | translate }}\n                  </button>\n                </div>\n              </div>\n            </form>\n\n            <form #smartGroupFilterForm=\"ngForm\" *ngIf=\"isSmartGroup()\">\n              <c8y-form-group class=\"m-b-0 m-t-8\">\n                <label class=\"m-b-0 text-nowrap\">\n                  {{ 'Smart group filter' | translate }}\n                  <button\n                    class=\"btn-clean text-primary m-r-4\"\n                    type=\"button\"\n                    popover=\"{{ filterHintMsg | translate }}\"\n                    triggers=\"focus\"\n                  >\n                    <i c8yIcon=\"question-circle-o\"></i>\n                  </button>\n                </label>\n\n                <p *ngIf=\"!canEdit\" class=\"form-control-static\">\n                  {{ smartGroupFilter }}\n                </p>\n                <div *ngIf=\"canEdit\" class=\"input-group input-group-editable\">\n                  <input\n                    type=\"text\"\n                    class=\"form-control\"\n                    [(ngModel)]=\"smartGroupFilter\"\n                    name=\"filter\"\n                    size=\"{{ smartGroupFilter.length + 2 }}\"\n                    placeholder=\"{{ 'e.g.' | translate }} $filter=(id eq '12*')\"\n                    maxlength=\"254\"\n                    title=\"{{ 'Smart group filter' | translate }}\"\n                  />\n                  <span></span>\n                  <div class=\"input-group-btn\">\n                    <button\n                      (click)=\"\n                        update({ c8y_DeviceQueryString: smartGroupFilter });\n                        smartGroupFilterForm.form.markAsPristine()\n                      \"\n                      class=\"btn btn-primary\"\n                      title=\"{{ 'Save' | translate }}\"\n                      [disabled]=\"smartGroupFilterForm.form.invalid\"\n                    >\n                      {{ 'Save' | translate }}\n                    </button>\n                  </div>\n                </div>\n              </c8y-form-group>\n            </form>\n          </div>\n          <div class=\"flex-grow\">\n            <p class=\"m-b-8\">\n              <i c8yIcon=\"info-circle\" class=\"text-info m-r-8\"></i>\n              <span class=\"text-label-small\">{{ 'Group info' | translate }}</span>\n            </p>\n            <ul class=\"list-unstyled small\">\n              <li class=\"p-t-4 p-b-4 flex-row separator-top-bottom text-nowrap\">\n                <label class=\"small m-b-0 m-r-8\">{{ 'Created' | translate }}</label>\n                <span class=\"flex-item-right\">{{ group.creationTime | c8yDate }}</span>\n              </li>\n              <li class=\"p-t-4 p-b-4 flex-row separator-bottom text-nowrap\">\n                <label class=\"small m-b-0 m-r-8\">{{ 'Last updated' | translate }}</label>\n                <span class=\"flex-item-right\">{{ group.lastUpdated | c8yDate }}</span>\n              </li>\n\n              <li\n                *ngIf=\"group.com_cumulocity_model_Agent\"\n                class=\"p-t-4 p-b-4 flex-row separator-bottom text-nowrap\"\n              >\n                <label class=\"small m-b-0 m-r-8\">{{ 'Status' | translate }}</label>\n                <span class=\"flex-item-right\" *ngIf=\"group.c8y_BrokerSource\">\n                  {{ group.c8y_BrokerSource.status }}\n                </span>\n                <span class=\"flex-item-right\" *ngIf=\"!group.c8y_BrokerSource\">\n                  {{ 'Offline' | translate }}\n                </span>\n              </li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n"
        })
    ], GroupInfoComponent);
    return GroupInfoComponent;
}());
export { GroupInfoComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXAtaW5mby5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3N1Yi1hc3NldHMvIiwic291cmNlcyI6WyJncm91cC1pbmZvLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsY0FBYyxFQUFFLGdCQUFnQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ25GLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUMxRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQU14RDtJQWFFLDRCQUNVLFNBQTJCLEVBQzNCLGdCQUFrQyxFQUNsQyxrQkFBc0MsRUFDdEMsa0JBQXNDLEVBQ3RDLFlBQTBCLEVBQzFCLFNBQTJCLEVBQzNCLFlBQTBCO1FBTjFCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBbEIxQixrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFNckMsY0FBUyxHQUFHLE9BQU8sQ0FDekIsOEVBQThFLENBQy9FLENBQUM7UUFDTSxlQUFVLEdB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QVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUE7O3dCQUFqQyxTQUFpQyxDQUFDO3dCQUNsQyxzQkFBTyxJQUFJLEVBQUM7Ozt3QkFFWixJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLE9BQUssQ0FBQyxDQUFDO3dCQUMxQyxzQkFBTyxLQUFLLEVBQUM7Ozs7O0tBRWhCOztnQkFoR29CLGdCQUFnQjtnQkFDVCxnQkFBZ0I7Z0JBQ2Qsa0JBQWtCO2dCQUNsQixrQkFBa0I7Z0JBQ3hCLFlBQVk7Z0JBQ2YsZ0JBQWdCO2dCQUNiLFlBQVk7O0lBbkIzQjtRQUFSLEtBQUssRUFBRTtxREFBdUI7SUFDckI7UUFBVCxNQUFNLEVBQUU7NkRBQW9DO0lBRmxDLGtCQUFrQjtRQUo5QixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsZ0JBQWdCO1lBQzFCLG1xT0FBMEM7U0FDM0MsQ0FBQztPQUNXLGtCQUFrQixDQStHOUI7SUFBRCx5QkFBQztDQUFBLEFBL0dELElBK0dDO1NBL0dZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgSW52ZW50b3J5U2VydmljZSwgU21hcnRHcm91cHNTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0LCBNb2RhbFNlcnZpY2UsIFN0YXR1cyB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgRGV2aWNlR3JvdXBTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9hc3NldHMtbmF2aWdhdG9yJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IFN1YkFzc2V0c1NlcnZpY2UgfSBmcm9tICcuL3N1Yi1hc3NldHMuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1ncm91cC1pbmZvJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2dyb3VwLWluZm8uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEdyb3VwSW5mb0NvbXBvbmVudCB7XG4gIEBJbnB1dCgpIGdyb3VwOiBJTWFuYWdlZE9iamVjdDtcbiAgQE91dHB1dCgpIG9uR3JvdXBDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIGNhbkVkaXQ6IGJvb2xlYW47XG4gIGdyb3VwSWNvbjogc3RyaW5nO1xuICBzbWFydEdyb3VwRmlsdGVyOiBzdHJpbmc7XG4gIGZpbHRlckhpbnRNc2c6IHN0cmluZztcblxuICBwcml2YXRlIGZpbHRlck1zZyA9IGdldHRleHQoXG4gICAgJ1NtYXJ0IGdyb3VwcyBhcmUgZ3JvdXBzIGR5bmFtaWNhbGx5IGNvbnN0cnVjdGVkIGJhc2VkIG9uIGZpbHRlcmluZyBjcml0ZXJpYS4nXG4gICk7XG4gIHByaXZhdGUgY2FuRWRpdE1zZyA9IGdldHRleHQoJ1lvdSBjYW4gZWRpdCB0aGUgZmlsdGVyIGhlcmUuJyk7XG4gIHByaXZhdGUgcmVhZG9ubHkgR1JPVVBfVVBEQVRFRF9NU0cgPSBnZXR0ZXh0KCdHcm91cCB1cGRhdGVkLicpO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIHN1YkFzc2V0c1NlcnZpY2U6IFN1YkFzc2V0c1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBkZXZpY2VHcm91cFNlcnZpY2U6IERldmljZUdyb3VwU2VydmljZSxcbiAgICBwcml2YXRlIHNtYXJ0R3JvdXBzU2VydmljZTogU21hcnRHcm91cHNTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZVxuICApIHt9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5jYW5FZGl0ID0gdGhpcy5zbWFydEdyb3Vwc1NlcnZpY2UuaXNTbWFydEdyb3VwVjIodGhpcy5ncm91cClcbiAgICAgID8gdGhpcy5zdWJBc3NldHNTZXJ2aWNlLmNhbkVkaXRTbWFydEdyb3VwKClcbiAgICAgIDogdGhpcy5zdWJBc3NldHNTZXJ2aWNlLmNhbkVkaXRHcm91cCh0aGlzLmdyb3VwKTtcbiAgICB0aGlzLmdyb3VwSWNvbiA9IHRoaXMuZGV2aWNlR3JvdXBTZXJ2aWNlLmljb24odGhpcy5ncm91cCk7XG4gICAgdGhpcy5zbWFydEdyb3VwRmlsdGVyID0gdGhpcy5ncm91cC5jOHlfRGV2aWNlUXVlcnlTdHJpbmc7XG5cbiAgICB0aGlzLnNldEhpbnRNc2coKTtcbiAgfVxuXG4gIGlzU21hcnRHcm91cCgpIHtcbiAgICByZXR1cm4gdGhpcy5zdWJBc3NldHNTZXJ2aWNlLmlzU21hcnRHcm91cCh0aGlzLmdyb3VwKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZShwYXJ0aWFsR3JvdXA6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGlzU21hcnRHcm91cDogYm9vbGVhbiA9IHRoaXMuc3ViQXNzZXRzU2VydmljZS5pc1NtYXJ0R3JvdXAodGhpcy5ncm91cCk7XG4gICAgICBpc1NtYXJ0R3JvdXBcbiAgICAgICAgPyBhd2FpdCB0aGlzLnVwZGF0ZVNtYXJ0R3JvdXAocGFydGlhbEdyb3VwKVxuICAgICAgICA6IGF3YWl0IHRoaXMudXBkYXRlR3JvdXAocGFydGlhbEdyb3VwKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRIaW50TXNnKCkge1xuICAgIGNvbnN0IGZpbHRlck1zZ1RyYW5zbGF0ZWQgPSB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KHRoaXMuZmlsdGVyTXNnKTtcbiAgICBjb25zdCBjYW5FZGl0TXNnVHJhbnNsYXRlZCA9IHRoaXMudHJhbnNsYXRlLmluc3RhbnQodGhpcy5jYW5FZGl0TXNnKTtcbiAgICB0aGlzLmZpbHRlckhpbnRNc2cgPSB0aGlzLmNhbkVkaXRcbiAgICAgID8gYCR7ZmlsdGVyTXNnVHJhbnNsYXRlZH0gJHtjYW5FZGl0TXNnVHJhbnNsYXRlZH1gXG4gICAgICA6IHRoaXMuZmlsdGVyTXNnO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGRhdGVHcm91cChwYXJ0aWFsR3JvdXA6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+KSB7XG4gICAgY29uc3QgeyBpZCB9ID0gdGhpcy5ncm91cDtcbiAgICBjb25zdCBncm91cDogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4gPSB7IGlkLCAuLi5wYXJ0aWFsR3JvdXAgfTtcblxuICAgIGNvbnN0IHVwZGF0ZWRHcm91cCA9IChhd2FpdCB0aGlzLmludmVudG9yeS51cGRhdGUoZ3JvdXApKS5kYXRhO1xuICAgIHRoaXMuc2V0R3JvdXAodXBkYXRlZEdyb3VwKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdXBkYXRlU21hcnRHcm91cChwYXJ0aWFsR3JvdXA6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+KSB7XG4gICAgY29uc3QgeyBpZCB9ID0gdGhpcy5ncm91cDtcbiAgICBjb25zdCB7IGM4eV9EZXZpY2VRdWVyeVN0cmluZyB9ID0gcGFydGlhbEdyb3VwO1xuICAgIGNvbnN0IGdyb3VwOiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiA9IHsgaWQsIC4uLnBhcnRpYWxHcm91cCB9O1xuICAgIGxldCB1cGRhdGVkR3JvdXA6IElNYW5hZ2VkT2JqZWN0O1xuXG4gICAgaWYgKCFjOHlfRGV2aWNlUXVlcnlTdHJpbmcpIHtcbiAgICAgIHVwZGF0ZWRHcm91cCA9IChhd2FpdCB0aGlzLnNtYXJ0R3JvdXBzU2VydmljZS51cGRhdGUoZ3JvdXApKS5kYXRhO1xuICAgICAgdGhpcy5zZXRHcm91cCh1cGRhdGVkR3JvdXApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBtb2RhbEJvZHkgPSBnZXR0ZXh0KFxuICAgICAgICAnWW91IGFyZSBhYm91dCB0byBjaGFuZ2UgdGhlIHNtYXJ0IGdyb3VwIGZpbHRlci4gRG8geW91IHdhbnQgdG8gcHJvY2VlZD8nXG4gICAgICApO1xuICAgICAgY29uc3QgdGl0bGUgPSBnZXR0ZXh0KCdTbWFydCBncm91cCBmaWx0ZXInKTtcbiAgICAgIGF3YWl0IHRoaXMubW9kYWxTZXJ2aWNlLmNvbmZpcm0odGl0bGUsIG1vZGFsQm9keSwgU3RhdHVzLldBUk5JTkcsIHtcbiAgICAgICAgb2s6IGdldHRleHQoJ1NhdmUnKSxcbiAgICAgICAgY2FuY2VsOiBnZXR0ZXh0KCdDYW5jZWwnKVxuICAgICAgfSk7XG5cbiAgICAgIGlmICghKGF3YWl0IHRoaXMuaXNRdWVyeUV4ZWN1dGFibGUoYzh5X0RldmljZVF1ZXJ5U3RyaW5nKSkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdXBkYXRlZEdyb3VwID0gKGF3YWl0IHRoaXMuc21hcnRHcm91cHNTZXJ2aWNlLnVwZGF0ZShncm91cCkpLmRhdGE7XG4gICAgdGhpcy5zZXRHcm91cCh1cGRhdGVkR3JvdXApO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRHcm91cChncm91cDogSU1hbmFnZWRPYmplY3QpIHtcbiAgICB0aGlzLm9uR3JvdXBDaGFuZ2UuZW1pdChncm91cCk7XG4gICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2Vzcyh0aGlzLkdST1VQX1VQREFURURfTVNHKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaXNRdWVyeUV4ZWN1dGFibGUocXVlcnk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWx0ZXIgPSB7IHE6IHF1ZXJ5IH07XG4gICAgICBhd2FpdCB0aGlzLmludmVudG9yeS5saXN0KGZpbHRlcik7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShlcnJvcik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG59XG4iXX0=