import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { IManagedObject, SmartGroupsService } from '@c8y/client';
import { DataGridComponent, gettext } from '@c8y/ngx-components';
import { BsModalService } from 'ngx-bootstrap/modal';
import { DeleteAssetsModalComponent } from './delete-assets-modal/delete-assets-modal.component';
import { SubAssetsService } from './sub-assets.service';
import { UnassignModalComponent } from './unassign-assets-modal/unassign-modal.component';
var SubAssetsGridComponent = /** @class */ (function () {
    function SubAssetsGridComponent(subAssetsGridService, bsModalService, smartGroupsService) {
        this.subAssetsGridService = subAssetsGridService;
        this.bsModalService = bsModalService;
        this.smartGroupsService = smartGroupsService;
        this.title = gettext('Subassets');
        this.emptyStateText = gettext('Add your first group or assign devices using the buttons on the toolbar.');
        this.loadingItemsLabel = gettext('Loading assetsâ€¦');
        this.selectable = false;
        this.baseQuery = {};
        this.filterable = true;
        this.sortable = true;
        this.onColumnsChange = new EventEmitter();
        this.itemsSelect = new EventEmitter();
        this.pagination = this.subAssetsGridService.getDefaultPagination();
        this.bulkActionControls = this.subAssetsGridService.getDefaultBulkActionControls();
        this.displayOptions = {
            striped: true,
            bordered: false,
            gridHeader: true,
            filter: true
        };
        this.serverSideDataCallback = this.onDataSourceModifier.bind(this);
    }
    Object.defineProperty(SubAssetsGridComponent.prototype, "columns", {
        get: function () {
            return this._columns;
        },
        set: function (value) {
            if (value) {
                this._columns = this.subAssetsGridService.getUserConfiguredColumns(value);
            }
            else {
                this._columns = this.subAssetsGridService.getUserConfiguredColumns(this.subAssetsGridService.getDefaultColumns());
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubAssetsGridComponent.prototype, "_pagination", {
        set: function (value) {
            if (value) {
                this.pagination = value;
            }
            else {
                this.pagination = this.subAssetsGridService.getDefaultPagination();
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubAssetsGridComponent.prototype, "_actionControls", {
        set: function (value) {
            if (value) {
                this.actionControls = value;
            }
            else {
                this.actionControls = this.subAssetsGridService.getDefaultActionControls();
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubAssetsGridComponent.prototype, "_bulkActionControls", {
        set: function (value) {
            if (value) {
                this.bulkActionControls = value;
            }
            else {
                this.bulkActionControls = this.subAssetsGridService.getDefaultBulkActionControls();
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubAssetsGridComponent.prototype, "isRootGroup", {
        get: function () {
            return !this.parentGroup;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubAssetsGridComponent.prototype, "getInfiniteScrollMode", {
        get: function () {
            return this.isRootGroup && this.subAssetsGridService.isUsingInventoryRoles()
                ? 'auto'
                : undefined;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(SubAssetsGridComponent.prototype, "_displayOptions", {
        set: function (displayOptions) {
            this.displayOptions = tslib_1.__assign({}, this.displayOptions, displayOptions);
        },
        enumerable: true,
        configurable: true
    });
    SubAssetsGridComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.columns = this.subAssetsGridService.getDefaultColumns(this.filterable, this.sortable);
        if (!this.filterable || !this.sortable) {
            this.columns.forEach(function (column) {
                column.filterable = _this.filterable;
                column.sortable = _this.sortable;
            });
        }
        this.setActionControls();
    };
    SubAssetsGridComponent.prototype.setActionControls = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var actionControls, isMicroserviceInstalled, deleteAction, unassignAction;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        actionControls = [];
                        return [4 /*yield*/, this.smartGroupsService.isSmartGroupsV2MicroserviceInstalled()];
                    case 1:
                        isMicroserviceInstalled = (_a.sent()).data;
                        deleteAction = {
                            type: "DELETE" /* Delete */,
                            callback: function (asset) { return _this.onDeleteAsset(asset, _this.parentGroup); },
                            showIf: function (asset) {
                                if (_this.smartGroupsService.isSmartGroupV2(asset)) {
                                    return isMicroserviceInstalled ? _this.subAssetsGridService.canDeleteSmartGroup() : false;
                                }
                                if (_this.smartGroupsService.isSmartGroup(asset)) {
                                    return _this.subAssetsGridService.canDeleteSmartGroup();
                                }
                                return true;
                            }
                        };
                        actionControls.push(deleteAction);
                        unassignAction = {
                            type: 'UNASSIGN',
                            icon: 'unlink',
                            text: gettext('Unassign'),
                            callback: function (asset) { return _this.onUnassignAsset(asset, _this.parentGroup); },
                            showIf: function (asset) {
                                return _this.subAssetsGridService.isDevice(asset) &&
                                    !_this.subAssetsGridService.isSmartGroup(_this.parentGroup);
                            }
                        };
                        actionControls.push(unassignAction);
                        if (!this.actionControls) {
                            this.actionControls = actionControls;
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    SubAssetsGridComponent.prototype.onUnassignAsset = function (asset, parentRef) {
        var _this = this;
        var initialState = {
            asset: asset
        };
        var modalRef = this.bsModalService.show(UnassignModalComponent, { initialState: initialState });
        modalRef.content.closeSubject.subscribe(function (result) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!result) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.subAssetsGridService.unassignAsset(asset, parentRef)];
                    case 1:
                        _a.sent();
                        this.refresh.emit();
                        _a.label = 2;
                    case 2: return [2 /*return*/];
                }
            });
        }); });
    };
    SubAssetsGridComponent.prototype.onDeleteAsset = function (asset, parentRef) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var initialState, modalRef;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                initialState = {
                    showWithDeviceUserCheckbox: this.subAssetsGridService.shouldShowWithDeviceUserCheckbox(asset),
                    asset: asset,
                    showWithCascadeCheckbox: !this.smartGroupsService.isSmartGroup(asset) &&
                        !this.smartGroupsService.isSmartGroupV2(asset)
                };
                modalRef = this.bsModalService.show(DeleteAssetsModalComponent, { initialState: initialState });
                modalRef.content.closeSubject.subscribe(function (result) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                    return tslib_1.__generator(this, function (_a) {
                        switch (_a.label) {
                            case 0:
                                if (!result) return [3 /*break*/, 2];
                                this.subAssetsGridService.uiOnlyCountersUpdate.next('DECREASE');
                                return [4 /*yield*/, this.subAssetsGridService.deleteAsset(asset, parentRef, result)];
                            case 1:
                                _a.sent();
                                this.refresh.emit();
                                _a.label = 2;
                            case 2: return [2 /*return*/];
                        }
                    });
                }); });
                return [2 /*return*/];
            });
        });
    };
    SubAssetsGridComponent.prototype.ngOnChanges = function (changes) {
        if (changes.parentGroup && !changes.parentGroup.firstChange) {
            this.dataGrid.reload();
        }
    };
    SubAssetsGridComponent.prototype.trackByName = function (_index, column) {
        return column.name;
    };
    SubAssetsGridComponent.prototype.onDataSourceModifier = function (dataSourceModifier) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var promises, counters, action, _a, dataResponse, size, filteredSize;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        promises = [];
                        promises.push(this.subAssetsGridService.getData(dataSourceModifier.columns, dataSourceModifier.pagination, this.parentGroup, this.baseQuery));
                        action = this.subAssetsGridService.uiOnlyCountersUpdate.value;
                        if (action) {
                            counters = this.uiOnlyCountersUpdate(action);
                            this.subAssetsGridService.uiOnlyCountersUpdate.next(null);
                        }
                        else {
                            promises.push(this.subAssetsGridService.getTotal(this.parentGroup, this.baseQuery));
                            promises.push(this.subAssetsGridService.getCount(dataSourceModifier.columns, dataSourceModifier.pagination, this.parentGroup, this.baseQuery));
                        }
                        return [4 /*yield*/, Promise.all(promises)];
                    case 1:
                        _a = tslib_1.__read.apply(void 0, [_b.sent(), 3]), dataResponse = _a[0], size = _a[1], filteredSize = _a[2];
                        if (!counters) {
                            counters = {
                                size: size,
                                filteredSize: filteredSize
                            };
                        }
                        this.onColumnsChange.emit(dataSourceModifier.columns);
                        return [2 /*return*/, tslib_1.__assign({ res: dataResponse.res, data: dataResponse.data, paging: dataResponse.paging }, counters)];
                }
            });
        });
    };
    SubAssetsGridComponent.prototype.configChange = function (config) {
        this.subAssetsGridService.saveConfig(config);
    };
    // workaround since the totalPages value is cached on the BE
    SubAssetsGridComponent.prototype.uiOnlyCountersUpdate = function (action) {
        var currentAllItemsCount = this.dataGrid.filteringLabelsParams.allItemsCount;
        var currentFilteredItemsCount = this.dataGrid.filteringLabelsParams.filteredItemsCount;
        var counters;
        if (action === 'DECREASE') {
            counters = {
                size: currentAllItemsCount - 1,
                filteredSize: currentFilteredItemsCount - 1
            };
        }
        if (action === 'INCREASE') {
            counters = {
                size: currentAllItemsCount + 1,
                filteredSize: currentFilteredItemsCount + 1
            };
        }
        return counters;
    };
    SubAssetsGridComponent.ctorParameters = function () { return [
        { type: SubAssetsService },
        { type: BsModalService },
        { type: SmartGroupsService }
    ]; };
    tslib_1.__decorate([
        Input('parent-group')
    ], SubAssetsGridComponent.prototype, "parentGroup", void 0);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "refresh", void 0);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "title", void 0);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "emptyStateText", void 0);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "loadingItemsLabel", void 0);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "columns", null);
    tslib_1.__decorate([
        Input('pagination')
    ], SubAssetsGridComponent.prototype, "_pagination", null);
    tslib_1.__decorate([
        Input('actionControls')
    ], SubAssetsGridComponent.prototype, "_actionControls", null);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "selectable", void 0);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "baseQuery", void 0);
    tslib_1.__decorate([
        Input('bulkActionControls')
    ], SubAssetsGridComponent.prototype, "_bulkActionControls", null);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "filterable", void 0);
    tslib_1.__decorate([
        Input()
    ], SubAssetsGridComponent.prototype, "sortable", void 0);
    tslib_1.__decorate([
        Output()
    ], SubAssetsGridComponent.prototype, "onColumnsChange", void 0);
    tslib_1.__decorate([
        Output()
    ], SubAssetsGridComponent.prototype, "itemsSelect", void 0);
    tslib_1.__decorate([
        ViewChild(DataGridComponent, { static: true })
    ], SubAssetsGridComponent.prototype, "dataGrid", void 0);
    tslib_1.__decorate([
        Input('displayOptions')
    ], SubAssetsGridComponent.prototype, "_displayOptions", null);
    SubAssetsGridComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-sub-assets-grid',
            template: "<c8y-data-grid\n  [title]=\"title\"\n  [loadingItemsLabel]=\"loadingItemsLabel\"\n  [columns]=\"columns\"\n  [pagination]=\"pagination\"\n  [actionControls]=\"actionControls\"\n  [selectable]=\"selectable\"\n  [bulkActionControls]=\"bulkActionControls\"\n  [serverSideDataCallback]=\"serverSideDataCallback\"\n  [infiniteScroll]=\"getInfiniteScrollMode\"\n  [refresh]=\"refresh\"\n  [displayOptions]=\"displayOptions\"\n  (onConfigChange)=\"configChange($event)\"\n  (itemsSelect)=\"itemsSelect.emit($event)\"\n  class=\"d-contents\"\n>\n  <ng-container *ngFor=\"let column of columns; trackBy: trackByName\">\n    <c8y-column [name]=\"column.name\"></c8y-column>\n  </ng-container>\n  <div class=\"c8y-empty-state\">\n    <h1 c8yIcon=\"c8y-group-add\" class=\"c8y-icon-duocolor\"></h1>\n    <div>\n      <p>\n        <strong>{{ 'No items to display.' | translate }}</strong>\n      </p>\n      <small>{{ emptyStateText | translate }}</small>\n    </div>\n  </div>\n</c8y-data-grid>\n"
        })
    ], SubAssetsGridComponent);
    return SubAssetsGridComponent;
}());
export { SubAssetsGridComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViLWFzc2V0cy1ncmlkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvc3ViLWFzc2V0cy8iLCJzb3VyY2VzIjpbInN1Yi1hc3NldHMtZ3JpZC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEVBRU4sU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDakUsT0FBTyxFQUlMLGlCQUFpQixFQUdqQixPQUFPLEVBSVIsTUFBTSxxQkFBcUIsQ0FBQztBQUU3QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFckQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0scURBQXFELENBQUM7QUFDakcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFLMUY7SUFtRkUsZ0NBQ1Msb0JBQXNDLEVBQ3JDLGNBQThCLEVBQzlCLGtCQUFzQztRQUZ2Qyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQWtCO1FBQ3JDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBbkZ2QyxVQUFLLEdBQVcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JDLG1CQUFjLEdBQVcsT0FBTyxDQUN2QywwRUFBMEUsQ0FDM0UsQ0FBQztRQUNPLHNCQUFpQixHQUFXLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBNEJ2RCxlQUFVLEdBQVksS0FBSyxDQUFDO1FBQzVCLGNBQVMsR0FBUSxFQUFFLENBQUM7UUFRcEIsZUFBVSxHQUFZLElBQUksQ0FBQztRQUMzQixhQUFR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Q0FBQyxjQUFjLENBQUM7K0RBQTZCO0lBQzFDO1FBQVIsS0FBSyxFQUFFOzJEQUE0QjtJQUMzQjtRQUFSLEtBQUssRUFBRTt5REFBc0M7SUFDckM7UUFBUixLQUFLLEVBQUU7a0VBRU47SUFDTztRQUFSLEtBQUssRUFBRTtxRUFBd0Q7SUFLdkQ7UUFBUixLQUFLLEVBQUU7eURBUVA7SUFDb0I7UUFBcEIsS0FBSyxDQUFDLFlBQVksQ0FBQzs2REFNbkI7SUFDd0I7UUFBeEIsS0FBSyxDQUFDLGdCQUFnQixDQUFDO2lFQU12QjtJQUNRO1FBQVIsS0FBSyxFQUFFOzhEQUE2QjtJQUM1QjtRQUFSLEtBQUssRUFBRTs2REFBcUI7SUFDQTtRQUE1QixLQUFLLENBQUMsb0JBQW9CLENBQUM7cUVBTTNCO0lBQ1E7UUFBUixLQUFLLEVBQUU7OERBQTRCO0lBQzNCO1FBQVIsS0FBSyxFQUFFOzREQUEwQjtJQUN4QjtRQUFULE1BQU0sRUFBRTttRUFFTDtJQUNNO1FBQVQsTUFBTSxFQUFFOytEQUFvRTtJQVE3RTtRQURDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQzs0REFDbkI7SUFzQjVCO1FBREMsS0FBSyxDQUFDLGdCQUFnQixDQUFDO2lFQUd2QjtJQWpGVSxzQkFBc0I7UUFKbEMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHFCQUFxQjtZQUMvQixvK0JBQStDO1NBQ2hELENBQUM7T0FDVyxzQkFBc0IsQ0FpUWxDO0lBQUQsNkJBQUM7Q0FBQSxBQWpRRCxJQWlRQztTQWpRWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzLFxuICBWaWV3Q2hpbGRcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgU21hcnRHcm91cHNTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHtcbiAgQWN0aW9uQ29udHJvbCxcbiAgQnVpbHRJbkFjdGlvblR5cGUsXG4gIEJ1bGtBY3Rpb25Db250cm9sLFxuICBEYXRhR3JpZENvbXBvbmVudCxcbiAgRGF0YVNvdXJjZU1vZGlmaWVyLFxuICBEaXNwbGF5T3B0aW9ucyxcbiAgZ2V0dGV4dCxcbiAgUGFnaW5hdGlvbixcbiAgUm93LFxuICBTZXJ2ZXJTaWRlRGF0YVJlc3VsdFxufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IERldmljZUdyaWRDb2x1bW4gfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2RldmljZS1ncmlkJztcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBEZWxldGVNb2RhbENoZWNrYm94ZXMgfSBmcm9tICcuL2RlbGV0ZS1hc3NldHMtbW9kYWwnO1xuaW1wb3J0IHsgRGVsZXRlQXNzZXRzTW9kYWxDb21wb25lbnQgfSBmcm9tICcuL2RlbGV0ZS1hc3NldHMtbW9kYWwvZGVsZXRlLWFzc2V0cy1tb2RhbC5jb21wb25lbnQnO1xuaW1wb3J0IHsgU3ViQXNzZXRzU2VydmljZSB9IGZyb20gJy4vc3ViLWFzc2V0cy5zZXJ2aWNlJztcbmltcG9ydCB7IFVuYXNzaWduTW9kYWxDb21wb25lbnQgfSBmcm9tICcuL3VuYXNzaWduLWFzc2V0cy1tb2RhbC91bmFzc2lnbi1tb2RhbC5jb21wb25lbnQnO1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXN1Yi1hc3NldHMtZ3JpZCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9zdWItYXNzZXRzLWdyaWQuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFN1YkFzc2V0c0dyaWRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBASW5wdXQoJ3BhcmVudC1ncm91cCcpIHBhcmVudEdyb3VwOiBJTWFuYWdlZE9iamVjdDtcbiAgQElucHV0KCkgcmVmcmVzaDogRXZlbnRFbWl0dGVyPGFueT47XG4gIEBJbnB1dCgpIHRpdGxlOiBzdHJpbmcgPSBnZXR0ZXh0KCdTdWJhc3NldHMnKTtcbiAgQElucHV0KCkgZW1wdHlTdGF0ZVRleHQ6IHN0cmluZyA9IGdldHRleHQoXG4gICAgJ0FkZCB5b3VyIGZpcnN0IGdyb3VwIG9yIGFzc2lnbiBkZXZpY2VzIHVzaW5nIHRoZSBidXR0b25zIG9uIHRoZSB0b29sYmFyLidcbiAgKTtcbiAgQElucHV0KCkgbG9hZGluZ0l0ZW1zTGFiZWw6IHN0cmluZyA9IGdldHRleHQoJ0xvYWRpbmcgYXNzZXRz4oCmJyk7XG5cbiAgZ2V0IGNvbHVtbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbHVtbnM7XG4gIH1cbiAgQElucHV0KCkgc2V0IGNvbHVtbnModmFsdWU6IERldmljZUdyaWRDb2x1bW5bXSkge1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgdGhpcy5fY29sdW1ucyA9IHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0VXNlckNvbmZpZ3VyZWRDb2x1bW5zKHZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fY29sdW1ucyA9IHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0VXNlckNvbmZpZ3VyZWRDb2x1bW5zKFxuICAgICAgICB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmdldERlZmF1bHRDb2x1bW5zKClcbiAgICAgICk7XG4gICAgfVxuICB9XG4gIEBJbnB1dCgncGFnaW5hdGlvbicpIHNldCBfcGFnaW5hdGlvbih2YWx1ZTogUGFnaW5hdGlvbikge1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgdGhpcy5wYWdpbmF0aW9uID0gdmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucGFnaW5hdGlvbiA9IHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0RGVmYXVsdFBhZ2luYXRpb24oKTtcbiAgICB9XG4gIH1cbiAgQElucHV0KCdhY3Rpb25Db250cm9scycpIHNldCBfYWN0aW9uQ29udHJvbHModmFsdWU6IEFjdGlvbkNvbnRyb2xbXSkge1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgdGhpcy5hY3Rpb25Db250cm9scyA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFjdGlvbkNvbnRyb2xzID0gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5nZXREZWZhdWx0QWN0aW9uQ29udHJvbHMoKTtcbiAgICB9XG4gIH1cbiAgQElucHV0KCkgc2VsZWN0YWJsZTogYm9vbGVhbiA9IGZhbHNlO1xuICBASW5wdXQoKSBiYXNlUXVlcnk6IGFueSA9IHt9O1xuICBASW5wdXQoJ2J1bGtBY3Rpb25Db250cm9scycpIHNldCBfYnVsa0FjdGlvbkNvbnRyb2xzKHZhbHVlOiBCdWxrQWN0aW9uQ29udHJvbFtdKSB7XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLmJ1bGtBY3Rpb25Db250cm9scyA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJ1bGtBY3Rpb25Db250cm9scyA9IHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UuZ2V0RGVmYXVsdEJ1bGtBY3Rpb25Db250cm9scygpO1xuICAgIH1cbiAgfVxuICBASW5wdXQoKSBmaWx0ZXJhYmxlOiBib29sZWFuID0gdHJ1ZTtcbiAgQElucHV0KCkgc29ydGFibGU6IGJvb2xlYW4gPSB0cnVlO1xuICBAT3V0cHV0KCkgb25Db2x1bW5zQ2hhbmdlOiBFdmVudEVtaXR0ZXI8RGV2aWNlR3JpZENvbHVtbltdPiA9IG5ldyBFdmVudEVtaXR0ZXI8XG4gICAgRGV2aWNlR3JpZENvbHVtbltdXG4gID4oKTtcbiAgQE91dHB1dCgpIGl0ZW1zU2VsZWN0OiBFdmVudEVtaXR0ZXI8c3RyaW5nW10+ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmdbXT4oKTtcblxuICBwYWdpbmF0aW9uOiBQYWdpbmF0aW9uID0gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5nZXREZWZhdWx0UGFnaW5hdGlvbigpO1xuICBhY3Rpb25Db250cm9sczogQWN0aW9uQ29udHJvbFtdO1xuICBidWxrQWN0aW9uQ29udHJvbHM6IEJ1bGtBY3Rpb25Db250cm9sW10gPSB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmdldERlZmF1bHRCdWxrQWN0aW9uQ29udHJvbHMoKTtcbiAgc2VydmVyU2lkZURhdGFDYWxsYmFjazogYW55O1xuXG4gIEBWaWV3Q2hpbGQoRGF0YUdyaWRDb21wb25lbnQsIHsgc3RhdGljOiB0cnVlIH0pXG4gIGRhdGFHcmlkOiBEYXRhR3JpZENvbXBvbmVudDtcblxuICBkaXNwbGF5T3B0aW9uczogRGlzcGxheU9wdGlvbnMgPSB7XG4gICAgc3RyaXBlZDogdHJ1ZSxcbiAgICBib3JkZXJlZDogZmFsc2UsXG4gICAgZ3JpZEhlYWRlcjogdHJ1ZSxcbiAgICBmaWx0ZXI6IHRydWVcbiAgfTtcblxuICBwcml2YXRlIF9jb2x1bW5zOiBEZXZpY2VHcmlkQ29sdW1uW107XG5cbiAgZ2V0IGlzUm9vdEdyb3VwKCkge1xuICAgIHJldHVybiAhdGhpcy5wYXJlbnRHcm91cDtcbiAgfVxuXG4gIGdldCBnZXRJbmZpbml0ZVNjcm9sbE1vZGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNSb290R3JvdXAgJiYgdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5pc1VzaW5nSW52ZW50b3J5Um9sZXMoKVxuICAgICAgPyAnYXV0bydcbiAgICAgIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgQElucHV0KCdkaXNwbGF5T3B0aW9ucycpXG4gIHNldCBfZGlzcGxheU9wdGlvbnMoZGlzcGxheU9wdGlvbnMpIHtcbiAgICB0aGlzLmRpc3BsYXlPcHRpb25zID0geyAuLi50aGlzLmRpc3BsYXlPcHRpb25zLCAuLi5kaXNwbGF5T3B0aW9ucyB9O1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHN1YkFzc2V0c0dyaWRTZXJ2aWNlOiBTdWJBc3NldHNTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgc21hcnRHcm91cHNTZXJ2aWNlOiBTbWFydEdyb3Vwc1NlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5zZXJ2ZXJTaWRlRGF0YUNhbGxiYWNrID0gdGhpcy5vbkRhdGFTb3VyY2VNb2RpZmllci5iaW5kKHRoaXMpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5jb2x1bW5zID0gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5nZXREZWZhdWx0Q29sdW1ucyh0aGlzLmZpbHRlcmFibGUsIHRoaXMuc29ydGFibGUpO1xuICAgIGlmICghdGhpcy5maWx0ZXJhYmxlIHx8ICF0aGlzLnNvcnRhYmxlKSB7XG4gICAgICB0aGlzLmNvbHVtbnMuZm9yRWFjaChjb2x1bW4gPT4ge1xuICAgICAgICBjb2x1bW4uZmlsdGVyYWJsZSA9IHRoaXMuZmlsdGVyYWJsZTtcbiAgICAgICAgY29sdW1uLnNvcnRhYmxlID0gdGhpcy5zb3J0YWJsZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLnNldEFjdGlvbkNvbnRyb2xzKCk7XG4gIH1cblxuICBhc3luYyBzZXRBY3Rpb25Db250cm9scygpIHtcbiAgICBjb25zdCBhY3Rpb25Db250cm9sczogQWN0aW9uQ29udHJvbFtdID0gW107XG4gICAgY29uc3Qge1xuICAgICAgZGF0YTogaXNNaWNyb3NlcnZpY2VJbnN0YWxsZWRcbiAgICB9ID0gYXdhaXQgdGhpcy5zbWFydEdyb3Vwc1NlcnZpY2UuaXNTbWFydEdyb3Vwc1YyTWljcm9zZXJ2aWNlSW5zdGFsbGVkKCk7XG5cbiAgICBjb25zdCBkZWxldGVBY3Rpb246IEFjdGlvbkNvbnRyb2wgPSB7XG4gICAgICB0eXBlOiBCdWlsdEluQWN0aW9uVHlwZS5EZWxldGUsXG4gICAgICBjYWxsYmFjazogKGFzc2V0OiBSb3cpID0+IHRoaXMub25EZWxldGVBc3NldChhc3NldCBhcyBJTWFuYWdlZE9iamVjdCwgdGhpcy5wYXJlbnRHcm91cCksXG4gICAgICBzaG93SWY6IChhc3NldDogUm93KSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnNtYXJ0R3JvdXBzU2VydmljZS5pc1NtYXJ0R3JvdXBWMihhc3NldCBhcyBJTWFuYWdlZE9iamVjdCkpIHtcbiAgICAgICAgICByZXR1cm4gaXNNaWNyb3NlcnZpY2VJbnN0YWxsZWQgPyB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmNhbkRlbGV0ZVNtYXJ0R3JvdXAoKSA6IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuc21hcnRHcm91cHNTZXJ2aWNlLmlzU21hcnRHcm91cChhc3NldCBhcyBJTWFuYWdlZE9iamVjdCkpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5jYW5EZWxldGVTbWFydEdyb3VwKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgYWN0aW9uQ29udHJvbHMucHVzaChkZWxldGVBY3Rpb24pO1xuXG4gICAgY29uc3QgdW5hc3NpZ25BY3Rpb246IEFjdGlvbkNvbnRyb2wgPSB7XG4gICAgICB0eXBlOiAnVU5BU1NJR04nLFxuICAgICAgaWNvbjogJ3VubGluaycsXG4gICAgICB0ZXh0OiBnZXR0ZXh0KCdVbmFzc2lnbicpLFxuICAgICAgY2FsbGJhY2s6IChhc3NldDogUm93KSA9PiB0aGlzLm9uVW5hc3NpZ25Bc3NldChhc3NldCBhcyBJTWFuYWdlZE9iamVjdCwgdGhpcy5wYXJlbnRHcm91cCksXG4gICAgICBzaG93SWY6IChhc3NldDogUm93KSA9PlxuICAgICAgICB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmlzRGV2aWNlKGFzc2V0IGFzIElNYW5hZ2VkT2JqZWN0KSAmJlxuICAgICAgICAhdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5pc1NtYXJ0R3JvdXAodGhpcy5wYXJlbnRHcm91cCBhcyBJTWFuYWdlZE9iamVjdClcbiAgICB9O1xuXG4gICAgYWN0aW9uQ29udHJvbHMucHVzaCh1bmFzc2lnbkFjdGlvbik7XG5cbiAgICBpZiAoIXRoaXMuYWN0aW9uQ29udHJvbHMpIHtcbiAgICAgIHRoaXMuYWN0aW9uQ29udHJvbHMgPSBhY3Rpb25Db250cm9scztcbiAgICB9XG4gIH1cblxuICBvblVuYXNzaWduQXNzZXQoYXNzZXQ6IElNYW5hZ2VkT2JqZWN0LCBwYXJlbnRSZWY6IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICAgICAgYXNzZXRcbiAgICB9O1xuICAgIGNvbnN0IG1vZGFsUmVmID0gdGhpcy5ic01vZGFsU2VydmljZS5zaG93KFVuYXNzaWduTW9kYWxDb21wb25lbnQsIHsgaW5pdGlhbFN0YXRlIH0pO1xuXG4gICAgbW9kYWxSZWYuY29udGVudC5jbG9zZVN1YmplY3Quc3Vic2NyaWJlKGFzeW5jIChyZXN1bHQ6IGJvb2xlYW4pID0+IHtcbiAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS51bmFzc2lnbkFzc2V0KGFzc2V0LCBwYXJlbnRSZWYpO1xuICAgICAgICB0aGlzLnJlZnJlc2guZW1pdCgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgb25EZWxldGVBc3NldChhc3NldDogSU1hbmFnZWRPYmplY3QsIHBhcmVudFJlZjogSU1hbmFnZWRPYmplY3QpIHtcbiAgICBjb25zdCBpbml0aWFsU3RhdGUgPSB7XG4gICAgICBzaG93V2l0aERldmljZVVzZXJDaGVja2JveDogdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS5zaG91bGRTaG93V2l0aERldmljZVVzZXJDaGVja2JveChhc3NldCksXG4gICAgICBhc3NldCxcbiAgICAgIHNob3dXaXRoQ2FzY2FkZUNoZWNrYm94OlxuICAgICAgICAhdGhpcy5zbWFydEdyb3Vwc1NlcnZpY2UuaXNTbWFydEdyb3VwKGFzc2V0KSAmJlxuICAgICAgICAhdGhpcy5zbWFydEdyb3Vwc1NlcnZpY2UuaXNTbWFydEdyb3VwVjIoYXNzZXQpXG4gICAgfTtcblxuICAgIGNvbnN0IG1vZGFsUmVmID0gdGhpcy5ic01vZGFsU2VydmljZS5zaG93KERlbGV0ZUFzc2V0c01vZGFsQ29tcG9uZW50LCB7IGluaXRpYWxTdGF0ZSB9KTtcblxuICAgIG1vZGFsUmVmLmNvbnRlbnQuY2xvc2VTdWJqZWN0LnN1YnNjcmliZShhc3luYyAocmVzdWx0OiBEZWxldGVNb2RhbENoZWNrYm94ZXMpID0+IHtcbiAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS51aU9ubHlDb3VudGVyc1VwZGF0ZS5uZXh0KCdERUNSRUFTRScpO1xuICAgICAgICBhd2FpdCB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmRlbGV0ZUFzc2V0KGFzc2V0LCBwYXJlbnRSZWYsIHJlc3VsdCk7XG4gICAgICAgIHRoaXMucmVmcmVzaC5lbWl0KCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMucGFyZW50R3JvdXAgJiYgIWNoYW5nZXMucGFyZW50R3JvdXAuZmlyc3RDaGFuZ2UpIHtcbiAgICAgIHRoaXMuZGF0YUdyaWQucmVsb2FkKCk7XG4gICAgfVxuICB9XG5cbiAgdHJhY2tCeU5hbWUoX2luZGV4LCBjb2x1bW46IERldmljZUdyaWRDb2x1bW4pOiBzdHJpbmcge1xuICAgIHJldHVybiBjb2x1bW4ubmFtZTtcbiAgfVxuXG4gIGFzeW5jIG9uRGF0YVNvdXJjZU1vZGlmaWVyKFxuICAgIGRhdGFTb3VyY2VNb2RpZmllcjogRGF0YVNvdXJjZU1vZGlmaWVyXG4gICk6IFByb21pc2U8U2VydmVyU2lkZURhdGFSZXN1bHQ+IHtcbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuICAgIGxldCBjb3VudGVycztcblxuICAgIHByb21pc2VzLnB1c2goXG4gICAgICB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmdldERhdGEoXG4gICAgICAgIGRhdGFTb3VyY2VNb2RpZmllci5jb2x1bW5zLFxuICAgICAgICBkYXRhU291cmNlTW9kaWZpZXIucGFnaW5hdGlvbixcbiAgICAgICAgdGhpcy5wYXJlbnRHcm91cCxcbiAgICAgICAgdGhpcy5iYXNlUXVlcnlcbiAgICAgIClcbiAgICApO1xuXG4gICAgY29uc3QgYWN0aW9uID0gdGhpcy5zdWJBc3NldHNHcmlkU2VydmljZS51aU9ubHlDb3VudGVyc1VwZGF0ZS52YWx1ZTtcbiAgICBpZiAoYWN0aW9uKSB7XG4gICAgICBjb3VudGVycyA9IHRoaXMudWlPbmx5Q291bnRlcnNVcGRhdGUoYWN0aW9uKTtcbiAgICAgIHRoaXMuc3ViQXNzZXRzR3JpZFNlcnZpY2UudWlPbmx5Q291bnRlcnNVcGRhdGUubmV4dChudWxsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmdldFRvdGFsKHRoaXMucGFyZW50R3JvdXAsIHRoaXMuYmFzZVF1ZXJ5KSk7XG4gICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLmdldENvdW50KFxuICAgICAgICAgIGRhdGFTb3VyY2VNb2RpZmllci5jb2x1bW5zLFxuICAgICAgICAgIGRhdGFTb3VyY2VNb2RpZmllci5wYWdpbmF0aW9uLFxuICAgICAgICAgIHRoaXMucGFyZW50R3JvdXAsXG4gICAgICAgICAgdGhpcy5iYXNlUXVlcnlcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgW2RhdGFSZXNwb25zZSwgc2l6ZSwgZmlsdGVyZWRTaXplXSA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICBpZiAoIWNvdW50ZXJzKSB7XG4gICAgICBjb3VudGVycyA9IHtcbiAgICAgICAgc2l6ZSxcbiAgICAgICAgZmlsdGVyZWRTaXplXG4gICAgICB9O1xuICAgIH1cbiAgICB0aGlzLm9uQ29sdW1uc0NoYW5nZS5lbWl0KGRhdGFTb3VyY2VNb2RpZmllci5jb2x1bW5zKTtcblxuICAgIHJldHVybiB7XG4gICAgICByZXM6IGRhdGFSZXNwb25zZS5yZXMsXG4gICAgICBkYXRhOiBkYXRhUmVzcG9uc2UuZGF0YSxcbiAgICAgIHBhZ2luZzogZGF0YVJlc3BvbnNlLnBhZ2luZyxcbiAgICAgIC4uLmNvdW50ZXJzXG4gICAgfTtcbiAgfVxuXG4gIGNvbmZpZ0NoYW5nZShjb25maWcpIHtcbiAgICB0aGlzLnN1YkFzc2V0c0dyaWRTZXJ2aWNlLnNhdmVDb25maWcoY29uZmlnKTtcbiAgfVxuXG4gIC8vIHdvcmthcm91bmQgc2luY2UgdGhlIHRvdGFsUGFnZXMgdmFsdWUgaXMgY2FjaGVkIG9uIHRoZSBCRVxuICBwcml2YXRlIHVpT25seUNvdW50ZXJzVXBkYXRlKGFjdGlvbjogJ0lOQ1JFQVNFJyB8ICdERUNSRUFTRScpIHtcbiAgICBjb25zdCBjdXJyZW50QWxsSXRlbXNDb3VudCA9IHRoaXMuZGF0YUdyaWQuZmlsdGVyaW5nTGFiZWxzUGFyYW1zLmFsbEl0ZW1zQ291bnQ7XG4gICAgY29uc3QgY3VycmVudEZpbHRlcmVkSXRlbXNDb3VudCA9IHRoaXMuZGF0YUdyaWQuZmlsdGVyaW5nTGFiZWxzUGFyYW1zLmZpbHRlcmVkSXRlbXNDb3VudDtcbiAgICBsZXQgY291bnRlcnM7XG4gICAgaWYgKGFjdGlvbiA9PT0gJ0RFQ1JFQVNFJykge1xuICAgICAgY291bnRlcnMgPSB7XG4gICAgICAgIHNpemU6IGN1cnJlbnRBbGxJdGVtc0NvdW50IC0gMSxcbiAgICAgICAgZmlsdGVyZWRTaXplOiBjdXJyZW50RmlsdGVyZWRJdGVtc0NvdW50IC0gMVxuICAgICAgfTtcbiAgICB9XG4gICAgaWYgKGFjdGlvbiA9PT0gJ0lOQ1JFQVNFJykge1xuICAgICAgY291bnRlcnMgPSB7XG4gICAgICAgIHNpemU6IGN1cnJlbnRBbGxJdGVtc0NvdW50ICsgMSxcbiAgICAgICAgZmlsdGVyZWRTaXplOiBjdXJyZW50RmlsdGVyZWRJdGVtc0NvdW50ICsgMVxuICAgICAgfTtcbiAgICB9XG4gICAgcmV0dXJuIGNvdW50ZXJzO1xuICB9XG59XG4iXX0=